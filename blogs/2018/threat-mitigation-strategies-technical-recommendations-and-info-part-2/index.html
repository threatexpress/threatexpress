



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Threatexpress Blog">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>Threat Mitagation Strategies - Part 2 - Threatexpress</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.30686662.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="">
      
    
    
      <script src="../../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../../css/extra.css">
    
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="black" data-md-color-accent="red">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#threat-mitigation-strategies-part-2" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../.." title="Threatexpress" class="md-header-nav__button md-logo">
          
            <img src="../../../img/threatexpress_logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Threatexpress
            </span>
            <span class="md-header-nav__topic">
              
                Threat Mitagation Strategies - Part 2
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/threatexpress/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    threatexpress/threatexpress
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../.." title="Threatexpress" class="md-nav__button md-logo">
      
        <img src="../../../img/threatexpress_logo.png" width="48" height="48">
      
    </a>
    Threatexpress
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/threatexpress/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    threatexpress/threatexpress
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://redteam.guide" title="REDTEAM.GUIDE" class="md-nav__link">
      REDTEAM.GUIDE
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Posts
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Posts
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-1" type="checkbox" id="nav-3-1">
    
    <label class="md-nav__link" for="nav-3-1">
      2020
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-1">
        2020
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../2020/red-team-development-and-operations/" title="Red Team Development and Operations" class="md-nav__link">
      Red Team Development and Operations
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-2" type="checkbox" id="nav-3-2">
    
    <label class="md-nav__link" for="nav-3-2">
      2019
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-2">
        2019
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../2019/event-data-collector/" title="Event Data Collector" class="md-nav__link">
      Event Data Collector
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../2019/c2-agent-comparison/" title="C2 Agent Comparison" class="md-nav__link">
      C2 Agent Comparison
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../2019/git-clone-entire-org/" title="Git clone all organizational repos" class="md-nav__link">
      Git clone all organizational repos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../2019/penetration-testing-pasties/" title="Penetration Testing Pasties" class="md-nav__link">
      Penetration Testing Pasties
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3" type="checkbox" id="nav-3-3" checked>
    
    <label class="md-nav__link" for="nav-3-3">
      2018
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-3">
        2018
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../a-deep-dive-into-cobalt-strike-malleable-c2/" title="A Deep Dive into Cobalt Strike Malleable C2" class="md-nav__link">
      A Deep Dive into Cobalt Strike Malleable C2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../threat-gets-a-vote-applying-a-threat-based-approach-to-security-testing/" title="Threat Get's a Vote - Applying a Threat-Based Approach to Security Testing" class="md-nav__link">
      Threat Get's a Vote - Applying a Threat-Based Approach to Security Testing
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Threat Mitagation Strategies - Part 2
      </label>
    
    <a href="./" title="Threat Mitagation Strategies - Part 2" class="md-nav__link md-nav__link--active">
      Threat Mitagation Strategies - Part 2
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#account-management" class="md-nav__link">
    Account Management
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adjust-password-policy" class="md-nav__link">
    Adjust Password Policy
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setting-the-password-policy-using-gpo" class="md-nav__link">
    Setting the Password Policy using GPO
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#krbtgt-password-reset" class="md-nav__link">
    KRBTGT password reset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-laps-to-manage-the-local-administrator-rid-500-password" class="md-nav__link">
    Use LAPS to manage the local Administrator (RID 500) password
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implement-managed-service-accounts" class="md-nav__link">
    Implement Managed Service Accounts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protected-lsa" class="md-nav__link">
    Protected LSA
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#protect-lsa-via-policy" class="md-nav__link">
    Protect LSA Via policy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protect-lsa-via-registry-entry" class="md-nav__link">
    Protect LSA Via Registry Entry
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#windows-logs" class="md-nav__link">
    Windows Logs
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#application-log" class="md-nav__link">
    Application log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-log" class="md-nav__link">
    Security log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-log" class="md-nav__link">
    Setup log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#system-log" class="md-nav__link">
    System log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#forwardedevents-log" class="md-nav__link">
    ForwardedEvents log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#applications-and-services-logs" class="md-nav__link">
    Applications and Services Logs
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#admin" class="md-nav__link">
    Admin
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operational" class="md-nav__link">
    Operational
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analytic" class="md-nav__link">
    Analytic
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debug" class="md-nav__link">
    Debug
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advanced-audit-policy-should-focus-on-these-in-no-specific-order" class="md-nav__link">
    Advanced Audit Policy should focus on these (in no specific order)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enable-command-line-logging-must-include-ms15-015-kb3031432" class="md-nav__link">
    Enable Command Line Logging (Must include MS15-015 KB3031432)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#account-honeytoken-manual" class="md-nav__link">
    Account HoneyToken (manual)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#account-honeytoken-network" class="md-nav__link">
    Account HoneyToken (network)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spn-honeytoken" class="md-nav__link">
    SPN HoneyToken
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershell-module-logging" class="md-nav__link">
    PowerShell Module Logging
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#log-parsing" class="md-nav__link">
    Log Parsing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parse-powershell-events-for-the-following-mimikatz-indicators" class="md-nav__link">
    Parse PowerShell events for the following Mimikatz indicators
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detecting-offensive-powershell-tools" class="md-nav__link">
    Detecting Offensive PowerShell Tools
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disable-windows-legacy-typically-unused-features" class="md-nav__link">
    Disable Windows Legacy &amp; Typically Unused Features
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#force-group-policy-to-reapply-settings-during-refresh" class="md-nav__link">
    Force Group Policy to reapply settings during "refresh"
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-unneeded-services" class="md-nav__link">
    Disable Unneeded Services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-net-session-enumeration-netcease" class="md-nav__link">
    Disable Net Session Enumeration (NetCease)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-wpad" class="md-nav__link">
    Disable WPAD
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-llmnr" class="md-nav__link">
    Disable LLMNR
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-wdigest" class="md-nav__link">
    Disable WDigest
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remove-the-use-of-ntlm-v1" class="md-nav__link">
    Remove the use of NTLM v1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consider-other-mitigations" class="md-nav__link">
    Consider other Mitigations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-security-back-port-patch-kb2871997" class="md-nav__link">
    Deploy security back-port patch (KB2871997)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prevent-local-administrator-accounts-from-authenticating-over-the-network" class="md-nav__link">
    Prevent local "administrator" accounts from authenticating over the network
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configure-through-group-policy" class="md-nav__link">
    Configure through Group Policy:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remote-connections" class="md-nav__link">
    Remote Connections
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rdp-restricted-admin-connect-to-only-1-resource" class="md-nav__link">
    RDP Restricted Admin (Connect to only 1 resource)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enable-restricted-admin-via-registry" class="md-nav__link">
    Enable Restricted Admin via Registry
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-restricted-admin-via-gpo" class="md-nav__link">
    Enable Restricted Admin via GPO
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rdp-windows-defender-remote-credential-guard-connect-to-multiple-resources" class="md-nav__link">
    RDP Windows Defender Remote Credential Guard (Connect to multiple resources)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enable-windows-defender-credential-guard-via-registry" class="md-nav__link">
    Enable Windows Defender Credential Guard via Registry
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-windef-cred-guard-via-gpo" class="md-nav__link">
    Enable WinDef Cred Guard via GPO
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#limit-client-to-client-communication-implement-and-configure-host-based-firewalls" class="md-nav__link">
    Limit Client-to-Client Communication (Implement and Configure Host Based Firewalls)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enable-firewall" class="md-nav__link">
    Enable Firewall
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blockcontrol-tcpudp-access-from-the-internal-network-and-dmz" class="md-nav__link">
    Block/control TCP/UDP access from the Internal network and DMZ
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#block-out-bound-tcpudp-access-from-the-client-systems-to-outbound-networks" class="md-nav__link">
    Block out bound TCP/UDP access from the Client systems to outbound networks.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implement-a-proxy-for-all-outbound-traffic" class="md-nav__link">
    Implement a Proxy for All Outbound Traffic
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-a-new-gpo-to-manage-the-proxy-settings" class="md-nav__link">
    Create a new GPO to manage the proxy settings
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configurations" class="md-nav__link">
    Configurations
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoruns" class="md-nav__link">
    AutoRuns
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#application-whiteblack-listing" class="md-nav__link">
    Application White/Black listing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#applocker" class="md-nav__link">
    Applocker
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#applocker-executable-path-restrictions" class="md-nav__link">
    AppLocker Executable Path Restrictions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#interesting-paths" class="md-nav__link">
    Interesting Paths
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#explicit-whitelisting" class="md-nav__link">
    Explicit Whitelisting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interesting-file-extensions" class="md-nav__link">
    Interesting file extensions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#manual-hunting-and-detection-examples" class="md-nav__link">
    Manual Hunting and Detection Examples
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#filtering-event-logs-via-powershell" class="md-nav__link">
    Filtering Event Logs via PowerShell
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#log-locations-on-disk-only-use-event-viewer-or-cli-to-copy" class="md-nav__link">
    Log locations on disk (only use event viewer or cli to copy)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-times-service-was-installed-all-evtx-files-should-be-system-and-count" class="md-nav__link">
    Get times Service was installed (all evtx files, should be system) and count
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-blocked-events" class="md-nav__link">
    Get blocked events
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-windowsdefender-actions" class="md-nav__link">
    Get WindowsDefender actions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-windowsdefender-detections" class="md-nav__link">
    Get WindowsDefender detections
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-files-by-extension-with-search-from-application-crash" class="md-nav__link">
    Get files (by extension) with search from Application (crash)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-emet-events" class="md-nav__link">
    Get EMET events
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-service-installs-and-errors" class="md-nav__link">
    Get service installs and errors
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-for-usb-loading" class="md-nav__link">
    Search for USB loading
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-for-errorwarninginfo" class="md-nav__link">
    Search for error/warning/info
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-remote-eventlog-caution-this-drops-credentials-onto-remote-system" class="md-nav__link">
    Get remote eventlog (caution this drops credentials onto remote system)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-log-within-x-hours" class="md-nav__link">
    Get log within X hours
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-logs-during-downtime" class="md-nav__link">
    Get logs during "downtime"
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-wevtutil-to-export-logs-export-log" class="md-nav__link">
    Use wevtutil to export logs (export-log)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-wevutil-to-get-last-20-startups-use-rcomputer-for-remote-and-qe-for-short-query" class="md-nav__link">
    Use wevutil to get last 20 startups (use /r:computer for remote and qe for short query)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows-consolidated-logging" class="md-nav__link">
    Windows consolidated logging
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-a-detailed-list-of-all-security-auditing-event-entries-use-an-elevated-prompt" class="md-nav__link">
    Get a detailed list of all security-auditing event entries (use an elevated prompt)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#return-a-list-of-all-security-auditing-categories-and-subcategories-use-an-elevated-prompt" class="md-nav__link">
    Return a list of all security-auditing categories and subcategories (use an elevated prompt)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#network" class="md-nav__link">
    Network
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#network-flow-basics" class="md-nav__link">
    Network Flow Basics:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#basic-pcap-carving-nix" class="md-nav__link">
    Basic PCAP Carving (*nix)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-certificates-from-pcap-use-bro-if-possible" class="md-nav__link">
    Get certificates from pcap (use BRO if possible)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-certificates-see-bro" class="md-nav__link">
    View certificates (see BRO)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-dns-queries-from-pcap-and-count-instances" class="md-nav__link">
    Get DNS queries from pcap and count instances
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-dns-queries-from-nx-domain" class="md-nav__link">
    Get DNS queries from NX domain
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dns-response-codes" class="md-nav__link">
    DNS Response Codes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-user-agents-from-pcap" class="md-nav__link">
    Get User-Agents from pcap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-info-for-frame-containing-search-dataf" class="md-nav__link">
    Get info for frame containing search dataf
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-for-string-in-tcp-data-finds-data-not-in-field-ie-ua-in-json" class="md-nav__link">
    Search for string in tcp data (finds data not in field i.e. UA in json)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#find-strings-in-pcap" class="md-nav__link">
    Find strings in pcap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-the-frame-that-contains-string" class="md-nav__link">
    Get the frame that contains string
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#show-packet-data-by-field" class="md-nav__link">
    Show packet data by field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-data-hex-from-first-two-packets-in-pcap" class="md-nav__link">
    Get data &amp; hex from first two packets in pcap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frames-that-have-tcp-header-length-gt-20-and-port-25" class="md-nav__link">
    Get frames that have tcp header length gt 20 and port 25
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-data-in-frames-that-have-tcp-header-length-gt-20-and-port-25" class="md-nav__link">
    Get data in frames that have tcp header length gt 20 and port 25
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frames-with-hex-data-0x7932" class="md-nav__link">
    Get frames with hex data 0x7932
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frames-and-show-hex-data" class="md-nav__link">
    Get frames and show hex data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-all-arp-request-and-count-request1-reply2" class="md-nav__link">
    Get all arp request and count (request=1, reply=2)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-iplen-less-than-46-64-for-ethernet-minus-14-header-and-4-trailer-icmp-of-0" class="md-nav__link">
    Get ip.len less than 46 (64 for ethernet minus 14 header and 4 trailer) &amp; icmp of 0
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-ip-option-of-loose-src-routing-with-offset-starting-at-ip-options" class="md-nav__link">
    Get ip option of loose src routing with offset starting at ip options
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filter-info" class="md-nav__link">
    Filter Info
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frame-with-ip-src-and-ack-flag-set" class="md-nav__link">
    Get frame with IP src and ACK flag set
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frame-with-ip-src-and-ack-or-rst-flag-set" class="md-nav__link">
    Get frame with IP src and ACK or RST flag set
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frame-with-dst-port-0-and-df-flag-set" class="md-nav__link">
    Get frame with dst port 0 and DF flag set
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frame-with-net-1010101024" class="md-nav__link">
    Get frame with net 10.10.10.10/24
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frames-by-ip" class="md-nav__link">
    Get frames by ip
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-specific-frame-verbose-note-tcp-stream-index-number" class="md-nav__link">
    View specific frame verbose (note tcp stream index number)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#follow-tcp-stream-0-ascii-raw-hex" class="md-nav__link">
    Follow tcp stream 0 (ascii, raw, hex)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flow-data-analysis" class="md-nav__link">
    Flow Data Analysis
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-rwfilter-to-analyze-flow-data-by-ip-and-port" class="md-nav__link">
    Use rwfilter to analyze flow data by IP and port
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-detail-of-flow-data-by-ip-and-port" class="md-nav__link">
    View detail of flow data by IP and port
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-all-udp-from-flow-then-pipe-to-get-field-4-4dst-port-3srcport-5proto-6packets-etc" class="md-nav__link">
    Extract all UDP from flow then pipe to get field 4 (4=dst port, 3=srcport, 5=proto, 6=packets, etc)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-connections-from-108-with-a-reset-to-close-then-pipe-to-get-srcip-count" class="md-nav__link">
    Extract connections from 10/8 with a reset to close then pipe to get srcIP count
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-rwstats-to-get-flow-data-of-top-5-flows" class="md-nav__link">
    Use rwstats to get flow data of top 5 flows
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-records-not-icmp-tcp-or-udp-note-fail-and-have-src-ip-of-1010101" class="md-nav__link">
    Extract records not ICMP, TCP or UDP (note fail) and have src IP of 10.10.10.1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-top-5-ip-with-data-transfer" class="md-nav__link">
    Get top 5 IP with data transfer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-flows-with-larger-than-100000-bytes" class="md-nav__link">
    Get flows with larger than 100,000 bytes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-queries" class="md-nav__link">
    ELSA (BRO queries)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#elsa-most-common-svc" class="md-nav__link">
    ELSA most common svc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-nx-domains" class="md-nav__link">
    ELSA BRO nx domains
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-common-fqdn" class="md-nav__link">
    ELSA BRO common FQDN
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-sites-hosting-exe" class="md-nav__link">
    ELSA BRO Sites hosting EXE
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-uri-with-exe-downloads" class="md-nav__link">
    ELSA BRO URI with EXE downloads
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-internal-ip-exe-download" class="md-nav__link">
    ELSA BRO Internal IP EXE download
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-connections-wo-ua-group-by-source-ip" class="md-nav__link">
    ELSA BRO connections w/o UA group by source IP
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro" class="md-nav__link">
    BRO
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bro-logs" class="md-nav__link">
    BRO Logs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-log-hunting" class="md-nav__link">
    BRO Log Hunting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-protocol-logs" class="md-nav__link">
    BRO Protocol Logs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-carving" class="md-nav__link">
    BRO Carving
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#read-and-output-bro-logs" class="md-nav__link">
    Read and output bro logs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-source-src-ip-dst-ip-dst-port-and-bytes-in-that-order" class="md-nav__link">
    Get source src ip, dst ip, dst port, and bytes (in that order)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#same-as-above-but-sort-by-bytes-field-5-reverse-by-number" class="md-nav__link">
    Same as above but sort by bytes (field 5 reverse by number)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-http-on-non-standard-ports-ssl" class="md-nav__link">
    Get http on non-standard ports (ssl?)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-dns-info-from-bro-logs" class="md-nav__link">
    Extract DNS info from bro logs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-user-agents" class="md-nav__link">
    Get User-Agents
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-mime-types" class="md-nav__link">
    Get Mime Types
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-bro-outbound-signature-stored-in-sig-file-read-with-s" class="md-nav__link">
    Get bro outbound signature stored in .sig file (read with -s)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-bro-windows-shell-signature-stored-in-sig-file-read-with-s" class="md-nav__link">
    Get bro Windows Shell signature stored in .sig file (read with -s)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-bro-with-sig-file" class="md-nav__link">
    Run bro with sig file
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-dst-addresses-in-signature-file" class="md-nav__link">
    View dst addresses in signature file
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-event-script-to-find-user-agent-outboundbro" class="md-nav__link">
    BRO event script to find User-Agent (outbound.bro)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-event-file-to-view-user-agent" class="md-nav__link">
    Run event file to view user-agent
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-extract-common-files-from-pcap" class="md-nav__link">
    BRO extract common files from pcap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-ssl-info" class="md-nav__link">
    Extract ssl info
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-extract-unique-ssl-certificate-data" class="md-nav__link">
    BRO extract unique SSL certificate data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-extract-ssl-issuer-data-from-certificate-extraction" class="md-nav__link">
    BRO extract SSL issuer data from certificate extraction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-show-shortest-issuer-from-extraction" class="md-nav__link">
    BRO show shortest issuer from extraction
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modsecurity-rules" class="md-nav__link">
    ModSecurity rules
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#errorlog-ua-not-starting-with-mozilla" class="md-nav__link">
    error.log UA not starting with Mozilla
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-visiting-ip-url" class="md-nav__link">
    error.log visiting IP URL
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-blank-ua" class="md-nav__link">
    error.log blank UA
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-ua-starting-with-mozilla" class="md-nav__link">
    error.log UA starting with mozilla
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-visiting-by-ip-log-ua-used" class="md-nav__link">
    error.log visiting by IP log UA used
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-no-ua-not-blank-but-none" class="md-nav__link">
    error.log no UA (not blank but none)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-note-param-entry" class="md-nav__link">
    error.log note param entry
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-trigger-on-keyword-can-use-pattern" class="md-nav__link">
    error.log trigger on keyword (can use pattern)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#splunk" class="md-nav__link">
    Splunk
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#new-unauthorized-service" class="md-nav__link">
    New unauthorized service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detecting-process-abuse" class="md-nav__link">
    Detecting process abuse
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detecting-process-abuse-simplified-requires-one-entry-per-process" class="md-nav__link">
    Detecting process abuse (simplified, requires one entry per process)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#process-starts-and-connects-to-ip" class="md-nav__link">
    Process starts and connects to IP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-smb-traffic-between-clients" class="md-nav__link">
    Detect SMB traffic between clients
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-named-pipes" class="md-nav__link">
    Detect Named Pipes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-wmi" class="md-nav__link">
    Detect WMI
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-powershell-commands" class="md-nav__link">
    Detect PowerShell Commands
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#alert-on-remote-files-copied-via-cmd-line" class="md-nav__link">
    Alert on remote files copied via cmd line
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alert-on-c-or-admin-share-enumeration" class="md-nav__link">
    Alert on C or Admin share enumeration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-for-file-delivery" class="md-nav__link">
    Search for file delivery
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-for-registry-run-or-runonce-keys" class="md-nav__link">
    Search for Registry Run (or RunOnce) Keys
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-for-file-system-persistence" class="md-nav__link">
    Search for file system persistence
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-credential-harvesting" class="md-nav__link">
    Detect credential harvesting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#potential-privilege-escalation" class="md-nav__link">
    Potential Privilege Escalation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#potential-beaconing-detection" class="md-nav__link">
    Potential Beaconing Detection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-webshell-activity-note-this-should-be-updated-at-implementation-and-often" class="md-nav__link">
    Detect webshell activity (note this should be updated at implementation and often)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-potential-sqli" class="md-nav__link">
    Detect potential SQLi
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-http-post-with-response" class="md-nav__link">
    View HTTP POST with response
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#find-weird-user-agents" class="md-nav__link">
    Find Weird User-Agents
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-high-severity-epo-events" class="md-nav__link">
    Get high severity EPO events
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snort" class="md-nav__link">
    Snort
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#detect-psexec" class="md-nav__link">
    Detect psexec
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-packets-with-with-port-4444-port-0" class="md-nav__link">
    Detect packets with with port 4444 (port 0?)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snort-appid-list" class="md-nav__link">
    Snort appid list
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interesting-file-extensions-note-this-is-the-same-list-as-above-placed-here-for-use-in-monitoring-via-snort" class="md-nav__link">
    Interesting file extensions (Note this is the same list as above, placed here for use in monitoring via Snort)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#additional-useful-info" class="md-nav__link">
    Additional Useful Info
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-methods-from-accesslog" class="md-nav__link">
    Get methods from access.log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decode-encoded-url-line-290" class="md-nav__link">
    Decode %encoded url (line 290)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gather-information-on-windows-host" class="md-nav__link">
    Gather Information on Windows host
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#list-task-services" class="md-nav__link">
    List task services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#show-modules-for-task" class="md-nav__link">
    Show modules for task
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verbose-task-information" class="md-nav__link">
    Verbose task information
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-information-about-processes" class="md-nav__link">
    Get information about processes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#look-for-code-injected-into-memory" class="md-nav__link">
    Look for code injected into memory
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../automating-cobalt-strike-profiles-apache-mod_rewrite-htaccess-files-intelligent-c2-redirection/" title="Automating Cobalt Strike Profiles Apache mod_rewrite htaccess Files for Intelligent C2 Redirection" class="md-nav__link">
      Automating Cobalt Strike Profiles Apache mod_rewrite htaccess Files for Intelligent C2 Redirection
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../threat-mitigation-strategies-observations-recommendations/" title="Threat Mitagation Strategies - Part 1" class="md-nav__link">
      Threat Mitagation Strategies - Part 1
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../hostenum-updates-usage/" title="HostEnum - Updates and Usage Guide" class="md-nav__link">
      HostEnum - Updates and Usage Guide
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4" type="checkbox" id="nav-3-4">
    
    <label class="md-nav__link" for="nav-3-4">
      2017
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-4">
        2017
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../2017/metatwin-borrowing-microsoft-metadata-and-digital-signatures-to-hide-binaries/" title="Borrowing Microsoft MetaData and Signatures to Hide Binary Payloads" class="md-nav__link">
      Borrowing Microsoft MetaData and Signatures to Hide Binary Payloads
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../2017/install-bloodhound-ubuntu/" title="Install BloodHound on Ubuntu" class="md-nav__link">
      Install BloodHound on Ubuntu
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../2017/empire-modifying-server-c2-indicators/" title="Empire Modifying Server C2 Indicators" class="md-nav__link">
      Empire Modifying Server C2 Indicators
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../2017/invoke-hostenum/" title="Invoke-Hostenum" class="md-nav__link">
      Invoke-Hostenum
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../2017/leveraging-expired-domains-for-red-team-engagements/" title="Leveraging Expired Domains for Red Team Engagements" class="md-nav__link">
      Leveraging Expired Domains for Red Team Engagements
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5" type="checkbox" id="nav-3-5">
    
    <label class="md-nav__link" for="nav-3-5">
      2016
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-5">
        2016
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../2016/slack-notifications-for-cobalt-strike/" title="Slack Notifications for Cobalt Strike" class="md-nav__link">
      Slack Notifications for Cobalt Strike
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../2016/web-shells-covert-channel/" title="SubShell and TinyShell - Custom Covert Webshells" class="md-nav__link">
      SubShell and TinyShell - Custom Covert Webshells
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../2016/new-information-security-red-teaming-blog-threat-express-minis/" title="New Information Security and Red Teaming Blog Threat Express by MINIS" class="md-nav__link">
      New Information Security and Red Teaming Blog Threat Express by MINIS
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Red Teaming
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Red Teaming
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../redteaming/redteaming/" title="What is Red Teaming" class="md-nav__link">
      What is Red Teaming
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../redteaming/red_vs_pen_vs_vuln/" title="Red vs Pen vs Vuln" class="md-nav__link">
      Red vs Pen vs Vuln
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../redteaming/rolesandrelationships/" title="Roles and Relationships" class="md-nav__link">
      Roles and Relationships
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../redteaming/mitre_attack/" title="Red Teaming and MITRE ATT&CK" class="md-nav__link">
      Red Teaming and MITRE ATT&CK
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../redteaming/definitions/" title="Definitions" class="md-nav__link">
      Definitions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-6" type="checkbox" id="nav-4-6">
    
    <label class="md-nav__link" for="nav-4-6">
      Red Team Planning
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-6">
        Red Team Planning
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../redteaming/redteamplanning/goalplanning/" title="Goal Planing" class="md-nav__link">
      Goal Planing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../redteaming/redteamplanning/redteamchecklist/" title="Red Team Checklist" class="md-nav__link">
      Red Team Checklist
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../redteaming/redteamplanning/roeguide/" title="Red Team ROE Guide" class="md-nav__link">
      Red Team ROE Guide
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../redteaming/redteamplanning/tradecraft/" title="Tradecraft Guidance" class="md-nav__link">
      Tradecraft Guidance
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-7" type="checkbox" id="nav-4-7">
    
    <label class="md-nav__link" for="nav-4-7">
      Red Team IOCs
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-7">
        Red Team IOCs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../redteaming/tool_ioc/tinyshell_ioc/" title="TinyShell IOCs" class="md-nav__link">
      TinyShell IOCs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../redteaming/tool_ioc/psexec/" title="PSEXEC IOCs" class="md-nav__link">
      PSEXEC IOCs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://jpcertcc.github.io/ToolAnalysisResultSheet/" title="JPCert IOCs" class="md-nav__link">
      JPCert IOCs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://digital-forensics.sans.org/media/SANS_Poster_2018_Hunt_Evil_FINAL.pdf" title="SANS Hunt Evil" class="md-nav__link">
      SANS Hunt Evil
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-8" type="checkbox" id="nav-4-8">
    
    <label class="md-nav__link" for="nav-4-8">
      Red Team Resources
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-8">
        Red Team Resources
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../redteaming/cheatsheets/" title="Cheatsheets" class="md-nav__link">
      Cheatsheets
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../redteaming/resources/" title="General Resources" class="md-nav__link">
      General Resources
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../redteaming/windowsactivedirectory/" title="Attack Active Directory" class="md-nav__link">
      Attack Active Directory
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../redteaming/videos/videos/" title="Red Team Videos" class="md-nav__link">
      Red Team Videos
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../archive/" title="Post Archive" class="md-nav__link">
      Post Archive
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../contributors/" title="Contributors" class="md-nav__link">
      Contributors
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#account-management" class="md-nav__link">
    Account Management
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adjust-password-policy" class="md-nav__link">
    Adjust Password Policy
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setting-the-password-policy-using-gpo" class="md-nav__link">
    Setting the Password Policy using GPO
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#krbtgt-password-reset" class="md-nav__link">
    KRBTGT password reset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-laps-to-manage-the-local-administrator-rid-500-password" class="md-nav__link">
    Use LAPS to manage the local Administrator (RID 500) password
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implement-managed-service-accounts" class="md-nav__link">
    Implement Managed Service Accounts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protected-lsa" class="md-nav__link">
    Protected LSA
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#protect-lsa-via-policy" class="md-nav__link">
    Protect LSA Via policy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protect-lsa-via-registry-entry" class="md-nav__link">
    Protect LSA Via Registry Entry
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#windows-logs" class="md-nav__link">
    Windows Logs
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#application-log" class="md-nav__link">
    Application log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-log" class="md-nav__link">
    Security log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-log" class="md-nav__link">
    Setup log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#system-log" class="md-nav__link">
    System log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#forwardedevents-log" class="md-nav__link">
    ForwardedEvents log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#applications-and-services-logs" class="md-nav__link">
    Applications and Services Logs
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#admin" class="md-nav__link">
    Admin
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operational" class="md-nav__link">
    Operational
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analytic" class="md-nav__link">
    Analytic
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debug" class="md-nav__link">
    Debug
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advanced-audit-policy-should-focus-on-these-in-no-specific-order" class="md-nav__link">
    Advanced Audit Policy should focus on these (in no specific order)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enable-command-line-logging-must-include-ms15-015-kb3031432" class="md-nav__link">
    Enable Command Line Logging (Must include MS15-015 KB3031432)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#account-honeytoken-manual" class="md-nav__link">
    Account HoneyToken (manual)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#account-honeytoken-network" class="md-nav__link">
    Account HoneyToken (network)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spn-honeytoken" class="md-nav__link">
    SPN HoneyToken
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershell-module-logging" class="md-nav__link">
    PowerShell Module Logging
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#log-parsing" class="md-nav__link">
    Log Parsing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parse-powershell-events-for-the-following-mimikatz-indicators" class="md-nav__link">
    Parse PowerShell events for the following Mimikatz indicators
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detecting-offensive-powershell-tools" class="md-nav__link">
    Detecting Offensive PowerShell Tools
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disable-windows-legacy-typically-unused-features" class="md-nav__link">
    Disable Windows Legacy &amp; Typically Unused Features
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#force-group-policy-to-reapply-settings-during-refresh" class="md-nav__link">
    Force Group Policy to reapply settings during "refresh"
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-unneeded-services" class="md-nav__link">
    Disable Unneeded Services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-net-session-enumeration-netcease" class="md-nav__link">
    Disable Net Session Enumeration (NetCease)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-wpad" class="md-nav__link">
    Disable WPAD
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-llmnr" class="md-nav__link">
    Disable LLMNR
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-wdigest" class="md-nav__link">
    Disable WDigest
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remove-the-use-of-ntlm-v1" class="md-nav__link">
    Remove the use of NTLM v1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consider-other-mitigations" class="md-nav__link">
    Consider other Mitigations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-security-back-port-patch-kb2871997" class="md-nav__link">
    Deploy security back-port patch (KB2871997)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prevent-local-administrator-accounts-from-authenticating-over-the-network" class="md-nav__link">
    Prevent local "administrator" accounts from authenticating over the network
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configure-through-group-policy" class="md-nav__link">
    Configure through Group Policy:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remote-connections" class="md-nav__link">
    Remote Connections
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rdp-restricted-admin-connect-to-only-1-resource" class="md-nav__link">
    RDP Restricted Admin (Connect to only 1 resource)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enable-restricted-admin-via-registry" class="md-nav__link">
    Enable Restricted Admin via Registry
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-restricted-admin-via-gpo" class="md-nav__link">
    Enable Restricted Admin via GPO
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rdp-windows-defender-remote-credential-guard-connect-to-multiple-resources" class="md-nav__link">
    RDP Windows Defender Remote Credential Guard (Connect to multiple resources)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enable-windows-defender-credential-guard-via-registry" class="md-nav__link">
    Enable Windows Defender Credential Guard via Registry
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-windef-cred-guard-via-gpo" class="md-nav__link">
    Enable WinDef Cred Guard via GPO
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#limit-client-to-client-communication-implement-and-configure-host-based-firewalls" class="md-nav__link">
    Limit Client-to-Client Communication (Implement and Configure Host Based Firewalls)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enable-firewall" class="md-nav__link">
    Enable Firewall
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blockcontrol-tcpudp-access-from-the-internal-network-and-dmz" class="md-nav__link">
    Block/control TCP/UDP access from the Internal network and DMZ
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#block-out-bound-tcpudp-access-from-the-client-systems-to-outbound-networks" class="md-nav__link">
    Block out bound TCP/UDP access from the Client systems to outbound networks.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implement-a-proxy-for-all-outbound-traffic" class="md-nav__link">
    Implement a Proxy for All Outbound Traffic
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-a-new-gpo-to-manage-the-proxy-settings" class="md-nav__link">
    Create a new GPO to manage the proxy settings
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configurations" class="md-nav__link">
    Configurations
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoruns" class="md-nav__link">
    AutoRuns
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#application-whiteblack-listing" class="md-nav__link">
    Application White/Black listing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#applocker" class="md-nav__link">
    Applocker
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#applocker-executable-path-restrictions" class="md-nav__link">
    AppLocker Executable Path Restrictions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#interesting-paths" class="md-nav__link">
    Interesting Paths
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#explicit-whitelisting" class="md-nav__link">
    Explicit Whitelisting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interesting-file-extensions" class="md-nav__link">
    Interesting file extensions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#manual-hunting-and-detection-examples" class="md-nav__link">
    Manual Hunting and Detection Examples
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#filtering-event-logs-via-powershell" class="md-nav__link">
    Filtering Event Logs via PowerShell
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#log-locations-on-disk-only-use-event-viewer-or-cli-to-copy" class="md-nav__link">
    Log locations on disk (only use event viewer or cli to copy)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-times-service-was-installed-all-evtx-files-should-be-system-and-count" class="md-nav__link">
    Get times Service was installed (all evtx files, should be system) and count
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-blocked-events" class="md-nav__link">
    Get blocked events
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-windowsdefender-actions" class="md-nav__link">
    Get WindowsDefender actions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-windowsdefender-detections" class="md-nav__link">
    Get WindowsDefender detections
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-files-by-extension-with-search-from-application-crash" class="md-nav__link">
    Get files (by extension) with search from Application (crash)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-emet-events" class="md-nav__link">
    Get EMET events
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-service-installs-and-errors" class="md-nav__link">
    Get service installs and errors
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-for-usb-loading" class="md-nav__link">
    Search for USB loading
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-for-errorwarninginfo" class="md-nav__link">
    Search for error/warning/info
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-remote-eventlog-caution-this-drops-credentials-onto-remote-system" class="md-nav__link">
    Get remote eventlog (caution this drops credentials onto remote system)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-log-within-x-hours" class="md-nav__link">
    Get log within X hours
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-logs-during-downtime" class="md-nav__link">
    Get logs during "downtime"
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-wevtutil-to-export-logs-export-log" class="md-nav__link">
    Use wevtutil to export logs (export-log)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-wevutil-to-get-last-20-startups-use-rcomputer-for-remote-and-qe-for-short-query" class="md-nav__link">
    Use wevutil to get last 20 startups (use /r:computer for remote and qe for short query)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows-consolidated-logging" class="md-nav__link">
    Windows consolidated logging
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-a-detailed-list-of-all-security-auditing-event-entries-use-an-elevated-prompt" class="md-nav__link">
    Get a detailed list of all security-auditing event entries (use an elevated prompt)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#return-a-list-of-all-security-auditing-categories-and-subcategories-use-an-elevated-prompt" class="md-nav__link">
    Return a list of all security-auditing categories and subcategories (use an elevated prompt)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#network" class="md-nav__link">
    Network
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#network-flow-basics" class="md-nav__link">
    Network Flow Basics:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#basic-pcap-carving-nix" class="md-nav__link">
    Basic PCAP Carving (*nix)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-certificates-from-pcap-use-bro-if-possible" class="md-nav__link">
    Get certificates from pcap (use BRO if possible)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-certificates-see-bro" class="md-nav__link">
    View certificates (see BRO)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-dns-queries-from-pcap-and-count-instances" class="md-nav__link">
    Get DNS queries from pcap and count instances
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-dns-queries-from-nx-domain" class="md-nav__link">
    Get DNS queries from NX domain
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dns-response-codes" class="md-nav__link">
    DNS Response Codes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-user-agents-from-pcap" class="md-nav__link">
    Get User-Agents from pcap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-info-for-frame-containing-search-dataf" class="md-nav__link">
    Get info for frame containing search dataf
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-for-string-in-tcp-data-finds-data-not-in-field-ie-ua-in-json" class="md-nav__link">
    Search for string in tcp data (finds data not in field i.e. UA in json)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#find-strings-in-pcap" class="md-nav__link">
    Find strings in pcap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-the-frame-that-contains-string" class="md-nav__link">
    Get the frame that contains string
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#show-packet-data-by-field" class="md-nav__link">
    Show packet data by field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-data-hex-from-first-two-packets-in-pcap" class="md-nav__link">
    Get data &amp; hex from first two packets in pcap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frames-that-have-tcp-header-length-gt-20-and-port-25" class="md-nav__link">
    Get frames that have tcp header length gt 20 and port 25
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-data-in-frames-that-have-tcp-header-length-gt-20-and-port-25" class="md-nav__link">
    Get data in frames that have tcp header length gt 20 and port 25
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frames-with-hex-data-0x7932" class="md-nav__link">
    Get frames with hex data 0x7932
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frames-and-show-hex-data" class="md-nav__link">
    Get frames and show hex data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-all-arp-request-and-count-request1-reply2" class="md-nav__link">
    Get all arp request and count (request=1, reply=2)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-iplen-less-than-46-64-for-ethernet-minus-14-header-and-4-trailer-icmp-of-0" class="md-nav__link">
    Get ip.len less than 46 (64 for ethernet minus 14 header and 4 trailer) &amp; icmp of 0
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-ip-option-of-loose-src-routing-with-offset-starting-at-ip-options" class="md-nav__link">
    Get ip option of loose src routing with offset starting at ip options
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filter-info" class="md-nav__link">
    Filter Info
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frame-with-ip-src-and-ack-flag-set" class="md-nav__link">
    Get frame with IP src and ACK flag set
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frame-with-ip-src-and-ack-or-rst-flag-set" class="md-nav__link">
    Get frame with IP src and ACK or RST flag set
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frame-with-dst-port-0-and-df-flag-set" class="md-nav__link">
    Get frame with dst port 0 and DF flag set
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frame-with-net-1010101024" class="md-nav__link">
    Get frame with net 10.10.10.10/24
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frames-by-ip" class="md-nav__link">
    Get frames by ip
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-specific-frame-verbose-note-tcp-stream-index-number" class="md-nav__link">
    View specific frame verbose (note tcp stream index number)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#follow-tcp-stream-0-ascii-raw-hex" class="md-nav__link">
    Follow tcp stream 0 (ascii, raw, hex)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flow-data-analysis" class="md-nav__link">
    Flow Data Analysis
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-rwfilter-to-analyze-flow-data-by-ip-and-port" class="md-nav__link">
    Use rwfilter to analyze flow data by IP and port
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-detail-of-flow-data-by-ip-and-port" class="md-nav__link">
    View detail of flow data by IP and port
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-all-udp-from-flow-then-pipe-to-get-field-4-4dst-port-3srcport-5proto-6packets-etc" class="md-nav__link">
    Extract all UDP from flow then pipe to get field 4 (4=dst port, 3=srcport, 5=proto, 6=packets, etc)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-connections-from-108-with-a-reset-to-close-then-pipe-to-get-srcip-count" class="md-nav__link">
    Extract connections from 10/8 with a reset to close then pipe to get srcIP count
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-rwstats-to-get-flow-data-of-top-5-flows" class="md-nav__link">
    Use rwstats to get flow data of top 5 flows
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-records-not-icmp-tcp-or-udp-note-fail-and-have-src-ip-of-1010101" class="md-nav__link">
    Extract records not ICMP, TCP or UDP (note fail) and have src IP of 10.10.10.1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-top-5-ip-with-data-transfer" class="md-nav__link">
    Get top 5 IP with data transfer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-flows-with-larger-than-100000-bytes" class="md-nav__link">
    Get flows with larger than 100,000 bytes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-queries" class="md-nav__link">
    ELSA (BRO queries)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#elsa-most-common-svc" class="md-nav__link">
    ELSA most common svc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-nx-domains" class="md-nav__link">
    ELSA BRO nx domains
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-common-fqdn" class="md-nav__link">
    ELSA BRO common FQDN
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-sites-hosting-exe" class="md-nav__link">
    ELSA BRO Sites hosting EXE
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-uri-with-exe-downloads" class="md-nav__link">
    ELSA BRO URI with EXE downloads
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-internal-ip-exe-download" class="md-nav__link">
    ELSA BRO Internal IP EXE download
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-connections-wo-ua-group-by-source-ip" class="md-nav__link">
    ELSA BRO connections w/o UA group by source IP
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro" class="md-nav__link">
    BRO
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bro-logs" class="md-nav__link">
    BRO Logs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-log-hunting" class="md-nav__link">
    BRO Log Hunting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-protocol-logs" class="md-nav__link">
    BRO Protocol Logs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-carving" class="md-nav__link">
    BRO Carving
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#read-and-output-bro-logs" class="md-nav__link">
    Read and output bro logs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-source-src-ip-dst-ip-dst-port-and-bytes-in-that-order" class="md-nav__link">
    Get source src ip, dst ip, dst port, and bytes (in that order)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#same-as-above-but-sort-by-bytes-field-5-reverse-by-number" class="md-nav__link">
    Same as above but sort by bytes (field 5 reverse by number)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-http-on-non-standard-ports-ssl" class="md-nav__link">
    Get http on non-standard ports (ssl?)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-dns-info-from-bro-logs" class="md-nav__link">
    Extract DNS info from bro logs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-user-agents" class="md-nav__link">
    Get User-Agents
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-mime-types" class="md-nav__link">
    Get Mime Types
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-bro-outbound-signature-stored-in-sig-file-read-with-s" class="md-nav__link">
    Get bro outbound signature stored in .sig file (read with -s)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-bro-windows-shell-signature-stored-in-sig-file-read-with-s" class="md-nav__link">
    Get bro Windows Shell signature stored in .sig file (read with -s)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-bro-with-sig-file" class="md-nav__link">
    Run bro with sig file
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-dst-addresses-in-signature-file" class="md-nav__link">
    View dst addresses in signature file
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-event-script-to-find-user-agent-outboundbro" class="md-nav__link">
    BRO event script to find User-Agent (outbound.bro)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-event-file-to-view-user-agent" class="md-nav__link">
    Run event file to view user-agent
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-extract-common-files-from-pcap" class="md-nav__link">
    BRO extract common files from pcap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-ssl-info" class="md-nav__link">
    Extract ssl info
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-extract-unique-ssl-certificate-data" class="md-nav__link">
    BRO extract unique SSL certificate data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-extract-ssl-issuer-data-from-certificate-extraction" class="md-nav__link">
    BRO extract SSL issuer data from certificate extraction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-show-shortest-issuer-from-extraction" class="md-nav__link">
    BRO show shortest issuer from extraction
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modsecurity-rules" class="md-nav__link">
    ModSecurity rules
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#errorlog-ua-not-starting-with-mozilla" class="md-nav__link">
    error.log UA not starting with Mozilla
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-visiting-ip-url" class="md-nav__link">
    error.log visiting IP URL
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-blank-ua" class="md-nav__link">
    error.log blank UA
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-ua-starting-with-mozilla" class="md-nav__link">
    error.log UA starting with mozilla
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-visiting-by-ip-log-ua-used" class="md-nav__link">
    error.log visiting by IP log UA used
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-no-ua-not-blank-but-none" class="md-nav__link">
    error.log no UA (not blank but none)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-note-param-entry" class="md-nav__link">
    error.log note param entry
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-trigger-on-keyword-can-use-pattern" class="md-nav__link">
    error.log trigger on keyword (can use pattern)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#splunk" class="md-nav__link">
    Splunk
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#new-unauthorized-service" class="md-nav__link">
    New unauthorized service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detecting-process-abuse" class="md-nav__link">
    Detecting process abuse
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detecting-process-abuse-simplified-requires-one-entry-per-process" class="md-nav__link">
    Detecting process abuse (simplified, requires one entry per process)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#process-starts-and-connects-to-ip" class="md-nav__link">
    Process starts and connects to IP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-smb-traffic-between-clients" class="md-nav__link">
    Detect SMB traffic between clients
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-named-pipes" class="md-nav__link">
    Detect Named Pipes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-wmi" class="md-nav__link">
    Detect WMI
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-powershell-commands" class="md-nav__link">
    Detect PowerShell Commands
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#alert-on-remote-files-copied-via-cmd-line" class="md-nav__link">
    Alert on remote files copied via cmd line
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alert-on-c-or-admin-share-enumeration" class="md-nav__link">
    Alert on C or Admin share enumeration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-for-file-delivery" class="md-nav__link">
    Search for file delivery
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-for-registry-run-or-runonce-keys" class="md-nav__link">
    Search for Registry Run (or RunOnce) Keys
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-for-file-system-persistence" class="md-nav__link">
    Search for file system persistence
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-credential-harvesting" class="md-nav__link">
    Detect credential harvesting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#potential-privilege-escalation" class="md-nav__link">
    Potential Privilege Escalation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#potential-beaconing-detection" class="md-nav__link">
    Potential Beaconing Detection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-webshell-activity-note-this-should-be-updated-at-implementation-and-often" class="md-nav__link">
    Detect webshell activity (note this should be updated at implementation and often)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-potential-sqli" class="md-nav__link">
    Detect potential SQLi
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-http-post-with-response" class="md-nav__link">
    View HTTP POST with response
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#find-weird-user-agents" class="md-nav__link">
    Find Weird User-Agents
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-high-severity-epo-events" class="md-nav__link">
    Get high severity EPO events
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snort" class="md-nav__link">
    Snort
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#detect-psexec" class="md-nav__link">
    Detect psexec
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-packets-with-with-port-4444-port-0" class="md-nav__link">
    Detect packets with with port 4444 (port 0?)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snort-appid-list" class="md-nav__link">
    Snort appid list
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interesting-file-extensions-note-this-is-the-same-list-as-above-placed-here-for-use-in-monitoring-via-snort" class="md-nav__link">
    Interesting file extensions (Note this is the same list as above, placed here for use in monitoring via Snort)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#additional-useful-info" class="md-nav__link">
    Additional Useful Info
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-methods-from-accesslog" class="md-nav__link">
    Get methods from access.log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decode-encoded-url-line-290" class="md-nav__link">
    Decode %encoded url (line 290)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gather-information-on-windows-host" class="md-nav__link">
    Gather Information on Windows host
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#list-task-services" class="md-nav__link">
    List task services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#show-modules-for-task" class="md-nav__link">
    Show modules for task
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verbose-task-information" class="md-nav__link">
    Verbose task information
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-information-about-processes" class="md-nav__link">
    Get information about processes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#look-for-code-injected-into-memory" class="md-nav__link">
    Look for code injected into memory
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/threatexpress/edit/master/docs/blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="threat-mitigation-strategies-part-2">Threat Mitigation Strategies: Part 2<a class="headerlink" href="#threat-mitigation-strategies-part-2" title="Permanent link">&para;</a></h1>
<p><strong>James Tubberville | May 15, 2018 | Tweet This Post: <a href="https://twitter.com/intent/tweet?url=http://threatexpress.com/blogs/2018/threat-mitigation-strategies-technical-recommendations-and-info-part-2/&amp;text=Threat Mitigation Strategies - Part 2"><i class="fa fa-twitter"></i></a></strong></p>
<p><em>The following information was composed by Andrew Chiles (@andrewchiles), Joe Vest (@joevest) and myself (@minis_io) for quick and easy reference. Much of it was pulled together from a variety of sources with attempts to provide references for each. This post is intended to be more of a brain dump rather than a complete technical breakout.</em></p>
<p><img alt="minis_io defender" src="/img/20180515_094034_defend-300x300.png" /></p>
<p>As discussed in the Threat Mitigation Strategies Part 1  <a href="http://threatexpress.com/2018/01/threat-mitigation-strategies-observations-recommendations/">http://threatexpress.com/2018/01/threat-mitigation-strategies-observations-recommendations/</a>, there is commonality between the inherent weaknesses and the actions a threat might perform within an information system or network.  The following recommendations and informational snippets were derived from many offensive and defensive efforts that continue to support these correlations. Each recommendation and snippet can <strong>and very likely should</strong> be applied to all networks. Some systems and networks will have exceptions; however, these are exceptions (not the status quo) and should be handled as such. Also note the exact syntax and use will vary with the network construct, operating system/version, and legal/regulatory security requirements.</p>
<h2 id="account-management">Account Management<a class="headerlink" href="#account-management" title="Permanent link">&para;</a></h2>
<p>Accounts should have specific roles.</p>
<p><strong>General Guidelines</strong></p>
<ul>
<li>Domain Administrators perform management of Windows Active Directory. They do not manage servers or workstations.</li>
<li>Server Administrators perform management of servers. They do not manage workstations.</li>
<li>Workstation Administrators perform management of workstation. They do not manage servers.</li>
<li>Privileged accounts should NOT have external communications (Internet, email, etc.)</li>
<li>Standard users should NOT have elevated access (use secondary accounts if required)</li>
</ul>
<h3 id="adjust-password-policy">Adjust Password Policy<a class="headerlink" href="#adjust-password-policy" title="Permanent link">&para;</a></h3>
<p>Adjust password policy to conform to "800-63-3: Digital Identity Guidelines".</p>
<ul>
<li>Remove periodic password change requirements</li>
<li>Passwords should only be changed if forgotten or suspected compromise  </li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>I don't agree with the two above and recommend maintaining a reasonable duration for password change requirements</p>
</div>
<ul>
<li>Remove complexity requirements (Upper/Lower/Number/Special character)</li>
<li>Require a minimum password length of</li>
<li>A minimum length of 8 is required by NIST, but minimum of <strong>16</strong> is recommended for user accounts</li>
<li>A minimum length of 20 (28+ is recommended) for service accounts</li>
<li>Suggest the use of pass-phrases (such as four random lowercase words). <strong>Example:</strong> "correct horse battery staple!"</li>
<li>Screen passwords against password compromise lists</li>
<li>Screen passwords against keyboard walks</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Meeting the complexity recommendation may not be possible due to current compliance requirements.</p>
</div>
<h4 id="setting-the-password-policy-using-gpo">Setting the Password Policy using GPO<a class="headerlink" href="#setting-the-password-policy-using-gpo" title="Permanent link">&para;</a></h4>
<p>Edit the "Domain Password Policy" GPO to configure the appropriate password length</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="mi">1</span><span class="p">.</span> <span class="k">Open</span> <span class="k">Group</span> <span class="n">Policy</span>  
<span class="mi">2</span><span class="p">.</span> <span class="n">Computer</span> <span class="n">Configurations</span> <span class="o">&gt;</span> <span class="n">Policies</span> <span class="o">&gt;</span> <span class="n">Windows</span> <span class="n">Settings</span> <span class="o">&gt;</span> <span class="k">Security</span> <span class="n">Settings</span> <span class="o">&gt;</span> <span class="n">Account</span> <span class="n">Policy</span> <span class="o">&gt;</span> <span class="n">Password</span> <span class="n">Policy</span>  
<span class="mi">3</span><span class="p">.</span> <span class="n">Minimum</span> <span class="n">password</span> <span class="k">length</span><span class="p">:</span> <span class="mi">20</span>
</pre></div>
</td></tr></table>

<h3 id="krbtgt-password-reset">KRBTGT password reset<a class="headerlink" href="#krbtgt-password-reset" title="Permanent link">&para;</a></h3>
<p>Regularly reset the KRBTGT password to minimize stolen credentials from be used in the future.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nv">Review</span> <span class="nv">the</span> <span class="nv">reset</span> <span class="nv">tool</span> <span class="nv">guide</span> <span class="s2">&quot;</span><span class="s">Guide to Running New-CtmADKrbtgtKeys</span><span class="s2">&quot;</span> <span class="ss">(</span><span class="nv">see</span> <span class="nv">references</span><span class="ss">)</span>  
<span class="nv">Use</span> <span class="nv">the</span> <span class="nv">the</span> <span class="nv">PowerShell</span> <span class="nv">script</span> <span class="nv">New</span><span class="o">-</span><span class="nv">CtmADKrbtgtKeys</span>.<span class="nv">ps1</span> <span class="nv">to</span> <span class="nv">reset</span> <span class="nv">the</span> <span class="nv">KRBTGT</span>  
<span class="k">Wait</span> <span class="mi">24</span> <span class="nv">hours</span> <span class="nv">and</span> <span class="nv">execute</span> <span class="nv">the</span> <span class="nv">change</span> <span class="nv">a</span> <span class="mi">2</span><span class="nv">nd</span> <span class="nv">time</span>  
<span class="nv">Recommend</span> <span class="nv">running</span> <span class="nv">on</span> <span class="nv">a</span> <span class="nv">regular</span> <span class="nv">schedule</span>. <span class="nv">This</span> <span class="nv">should</span> <span class="nv">be</span> <span class="nv">monthly</span>, <span class="nv">quarterly</span> <span class="ss">(</span><span class="nv">at</span> <span class="nv">most</span><span class="ss">)</span>, <span class="nv">or</span> <span class="nv">after</span> <span class="nv">an</span> <span class="nv">incident</span> <span class="nv">where</span> <span class="nv">compromise</span> <span class="nv">is</span> <span class="nv">suspected</span>.
</pre></div>
</td></tr></table>

<p><strong>References</strong></p>
<ul>
<li><a href="https://gallery.technet.microsoft.com/Reset-the-krbtgt-account-581a9e51">https://gallery.technet.microsoft.com/Reset-the-krbtgt-account-581a9e51</a></li>
<li><a href="https://adsecurity.org/?p=483">https://adsecurity.org/?p=483</a></li>
</ul>
<hr />
<h3 id="use-laps-to-manage-the-local-administrator-rid-500-password">Use LAPS to manage the local Administrator (RID 500) password<a class="headerlink" href="#use-laps-to-manage-the-local-administrator-rid-500-password" title="Permanent link">&para;</a></h3>
<ul>
<li>Install KB2871997</li>
<li>Follow details outlined at <a href="https://adsecurity.org/?p=1790">https://adsecurity.org/?p=1790</a></li>
</ul>
<p><strong>References</strong></p>
<ul>
<li><a href="https://adsecurity.org/?p=1790">https://adsecurity.org/?p=1790</a></li>
<li><a href="https://adsecurity.org/?p=559">https://adsecurity.org/?p=559</a></li>
</ul>
<hr />
<h3 id="implement-managed-service-accounts">Implement Managed Service Accounts<a class="headerlink" href="#implement-managed-service-accounts" title="Permanent link">&para;</a></h3>
<p>Windows Server 2008 R2 and Windows 7 introduced Managed Service Accounts. MSA's allow you to create an account in Active Directory that is tied to a specific computer. That account has its own complex password (see password policy) and is maintained automatically. This means that an MSA can run services on a computer in a secure and easy to maintain manner, while maintaining the capability to connect to network resources as a specific user principal.</p>
<p>Group level MSA's can be deployed in Windows 2012 or higher Domains.</p>
<p><strong>Reference</strong></p>
<ul>
<li><a href="https://blogs.technet.microsoft.com/askds/2009/09/10/managed-service-accounts-understanding-implementing-best-practices-and-troubleshooting/">https://blogs.technet.microsoft.com/askds/2009/09/10/managed-service-accounts-understanding-implementing-best-practices-and-troubleshooting/</a></li>
<li><a href="https://technet.microsoft.com/en-us/library/hh831782.aspx">https://technet.microsoft.com/en-us/library/hh831782.aspx</a></li>
</ul>
<hr />
<h3 id="protected-lsa">Protected LSA<a class="headerlink" href="#protected-lsa" title="Permanent link">&para;</a></h3>
<h4 id="protect-lsa-via-policy">Protect LSA Via policy<a class="headerlink" href="#protect-lsa-via-policy" title="Permanent link">&para;</a></h4>
<p><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nt">1</span><span class="o">.</span> <span class="nt">Advanced</span> <span class="nt">Audit</span> <span class="nt">Policy</span> <span class="nt">Configuration</span> <span class="o">&gt;</span> <span class="nt">Object</span> <span class="nt">Access</span> <span class="o">&gt;</span> <span class="nt">Audit</span> <span class="nt">Kernel</span> <span class="nt">Object</span>  
<span class="nt">2</span><span class="o">.</span> <span class="nt">Enable</span> <span class="nt">SACL</span> <span class="nt">L</span><span class="s2">&quot;S:(AU;SAFA;0x0010;;;WD)&quot;</span>
</pre></div>
</td></tr></table>
and</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="mi">1</span><span class="p">.</span> <span class="n">Computer</span> <span class="n">Configuration</span> <span class="o">&gt;</span> <span class="n">Preferences</span> <span class="o">&gt;</span> <span class="n">Windows</span> <span class="n">Settings</span>  
<span class="mi">2</span><span class="p">.</span> <span class="k">Right</span><span class="o">-</span><span class="n">click</span> <span class="n">Registry</span> <span class="o">&gt;</span> <span class="k">New</span> <span class="o">&gt;</span> <span class="n">Registry</span> <span class="n">Item</span>  
<span class="mi">3</span><span class="p">.</span> <span class="n">Hive</span> <span class="n">HKLM</span> <span class="o">&gt;</span> <span class="n">Path</span> <span class="n">SYSTEMCurrentControlSetControlLsa</span>  
<span class="mi">4</span><span class="p">.</span> <span class="n">DWORD</span> <span class="n">value</span> <span class="n">RunAsPPL</span><span class="o">=</span><span class="mi">00000001</span>
</pre></div>
</td></tr></table>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>LSA Protection prevents non-protected processes from interacting with LSASS. Mimikatz can still bypass this with a driver ("!+").</p>
</div>
<h4 id="protect-lsa-via-registry-entry">Protect LSA Via Registry Entry<a class="headerlink" href="#protect-lsa-via-registry-entry" title="Permanent link">&para;</a></h4>
<p><code class="codehilite"><span class="n">Manually</span> <span class="k">create</span> <span class="n">registry</span> <span class="n">entry</span> <span class="n">HKEY_LOCAL_MACHINESystemCurrentControlSetControlLsa</span> <span class="n">DWORD</span> <span class="n">RunAsPPL</span><span class="o">=</span><span class="mi">00000001</span></code></p>
<p>or</p>
<p><code class="codehilite"><span class="n">reg</span> <span class="k">add</span> <span class="n">HKEY_LOCAL_MACHINESystemCurrentControlSetControlLsa</span> <span class="o">/</span><span class="n">v</span> <span class="n">RunAsPPL</span> <span class="o">/</span><span class="n">d</span> <span class="mi">00000001</span> <span class="o">/</span><span class="n">t</span> <span class="n">REG_DWORD</span></code></p>
<hr />
<p>Windows Event Forwarding (WEF) reads any operational or administrative event log on a device in your organization and forwards the events you choose to a Windows Event Collector (WEC) server.</p>
<h2 id="windows-logs">Windows Logs<a class="headerlink" href="#windows-logs" title="Permanent link">&para;</a></h2>
<p>The Windows Logs category includes the logs that were available on previous versions of Windows: the Application, Security, and System logs. It also includes two new logs: the Setup log and the ForwardedEvents log. Windows logs are intended to store events from legacy applications and events that apply to the entire system.</p>
<h5 id="application-log">Application log<a class="headerlink" href="#application-log" title="Permanent link">&para;</a></h5>
<p>The Application log contains events logged by applications or programs. For example, a database program might record a file error in the application log. Program developers decide which events to log.</p>
<h5 id="security-log">Security log<a class="headerlink" href="#security-log" title="Permanent link">&para;</a></h5>
<p>The Security log contains events such as valid and invalid logon attempts, as well as events related to resource use, such as creating, opening, or deleting files or other objects. Administrators can specify what events are recorded in the security log. For example, if you have enabled logon auditing, attempts to log on to the system are recorded in the security log.</p>
<h5 id="setup-log">Setup log<a class="headerlink" href="#setup-log" title="Permanent link">&para;</a></h5>
<p>The Setup log contains events related to application setup.</p>
<h5 id="system-log">System log<a class="headerlink" href="#system-log" title="Permanent link">&para;</a></h5>
<p>The System log contains events logged by Windows system components. For example, the failure of a driver or other system component to load during startup is recorded in the system log. The event types logged by system components are predetermined by Windows.</p>
<h5 id="forwardedevents-log">ForwardedEvents log<a class="headerlink" href="#forwardedevents-log" title="Permanent link">&para;</a></h5>
<p>The ForwardedEvents log is used to store events collected from remote computers. To collect events from remote computers, you must create an event subscription. To learn about event subscriptions, see Event Subscriptions.</p>
<h4 id="applications-and-services-logs">Applications and Services Logs<a class="headerlink" href="#applications-and-services-logs" title="Permanent link">&para;</a></h4>
<p>Applications and Services logs are a new category of event logs. These logs store events from a single application or component rather than events that might have system wide impact.</p>
<p>This category of logs includes four subtypes: Admin, Operational, Analytic, and Debug logs. Events in Admin logs are of particular interest to IT Professionals using the Event Viewer to troubleshoot problems. Events in the Admin log should provide you with guidance about how to respond to them. Events in the Operational log are also useful for IT Professionals, but they are likely to require more interpretation.</p>
<p>Admin and Debug logs are not as user friendly. Analytic logs store events that trace an issue and, often, a high volume of events are logged. Debug logs are used by developers when debugging applications. Both Analytic and Debug logs are hidden and disabled by default. To make these logs visible, follow the steps in Show or Hide Analytic and Debug Logs. To enable these logs, follow the steps in Enable Analytic and Debug Logs.</p>
<h5 id="admin">Admin<a class="headerlink" href="#admin" title="Permanent link">&para;</a></h5>
<p>These events are primarily targeted at end users, administrators, and support personnel. The events that are found in the Admin channels indicate a problem and a well-defined solution that an administrator can act on. An example of an admin event is an event that occurs when an application fails to connect to a printer. These events are either well documented or have a message associated with them that gives the reader direct instructions of what must be done to rectify the problem.</p>
<h5 id="operational">Operational<a class="headerlink" href="#operational" title="Permanent link">&para;</a></h5>
<p>Operational events are used for analyzing and diagnosing a problem or occurrence. They can be used to trigger tools or tasks based on the problem or occurrence. An example of an operational event is an event that occurs when a printer is added or removed from a system.</p>
<h5 id="analytic">Analytic<a class="headerlink" href="#analytic" title="Permanent link">&para;</a></h5>
<p>Analytic events are published in high volume. They describe program operation and indicate problems that cannot be handled by user intervention.</p>
<h5 id="debug">Debug<a class="headerlink" href="#debug" title="Permanent link">&para;</a></h5>
<p>Debug events are used by developers troubleshooting issues with their programs.</p>
<hr />
<h3 id="advanced-audit-policy-should-focus-on-these-in-no-specific-order">Advanced Audit Policy should focus on these (in no specific order)<a class="headerlink" href="#advanced-audit-policy-should-focus-on-these-in-no-specific-order" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="mi">1</span><span class="p">.</span> <span class="n">A</span> <span class="n">logon</span> <span class="n">was</span> <span class="n">attempted</span> <span class="k">using</span> <span class="n">explicit</span> <span class="n">credentials</span><span class="p">:</span> <span class="n">Event</span> <span class="mi">552</span> <span class="k">and</span> <span class="mi">4648</span>  
<span class="mi">2</span><span class="p">.</span> <span class="n">A</span> <span class="n">member</span> <span class="n">was</span> <span class="n">added</span> <span class="k">to</span> <span class="n">a</span> <span class="k">security</span><span class="o">-</span><span class="n">enabled</span> <span class="k">global</span> <span class="k">group</span><span class="p">:</span> <span class="n">Event</span> <span class="mi">4728</span>  
<span class="mi">3</span><span class="p">.</span> <span class="n">A</span> <span class="n">member</span> <span class="n">was</span> <span class="n">added</span> <span class="k">to</span> <span class="n">a</span> <span class="k">security</span><span class="o">-</span><span class="n">enabled</span> <span class="k">local</span> <span class="k">group</span><span class="p">:</span> <span class="n">Event</span> <span class="mi">4732</span>  
<span class="mi">4</span><span class="p">.</span> <span class="n">A</span> <span class="n">member</span> <span class="n">was</span> <span class="n">added</span> <span class="k">to</span> <span class="n">a</span> <span class="k">security</span><span class="o">-</span><span class="n">enabled</span> <span class="n">universal</span> <span class="k">group</span><span class="p">:</span> <span class="n">Event</span> <span class="mi">4756</span>  
<span class="mi">5</span><span class="p">.</span> <span class="n">An</span> <span class="n">account</span> <span class="n">failed</span> <span class="k">to</span> <span class="n">log</span> <span class="k">on</span><span class="p">:</span> <span class="n">Event</span> <span class="mi">529</span><span class="o">-</span><span class="mi">539</span> <span class="mi">4625</span> <span class="p">(</span><span class="n">followed</span> <span class="k">by</span> <span class="n">a</span> <span class="n">success</span> <span class="mi">4624</span><span class="p">)</span>  
<span class="mi">6</span><span class="p">.</span> <span class="n">LogonAccount</span><span class="o">/</span><span class="n">TargetUserName</span> <span class="k">is</span> <span class="n">Administrator</span> <span class="p">(</span><span class="k">Using</span> <span class="n">RID</span><span class="o">-</span><span class="mi">500</span><span class="p">):</span> <span class="n">Event</span> <span class="mi">4624</span><span class="p">,</span> <span class="mi">4776</span>  
<span class="mi">7</span><span class="p">.</span> <span class="n">Scheduled</span> <span class="n">Task</span> <span class="n">Creation</span><span class="p">:</span> <span class="n">Event</span> <span class="mi">602</span><span class="p">,</span> <span class="mi">4698</span>  
<span class="mi">8</span><span class="p">.</span> <span class="n">Log</span> <span class="n">was</span> <span class="n">cleared</span><span class="p">:</span> <span class="n">Event</span> <span class="mi">104</span> <span class="k">and</span> <span class="mi">1102</span><span class="p">,</span> <span class="mi">4949</span>  
<span class="mi">9</span><span class="p">.</span> <span class="n">EMET</span> <span class="n">dies</span><span class="p">:</span> <span class="n">Event</span> <span class="mi">1</span> <span class="k">and</span> <span class="mi">2</span>  
<span class="mi">10</span><span class="p">.</span> <span class="n">Application</span> <span class="n">Error</span> <span class="k">or</span> <span class="n">Hang</span><span class="p">:</span> <span class="n">Event</span> <span class="mi">1000</span> <span class="k">and</span> <span class="mi">1002</span>  
<span class="mi">11</span><span class="p">.</span> <span class="n">Windows</span> <span class="n">Defender</span> <span class="n">Errors</span><span class="p">:</span> <span class="n">Event</span> <span class="mi">1005</span><span class="p">,</span> <span class="mi">1006</span><span class="p">,</span> <span class="mi">1008</span><span class="p">,</span> <span class="mi">1010</span><span class="p">,</span> <span class="mi">2001</span><span class="p">,</span> <span class="mi">2003</span><span class="p">,</span> <span class="mi">2004</span><span class="p">,</span> <span class="mi">3002</span><span class="p">,</span> <span class="mi">5008</span>  
<span class="mi">12</span><span class="p">.</span> <span class="k">New</span> <span class="n">process</span><span class="p">:</span> <span class="k">User</span> <span class="k">NOT</span> <span class="k">admin</span> <span class="k">and</span> <span class="n">Event</span> <span class="mi">4688</span>  
<span class="p">(</span><span class="n">arp</span><span class="p">,</span> <span class="k">at</span><span class="p">,</span> <span class="n">bcdedit</span><span class="p">,</span> <span class="n">certutil</span><span class="p">,</span> <span class="n">cscript</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">dsquery</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">ipconfig</span><span class="p">,</span> <span class="n">msbuild</span><span class="p">,</span> <span class="n">nbtstat</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">netsh</span><span class="p">,</span> <span class="n">netstat</span><span class="p">,</span> <span class="n">nslookup</span><span class="p">,</span> <span class="n">ntdsutil</span><span class="p">,</span> <span class="n">pcalua</span><span class="p">,</span> <span class="n">ping</span><span class="p">,</span> <span class="n">powershell</span><span class="p">,</span> <span class="n">psexec</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">regasm</span><span class="p">,</span> <span class="n">regedit</span><span class="p">,</span> <span class="n">regedt32</span><span class="p">,</span> <span class="n">regsvr32</span><span class="p">,</span> <span class="n">regsvcs</span><span class="p">,</span> <span class="n">rundll32</span><span class="p">,</span> <span class="k">set</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">schtasks</span><span class="p">,</span> <span class="n">systeminfo</span><span class="p">,</span> <span class="n">tasklist</span><span class="p">,</span> <span class="n">tracert</span><span class="p">,</span> <span class="n">whoami</span><span class="p">,</span> <span class="n">wmic</span><span class="p">,</span> <span class="n">wscript</span><span class="p">,</span> <span class="n">wsmprovhost</span><span class="p">)</span>  
<span class="mi">13</span><span class="p">.</span> <span class="n">Service</span> <span class="n">creation</span><span class="o">/</span><span class="n">install</span><span class="p">:</span> <span class="n">Event</span> <span class="mi">601</span><span class="p">,</span> <span class="mi">4697</span><span class="p">,</span> <span class="mi">7045</span>  
<span class="mi">14</span><span class="p">.</span> <span class="n">Service</span> <span class="n">changes</span><span class="p">:</span> <span class="n">Event</span> <span class="mi">7040</span>  
<span class="mi">15</span><span class="p">.</span> <span class="n">File</span> <span class="k">share</span> <span class="k">access</span><span class="o">/</span><span class="n">attempts</span> <span class="p">(</span><span class="k">C</span><span class="err">$</span><span class="p">,</span> <span class="k">ADMIN</span><span class="err">$</span><span class="p">,</span> <span class="n">IPC$</span><span class="p">):</span> <span class="n">Event</span> <span class="mi">5140</span>  
<span class="mi">16</span><span class="p">.</span> <span class="n">PowerShell</span> <span class="n">execution</span> <span class="k">and</span> <span class="n">module</span> <span class="n">loading</span><span class="p">:</span> <span class="n">Event</span> <span class="mi">501</span> <span class="k">and</span> <span class="mi">4104</span> <span class="n">respectively</span>  
<span class="mi">17</span><span class="p">.</span> <span class="k">External</span> <span class="n">media</span> <span class="n">detection</span><span class="p">:</span> <span class="k">All</span> <span class="n">Events</span> <span class="mi">7045</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">10001</span> <span class="k">or</span> <span class="mi">10002</span><span class="p">,</span> <span class="mi">10100</span><span class="p">,</span> <span class="mi">20001</span><span class="p">,</span> <span class="mi">20003</span><span class="p">,</span> <span class="mi">24576</span><span class="p">,</span> <span class="mi">24577</span><span class="p">,</span> <span class="mi">24579</span>  
<span class="mi">18</span><span class="p">.</span> <span class="k">User</span> <span class="n">creation</span><span class="p">:</span> <span class="n">Event</span> <span class="mi">4720</span>
</pre></div>
</td></tr></table>

<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>It's a good idea to hide/exclude these events except specific conditions (See caveats above) as these are consistently rolling: 4688,4689,5156,5158</p>
</div>
<h5 id="enable-command-line-logging-must-include-ms15-015-kb3031432">Enable Command Line Logging (Must include MS15-015 KB3031432)<a class="headerlink" href="#enable-command-line-logging-must-include-ms15-015-kb3031432" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">HKLMSoftwareMicrosoftWindowsCurrentVersionPoliciesSystemAudit</span> <span class="n">DWORD</span> <span class="n">ProcessCreationIncludeCmdLine_Enabled</span><span class="o">=</span><span class="mi">1</span></code></p>
<h5 id="account-honeytoken-manual">Account HoneyToken (manual)<a class="headerlink" href="#account-honeytoken-manual" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">echo</span> <span class="ss">&quot;crazypassword&quot;</span> <span class="o">|</span> <span class="n">runas</span> <span class="o">/</span><span class="n">u</span><span class="p">:</span><span class="n">yourdomain</span><span class="p">.</span><span class="n">comXadmin</span> <span class="o">/</span><span class="n">netonly</span> <span class="n">ipconfig</span></code></p>
<p>Consider a check on 4625 where Xadmin is found</p>
<p>Also add hash of crazypassword to IDS and alert when seen</p>
<h5 id="account-honeytoken-network">Account HoneyToken (network)<a class="headerlink" href="#account-honeytoken-network" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">Invoke</span><span class="o">-</span><span class="n">HoneyCreds</span><span class="p">.</span><span class="n">ps1</span></code></p>
<p>Reference: <a href="https://github.com/Ben0xA/PowerShellDefense/blob/master/Invoke-HoneyCreds.ps1">https://github.com/Ben0xA/PowerShellDefense/blob/master/Invoke-HoneyCreds.ps1</a></p>
<h5 id="spn-honeytoken">SPN HoneyToken<a class="headerlink" href="#spn-honeytoken" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">Set</span><span class="o">-</span><span class="n">ADUser</span> <span class="n">watchaccount</span> <span class="o">-</span><span class="n">ServicePrincipalNames</span> <span class="o">@</span><span class="err">{</span><span class="k">Add</span><span class="o">=</span><span class="err">&quot;</span><span class="n">MSSQLSvc</span><span class="o">/</span><span class="n">sql1</span><span class="p">:</span><span class="mi">1433</span><span class="err">}</span></code></p>
<hr />
<h3 id="powershell-module-logging">PowerShell Module Logging<a class="headerlink" href="#powershell-module-logging" title="Permanent link">&para;</a></h3>
<p>Ensure all Windows systems have PowerShell v3 or newer. Newer versions of PowerShell have better logging features, especially PowerShell v5. This will log all PowerShell activity including all PowerShell modules.</p>
<p>Enable PowerShell Module Logging  </p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="mi">1</span><span class="p">.</span> <span class="k">Open</span> <span class="k">Group</span> <span class="n">Policy</span>  
<span class="mi">2</span><span class="p">.</span> <span class="n">Computer</span> <span class="n">Configuration</span> <span class="o">&gt;</span> <span class="n">Policies</span> <span class="o">&gt;</span> <span class="n">Administrative</span> <span class="n">Templates</span> <span class="o">&gt;</span> <span class="n">Windows</span> <span class="n">Components</span> <span class="o">&gt;</span> <span class="n">Windows</span> <span class="n">PowerShell</span>  
<span class="mi">3</span><span class="p">.</span> <span class="n">Turn</span> <span class="k">on</span> <span class="n">Module</span> <span class="n">Logging</span>  
<span class="mi">4</span><span class="p">.</span> <span class="n">Enter</span> <span class="ss">&quot;*&quot;</span> <span class="k">and</span> <span class="n">click</span> <span class="n">OK</span><span class="p">.</span><span class="o">`</span>
</pre></div>
</td></tr></table>

<h4 id="log-parsing">Log Parsing<a class="headerlink" href="#log-parsing" title="Permanent link">&para;</a></h4>
<p>If enabled, PowerShell activity will be logged to the Microsoft-Windows-PowerShell/Operational Log. Push or pull these events to a central logging server (via Windows Event Forwarding or similar) or SIEM.</p>
<h4 id="parse-powershell-events-for-the-following-mimikatz-indicators">Parse PowerShell events for the following Mimikatz indicators<a class="headerlink" href="#parse-powershell-events-for-the-following-mimikatz-indicators" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="ss">&quot;System.Reflection.AssemblyName&quot;</span>  
<span class="ss">&quot;System.Reflection.Emit.AssemblyBuilderAccess &quot;</span>  
<span class="ss">&quot;System.Runtime.InteropServices.MarshalAsAttribute&quot;</span>  
<span class="ss">&quot;TOKEN_PRIVILEGES&quot;</span>  
<span class="ss">&quot;SE_PRIVILEGE_ENABLED&quot;</span><span class="o">`</span>
</pre></div>
</td></tr></table>

<h4 id="detecting-offensive-powershell-tools">Detecting Offensive PowerShell Tools<a class="headerlink" href="#detecting-offensive-powershell-tools" title="Permanent link">&para;</a></h4>
<p>Many PowerShell offensive tools use the following calls which are logged in PowerShell Module Logging.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="ss">&quot;GetDelegateForFunctionPointer&quot;</span>  
<span class="ss">&quot;System.Reflection.AssemblyName&quot;</span>  
<span class="ss">&quot;System.Reflection.Emit.AssemblyBuilderAccess&quot;</span>  
<span class="ss">&quot;System.Management.Automation.WindowsErrorReporting&quot;</span>  
<span class="ss">&quot;MiniDumpWriteDump&quot;</span>  
<span class="ss">&quot;TOKEN_IMPERSONATE&quot;</span>  
<span class="ss">&quot;TOKEN_DUPLICATE&quot;</span>  
<span class="ss">&quot;TOKEN_ADJUST_PRIVILEGES&quot;</span>  
<span class="ss">&quot;TOKEN_PRIVILEGES&quot;</span><span class="o">`</span>
</pre></div>
</td></tr></table>

<p><strong>Reference</strong></p>
<ul>
<li><a href="https://github.com/palantir/windows-event-forwarding/tree/master/group-policy-objects">https://github.com/palantir/windows-event-forwarding/tree/master/group-policy-objects</a></li>
<li><a href="https://github.com/iadgov/Event-Forwarding-Guidance/tree/master/Subscriptions/samples">https://github.com/iadgov/Event-Forwarding-Guidance/tree/master/Subscriptions/samples</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/threat-protection/use-windows-event-forwarding-to-assist-in-instrusion-detection">https://docs.microsoft.com/en-us/windows/threat-protection/use-windows-event-forwarding-to-assist-in-instrusion-detection</a></li>
<li><a href="https://github.com/MicrosoftDocs/windows-itpro-docs/blob/master/windows/threat-protection/use-windows-event-forwarding-to-assist-in-instrusion-detection.md">https://github.com/MicrosoftDocs/windows-itpro-docs/blob/master/windows/threat-protection/use-windows-event-forwarding-to-assist-in-instrusion-detection.md</a></li>
</ul>
<hr />
<h2 id="disable-windows-legacy-typically-unused-features">Disable Windows Legacy &amp; <strong>Typically</strong> Unused Features<a class="headerlink" href="#disable-windows-legacy-typically-unused-features" title="Permanent link">&para;</a></h2>
<p>The reference (Securing Windows Workstations: Developing a Secure Baseline) located at <a href="https://adsecurity.org/?p=3299">https://adsecurity.org/?p=3299</a> contains a wealth of information to help reduce security risks in a Windows Domain. Key mitigations are highlighted below.</p>
<h3 id="force-group-policy-to-reapply-settings-during-refresh">Force Group Policy to reapply settings during "refresh"<a class="headerlink" href="#force-group-policy-to-reapply-settings-during-refresh" title="Permanent link">&para;</a></h3>
<p><code class="codehilite"><span class="n">Computer</span> <span class="n">Configuration</span><span class="o">&gt;</span><span class="n">Policies</span><span class="o">&gt;</span><span class="n">Administrative</span> <span class="n">Templates</span><span class="o">&gt;</span><span class="k">System</span><span class="o">&gt;</span><span class="k">Group</span> <span class="n">Policy</span><span class="o">&gt;</span><span class="n">Configure</span> <span class="k">security</span> <span class="n">policy</span> <span class="n">processing</span></code></p>
<p>Set to Enabled  </p>
<p><code class="codehilite"><span class="nv">Also</span> <span class="nv">check</span> <span class="nv">the</span> <span class="nv">box</span> <span class="k">for</span> <span class="s2">&quot;</span><span class="s">Process even if the Group Policy objects have not changed</span><span class="s2">&quot;</span></code></p>
<p>It's also recommended to configure the same settings for each of the following:</p>
<ul>
<li>Computer Configuration, Policies, Administrative Templates, System, Group Policy, Configure registry policy processing</li>
<li>Computer Configuration, Policies, Administrative Templates, System, Group Policy, Configure scripts policy processing</li>
<li>As well as any other policy settings as needed.</li>
</ul>
<hr />
<h3 id="disable-unneeded-services">Disable Unneeded Services<a class="headerlink" href="#disable-unneeded-services" title="Permanent link">&para;</a></h3>
<p>The document Service-management-WS2016.xlsx contains a list default services, their state, use, and if it is safe to disable.</p>
<ul>
<li>Review the Services outlined in the document Service-management-WS2016.xlsx</li>
<li>Create a list of service to disable, and enforce via GPO</li>
</ul>
<h3 id="disable-net-session-enumeration-netcease">Disable Net Session Enumeration (NetCease)<a class="headerlink" href="#disable-net-session-enumeration-netcease" title="Permanent link">&para;</a></h3>
<p>This hardening process prevents attackers from easily getting some valuable recon information to move laterally within their victim's network.</p>
<ul>
<li>Run the NetCease PowerShell script on Server</li>
<li>Include DCs, Fileservers, or other servers where Session information may be used by and attacker for enumeration</li>
</ul>
<p><strong>References</strong></p>
<ul>
<li><a href="https://gallery.technet.microsoft.com/Net-Cease-Blocking-Net-1e8dcb5b">https://gallery.technet.microsoft.com/Net-Cease-Blocking-Net-1e8dcb5b</a></li>
<li><a href="https://adsecurity.org/?p=3299">https://adsecurity.org/?p=3299</a></li>
</ul>
<hr />
<h3 id="disable-wpad">Disable WPAD<a class="headerlink" href="#disable-wpad" title="Permanent link">&para;</a></h3>
<p>Web Proxy Auto-Discovery Protocol (WPAD) is "a method used by clients to locate the URL of a configuration file using DHCP and/or DNS discovery methods. Once detection and download of the configuration file is complete, it can be executed to determine the proxy for a specified URL."</p>
<p>Disable WPAD via Group Policy by deploying the following registry change:</p>
<p><code class="codehilite"><span class="n">HKEY_CURRENT_USERSoftwareMicrosoftWindowsCurrentVersionInternet</span> <span class="n">SettingsWpad</span><span class="k">New</span> <span class="n">DWORD</span> <span class="p">(</span><span class="mi">32</span><span class="o">-</span><span class="nb">Bit</span> <span class="n">Value</span><span class="p">)</span> <span class="k">called</span> <span class="ss">&quot;WpadOverride&quot;</span> <span class="k">and</span> <span class="k">set</span> <span class="k">to</span> <span class="ss">&quot;1&quot;</span></code></p>
<p>Disable the service "WinHTTP Web Proxy Auto-Discovery Service"</p>
<p><code class="codehilite"><span class="n">Computer</span> <span class="n">Configuration</span><span class="o">&gt;</span><span class="n">Policies</span><span class="o">&gt;</span><span class="n">Windows</span> <span class="n">Settings</span><span class="o">&gt;</span><span class="k">Security</span> <span class="n">Settings</span><span class="o">&gt;</span><span class="k">System</span> <span class="n">Services</span><span class="k">Set</span> <span class="n">WinHTTP</span> <span class="n">Web</span> <span class="n">Proxy</span> <span class="n">Auto</span><span class="o">-</span><span class="n">Discovery</span> <span class="n">Service</span> <span class="k">to</span> <span class="n">Disabled</span></code></p>
<p>Note:<br />
Partial mitigation of WPAD issues is possible by installing the Microsoft patch KB3165191 (MS16-077). This patch hardens the WPAD process and when the system responds to NetBIOS requests.</p>
<hr />
<h3 id="disable-llmnr">Disable LLMNR<a class="headerlink" href="#disable-llmnr" title="Permanent link">&para;</a></h3>
<p>Link-Local Multicast Name Resolution (LLMNR):<br />
In a nutshell, Link-Local Multicast Name Resolution (LLMNR) resolves single label names (like: COMPUTER1), on the local subnet, when DNS is unable to resolve the name.</p>
<p>Disable LLMNR via Group Policy by deploying the following:</p>
<p><code class="codehilite"><span class="k">Group</span> <span class="n">Policy</span><span class="p">:</span><span class="n">Computer</span> <span class="n">Configuration</span><span class="o">/</span><span class="n">Administrative</span> <span class="n">Templates</span><span class="o">/</span><span class="n">Network</span><span class="o">/</span><span class="n">DNS</span> <span class="n">Client</span><span class="k">Set</span> <span class="ss">&quot;Turn Off Multicast Name Resolution&quot;</span> <span class="k">to</span> <span class="ss">&quot;Enabled&quot;</span></code></p>
<hr />
<h3 id="disable-wdigest">Disable WDigest<a class="headerlink" href="#disable-wdigest" title="Permanent link">&para;</a></h3>
<p>WDigest provides support for Digest authentication which is: "An industry standard that is used in Windows Server 2003 for Lightweight Directory Access Protocol (LDAP) and Web authentication. Digest Authentication transmits credentials across the network as an MD5 hash or message digest."</p>
<p>Prior to Windows 8.1 and Windows Server 2012 R2, Wdigest was enabled which placed the user's "clear text" password in LSASS memory space in order to support basic authentication scenarios. Windows 8.1 and Windows Server 2012 R2 and newer have WDigest disabled by default.</p>
<p>Disable WDigest via Group Policy by deploying the following registry change:</p>
<p><code class="codehilite"><span class="n">HKEY_LOCAL_MACHINESystemCurrentControlSetControlSecurityProvidersWdigestUseLogonCredential</span> <span class="o">=</span> <span class="ss">&quot;0&quot;</span></code></p>
<p><strong>References</strong></p>
<ul>
<li><a href="https://adsecurity.org/?p=3299">https://adsecurity.org/?p=3299</a></li>
</ul>
<hr />
<h3 id="remove-the-use-of-ntlm-v1">Remove the use of NTLM v1<a class="headerlink" href="#remove-the-use-of-ntlm-v1" title="Permanent link">&para;</a></h3>
<p>Windows Server 2008 R2 included features to help identify NTLM authentication use on the network. It is important to completely remove these legacy authentication protocols since they are insecure. Removal and prevention of LM and NTLMv1 use can be activated through the use of Group Policy security settings.<br />
Plan to move to NTLMv2 and Kerberos at the least, with the long-term goal being Kerberos only.</p>
<ul>
<li>Audit the use of NTLM v1 on the network</li>
<li>Determine the risks and need to support NTLM v1</li>
<li>Disable the use of NTLM v1</li>
</ul>
<p><strong>Reference</strong></p>
<ul>
<li><a href="https://technet.microsoft.com/en-us/library/jj865674(v=ws.10).aspx">https://technet.microsoft.com/en-us/library/jj865674(v=ws.10).aspx</a></li>
<li><a href="https://technet.microsoft.com/en-us/library/dd560653%28v=ws.10%29.aspx">https://technet.microsoft.com/en-us/library/dd560653%28v=ws.10%29.aspx</a></li>
</ul>
<h3 id="consider-other-mitigations">Consider other Mitigations<a class="headerlink" href="#consider-other-mitigations" title="Permanent link">&para;</a></h3>
<p>Consider other mitigations detailed at <a href="https://adsecurity.org/?p=3299">https://adsecurity.org/?p=3299</a></p>
<p><strong>References</strong></p>
<ul>
<li><a href="https://adsecurity.org/?p=3299">https://adsecurity.org/?p=3299</a></li>
</ul>
<hr />
<h3 id="deploy-security-back-port-patch-kb2871997">Deploy security back-port patch (KB2871997)<a class="headerlink" href="#deploy-security-back-port-patch-kb2871997" title="Permanent link">&para;</a></h3>
<p>Ensure all Windows systems prior to Windows 8.1 &amp; Windows Server 2012 R2 have the KB2871997 patch installed. This patch updates earlier supported versions of Windows with security enhancements baked into Windows 8.1 &amp; Windows Server 2012 R2.</p>
<p><strong>References</strong></p>
<ul>
<li><a href="https://adsecurity.org/?p=559">https://adsecurity.org/?p=559</a></li>
<li><a href="https://blogs.technet.microsoft.com/kfalde/2014/11/01/kb2871997-and-wdigest-part-1/">https://blogs.technet.microsoft.com/kfalde/2014/11/01/kb2871997-and-wdigest-part-1/</a></li>
</ul>
<h3 id="prevent-local-administrator-accounts-from-authenticating-over-the-network">Prevent local "administrator" accounts from authenticating over the network<a class="headerlink" href="#prevent-local-administrator-accounts-from-authenticating-over-the-network" title="Permanent link">&para;</a></h3>
<p>While the local Administrator (RID 500) account on two different computers has a different SID, if they have the same account name and password, the local Administrator account from one can authenticate as Administrator on the other. The same is true with any local account that is duplicated on multiple computers.<br />
This presents a security issue if multiple (or all) workstations in an organization have the same account name and password since compromise of one workstation results in compromise of all.</p>
<p>Windows 8.1 &amp; Windows 2012 R2 and newer introduced two new local SIDs:<br />
S-1-5-113: NT AUTHORITYLocal account<br />
S-1-5-114: NT AUTHORITYLocal account and member of Administrators group<br />
These SIDs are also added in earlier supported versions of Windows by installing the KB2871997 patch.</p>
<p><code class="codehilite"><span class="n">Install</span> <span class="n">patch</span> <span class="n">KB2871997</span></code></p>
<h4 id="configure-through-group-policy">Configure through Group Policy:<a class="headerlink" href="#configure-through-group-policy" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="mi">1</span><span class="p">.</span> <span class="k">Open</span> <span class="k">Group</span> <span class="n">Policy</span> <span class="n">Management</span> <span class="p">(</span><span class="n">gpmc</span><span class="p">.</span><span class="n">msc</span> <span class="k">or</span> <span class="n">via</span> <span class="n">MMC</span> <span class="k">Group</span> <span class="n">Policy</span> <span class="k">Object</span> <span class="n">Editor</span><span class="p">)</span>  
<span class="mi">2</span><span class="p">.</span> <span class="n">Computer</span> <span class="n">Configuration</span> <span class="o">&gt;</span> <span class="n">Windows</span> <span class="n">Settings</span> <span class="o">&gt;</span> <span class="k">Local</span> <span class="n">Policies</span> <span class="o">&gt;</span> <span class="k">User</span> <span class="n">Rights</span> <span class="k">Assignment</span>  
<span class="mi">3</span><span class="p">.</span> <span class="n">Deny</span> <span class="k">access</span> <span class="k">to</span> <span class="n">this</span> <span class="n">computer</span> <span class="k">from</span> <span class="n">the</span> <span class="n">network</span><span class="p">:</span> <span class="k">Local</span> <span class="n">account</span> <span class="k">and</span> <span class="n">member</span> <span class="k">of</span> <span class="n">Administrators</span> <span class="k">group</span>  
<span class="mi">4</span><span class="p">.</span> <span class="n">Deny</span> <span class="n">log</span> <span class="k">on</span> <span class="n">through</span> <span class="n">Remote</span> <span class="n">Desktop</span> <span class="n">Services</span><span class="p">:</span> <span class="k">Local</span> <span class="n">account</span> <span class="k">and</span> <span class="n">member</span> <span class="k">of</span> <span class="n">Administrators</span> <span class="k">group</span>
</pre></div>
</td></tr></table>

<hr />
<h3 id="remote-connections">Remote Connections<a class="headerlink" href="#remote-connections" title="Permanent link">&para;</a></h3>
<h4 id="rdp-restricted-admin-connect-to-only-1-resource">RDP Restricted Admin (Connect to only 1 resource)<a class="headerlink" href="#rdp-restricted-admin-connect-to-only-1-resource" title="Permanent link">&para;</a></h4>
<p><code class="codehilite"><span class="n">mstsc</span> <span class="o">/</span><span class="n">v</span><span class="p">:</span><span class="n">server</span> <span class="o">/</span><span class="n">restrictedAdmin</span></code></p>
<h5 id="enable-restricted-admin-via-registry">Enable Restricted Admin via Registry<a class="headerlink" href="#enable-restricted-admin-via-registry" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">Manually</span> <span class="k">create</span> <span class="n">registry</span> <span class="n">entry</span> <span class="n">HKEY_LOCAL_MACHINESystemCurrentControlSetControlLsa</span> <span class="n">DWORD</span> <span class="n">DisableRestrictedAdmin</span><span class="o">=</span><span class="mi">0</span></code></p>
<p>or</p>
<p><code class="codehilite"><span class="n">reg</span> <span class="k">add</span> <span class="n">HKEY_LOCAL_MACHINESystemCurrentControlSetControlLsa</span> <span class="o">/</span><span class="n">v</span> <span class="n">DisableRestrictedAdmin</span> <span class="o">/</span><span class="n">d</span> <span class="mi">0</span> <span class="o">/</span><span class="n">t</span> <span class="n">REG_DWORD</span></code></p>
<h5 id="enable-restricted-admin-via-gpo">Enable Restricted Admin via GPO<a class="headerlink" href="#enable-restricted-admin-via-gpo" title="Permanent link">&para;</a></h5>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="mi">1</span><span class="p">.</span> <span class="k">Open</span> <span class="k">Group</span> <span class="n">Policy</span> <span class="n">Management</span> <span class="p">(</span><span class="n">gpmc</span><span class="p">.</span><span class="n">msc</span> <span class="k">or</span> <span class="n">via</span> <span class="n">MMC</span> <span class="k">Group</span> <span class="n">Policy</span> <span class="k">Object</span> <span class="n">Editor</span><span class="p">)</span>  
<span class="mi">2</span><span class="p">.</span> <span class="n">Computer</span> <span class="n">Configurations</span> <span class="o">&gt;</span> <span class="n">Policies</span> <span class="o">&gt;</span> <span class="n">Administrative</span> <span class="n">Templates</span> <span class="o">&gt;</span> <span class="k">System</span> <span class="o">&gt;</span> <span class="n">Credential</span> <span class="n">Delegation</span>  
<span class="mi">3</span><span class="p">.</span> <span class="k">Set</span> <span class="ss">&quot;Restrict Delegation of credential to remote servers&quot;</span> <span class="k">to</span> <span class="n">enable</span>
</pre></div>
</td></tr></table>

<h4 id="rdp-windows-defender-remote-credential-guard-connect-to-multiple-resources">RDP Windows Defender Remote Credential Guard (Connect to multiple resources)<a class="headerlink" href="#rdp-windows-defender-remote-credential-guard-connect-to-multiple-resources" title="Permanent link">&para;</a></h4>
<p><code class="codehilite"><span class="n">mstsc</span> <span class="o">/</span><span class="n">v</span><span class="p">:</span><span class="n">server</span> <span class="o">/</span><span class="n">remoteguard</span></code></p>
<h5 id="enable-windows-defender-credential-guard-via-registry">Enable Windows Defender Credential Guard via Registry<a class="headerlink" href="#enable-windows-defender-credential-guard-via-registry" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">Manually</span> <span class="k">create</span> <span class="n">registry</span> <span class="n">entry</span> <span class="n">HKEY_LOCAL_MACHINESystemCurrentControlSetControlLsa</span> <span class="n">DWORD</span> <span class="n">DisableRestrictedAdmin</span><span class="o">=</span><span class="mi">0</span></code></p>
<p>or</p>
<p><code class="codehilite"><span class="n">reg</span> <span class="k">add</span> <span class="n">HKEY_LOCAL_MACHINESystemCurrentControlSetControlLsa</span> <span class="o">/</span><span class="n">v</span> <span class="n">DisableRestrictedAdmin</span> <span class="o">/</span><span class="n">d</span> <span class="mi">0</span> <span class="o">/</span><span class="n">t</span> <span class="n">REG_DWORD</span></code></p>
<h5 id="enable-windef-cred-guard-via-gpo">Enable WinDef Cred Guard via GPO<a class="headerlink" href="#enable-windef-cred-guard-via-gpo" title="Permanent link">&para;</a></h5>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="mi">1</span><span class="p">.</span> <span class="k">Open</span> <span class="k">Group</span> <span class="n">Policy</span> <span class="n">Management</span> <span class="p">(</span><span class="n">gpmc</span><span class="p">.</span><span class="n">msc</span> <span class="k">or</span> <span class="n">via</span> <span class="n">MMC</span> <span class="k">Group</span> <span class="n">Policy</span> <span class="k">Object</span> <span class="n">Editor</span><span class="p">)</span>  
<span class="mi">2</span><span class="p">.</span> <span class="n">Computer</span> <span class="n">Configurations</span> <span class="o">&gt;</span> <span class="n">Policies</span> <span class="o">&gt;</span> <span class="n">Administrative</span> <span class="n">Templates</span> <span class="o">&gt;</span> <span class="k">System</span> <span class="o">&gt;</span> <span class="n">Credential</span> <span class="n">Delegation</span>  
<span class="mi">3</span><span class="p">.</span> <span class="k">Set</span> <span class="ss">&quot;Restrict Delegation of credential to remote servers&quot;</span> <span class="k">to</span> <span class="n">enable</span>  
<span class="mi">4</span><span class="p">.</span> <span class="k">In</span> <span class="k">Options</span><span class="p">,</span> <span class="k">Under</span> <span class="n">use</span> <span class="n">the</span> <span class="n">following</span> <span class="n">restricted</span> <span class="k">mode</span><span class="p">:</span> <span class="n">Choose</span> <span class="ss">&quot;Prefer Windows Defender Remote Credential Guard&quot;</span> 
</pre></div>
</td></tr></table>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If all systems are Windows 10/2016, Choose "Require Remote Credential Guard"</p>
</div>
<hr />
<h3 id="limit-client-to-client-communication-implement-and-configure-host-based-firewalls">Limit Client-to-Client Communication (Implement <em>and Configure</em> Host Based Firewalls)<a class="headerlink" href="#limit-client-to-client-communication-implement-and-configure-host-based-firewalls" title="Permanent link">&para;</a></h3>
<ul>
<li>Clients and Server should be split into separate OU's</li>
<li>Enable the Windows Firewall through GPO</li>
<li>(Optional) Add exceptions to systems that are used to manage other hosts such as Sysadmins. Use a jump host to minimize exposure.</li>
</ul>
<h4 id="enable-firewall">Enable Firewall<a class="headerlink" href="#enable-firewall" title="Permanent link">&para;</a></h4>
<p><strong>PowerShell</strong></p>
<p>1) Create a GPO to hold the Workstation FW settings (workstation_fw)</p>
<p>Example</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">Set</span><span class="o">-</span><span class="n">NetFirewallProfile</span> <span class="o">-</span><span class="n">Profile</span> <span class="k">Domain</span><span class="p">,</span><span class="k">Public</span><span class="p">,</span><span class="n">Private</span> <span class="o">-</span><span class="n">Enabled</span> <span class="k">True</span> <span class="err"></span><span class="n">PolicyStore</span> <span class="n">example_domain</span><span class="p">.</span><span class="n">localworkstation_fw</span>  
<span class="k">Set</span><span class="o">-</span><span class="n">NetFirewallProfile</span> <span class="o">-</span><span class="n">DefaultInboundAction</span> <span class="n">Block</span> <span class="o">-</span><span class="n">DefaultOutboundAction</span> <span class="n">Allow</span> <span class="err"></span><span class="n">NotifyOnListen</span> <span class="k">True</span> <span class="o">-</span><span class="n">AllowUnicastResponseToMulticast</span> <span class="k">True</span> <span class="err"></span><span class="n">LogFileName</span> <span class="o">%</span><span class="n">SystemRoot</span><span class="o">%</span><span class="n">System32LogFilesFirewallpfirewall</span><span class="p">.</span><span class="n">log</span> <span class="err"></span><span class="n">PolicyStore</span> <span class="n">example_domain</span><span class="p">.</span><span class="n">localworkstation_fw</span>
</pre></div>
</td></tr></table>

<p>2) Assign the GPO to a Workstation Container</p>
<p><strong>References</strong></p>
<ul>
<li><a href="https://technet.microsoft.com/en-us/library/hh831755(v=ws.11).aspx">https://technet.microsoft.com/en-us/library/hh831755(v=ws.11).aspx</a></li>
</ul>
<h3 id="blockcontrol-tcpudp-access-from-the-internal-network-and-dmz">Block/control TCP/UDP access from the Internal network and DMZ<a class="headerlink" href="#blockcontrol-tcpudp-access-from-the-internal-network-and-dmz" title="Permanent link">&para;</a></h3>
<ul>
<li>Evaluate the need for servers to connect to the Internet.</li>
<li>Create a list of systems outside the network that require access. Limit access using this whitelist.</li>
<li>Configure firewall rules to enforce these traffic policies.</li>
</ul>
<hr />
<h3 id="block-out-bound-tcpudp-access-from-the-client-systems-to-outbound-networks">Block out bound TCP/UDP access from the Client systems to outbound networks.<a class="headerlink" href="#block-out-bound-tcpudp-access-from-the-client-systems-to-outbound-networks" title="Permanent link">&para;</a></h3>
<p>Clients generally only need a few ports to connect out bound. Limit access from client workstations to these ports.</p>
<ul>
<li>Create a list of ports required by clients to communicate outside the network. Limit access using this whitelist.</li>
<li>Configure firewall rules to enforce these traffic policies.</li>
<li>Rule can be managed at the HOST level via GPO or the network level via firewall rules.</li>
</ul>
<hr />
<h3 id="implement-a-proxy-for-all-outbound-traffic">Implement a Proxy for All Outbound Traffic<a class="headerlink" href="#implement-a-proxy-for-all-outbound-traffic" title="Permanent link">&para;</a></h3>
<p>Force systems to traverse an proxy to communicate outbound. It is preferred to only allow authenticated communications. This prevents privilege users (SYSTEM, root) from communicating outbound.</p>
<ul>
<li>At a minimum, force all client's HTTP(S) and DNS through a proxy</li>
<li>If possible, require user authentication</li>
<li>Prevent outbound access if a client or system attempts to connect to external port directly using network firewall rules</li>
</ul>
<h4 id="create-a-new-gpo-to-manage-the-proxy-settings">Create a new GPO to manage the proxy settings<a class="headerlink" href="#create-a-new-gpo-to-manage-the-proxy-settings" title="Permanent link">&para;</a></h4>
<p>Edit the GPO</p>
<p><code class="codehilite"><span class="k">User</span> <span class="n">Configuration</span><span class="o">&gt;</span><span class="n">Windows</span> <span class="n">Settings</span><span class="o">&gt;</span><span class="n">Internet</span> <span class="n">Explorer</span> <span class="n">Maintenance</span><span class="o">&gt;</span><span class="k">Connection</span></code></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">Select</span> <span class="n">Proxy</span> <span class="n">Server</span>  
<span class="n">Enter</span> <span class="n">the</span> <span class="n">Proxy</span> <span class="n">IP</span> <span class="n">address</span> <span class="k">and</span> <span class="n">Port</span>
</pre></div>
</td></tr></table>

<p>Prevent Users from Changing Settings</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">User</span> <span class="n">Configuration</span><span class="o">&gt;</span><span class="n">Administrative</span> <span class="n">Templates</span><span class="o">&gt;</span><span class="n">Windows</span> <span class="n">Components</span><span class="o">&gt;</span><span class="n">Internet</span> <span class="n">Explorer</span><span class="o">&gt;</span><span class="n">Internet</span> <span class="n">Control</span> <span class="n">Panel</span>  
<span class="k">Set</span> <span class="n">Disable</span> <span class="n">the</span> <span class="n">Connections</span> <span class="n">Page</span> <span class="k">to</span> <span class="n">Enabled</span>
</pre></div>
</td></tr></table>

<hr />
<h2 id="configurations">Configurations<a class="headerlink" href="#configurations" title="Permanent link">&para;</a></h2>
<h3 id="autoruns">AutoRuns<a class="headerlink" href="#autoruns" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="mi">1</span><span class="p">.</span> <span class="n">De</span><span class="o">-</span><span class="k">select</span> <span class="ss">&quot;Hide Microsoft Entries&quot;</span>  
<span class="mi">2</span><span class="p">.</span> <span class="n">De</span><span class="o">-</span><span class="k">select</span> <span class="ss">&quot;Hide Windows Entries&quot;</span>  
<span class="mi">3</span><span class="p">.</span> <span class="k">Under</span> <span class="n">Scan</span> <span class="k">Options</span><span class="p">,</span> <span class="n">enable</span> <span class="ss">&quot;Verify code signatures&quot;</span>  
<span class="mi">4</span><span class="p">.</span> <span class="k">Under</span> <span class="n">Scan</span> <span class="k">Options</span><span class="p">,</span> <span class="n">enable</span> <span class="ss">&quot;Check VirusTotal.com&quot;</span> <span class="p">(</span><span class="n">note</span> <span class="n">this</span> <span class="n">shouldn</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">be</span> <span class="n">done</span> <span class="k">on</span> <span class="n">GOV</span> <span class="k">or</span> <span class="n">otherwise</span> <span class="k">sensitive</span> <span class="n">networks</span><span class="p">)</span>  
<span class="mi">5</span><span class="p">.</span> <span class="n">Review</span> <span class="k">all</span> <span class="n">entries</span> <span class="k">with</span> <span class="n">multiple</span> <span class="k">parameters</span>
</pre></div>
</td></tr></table>

<hr />
<h3 id="application-whiteblack-listing">Application White/Black listing<a class="headerlink" href="#application-whiteblack-listing" title="Permanent link">&para;</a></h3>
<p>A number of solutions exist to limit the applications a user can use on a system. AppLocker allows you to specify which users or groups can run particular applications in your organization based on unique identities of files. If you use AppLocker, you can create rules to allow or deny applications from running.</p>
<hr />
<h3 id="applocker">Applocker<a class="headerlink" href="#applocker" title="Permanent link">&para;</a></h3>
<h4 id="applocker-executable-path-restrictions">AppLocker Executable Path Restrictions<a class="headerlink" href="#applocker-executable-path-restrictions" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="mi">1</span>. <span class="nv">Open</span> <span class="nv">Group</span> <span class="nv">Policy</span> <span class="nv">Management</span> <span class="ss">(</span><span class="nv">gpmc</span>.<span class="nv">msc</span> <span class="nv">or</span> <span class="nv">via</span> <span class="nv">MMC</span> <span class="nv">Group</span> <span class="nv">Policy</span> <span class="nv">Object</span> <span class="nv">Editor</span><span class="ss">)</span>  
<span class="mi">2</span>. <span class="nv">Computer</span> <span class="nv">Configuration</span> <span class="o">&gt;</span> <span class="nv">Policies</span> <span class="o">&gt;</span> <span class="nv">Windows</span> <span class="nv">Settings</span> <span class="o">&gt;</span> <span class="nv">Security</span> <span class="nv">Settings</span> <span class="o">&gt;</span> <span class="nv">Application</span> <span class="nv">Control</span> <span class="nv">Policies</span> <span class="o">&gt;</span> <span class="nv">AppLocker</span>  
<span class="mi">3</span>. <span class="nv">Configure</span> <span class="nv">rule</span> <span class="nv">enforcement</span>  
<span class="mi">4</span>. <span class="nv">Executable</span> <span class="nv">rules</span>, <span class="nv">Check</span> <span class="nv">Configured</span>, <span class="nv">Enforce</span> <span class="nv">rules</span>  
<span class="mi">5</span>. <span class="nv">Overview</span> <span class="o">&gt;</span> <span class="nv">Executable</span> <span class="nv">Rules</span> <span class="o">&gt;</span> <span class="nv">Right</span> <span class="nv">Click</span> <span class="nv">Create</span> <span class="nv">New</span> <span class="nv">Rule</span>  
<span class="mi">6</span>. <span class="nv">Permissions</span> <span class="o">&gt;</span> <span class="nv">Deny</span> <span class="o">&gt;</span> <span class="nv">Domain</span> <span class="nv">Users</span>  
<span class="mi">7</span>. <span class="nv">Conditions</span> <span class="o">&gt;</span> <span class="nv">Path</span>  
<span class="mi">8</span>. <span class="nv">Exceptions</span> <span class="o">&gt;</span> <span class="nv">Add</span> <span class="nv">as</span><span class="o">/</span><span class="k">if</span> <span class="nv">required</span>  
<span class="mi">9</span>. <span class="nv">Create</span> <span class="o">&gt;</span> <span class="nv">Yes</span>
</pre></div>
</td></tr></table>

<h5 id="interesting-paths">Interesting Paths<a class="headerlink" href="#interesting-paths" title="Permanent link">&para;</a></h5>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="mi">1</span>. <span class="o">&lt;</span><span class="nv">drive</span> <span class="nv">letter</span><span class="o">&gt;</span><span class="nv">users</span><span class="o">&lt;</span><span class="nv">username</span><span class="o">&gt;</span><span class="nv">appdata</span> <span class="ss">(</span><span class="o">%</span><span class="nv">AppData</span><span class="o">%</span> <span class="nv">or</span> <span class="k">for</span> <span class="nv">extension</span> <span class="o">%</span><span class="nv">AppData</span><span class="o">%*</span>.<span class="nv">exe</span> <span class="mi">5</span><span class="nv">AppData</span><span class="o">%**</span>.<span class="nv">exe</span><span class="ss">)</span>  
<span class="mi">2</span>. <span class="nv">users</span><span class="nv">ppdatalocal</span>  
<span class="mi">3</span>. <span class="nv">users</span><span class="nv">ppdatalocaltemp</span>  
<span class="mi">4</span>. <span class="nv">users</span><span class="nv">ppdataroaming</span>  
<span class="mi">5</span>. <span class="nv">programdata</span>
</pre></div>
</td></tr></table>

<h4 id="explicit-whitelisting">Explicit Whitelisting<a class="headerlink" href="#explicit-whitelisting" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="mi">1</span><span class="p">.</span> <span class="k">Open</span> <span class="k">Group</span> <span class="n">Policy</span> <span class="n">Management</span> <span class="p">(</span><span class="n">gpmc</span><span class="p">.</span><span class="n">msc</span> <span class="k">or</span> <span class="n">via</span> <span class="n">MMC</span> <span class="k">Group</span> <span class="n">Policy</span> <span class="k">Object</span> <span class="n">Editor</span><span class="p">)</span>  
<span class="mi">2</span><span class="p">.</span> <span class="n">Computer</span> <span class="n">Configuration</span> <span class="o">&gt;</span> <span class="n">Policies</span> <span class="o">&gt;</span> <span class="n">Windows</span> <span class="n">Settings</span> <span class="o">&gt;</span> <span class="k">Security</span> <span class="n">Settings</span> <span class="o">&gt;</span> <span class="n">Software</span> <span class="n">Restriction</span> <span class="n">Policies</span>  
<span class="mi">3</span><span class="p">.</span> <span class="k">Security</span> <span class="k">Level</span> <span class="n">Disallowed</span>  
<span class="mi">4</span><span class="p">.</span> <span class="k">In</span> <span class="n">additional</span> <span class="n">rules</span> <span class="n">allow</span>  
<span class="n">a</span><span class="p">.</span> <span class="o">%</span><span class="n">HKEY_LOCAL_MACHINESOFTWAREMicrosoftWindowsNTCurrentVersionSystemRoot</span><span class="o">%</span>  
<span class="n">b</span><span class="p">.</span> <span class="o">%</span><span class="n">HKEY_LOCAL_MACHINESOFTWAREMicrosoftWindowsCurrentVersionProgramFilesDir</span> <span class="p">(</span><span class="n">x86</span><span class="p">)</span><span class="o">%</span>  
<span class="k">c</span><span class="p">.</span> <span class="o">%</span><span class="n">HKEY_LOCAL_MACHINESOFTWAREMicrosoftWindowsCurrentVersionProgramFilesDir</span><span class="o">%</span>  
<span class="n">d</span><span class="p">.</span> <span class="o">*</span><span class="p">.</span><span class="n">lnk</span>
</pre></div>
</td></tr></table>

<h4 id="interesting-file-extensions">Interesting file extensions<a class="headerlink" href="#interesting-file-extensions" title="Permanent link">&para;</a></h4>
<p><code class="codehilite"><span class="na">.ade</span><span class="p">,</span> <span class="no">.adp</span><span class="p">,</span> <span class="no">.ani</span><span class="p">,</span> <span class="no">.bas</span><span class="p">,</span> <span class="no">.bat</span><span class="p">,</span> <span class="no">.chm</span><span class="p">,</span> <span class="no">.cmd</span><span class="p">,</span> <span class="no">.com</span><span class="p">,</span> <span class="no">.cpl</span><span class="p">,</span> <span class="no">.crt</span><span class="p">,</span> <span class="no">.exe</span><span class="p">,</span> <span class="no">.hlp</span><span class="p">,</span> <span class="no">.ht</span><span class="p">,</span> <span class="no">.hta</span><span class="p">,</span> <span class="no">.inf</span><span class="p">,</span> <span class="no">.ins</span><span class="p">,</span> <span class="no">.isp</span><span class="p">,</span> <span class="no">.jar</span><span class="p">,</span> <span class="no">.job</span><span class="p">,</span> <span class="no">.js</span><span class="p">,</span> <span class="no">.jse</span><span class="p">,</span> <span class="no">.lnk</span><span class="p">,</span> <span class="no">.mda</span><span class="p">,</span> <span class="no">.mdb</span><span class="p">,</span> <span class="no">.mde</span><span class="p">,</span> <span class="no">.mdz</span><span class="p">,</span> <span class="no">.msc</span><span class="p">,</span> <span class="no">.msi</span><span class="p">,</span> <span class="no">.msp</span><span class="p">,</span> <span class="no">.mst</span><span class="p">,</span> <span class="no">.ocx</span><span class="p">,</span> <span class="no">.pcd</span><span class="p">,</span> <span class="no">.ps1</span><span class="p">,</span> <span class="no">.reg</span><span class="p">,</span> <span class="no">.scr</span><span class="p">,</span> <span class="no">.sct</span><span class="p">,</span> <span class="no">.shs</span><span class="p">,</span> <span class="no">.svg</span><span class="p">,</span> <span class="no">.url</span><span class="p">,</span> <span class="no">.vb</span><span class="p">,</span> <span class="no">.vbe</span><span class="p">,</span> <span class="no">.vbs</span><span class="p">,</span> <span class="no">.wbk</span><span class="p">,</span> <span class="no">.wsc</span><span class="p">,</span> <span class="no">.ws</span><span class="p">,</span> <span class="no">.wsf</span><span class="p">,</span> <span class="no">.wsh</span><span class="p">,</span> <span class="no">.exe</span><span class="p">,</span> <span class="no">.pif</span><span class="p">,</span> <span class="no">.pub</span><span class="p">,</span> <span class="no">.ip</span></code></p>
<p><strong>References</strong></p>
<ul>
<li><a href="https://technet.microsoft.com/en-us/library/dd759117(v=ws.11).aspx">https://technet.microsoft.com/en-us/library/dd759117(v=ws.11).aspx</a></li>
<li><a href="https://technet.microsoft.com/en-us/library/dd759123(v=ws.11).aspx">https://technet.microsoft.com/en-us/library/dd759123(v=ws.11).aspx</a></li>
<li><a href="https://technet.microsoft.com/en-us/library/dd759116(v=ws.11).aspx">https://technet.microsoft.com/en-us/library/dd759116(v=ws.11).aspx</a></li>
</ul>
<hr />
<h2 id="manual-hunting-and-detection-examples">Manual Hunting and Detection Examples<a class="headerlink" href="#manual-hunting-and-detection-examples" title="Permanent link">&para;</a></h2>
<h3 id="filtering-event-logs-via-powershell">Filtering Event Logs via PowerShell<a class="headerlink" href="#filtering-event-logs-via-powershell" title="Permanent link">&para;</a></h3>
<h5 id="log-locations-on-disk-only-use-event-viewer-or-cli-to-copy">Log locations on disk (only use event viewer or cli to copy)<a class="headerlink" href="#log-locations-on-disk-only-use-event-viewer-or-cli-to-copy" title="Permanent link">&para;</a></h5>
<ol>
<li>XP or older: %windir%system32config</li>
<li>Vista or newer: %windir%system32winevtlogs</li>
</ol>
<h5 id="get-times-service-was-installed-all-evtx-files-should-be-system-and-count">Get times Service was installed (all evtx files, should be system) and count<a class="headerlink" href="#get-times-service-was-installed-all-evtx-files-should-be-system-and-count" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">WinEvent</span> <span class="o">-</span><span class="n">FilterHashtable</span> <span class="o">@</span><span class="err">{</span><span class="n">Path</span><span class="o">=</span><span class="ss">&quot;*.evtx&quot;</span><span class="p">;</span> <span class="n">ID</span><span class="o">=</span><span class="mi">7045</span><span class="err">}</span><span class="o">|</span><span class="n">Measure</span><span class="o">-</span><span class="k">Object</span> <span class="o">-</span><span class="n">Line</span></code></p>
<h5 id="get-blocked-events">Get blocked events<a class="headerlink" href="#get-blocked-events" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">WinEvent</span> <span class="o">-</span><span class="n">FilterHashtable</span> <span class="o">@</span><span class="err">{</span><span class="n">Path</span><span class="o">=</span><span class="ss">&quot;AppLocker.evtx&quot;</span><span class="p">;</span> <span class="n">ID</span><span class="o">=</span><span class="mi">8004</span><span class="err">}</span><span class="o">|</span> <span class="n">Format</span><span class="o">-</span><span class="k">Table</span> <span class="o">-</span><span class="n">Wrap</span></code></p>
<h5 id="get-windowsdefender-actions">Get WindowsDefender actions<a class="headerlink" href="#get-windowsdefender-actions" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">WinEvent</span> <span class="o">-</span><span class="n">FilterHashtable</span> <span class="o">@</span><span class="err">{</span><span class="n">Path</span><span class="o">=</span><span class="ss">&quot;WindowsDefender.evtx&quot;</span><span class="p">;</span> <span class="n">ID</span><span class="o">=</span><span class="mi">1117</span><span class="err">}</span><span class="o">|</span> <span class="n">Format</span><span class="o">-</span><span class="k">Table</span></code></p>
<h5 id="get-windowsdefender-detections">Get WindowsDefender detections<a class="headerlink" href="#get-windowsdefender-detections" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">WinEvent</span> <span class="o">-</span><span class="n">FilterHashtable</span> <span class="o">@</span><span class="err">{</span><span class="n">Path</span><span class="o">=</span><span class="ss">&quot;WindowsDefender.evtx&quot;</span><span class="p">;</span> <span class="n">ID</span><span class="o">=</span><span class="mi">1116</span><span class="err">}</span><span class="o">|</span> <span class="n">Format</span><span class="o">-</span><span class="k">Table</span></code></p>
<h5 id="get-files-by-extension-with-search-from-application-crash">Get files (by extension) with search from Application (crash)<a class="headerlink" href="#get-files-by-extension-with-search-from-application-crash" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="x">Get-WinEvent -FilterHashtable @</span><span class="cp">{</span><span class="nf">Path</span><span class="o">=</span><span class="s2">&quot;application.evtx&quot;</span><span class="cp">}</span><span class="x">|Where </span><span class="cp">{</span><span class="nv">$_.Message</span> <span class="o">-</span><span class="na">like</span> <span class="s2">&quot;*pdf*&quot;</span><span class="cp">}</span><span class="x">|Format-Table -Wrap</span></code></p>
<h5 id="get-emet-events">Get EMET events<a class="headerlink" href="#get-emet-events" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">WinEvent</span> <span class="o">-</span><span class="n">FilterHashtable</span> <span class="o">@</span><span class="err">{</span><span class="n">Path</span><span class="o">=</span><span class="ss">&quot;Win7-Application.evtx&quot;</span><span class="p">;</span> <span class="n">providername</span><span class="o">=</span><span class="ss">&quot;EMET&quot;</span><span class="err">}</span><span class="o">|</span><span class="n">Format</span><span class="o">-</span><span class="k">Table</span> <span class="o">-</span><span class="n">Wrap</span></code></p>
<h5 id="get-service-installs-and-errors">Get service installs and errors<a class="headerlink" href="#get-service-installs-and-errors" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">WinEvent</span> <span class="o">-</span><span class="n">FilterHashtable</span> <span class="o">@</span><span class="err">{</span><span class="n">Path</span><span class="o">=</span><span class="ss">&quot;system.evtx&quot;</span><span class="p">;</span> <span class="n">ID</span><span class="o">=</span><span class="mi">7030</span><span class="p">,</span><span class="mi">7045</span><span class="err">}</span><span class="o">|</span> <span class="n">fl</span></code></p>
<h5 id="search-for-usb-loading">Search for USB loading<a class="headerlink" href="#search-for-usb-loading" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="x">Get-WinEvent -FilterHashtable @</span><span class="cp">{</span><span class="nf">Path</span><span class="o">=</span><span class="s2">&quot;system.evtx&quot;</span><span class="o">;</span> <span class="na">ID</span><span class="o">=</span><span class="m">7045</span><span class="o">,</span><span class="m">10000</span><span class="o">,</span><span class="m">10001</span><span class="o">,</span><span class="m">10100</span><span class="o">,</span><span class="m">20001</span><span class="o">,</span><span class="m">20002</span><span class="o">,</span><span class="m">30003</span><span class="o">,</span><span class="m">24576</span><span class="o">,</span><span class="m">24577</span><span class="o">,</span><span class="m">24579</span><span class="cp">}</span><span class="x">|Where </span><span class="cp">{</span><span class="nv">$_.Message</span> <span class="o">-</span><span class="na">like</span> <span class="s2">&quot;*USB*&quot;</span><span class="cp">}</span><span class="x">|fl</span></code></p>
<h5 id="search-for-errorwarninginfo">Search for error/warning/info<a class="headerlink" href="#search-for-errorwarninginfo" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">WinEvent</span> <span class="o">-</span><span class="n">FilterHashtable</span> <span class="o">@</span><span class="err">{</span><span class="n">Path</span><span class="o">=</span><span class="ss">&quot;application.evtx&quot;</span><span class="p">;</span> <span class="k">level</span><span class="o">=</span><span class="mi">2</span><span class="err">}</span></code></p>
<h5 id="get-remote-eventlog-caution-this-drops-credentials-onto-remote-system">Get remote eventlog (caution this drops credentials onto remote system)<a class="headerlink" href="#get-remote-eventlog-caution-this-drops-credentials-onto-remote-system" title="Permanent link">&para;</a></h5>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">Get</span><span class="o">-</span><span class="n">EventLog</span> <span class="o">-</span><span class="n">List</span> <span class="o">-</span><span class="n">ComputerName</span> <span class="o">&lt;</span><span class="n">ip</span><span class="o">&gt;</span>  
<span class="k">Get</span><span class="o">-</span><span class="n">EventLog</span> <span class="o">-</span><span class="n">LogName</span> <span class="k">System</span> <span class="o">-</span><span class="n">ComputerName</span>
</pre></div>
</td></tr></table>

<h5 id="get-log-within-x-hours">Get log within X hours<a class="headerlink" href="#get-log-within-x-hours" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="x">Get-EventLog System -after (get-date).addhours(-12) | Where </span><span class="cp">{</span><span class="nv">$_.entrytype</span> <span class="o">-</span><span class="na">eq</span> <span class="s2">&quot;warning&quot;</span><span class="cp">}</span><span class="x"></span></code></p>
<h5 id="get-logs-during-downtime">Get logs during "downtime"<a class="headerlink" href="#get-logs-during-downtime" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="x">Get-EventLog -LogName security | ? </span><span class="cp">{</span><span class="nv">$_.EventId</span> <span class="o">-</span><span class="na">eq</span> <span class="m">4624</span> <span class="err"></span><span class="na">and</span> <span class="o">(</span><span class="nv">$_.TimeGenerated.TimeOfDay</span> <span class="o">-</span><span class="na">gt</span> <span class="s1">&#39;20:00:00&#39;</span> <span class="o">-</span><span class="na">or</span> <span class="nv">$_.TimeGenerated.TimeOfDay</span> <span class="o">-</span><span class="na">lt</span> <span class="s1">&#39;08:00:00&#39;</span> <span class="o">)</span> <span class="cp">}</span><span class="x"> | export-csv offhours.csv</span></code></p>
<h5 id="use-wevtutil-to-export-logs-export-log">Use wevtutil to export logs (export-log)<a class="headerlink" href="#use-wevtutil-to-export-logs-export-log" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">wevtutil</span><span class="p">.</span><span class="n">exe</span> <span class="n">epl</span> <span class="k">system</span> <span class="k">system</span><span class="p">.</span><span class="n">evtx</span></code></p>
<h5 id="use-wevutil-to-get-last-20-startups-use-rcomputer-for-remote-and-qe-for-short-query">Use wevutil to get last 20 startups (use /r:computer for remote and qe for short query)<a class="headerlink" href="#use-wevutil-to-get-last-20-startups-use-rcomputer-for-remote-and-qe-for-short-query" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">wevutil</span> <span class="n">query</span><span class="o">-</span><span class="n">events</span> <span class="k">System</span> <span class="o">/</span><span class="k">count</span><span class="p">:</span><span class="mi">20</span> <span class="o">/</span><span class="n">rd</span><span class="p">:</span><span class="k">true</span> <span class="o">/</span><span class="n">format</span><span class="p">:</span><span class="nb">text</span> <span class="o">/</span><span class="n">q</span><span class="p">:</span><span class="ss">&quot;Event[System[(EventID=12)]]&quot;</span></code></p>
<h4 id="windows-consolidated-logging">Windows consolidated logging<a class="headerlink" href="#windows-consolidated-logging" title="Permanent link">&para;</a></h4>
<ol>
<li>enable winrm  <ul>
<li><code class="codehilite"><span class="n">winrm</span> <span class="n">qc</span></code></li>
</ul>
</li>
<li>enable wecutil  <ul>
<li><code class="codehilite"><span class="n">wecutil</span> <span class="n">qc</span></code></li>
</ul>
</li>
<li>Create subscriptions and select events/filters in event viewer  <ul>
<li>via event viewer or  </li>
<li>by PowerShell  <ul>
<li><code class="codehilite"><span class="n">wecutil</span> <span class="n">cs</span> <span class="ss">&quot;Creates a subscription&quot;</span></code></li>
<li><code class="codehilite"><span class="n">wecutil</span> <span class="n">ss</span> <span class="ss">&quot;Sets a subscription&quot;</span></code>  </li>
<li><code class="codehilite"><span class="n">wecutil</span> <span class="n">es</span> <span class="ss">&quot;Views subscriptions&quot;</span></code></li>
</ul>
</li>
</ul>
</li>
</ol>
<h5 id="get-a-detailed-list-of-all-security-auditing-event-entries-use-an-elevated-prompt">Get a detailed list of all security-auditing event entries (use an elevated prompt)<a class="headerlink" href="#get-a-detailed-list-of-all-security-auditing-event-entries-use-an-elevated-prompt" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">wevtutil</span> <span class="n">gp</span> <span class="n">Microsoft</span><span class="o">-</span><span class="n">Windows</span><span class="o">-</span><span class="k">Security</span><span class="o">-</span><span class="n">Auditing</span> <span class="o">/</span><span class="n">ge</span> <span class="o">/</span><span class="n">gm</span><span class="p">:</span><span class="k">true</span></code></p>
<h5 id="return-a-list-of-all-security-auditing-categories-and-subcategories-use-an-elevated-prompt">Return a list of all security-auditing categories and subcategories (use an elevated prompt)<a class="headerlink" href="#return-a-list-of-all-security-auditing-categories-and-subcategories-use-an-elevated-prompt" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">auditpol</span> <span class="o">/</span><span class="n">list</span> <span class="o">/</span><span class="n">subcategory</span><span class="p">:</span><span class="o">*</span></code></p>
<hr />
<h3 id="network">Network<a class="headerlink" href="#network" title="Permanent link">&para;</a></h3>
<h4 id="network-flow-basics">Network Flow Basics:<a class="headerlink" href="#network-flow-basics" title="Permanent link">&para;</a></h4>
<ol>
<li>Prevent traffic on uncommon ports (not if a good threat)</li>
<li>Establish commonality in traffic (size, frequency, browser headers, etc.)</li>
<li>Consistently review outlying DNS entries (very few connections or host traffic)</li>
<li>Identify and investigate unique User-Agent strings</li>
<li>Identify and investigate Base64 encoded strings within the URL</li>
<li>Identify and investigate executables being downloaded and traversing the network</li>
</ol>
<h4 id="basic-pcap-carving-nix">Basic PCAP Carving (*nix)<a class="headerlink" href="#basic-pcap-carving-nix" title="Permanent link">&para;</a></h4>
<p>Note: The snippets below are examples for pcap carving. I'd highly recommend using bro/  for traffic analysis.</p>
<h5 id="get-certificates-from-pcap-use-bro-if-possible">Get certificates from pcap (use BRO if possible)<a class="headerlink" href="#get-certificates-from-pcap-use-bro-if-possible" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">nr</span> <span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="o">-</span><span class="mi">2</span> <span class="o">-</span><span class="n">R</span> <span class="ss">&quot;ssl.handshake.certificate&quot;</span> <span class="o">-</span><span class="n">V</span> <span class="o">&gt;</span> <span class="n">cert</span><span class="p">.</span><span class="n">txt</span></code></p>
<p>or</p>
<p><code class="codehilite"><span class="nv">ssldump</span> <span class="o">-</span><span class="nv">Nr</span> <span class="o">/</span><span class="nv">path</span><span class="o">/</span><span class="nv">file</span>.<span class="nv">pcap</span> <span class="o">|</span> <span class="nv">awk</span> <span class="s1">&#39;</span><span class="s">BEGIN {c=0;} { if ($0 ~ /^[ ]+Certificate$/) {c=1; print &quot;========================================&quot;;} if ($0 !~ /^ +/ ) {c=0;} if (c==1) print $0; }</span><span class="s1">&#39;</span></code></p>
<h5 id="view-certificates-see-bro">View certificates (see BRO)<a class="headerlink" href="#view-certificates-see-bro" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">openssl</span> <span class="n">x509</span> <span class="o">-</span><span class="k">in</span> <span class="n">certsname</span><span class="p">.</span><span class="n">der</span> <span class="o">-</span><span class="n">inform</span> <span class="n">der</span> <span class="o">-</span><span class="nb">text</span> <span class="o">-</span><span class="n">noout</span></code></p>
<h5 id="get-dns-queries-from-pcap-and-count-instances">Get DNS queries from pcap and count instances<a class="headerlink" href="#get-dns-queries-from-pcap-and-count-instances" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="o">-</span><span class="n">T</span> <span class="n">fields</span> <span class="o">-</span><span class="n">e</span> <span class="n">ip</span><span class="p">.</span><span class="n">src</span> <span class="o">-</span><span class="n">e</span> <span class="n">dns</span><span class="p">.</span><span class="n">qry</span><span class="p">.</span><span class="n">name</span> <span class="o">-</span><span class="mi">2</span> <span class="o">-</span><span class="n">R</span> <span class="ss">&quot;dns.flags.response eq 0&quot;</span></code></p>
<p>or</p>
<p><code class="codehilite"><span class="n">tcpdump</span> <span class="err"></span><span class="n">n</span> <span class="err"></span><span class="n">r</span> <span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="ss">&quot;port 53&quot;</span> <span class="mi">2</span><span class="o">&gt;/</span><span class="n">dev</span><span class="o">/</span><span class="k">null</span><span class="o">|</span><span class="n">grep</span> <span class="err"></span><span class="n">E</span> <span class="s1">&#39;A?&#39;</span><span class="o">|</span><span class="n">awk</span> <span class="s1">&#39;{print $(NF-1)}&#39;</span><span class="o">|</span><span class="n">sort</span><span class="o">|</span><span class="n">uniq</span> <span class="err"></span><span class="k">c</span><span class="o">|</span><span class="n">sort</span> <span class="err"></span><span class="n">n</span></code></p>
<h5 id="get-dns-queries-from-nx-domain">Get DNS queries from NX domain<a class="headerlink" href="#get-dns-queries-from-nx-domain" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="o">-</span><span class="n">T</span> <span class="n">fields</span> <span class="o">-</span><span class="n">e</span> <span class="n">ip</span><span class="p">.</span><span class="n">src</span> <span class="o">-</span><span class="n">e</span> <span class="n">dns</span><span class="p">.</span><span class="n">qry</span><span class="p">.</span><span class="n">name</span> <span class="o">-</span><span class="mi">2</span> <span class="o">-</span><span class="n">R</span> <span class="ss">&quot;dns.flags.rcode eq 3&quot;</span></code></p>
<h5 id="dns-response-codes">DNS Response Codes<a class="headerlink" href="#dns-response-codes" title="Permanent link">&para;</a></h5>
<table>
<thead>
<tr>
<th>RCODE</th>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>NoError</td>
<td>No Error</td>
</tr>
<tr>
<td>1</td>
<td>FormErr</td>
<td>Format Error</td>
</tr>
<tr>
<td>2</td>
<td>ServFail</td>
<td>Server Failure</td>
</tr>
<tr>
<td>3</td>
<td>NXDomain</td>
<td>Non-Existent Domain</td>
</tr>
<tr>
<td>4</td>
<td>NotImp</td>
<td>Not Implemented</td>
</tr>
<tr>
<td>5</td>
<td>Refused</td>
<td>Query Refused</td>
</tr>
<tr>
<td>6</td>
<td>YXDomain</td>
<td>Name Exists when it should not</td>
</tr>
<tr>
<td>7</td>
<td>YXRRSet</td>
<td>RR Set Exists when it should not</td>
</tr>
<tr>
<td>8</td>
<td>NXRRSet</td>
<td>RR Set that should exist does not</td>
</tr>
<tr>
<td>9</td>
<td>NotAuth</td>
<td>Server Not Authoritative for zone</td>
</tr>
<tr>
<td>9</td>
<td>NotAuth</td>
<td>Not Authorized</td>
</tr>
<tr>
<td>10</td>
<td>NotZone</td>
<td>Name not contained in zone</td>
</tr>
<tr>
<td>16</td>
<td>BADVERS</td>
<td>Bad OPT Version</td>
</tr>
<tr>
<td>16</td>
<td>BADSIG</td>
<td>TSIG Signature Failure</td>
</tr>
<tr>
<td>17</td>
<td>BADKEY</td>
<td>Key not recognized</td>
</tr>
<tr>
<td>18</td>
<td>BADTIME</td>
<td>Signature out of time window</td>
</tr>
<tr>
<td>19</td>
<td>BADMODE</td>
<td>Bad TKEY Mode</td>
</tr>
<tr>
<td>20</td>
<td>BADNAME</td>
<td>Duplicate key name</td>
</tr>
<tr>
<td>21</td>
<td>BADALG</td>
<td>Algorithm not supported</td>
</tr>
<tr>
<td>22</td>
<td>BADTRUNC</td>
<td>Bad Truncation</td>
</tr>
<tr>
<td>23</td>
<td>BADCOOKIE</td>
<td>Bad/missing Server Cookie</td>
</tr>
</tbody>
</table>
<h5 id="get-user-agents-from-pcap">Get User-Agents from pcap<a class="headerlink" href="#get-user-agents-from-pcap" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="o">-</span><span class="n">T</span> <span class="n">fields</span> <span class="o">-</span><span class="n">e</span> <span class="n">http</span><span class="p">.</span><span class="n">user_agent</span><span class="o">|</span><span class="n">sort</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">k1</span><span class="o">|</span><span class="n">uniq</span> <span class="o">-</span><span class="k">c</span><span class="o">|</span><span class="n">sort</span> <span class="o">-</span><span class="n">n</span></code></p>
<p>or</p>
<p><code class="codehilite"><span class="n">tcpdump</span> <span class="err"></span><span class="n">n</span> <span class="err"></span><span class="n">A</span> <span class="err"></span><span class="n">r</span> <span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="s1">&#39;tcp port 80&#39;</span><span class="o">|</span><span class="n">egrep</span> <span class="err"></span><span class="n">I</span> <span class="ss">&quot;User-Agent&quot;</span><span class="o">|</span><span class="n">sort</span><span class="o">|</span><span class="n">uniq</span> <span class="err"></span><span class="k">c</span><span class="o">|</span><span class="n">sort</span> <span class="o">-</span><span class="n">n</span></code></p>
<p>or</p>
<p><code class="codehilite"><span class="n">strings</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="o">|</span><span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="k">User</span><span class="o">-</span><span class="n">Agent</span><span class="o">|</span><span class="n">uniq</span> <span class="o">-</span><span class="k">c</span><span class="o">|</span><span class="n">sort</span> <span class="o">-</span><span class="n">n</span></code></p>
<h5 id="get-info-for-frame-containing-search-dataf">Get info for frame containing search dataf<a class="headerlink" href="#get-info-for-frame-containing-search-dataf" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="mi">10</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">52</span><span class="p">:</span><span class="mi">1082</span><span class="n">_10</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">19</span><span class="p">.</span><span class="mi">32</span><span class="p">:</span><span class="mi">80</span><span class="o">-</span><span class="mi">6</span><span class="p">.</span><span class="n">raw</span> <span class="o">-</span><span class="mi">2</span> <span class="o">-</span><span class="n">R</span> <span class="s1">&#39;frame contains &quot;MZ&quot;&#39;</span></code></p>
<h5 id="search-for-string-in-tcp-data-finds-data-not-in-field-ie-ua-in-json">Search for string in tcp data (finds data not in field i.e. UA in json)<a class="headerlink" href="#search-for-string-in-tcp-data-finds-data-not-in-field-ie-ua-in-json" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="o">-</span><span class="n">T</span> <span class="n">pdml</span> <span class="o">-</span><span class="n">T</span> <span class="n">fields</span> <span class="o">-</span><span class="n">e</span> <span class="n">tcp</span><span class="p">.</span><span class="k">data</span> <span class="o">-</span><span class="mi">2</span> <span class="o">-</span><span class="n">R</span> <span class="s1">&#39;tcp contains &quot;User-Agent&quot;&#39;</span><span class="o">|</span><span class="n">sed</span> <span class="n">s</span><span class="o">/</span><span class="p">:</span><span class="o">//</span><span class="k">g</span><span class="o">|</span><span class="n">xxd</span> <span class="o">-</span><span class="n">p</span> <span class="o">-</span><span class="n">r</span><span class="o">|</span><span class="n">grep</span> <span class="o">-</span><span class="n">a</span> <span class="k">User</span><span class="o">-</span><span class="n">Agent</span><span class="o">|</span><span class="n">uniq</span> <span class="o">-</span><span class="k">c</span></code></p>
<h5 id="find-strings-in-pcap">Find strings in pcap<a class="headerlink" href="#find-strings-in-pcap" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">r</span> <span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="o">-</span><span class="n">T</span> <span class="n">pdml</span> <span class="o">-</span><span class="n">T</span> <span class="n">fields</span> <span class="o">-</span><span class="n">e</span> <span class="n">irc</span><span class="p">.</span><span class="n">response</span> <span class="o">-</span><span class="n">Y</span> <span class="s1">&#39;frame contains &quot;badguy&quot;&#39;</span></code></p>
<p>or</p>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">r</span> <span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="o">-</span><span class="n">T</span> <span class="n">pdml</span> <span class="o">-</span><span class="n">Y</span> <span class="s1">&#39;frame contains &quot;badguy&quot;&#39;</span><span class="o">|</span><span class="n">grep</span> <span class="n">badguy</span></code></p>
<p>or</p>
<p><code class="codehilite"><span class="n">ngrep</span> <span class="o">-</span><span class="n">q</span> <span class="o">-</span><span class="n">I</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="ss">&quot;badguy&quot;</span></code></p>
<p>or</p>
<p><code class="codehilite"><span class="n">strings</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="o">|</span><span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="k">User</span><span class="o">-</span><span class="n">Agent</span> <span class="o">|</span><span class="n">sort</span> <span class="o">-</span><span class="n">u</span></code></p>
<p>or</p>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="o">-</span><span class="n">T</span> <span class="n">pdml</span> <span class="o">-</span><span class="mi">2</span> <span class="o">-</span><span class="n">R</span> <span class="s1">&#39;frame contains &quot;User-Agent&quot;&#39;</span><span class="o">|</span><span class="n">grep</span> <span class="k">User</span><span class="o">-</span><span class="n">Agent</span></code></p>
<h5 id="get-the-frame-that-contains-string">Get the frame that contains string<a class="headerlink" href="#get-the-frame-that-contains-string" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">r</span> <span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="o">-</span><span class="mi">2</span> <span class="o">-</span><span class="n">R</span> <span class="err">&#39;</span><span class="n">frame</span> <span class="k">contains</span> <span class="ss">&quot;badguy&quot;</span></code></p>
<h5 id="show-packet-data-by-field">Show packet data by field<a class="headerlink" href="#show-packet-data-by-field" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">nr</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="o">-</span><span class="n">T</span> <span class="n">fields</span> <span class="o">-</span><span class="n">e</span> <span class="n">http</span><span class="p">.</span><span class="n">user_agent</span> <span class="o">-</span><span class="mi">2</span> <span class="o">-</span><span class="n">R</span> <span class="n">http</span><span class="p">.</span><span class="n">user_agent</span></code></p>
<h5 id="get-data-hex-from-first-two-packets-in-pcap">Get data &amp; hex from first two packets in pcap<a class="headerlink" href="#get-data-hex-from-first-two-packets-in-pcap" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tcpdump</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="o">-</span><span class="n">c2</span> <span class="o">-</span><span class="n">x</span> <span class="o">-</span><span class="n">v</span></code></p>
<h5 id="get-frames-that-have-tcp-header-length-gt-20-and-port-25">Get frames that have tcp header length gt 20 and port 25<a class="headerlink" href="#get-frames-that-have-tcp-header-length-gt-20-and-port-25" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="o">-</span><span class="n">Y</span> <span class="s1">&#39;tcp.hdr_len &gt; 20 &amp;&amp; tcp.port == 25&#39;</span></code></p>
<h5 id="get-data-in-frames-that-have-tcp-header-length-gt-20-and-port-25">Get data in frames that have tcp header length gt 20 and port 25<a class="headerlink" href="#get-data-in-frames-that-have-tcp-header-length-gt-20-and-port-25" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="o">-</span><span class="n">T</span> <span class="n">pdml</span> <span class="o">-</span><span class="n">T</span> <span class="n">fields</span> <span class="o">-</span><span class="n">e</span> <span class="n">tcp</span><span class="p">.</span><span class="n">port</span> <span class="o">-</span><span class="n">e</span> <span class="n">tcp</span><span class="p">.</span><span class="n">hdr_len</span> <span class="o">-</span><span class="n">Y</span> <span class="s1">&#39;tcp.hdr_len &gt; 20 &amp;&amp; tcp.port == 25&#39;</span></code></p>
<h5 id="get-frames-with-hex-data-0x7932">Get frames with hex data 0x7932<a class="headerlink" href="#get-frames-with-hex-data-0x7932" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="o">-</span><span class="n">Y</span> <span class="s1">&#39;ip.id == 0x7932&#39;</span></code></p>
<h5 id="get-frames-and-show-hex-data">Get frames and show hex data<a class="headerlink" href="#get-frames-and-show-hex-data" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="o">-</span><span class="n">T</span> <span class="n">pdml</span> <span class="o">-</span><span class="n">T</span> <span class="n">fields</span> <span class="o">-</span><span class="n">e</span> <span class="n">ip</span><span class="p">.</span><span class="n">id</span> <span class="o">-</span><span class="n">Y</span> <span class="s1">&#39;ip.id == 0x7932&#39;</span></code></p>
<h5 id="get-all-arp-request-and-count-request1-reply2">Get all arp request and count (request=1, reply=2)<a class="headerlink" href="#get-all-arp-request-and-count-request1-reply2" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">r</span> <span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="o">-</span><span class="n">Y</span> <span class="s1">&#39;arp.opcode == 1&#39;</span><span class="o">|</span><span class="n">wc</span> <span class="o">-</span><span class="n">l</span></code></p>
<h5 id="get-iplen-less-than-46-64-for-ethernet-minus-14-header-and-4-trailer-icmp-of-0">Get ip.len less than 46 (64 for ethernet minus 14 header and 4 trailer) &amp; icmp of 0<a class="headerlink" href="#get-iplen-less-than-46-64-for-ethernet-minus-14-header-and-4-trailer-icmp-of-0" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">r</span> <span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="o">-</span><span class="n">Y</span> <span class="s1">&#39;ip.len &lt; 46 &amp;&amp; icmp.type == 0&#39;</span></code></p>
<h5 id="get-ip-option-of-loose-src-routing-with-offset-starting-at-ip-options">Get ip option of loose src routing with offset starting at ip options<a class="headerlink" href="#get-ip-option-of-loose-src-routing-with-offset-starting-at-ip-options" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">r</span> <span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="o">-</span><span class="n">Y</span> <span class="s1">&#39;ip[20] == 0x83 &amp;&amp; ip.hdr_len &gt;20&#39;</span></code></p>
<h5 id="filter-info">Filter Info<a class="headerlink" href="#filter-info" title="Permanent link">&para;</a></h5>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">URG</span> <span class="o">=</span> <span class="mi">32</span> <span class="k">or</span> <span class="mi">0</span><span class="n">x20</span>  
<span class="n">ACK</span> <span class="o">=</span> <span class="mi">16</span> <span class="k">or</span> <span class="mi">0</span><span class="n">x10</span>  
<span class="n">PSH</span> <span class="o">=</span> <span class="mi">8</span> <span class="k">or</span> <span class="mi">0</span><span class="n">x08</span>  
<span class="n">RST</span> <span class="o">=</span> <span class="mi">4</span> <span class="k">or</span> <span class="mi">0</span><span class="n">x04</span>  
<span class="n">SYN</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">or</span> <span class="mi">0</span><span class="n">x02</span>  
<span class="n">FIN</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">or</span> <span class="mi">0</span><span class="n">x01</span>  
<span class="k">All</span> <span class="o">=</span> <span class="mi">0</span><span class="n">xFF</span>
</pre></div>
</td></tr></table>

<p>Examples:<br />
<code class="codehilite"><span class="s1">&#39;tcp[13] &amp; 2 !=0&#39;</span> <span class="k">Get</span> <span class="k">all</span> <span class="n">SYN</span></code></p>
<p><code class="codehilite"><span class="s1">&#39;tcp[13] &amp; 4 !=0&#39;</span> <span class="k">Get</span> <span class="k">all</span> <span class="n">RST</span></code></p>
<p><code class="codehilite"><span class="s1">&#39;tcp[13] &amp; 16 !=0&#39;</span> <span class="k">Get</span> <span class="k">all</span> <span class="n">ACK</span></code></p>
<h5 id="get-frame-with-ip-src-and-ack-flag-set">Get frame with IP src and ACK flag set<a class="headerlink" href="#get-frame-with-ip-src-and-ack-flag-set" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="s1">&#39;((ip.src == 192.168.10.1) and (tcp.flags.ack==1))&#39;</span></code></p>
<p>or</p>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="s1">&#39;tcp[13] == 0x10 &amp;&amp; ip.src == 192.168.10.1&#39;</span></code></p>
<p>or</p>
<p><code class="codehilite"><span class="n">tcpdump</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="s1">&#39;src host 192.168.10.1 and tcp[13] = 0x10&#39;</span></code></p>
<h5 id="get-frame-with-ip-src-and-ack-or-rst-flag-set">Get frame with IP src and ACK or RST flag set<a class="headerlink" href="#get-frame-with-ip-src-and-ack-or-rst-flag-set" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="s1">&#39;((ip.src == 192.168.10.1) and (tcp.flags.syn==1 or tcp.flags.reset==1))&#39;</span></code></p>
<p>or</p>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="s1">&#39;ip.src == 192.168.10.1 &amp;&amp; tcp[13] == 0x14 or tcp[13] == 0x10 or tcp[13] == 0x04&#39;</span></code></p>
<p>or</p>
<p><code class="codehilite"><span class="n">tcpdump</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="s1">&#39;src host 192.168.10.1 and tcp[13] &amp; 0x14 !=0&#39;</span></code></p>
<h5 id="get-frame-with-dst-port-0-and-df-flag-set">Get frame with dst port 0 and DF flag set<a class="headerlink" href="#get-frame-with-dst-port-0-and-df-flag-set" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="s1">&#39;tcp.port == 0 &amp;&amp; ip[6] == 0x40&#39;</span></code></p>
<h5 id="get-frame-with-net-1010101024">Get frame with net 10.10.10.10/24<a class="headerlink" href="#get-frame-with-net-1010101024" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tcpdump</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="s1">&#39;dst net 10.10.10 and ip[19] &amp; 0xd0 = 0xd0&#39;</span></code></p>
<h5 id="get-frames-by-ip">Get frames by ip<a class="headerlink" href="#get-frames-by-ip" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">r</span> <span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="s1">&#39;((ip.addr == 10.10.10.10) and (ip.addr == 192.168.10.11))&#39;</span></code></p>
<h5 id="view-specific-frame-verbose-note-tcp-stream-index-number">View specific frame verbose (note tcp stream index number)<a class="headerlink" href="#view-specific-frame-verbose-note-tcp-stream-index-number" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">r</span> <span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="o">-</span><span class="n">Y</span> <span class="n">frame</span><span class="p">.</span><span class="nb">number</span><span class="o">==</span><span class="mi">12</span> <span class="o">-</span><span class="n">V</span></code></p>
<h5 id="follow-tcp-stream-0-ascii-raw-hex">Follow tcp stream 0 (ascii, raw, hex)<a class="headerlink" href="#follow-tcp-stream-0-ascii-raw-hex" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tshark</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">r</span> <span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="o">-</span><span class="n">z</span> <span class="ss">&quot;follow,tcp,ascii,0&quot;</span></code></p>
<h4 id="flow-data-analysis">Flow Data Analysis<a class="headerlink" href="#flow-data-analysis" title="Permanent link">&para;</a></h4>
<h5 id="use-rwfilter-to-analyze-flow-data-by-ip-and-port">Use rwfilter to analyze flow data by IP and port<a class="headerlink" href="#use-rwfilter-to-analyze-flow-data-by-ip-and-port" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">rwfilter</span> <span class="n">suspicious</span><span class="p">.</span><span class="n">silk</span> <span class="c1">--any-address=192.168.10.10 --aport=1088 --print-stat</span></code></p>
<h5 id="view-detail-of-flow-data-by-ip-and-port">View detail of flow data by IP and port<a class="headerlink" href="#view-detail-of-flow-data-by-ip-and-port" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">rwfilter</span> <span class="n">suspicious</span><span class="p">.</span><span class="n">silk</span> <span class="c1">--any-address=192.168.10.10 --aport=1088 --pass=stdout|rwcut</span></code></p>
<h5 id="extract-all-udp-from-flow-then-pipe-to-get-field-4-4dst-port-3srcport-5proto-6packets-etc">Extract all UDP from flow then pipe to get field 4 (4=dst port, 3=srcport, 5=proto, 6=packets, etc)<a class="headerlink" href="#extract-all-udp-from-flow-then-pipe-to-get-field-4-4dst-port-3srcport-5proto-6packets-etc" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">rwfilter</span> <span class="n">suspicious</span><span class="p">.</span><span class="n">silk</span> <span class="c1">--proto=17 --pass=stdout|rwuniq --fields=4</span></code></p>
<h5 id="extract-connections-from-108-with-a-reset-to-close-then-pipe-to-get-srcip-count">Extract connections from 10/8 with a reset to close then pipe to get srcIP count<a class="headerlink" href="#extract-connections-from-108-with-a-reset-to-close-then-pipe-to-get-srcip-count" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">rwfilter</span> <span class="n">suspicious</span><span class="p">.</span><span class="n">silk</span> <span class="c1">--any-address=10.10.0.0/16 --flags-all=R/R --pass=stdout|rwuniq --fields=1</span></code></p>
<h5 id="use-rwstats-to-get-flow-data-of-top-5-flows">Use rwstats to get flow data of top 5 flows<a class="headerlink" href="#use-rwstats-to-get-flow-data-of-top-5-flows" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">rwstats</span> <span class="n">suspicious</span><span class="p">.</span><span class="n">silk</span> <span class="c1">--fields sIP --bytes --count=5</span></code></p>
<h5 id="extract-records-not-icmp-tcp-or-udp-note-fail-and-have-src-ip-of-1010101">Extract records not ICMP, TCP or UDP (note fail) and have src IP of 10.10.10.1<a class="headerlink" href="#extract-records-not-icmp-tcp-or-udp-note-fail-and-have-src-ip-of-1010101" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">rwfilter</span> <span class="n">suspicious</span><span class="p">.</span><span class="n">silk</span> <span class="c1">--proto=1,6,17 --fail=stdout|rwfilter --input-pipe=stdin --saddress=10.10.10.1 --pass=stdout | rwcut</span></code></p>
<p>or</p>
<p><code class="codehilite"><span class="n">rwfilter</span> <span class="n">suspicious</span><span class="p">.</span><span class="n">silk</span> <span class="c1">--proto=0,2-5,7-16,18- --saddress=10.10.10.1 --pass=stdout | rwcut</span></code></p>
<h5 id="get-top-5-ip-with-data-transfer">Get top 5 IP with data transfer<a class="headerlink" href="#get-top-5-ip-with-data-transfer" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">rwstats</span> <span class="n">phishing</span><span class="o">-</span><span class="n">attack</span><span class="p">.</span><span class="n">silk</span> <span class="c1">--fields=sip --top --bytes --count 5</span></code></p>
<h5 id="get-flows-with-larger-than-100000-bytes">Get flows with larger than 100,000 bytes<a class="headerlink" href="#get-flows-with-larger-than-100000-bytes" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">rwfilter</span> <span class="n">phishing</span><span class="o">-</span><span class="n">attack</span><span class="p">.</span><span class="n">silk</span> <span class="c1">--proto=6 --bytes=100000- --pass=stdout |rwcut -f 1-8</span></code></p>
<hr />
<h4 id="elsa-bro-queries">ELSA (BRO queries)<a class="headerlink" href="#elsa-bro-queries" title="Permanent link">&para;</a></h4>
<h5 id="elsa-most-common-svc">ELSA most common svc<a class="headerlink" href="#elsa-most-common-svc" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">class</span>=<span class="n">BRO_CONN</span> <span class="n">groupby:service</span></code></p>
<h5 id="elsa-bro-nx-domains">ELSA BRO nx domains<a class="headerlink" href="#elsa-bro-nx-domains" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">class</span>=<span class="n">BRO_DNS</span> <span class="n">nxdomain</span> <span class="n">groupby:hostname</span></code></p>
<h5 id="elsa-bro-common-fqdn">ELSA BRO common FQDN<a class="headerlink" href="#elsa-bro-common-fqdn" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">class</span>=<span class="n">BRO_HTTP</span> <span class="s">&quot;-&quot;</span> <span class="n">groupby:site</span></code></p>
<h5 id="elsa-bro-sites-hosting-exe">ELSA BRO Sites hosting EXE<a class="headerlink" href="#elsa-bro-sites-hosting-exe" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">class</span>=<span class="n">BRO_HTTP</span> <span class="n">BRO_HTTP</span>.<span class="n">mime_type</span>=<span class="s">&quot;x-dosexec&quot;</span> <span class="n">groupby:site</span></code></p>
<h5 id="elsa-bro-uri-with-exe-downloads">ELSA BRO URI with EXE downloads<a class="headerlink" href="#elsa-bro-uri-with-exe-downloads" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">class</span>=<span class="n">BRO_HTTP</span> <span class="n">BRO_HTTP</span>.<span class="n">mime_type</span>=<span class="s">&quot;x-dosexec&quot;</span> <span class="n">groupby:BRO_HTTP</span>.<span class="n">uri</span></code></p>
<h5 id="elsa-bro-internal-ip-exe-download">ELSA BRO Internal IP EXE download<a class="headerlink" href="#elsa-bro-internal-ip-exe-download" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">class</span>=<span class="n">BRO_FILES</span> <span class="s">&quot;-&quot;</span> <span class="n">mime_type</span>=<span class="s">&quot;application/x-dosexec&quot;</span> <span class="n">groupby:rx_hosts</span></code></p>
<h5 id="elsa-bro-connections-wo-ua-group-by-source-ip">ELSA BRO connections w/o UA group by source IP<a class="headerlink" href="#elsa-bro-connections-wo-ua-group-by-source-ip" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">class</span>=<span class="n">BRO_HTTP</span> <span class="s">&quot;-&quot;</span> <span class="n">user_agent</span>=<span class="s">&quot;-&quot;</span> <span class="n">groupby:srcipt</span></code></p>
<hr />
<h4 id="bro">BRO<a class="headerlink" href="#bro" title="Permanent link">&para;</a></h4>
<h5 id="bro-logs">BRO Logs<a class="headerlink" href="#bro-logs" title="Permanent link">&para;</a></h5>
<p>Just a few logs that can be used to gather information. Note, custom logs can be created and referenced using the BRO.</p>
<h5 id="bro-log-hunting">BRO Log Hunting<a class="headerlink" href="#bro-log-hunting" title="Permanent link">&para;</a></h5>
<table>
<thead>
<tr>
<th>BRO log</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>conn.log</td>
<td>IP/protocol connections</td>
</tr>
<tr>
<td>conn-summary.log</td>
<td>Statistics/summarizes activity</td>
</tr>
<tr>
<td>known_hosts.log</td>
<td>New hosts within past hour</td>
</tr>
<tr>
<td>known_serices.log</td>
<td>New services within past hour</td>
</tr>
<tr>
<td>dpd.log</td>
<td>Dynamic protocol detection</td>
</tr>
<tr>
<td>weird.log</td>
<td>Anomalous activity</td>
</tr>
<tr>
<td>loaded_scripts.log</td>
<td>Scripts loaded on start</td>
</tr>
<tr>
<td>reporter.log</td>
<td>Severity of issues with bro</td>
</tr>
<tr>
<td>software.log</td>
<td>Determines version of detected protocol</td>
</tr>
<tr>
<td>various protocols (http,dns,ssl,etc)</td>
<td>Activity log per protocol</td>
</tr>
</tbody>
</table>
<h5 id="bro-protocol-logs">BRO Protocol Logs<a class="headerlink" href="#bro-protocol-logs" title="Permanent link">&para;</a></h5>
<table>
<thead>
<tr>
<th>BRO log</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>conn.log</td>
<td>TCP/UDP/ICMP connections</td>
</tr>
<tr>
<td>dce_rpc.log</td>
<td>Distributed Computing Environment/RPC</td>
</tr>
<tr>
<td>dhcp.log</td>
<td>DHCP leases</td>
</tr>
<tr>
<td>dnp3.log</td>
<td>DNP3 requests and replies</td>
</tr>
<tr>
<td>dns.log</td>
<td>DNS activity</td>
</tr>
<tr>
<td>ftp.log</td>
<td>FTP activity</td>
</tr>
<tr>
<td>http.log</td>
<td>HTTP requests and replies</td>
</tr>
<tr>
<td>irc.log</td>
<td>IRC commands and responses</td>
</tr>
<tr>
<td>kerberos.log</td>
<td>Kerberos</td>
</tr>
<tr>
<td>modbus.log</td>
<td>Modbus commands and responses</td>
</tr>
<tr>
<td>modbus_register_change.log</td>
<td>Tracks changes to Modbus holding registers</td>
</tr>
<tr>
<td>mysql.log</td>
<td>MySQL</td>
</tr>
<tr>
<td>ntlm.log</td>
<td>NT LAN Manager (NTLM)</td>
</tr>
<tr>
<td>radius.log</td>
<td>RADIUS authentication attempts</td>
</tr>
<tr>
<td>rdp.log</td>
<td>RDP RDP</td>
</tr>
<tr>
<td>rfb.log</td>
<td>Remote Framebuffer (RFB)</td>
</tr>
<tr>
<td>sip.log</td>
<td>SIP</td>
</tr>
<tr>
<td>smb_cmd.log</td>
<td>SMB commands</td>
</tr>
<tr>
<td>smb_files.log</td>
<td>SMB files</td>
</tr>
<tr>
<td>smb_mapping.log</td>
<td>SMB trees</td>
</tr>
<tr>
<td>smtp.log</td>
<td>SMTP transactions</td>
</tr>
<tr>
<td>snmp.log</td>
<td>SNMP messages</td>
</tr>
<tr>
<td>socks.log</td>
<td>SOCKS proxy requests</td>
</tr>
<tr>
<td>ssh.log</td>
<td>SSH connections</td>
</tr>
<tr>
<td>ssl.log</td>
<td>SSL/TLS handshake info</td>
</tr>
<tr>
<td>syslog.log</td>
<td>Syslog messages</td>
</tr>
<tr>
<td>tunnel.log</td>
<td>Tunneling protocol events</td>
</tr>
</tbody>
</table>
<p><strong>BRO Log Reference</strong><br />
 <a href="https://www.bro.org/sphinx-git/script-reference/log-files.html">https://www.bro.org/sphinx-git/script-reference/log-files.html</a></p>
<h4 id="bro-carving">BRO Carving<a class="headerlink" href="#bro-carving" title="Permanent link">&para;</a></h4>
<h5 id="read-and-output-bro-logs">Read and output bro logs<a class="headerlink" href="#read-and-output-bro-logs" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">bro</span> <span class="o">-</span><span class="n">r</span> <span class="n">file</span><span class="p">.</span><span class="n">pcap</span></code></p>
<h5 id="get-source-src-ip-dst-ip-dst-port-and-bytes-in-that-order">Get source src ip, dst ip, dst port, and bytes (in that order)<a class="headerlink" href="#get-source-src-ip-dst-ip-dst-port-and-bytes-in-that-order" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">cat</span> <span class="n">conn</span><span class="p">.</span><span class="n">log</span> <span class="o">|</span><span class="n">bro</span><span class="o">-</span><span class="n">cut</span> <span class="n">id</span><span class="p">.</span><span class="n">orig_h</span> <span class="n">id</span><span class="p">.</span><span class="n">resp_h</span> <span class="n">id</span><span class="p">.</span><span class="n">resp_p</span> <span class="n">orig_bytes</span> <span class="o">|</span><span class="n">head</span> <span class="o">-</span><span class="mi">2</span></code></p>
<h5 id="same-as-above-but-sort-by-bytes-field-5-reverse-by-number">Same as above but sort by bytes (field 5 reverse by number)<a class="headerlink" href="#same-as-above-but-sort-by-bytes-field-5-reverse-by-number" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">cat</span> <span class="n">conn</span><span class="p">.</span><span class="n">log</span> <span class="o">|</span><span class="n">bro</span><span class="o">-</span><span class="n">cut</span> <span class="n">id</span><span class="p">.</span><span class="n">orig_h</span> <span class="n">id</span><span class="p">.</span><span class="n">orig_p</span> <span class="n">id</span><span class="p">.</span><span class="n">resp_h</span> <span class="n">id</span><span class="p">.</span><span class="n">resp_p</span> <span class="n">orig_bytes</span><span class="o">|</span><span class="n">sort</span> <span class="o">-</span><span class="n">k</span> <span class="mi">5</span> <span class="o">-</span><span class="n">rn</span></code></p>
<h5 id="get-http-on-non-standard-ports-ssl">Get http on non-standard ports (ssl?)<a class="headerlink" href="#get-http-on-non-standard-ports-ssl" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">cat</span> <span class="n">conn</span><span class="p">.</span><span class="n">log</span> <span class="o">|</span> <span class="n">bro</span><span class="o">-</span><span class="n">cut</span> <span class="n">service</span> <span class="n">id</span><span class="p">.</span><span class="n">resp_p</span> <span class="n">id</span><span class="p">.</span><span class="n">resp_h</span> <span class="o">|</span> <span class="n">awk</span> <span class="s1">&#39;$1 == &quot;http&quot; &amp;&amp; ! ($2 == 80 || $2 == 8080) { print $3 }&#39;</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">-</span><span class="n">u</span></code></p>
<h5 id="extract-dns-info-from-bro-logs">Extract DNS info from bro logs<a class="headerlink" href="#extract-dns-info-from-bro-logs" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">cat</span> <span class="n">dns</span><span class="p">.</span><span class="n">log</span> <span class="o">|</span><span class="n">bro</span><span class="o">-</span><span class="n">cut</span> <span class="n">query</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">-</span><span class="n">u</span></code></p>
<p>and</p>
<p><code class="codehilite"><span class="n">cat</span> <span class="n">dns</span><span class="p">.</span><span class="n">log</span> <span class="o">|</span> <span class="n">bro</span><span class="o">-</span><span class="n">cut</span> <span class="o">-</span><span class="n">d</span> <span class="n">answers</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">-</span><span class="n">u</span></code></p>
<h5 id="get-user-agents">Get User-Agents<a class="headerlink" href="#get-user-agents" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">cat</span> <span class="n">http</span><span class="p">.</span><span class="n">log</span> <span class="o">|</span> <span class="n">bro</span><span class="o">-</span><span class="n">cut</span> <span class="n">user_agent</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">|</span> <span class="n">uniq</span> <span class="o">-</span><span class="k">c</span> <span class="o">|</span><span class="n">sort</span> <span class="o">-</span><span class="n">n</span></code></p>
<h5 id="get-mime-types">Get Mime Types<a class="headerlink" href="#get-mime-types" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">cat</span> <span class="n">http</span><span class="p">.</span><span class="n">log</span> <span class="o">|</span> <span class="n">bro</span><span class="o">-</span><span class="n">cut</span> <span class="n">orig_mime_type</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">|</span> <span class="n">uniq</span> <span class="o">-</span><span class="k">c</span> <span class="o">|</span><span class="n">sort</span> <span class="o">-</span><span class="n">n</span></code></p>
<h5 id="get-bro-outbound-signature-stored-in-sig-file-read-with-s">Get bro outbound signature stored in .sig file (read with -s)<a class="headerlink" href="#get-bro-outbound-signature-stored-in-sig-file-read-with-s" title="Permanent link">&para;</a></h5>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">signature</span> <span class="n">outbound</span><span class="o">-</span><span class="n">sig</span> <span class="err">{</span>  
<span class="n">ip</span><span class="o">-</span><span class="n">proto</span> <span class="o">==</span> <span class="n">tcp</span>  
<span class="n">src</span><span class="o">-</span><span class="n">ip</span> <span class="o">==</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">16</span>  
<span class="n">dst</span><span class="o">-</span><span class="n">ip</span> <span class="o">!=</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">16</span>  
<span class="n">dst</span><span class="o">-</span><span class="n">port</span> <span class="o">==</span> <span class="mi">80</span>  
<span class="n">http</span><span class="o">-</span><span class="n">request</span><span class="o">-</span><span class="n">header</span> <span class="o">/^</span><span class="k">User</span><span class="o">-</span><span class="n">Agent</span><span class="p">:.</span><span class="o">*/</span>  
<span class="n">event</span> <span class="ss">&quot;Outbound HTTP traffic&quot;</span>  
<span class="err">}</span>
</pre></div>
</td></tr></table>

<h5 id="get-bro-windows-shell-signature-stored-in-sig-file-read-with-s">Get bro Windows Shell signature stored in .sig file (read with -s)<a class="headerlink" href="#get-bro-windows-shell-signature-stored-in-sig-file-read-with-s" title="Permanent link">&para;</a></h5>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">signature</span> <span class="n">windows_reverse_shell</span> <span class="err">{</span>  
<span class="n">ip</span><span class="o">-</span><span class="n">proto</span> <span class="o">==</span> <span class="n">tcp</span>  
<span class="n">tcp</span><span class="o">-</span><span class="k">state</span> <span class="n">established</span><span class="p">,</span><span class="n">originator</span>  
<span class="n">event</span> <span class="ss">&quot;ATTACK-RESPONSES Microsoft cmd.exe banner (reverse-shell originator)&quot;</span>  
<span class="n">payload</span> <span class="o">/</span><span class="p">.</span><span class="o">*</span><span class="n">Microsoft</span> <span class="n">Windows</span><span class="p">.</span><span class="o">*</span><span class="n">x28Cx29</span> <span class="n">Copyright</span> <span class="mi">1985</span><span class="o">-</span><span class="p">.</span><span class="o">*</span><span class="n">Microsoft</span> <span class="n">Corp</span><span class="o">/</span>  
<span class="err">}</span>
</pre></div>
</td></tr></table>

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">signature</span> <span class="n">windows_shell</span> <span class="err">{</span>  
<span class="n">ip</span><span class="o">-</span><span class="n">proto</span> <span class="o">==</span> <span class="n">tcp</span>  
<span class="n">tcp</span><span class="o">-</span><span class="k">state</span> <span class="n">established</span><span class="p">,</span><span class="n">responder</span>  
<span class="n">event</span> <span class="ss">&quot;ATTACK-RESPONSES Microsoft cmd.exe banner (normal-shell responder)&quot;</span>  
<span class="n">payload</span> <span class="o">/</span><span class="p">.</span><span class="o">*</span><span class="n">Microsoft</span> <span class="n">Windows</span><span class="p">.</span><span class="o">*</span><span class="n">x28Cx29</span> <span class="n">Copyright</span> <span class="mi">1985</span><span class="o">-</span><span class="p">.</span><span class="o">*</span><span class="n">Microsoft</span> <span class="n">Corp</span><span class="o">/</span>  
<span class="err">}</span>
</pre></div>
</td></tr></table>

<h5 id="run-bro-with-sig-file">Run bro with sig file<a class="headerlink" href="#run-bro-with-sig-file" title="Permanent link">&para;</a></h5>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">bro</span> <span class="o">-</span><span class="n">r</span> <span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="o">-</span><span class="n">s</span> <span class="n">outbound</span><span class="p">.</span><span class="n">sig</span>
</pre></div>
</td></tr></table>

<h5 id="view-dst-addresses-in-signature-file">View dst addresses in signature file<a class="headerlink" href="#view-dst-addresses-in-signature-file" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">cat</span> <span class="n">signatures</span><span class="p">.</span><span class="n">log</span> <span class="o">|</span><span class="n">bro</span><span class="o">-</span><span class="n">cut</span> <span class="n">dst_addr</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">|</span> <span class="n">uniq</span> <span class="o">-</span><span class="k">c</span> <span class="o">|</span><span class="n">sort</span> <span class="o">-</span><span class="n">n</span></code></p>
<h5 id="bro-event-script-to-find-user-agent-outboundbro">BRO event script to find User-Agent (outbound.bro)<a class="headerlink" href="#bro-event-script-to-find-user-agent-outboundbro" title="Permanent link">&para;</a></h5>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nv">event</span> <span class="nv">http_header</span><span class="ss">(</span><span class="nv">c</span>: <span class="nv">connection</span>, <span class="nv">is_orig</span>: <span class="nv">bool</span>, <span class="nv">name</span>: <span class="nv">string</span>, <span class="nv">value</span>: <span class="nv">string</span><span class="ss">)</span>  
{  
<span class="nv">local</span> <span class="nv">snet</span> <span class="o">=</span> <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">0</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">16</span><span class="c1">;  </span>
<span class="k">if</span> <span class="ss">(</span><span class="nv">c</span>$<span class="nv">id</span>$<span class="nv">orig_h</span> <span class="nv">in</span> <span class="nv">snet</span><span class="ss">)</span>  
{  
<span class="k">if</span> <span class="ss">(</span><span class="nv">c</span>$<span class="nv">id</span>$<span class="nv">resp_h</span> <span class="o">!</span><span class="nv">in</span> <span class="nv">snet</span><span class="ss">)</span>  
{  
<span class="k">if</span> <span class="ss">(</span><span class="nv">c</span>$<span class="nv">id</span>$<span class="nv">resp_p</span> <span class="o">==</span> <span class="mi">80</span><span class="o">/</span><span class="nv">tcp</span> <span class="o">&amp;&amp;</span> <span class="nv">name</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">USER-AGENT</span><span class="s2">&quot;</span><span class="ss">)</span>  
{  
<span class="nv">print</span> <span class="nv">fmt</span> <span class="ss">(</span><span class="s2">&quot;</span><span class="s">source IP %s, destination IP/port %s %s, USER-AGENT content %s</span><span class="s2">&quot;</span>,  
<span class="nv">c</span>$<span class="nv">id</span>$<span class="nv">orig_h</span>,<span class="nv">c</span>$<span class="nv">id</span>$<span class="nv">resp_h</span>,<span class="nv">c</span>$<span class="nv">id</span>$<span class="nv">resp_p</span>,<span class="nv">value</span><span class="ss">)</span><span class="c1">;  </span>
}  
}  
}  
}
</pre></div>
</td></tr></table>

<p><strong>BRO Scripting Reference</strong> 
 <a href="https://www.bro.org/sphinx/scripting/">https://www.bro.org/sphinx/scripting/</a></p>
<h5 id="run-event-file-to-view-user-agent">Run event file to view user-agent<a class="headerlink" href="#run-event-file-to-view-user-agent" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">bro</span> <span class="o">-</span><span class="n">r</span> <span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="n">outbound</span><span class="o">-</span><span class="n">event</span><span class="p">.</span><span class="n">bro</span></code></p>
<h5 id="bro-extract-common-files-from-pcap">BRO extract common files from pcap<a class="headerlink" href="#bro-extract-common-files-from-pcap" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">sudo</span> <span class="n">bro</span> <span class="o">-</span><span class="n">r</span> <span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">bro</span><span class="o">/</span><span class="k">share</span><span class="o">/</span><span class="n">bro</span><span class="o">/</span><span class="n">file</span><span class="o">-</span><span class="n">extraction</span><span class="o">/</span><span class="k">extract</span><span class="p">.</span><span class="n">bro</span></code></p>
<h5 id="extract-ssl-info">Extract ssl info<a class="headerlink" href="#extract-ssl-info" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">cat</span> <span class="n">ssl</span><span class="p">.</span><span class="n">log</span> <span class="o">|</span> <span class="n">bro</span><span class="o">-</span><span class="n">cut</span> <span class="k">server_name</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">issuer_subject</span></code></p>
<h5 id="bro-extract-unique-ssl-certificate-data">BRO extract unique SSL certificate data<a class="headerlink" href="#bro-extract-unique-ssl-certificate-data" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">bro</span> <span class="o">-</span><span class="k">C</span> <span class="o">-</span><span class="n">r</span> <span class="n">file</span><span class="p">.</span><span class="n">pcap</span> <span class="o">&gt;</span> <span class="n">cert_data</span><span class="p">.</span><span class="n">txt</span></code></p>
<h5 id="bro-extract-ssl-issuer-data-from-certificate-extraction">BRO extract SSL issuer data from certificate extraction<a class="headerlink" href="#bro-extract-ssl-issuer-data-from-certificate-extraction" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">cat</span> <span class="n">ssl</span><span class="p">.</span><span class="n">log</span><span class="o">|</span><span class="n">bro</span><span class="o">-</span><span class="n">cut</span> <span class="n">issuer_subject</span><span class="o">|</span><span class="n">sort</span> <span class="o">-</span><span class="n">u</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">bro</span><span class="o">/</span><span class="k">data</span><span class="p">.</span><span class="n">txt</span></code></p>
<h5 id="bro-show-shortest-issuer-from-extraction">BRO show shortest issuer from extraction<a class="headerlink" href="#bro-show-shortest-issuer-from-extraction" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">cat</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">bro</span><span class="o">/</span><span class="k">data</span><span class="p">.</span><span class="n">txt</span> <span class="o">|</span><span class="n">awk</span> <span class="s1">&#39;{print length, $0}&#39;</span><span class="o">|</span><span class="n">sort</span> <span class="o">-</span><span class="n">nr</span></code></p>
<hr />
<h4 id="modsecurity-rules">ModSecurity rules<a class="headerlink" href="#modsecurity-rules" title="Permanent link">&para;</a></h4>
<h5 id="errorlog-ua-not-starting-with-mozilla">error.log UA not starting with Mozilla<a class="headerlink" href="#errorlog-ua-not-starting-with-mozilla" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">SecRule</span> <span class="n">REQUEST_HEADERS</span><span class="p">:</span><span class="k">User</span><span class="o">-</span><span class="n">Agent</span> <span class="ss">&quot;!^Mozilla/d.d&quot;</span> <span class="ss">&quot;log,msg:&#39;User-Agent without Mozilla/#.#&#39;&quot;</span></code></p>
<h5 id="errorlog-visiting-ip-url">error.log visiting IP URL<a class="headerlink" href="#errorlog-visiting-ip-url" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">SecRule</span> <span class="n">REQUEST_HEADERS</span><span class="p">:</span><span class="k">Host</span> <span class="ss">&quot;^[d.:]+$&quot;</span> <span class="ss">&quot;log,msg:&#39;Host used an IP address&#39;&quot;</span></code></p>
<h5 id="errorlog-blank-ua">error.log blank UA<a class="headerlink" href="#errorlog-blank-ua" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">SecRule</span> <span class="n">REQUEST_HEADERS</span><span class="p">:</span><span class="k">User</span><span class="o">-</span><span class="n">Agent</span> <span class="ss">&quot;^$&quot;</span> <span class="ss">&quot;log,msg:&#39;Request has blank UA&#39;&quot;</span></code></p>
<h5 id="errorlog-ua-starting-with-mozilla">error.log UA starting with mozilla<a class="headerlink" href="#errorlog-ua-starting-with-mozilla" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">SecRule</span> <span class="n">REQUEST_HEADERS</span><span class="p">:</span><span class="k">User</span><span class="o">-</span><span class="n">Agent</span> <span class="ss">&quot;^mozilla&quot;</span> <span class="ss">&quot;log,msg:&#39;Request has mozilla UA&#39;&quot;</span></code></p>
<h5 id="errorlog-visiting-by-ip-log-ua-used">error.log visiting by IP log UA used<a class="headerlink" href="#errorlog-visiting-by-ip-log-ua-used" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="nv">SecRule</span> <span class="nv">REQUEST_HEADERS</span>:<span class="nv">Host</span> <span class="s2">&quot;</span><span class="s">^[d.:]+$</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="s">log,msg:&#39;Host used an IP address check errorlog for UA&#39;,logdata:&#39;User-Agent:%{REQUEST_HEADERS.User-Agent}&#39;</span><span class="s2">&quot;</span></code></p>
<h5 id="errorlog-no-ua-not-blank-but-none">error.log no UA (not blank but none)<a class="headerlink" href="#errorlog-no-ua-not-blank-but-none" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">SecRule</span><span class="w"> </span><span class="o">&amp;</span><span class="nl">REQUEST_HEADERS</span><span class="p">:</span><span class="k">User</span><span class="o">-</span><span class="n">Agent</span><span class="w"> </span><span class="ss">&quot;@eq 0&quot;</span><span class="w"> </span><span class="ss">&quot;log,msg:&#39;Request missing UA&#39;,logdata:&#39;User-Agent:%{REQUEST_HEADERS.User-Agent}&#39;&quot;</span><span class="w"></span></code></p>
<h5 id="errorlog-note-param-entry">error.log note param entry<a class="headerlink" href="#errorlog-note-param-entry" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">SecRule</span><span class="w"> </span><span class="o">&amp;</span><span class="nl">ARGS</span><span class="p">:</span><span class="n">password</span><span class="w"> </span><span class="ss">&quot;@gt 1&quot;</span><span class="w"> </span><span class="ss">&quot;log,msg:&#39;PW data&#39;,logdata:&#39;params:%{REQUEST_LINE}&#39;&quot;</span><span class="w"></span></code></p>
<h5 id="errorlog-trigger-on-keyword-can-use-pattern">error.log trigger on keyword (can use pattern)<a class="headerlink" href="#errorlog-trigger-on-keyword-can-use-pattern" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="o">#</span><span class="k">Trigger</span> <span class="k">on</span> <span class="n">EXFIL</span> <span class="k">from</span> <span class="n">body</span> <span class="p">(</span><span class="n">phase</span><span class="p">:</span><span class="mi">4</span> <span class="k">is</span> <span class="n">the</span> <span class="n">Response</span> <span class="n">Body</span><span class="p">)</span><span class="n">SecRule</span> <span class="n">RESPONSE_BODY</span> <span class="ss">&quot;badguy&quot;</span> <span class="ss">&quot;phase:4, msg:&#39;HoneyToken Exfil Detected&#39;, tag:&#39;HONEYTOKEN EXFIL&#39;&quot;</span></code></p>
<hr />
<h4 id="splunk">Splunk<a class="headerlink" href="#splunk" title="Permanent link">&para;</a></h4>
<p>Note these are examples and are mainly illustrated as templates for creating your own internal searches</p>
<h5 id="new-unauthorized-service">New unauthorized service<a class="headerlink" href="#new-unauthorized-service" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">index</span><span class="o">=</span><span class="n">windows</span> <span class="n">LogName</span><span class="o">=</span><span class="k">System</span> <span class="n">EventCode</span><span class="o">=</span><span class="mi">7045</span> <span class="k">NOT</span> <span class="p">(</span><span class="n">Service_Name</span><span class="o">=&lt;</span><span class="n">yourscanner</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">|</span> <span class="n">eval</span> <span class="n">Message</span><span class="o">=</span><span class="n">split</span><span class="p">(</span><span class="n">Message</span><span class="p">,</span><span class="ss">&quot;.&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">eval</span> <span class="n">Short_Message</span><span class="o">=</span><span class="n">mvindex</span><span class="p">(</span><span class="n">Message</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">table_time</span><span class="p">,</span> <span class="k">host</span><span class="p">,</span> <span class="n">Service_Name</span><span class="p">,</span> <span class="n">Service_Type</span><span class="p">,</span> <span class="n">Service_Start_Type</span><span class="p">,</span> <span class="n">Service_Account</span><span class="p">,</span> <span class="n">Short_Message</span></code></p>
<h5 id="detecting-process-abuse">Detecting process abuse<a class="headerlink" href="#detecting-process-abuse" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">index</span><span class="o">=</span><span class="n">sysmon</span> <span class="n">SourceType</span><span class="o">=</span><span class="ss">&quot;WinEventLog:Microsoft-Windows-Sysmon/Operational&quot;</span> <span class="n">ProcessCreate</span> <span class="p">(</span><span class="n">whoami</span> <span class="k">OR</span> <span class="n">netstat</span> <span class="k">OR</span> <span class="n">etc</span><span class="p">)</span> <span class="o">|</span> <span class="k">search</span> <span class="n">EventCode</span><span class="o">=</span><span class="mi">1</span> <span class="n">Image</span><span class="o">=</span><span class="ss">&quot;*\whoami.exe&quot;</span> <span class="k">OR</span> <span class="n">Image</span><span class="o">=</span><span class="ss">&quot;* etstat.exe&quot;</span> <span class="k">OR</span> <span class="n">Image</span><span class="o">=</span><span class="ss">&quot;* asklist.exe&quot;</span> <span class="o">|</span> <span class="n">bin</span> <span class="p">)</span><span class="n">time</span> <span class="n">span</span><span class="o">=</span><span class="mi">5</span><span class="n">m</span> <span class="o">|</span> <span class="n">rex</span> <span class="n">field</span><span class="o">=</span><span class="n">Message</span> <span class="ss">&quot;.*User:(xxx|NT AUTHORITY)\(?&lt;USER&gt;.*)&quot;</span> <span class="o">|</span> <span class="n">stats</span> <span class="n">dc</span><span class="p">(</span><span class="n">Image</span><span class="p">)</span> <span class="k">AS</span> <span class="n">CNT_CMDS</span> <span class="k">values</span><span class="p">(</span><span class="n">CommandLine</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="n">ParentImage</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="n">ParentCommandLine</span><span class="p">)</span> <span class="k">count</span> <span class="k">by</span> <span class="n">_time</span> <span class="n">ComputerName</span> <span class="k">USER</span></code></p>
<h5 id="detecting-process-abuse-simplified-requires-one-entry-per-process">Detecting process abuse (simplified, requires one entry per process)<a class="headerlink" href="#detecting-process-abuse-simplified-requires-one-entry-per-process" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">index</span><span class="o">=</span><span class="n">sysmon</span> <span class="n">Image</span><span class="o">=</span><span class="ss">&quot;* et.exe&quot;</span> <span class="p">(</span><span class="n">CommandLine</span><span class="o">=</span><span class="ss">&quot;*net group*&quot;</span> <span class="k">OR</span> <span class="n">CommandLine</span><span class="o">=</span><span class="ss">&quot;*net localgroup*&quot;</span> <span class="k">OR</span> <span class="n">CommandLine</span><span class="o">=</span><span class="ss">&quot;*net user*&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">stats</span> <span class="k">count</span> <span class="k">by</span> <span class="n">Computer</span><span class="p">,</span><span class="n">CommandLine</span></code></p>
<h5 id="process-starts-and-connects-to-ip">Process starts and connects to IP<a class="headerlink" href="#process-starts-and-connects-to-ip" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">index</span><span class="o">=</span><span class="n">windows</span> <span class="n">LogName</span><span class="o">=</span><span class="k">System</span> <span class="n">EventCode</span><span class="o">=</span><span class="mi">5156</span> <span class="k">NOT</span> <span class="p">(</span><span class="n">Source_Address</span><span class="o">=</span><span class="ss">&quot;10.10.10.15&quot;</span><span class="p">)</span> <span class="k">NOT</span> <span class="p">(</span><span class="n">Application_Name</span><span class="o">=</span><span class="ss">&quot;path:file.exe&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">eval</span> <span class="n">Message</span><span class="o">=</span><span class="n">split</span><span class="p">(</span><span class="n">Message</span><span class="p">,</span><span class="ss">&quot;.&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">table_time</span><span class="p">,</span> <span class="k">host</span><span class="p">,</span> <span class="n">Application_Name</span><span class="p">,</span> <span class="n">Source_Address</span><span class="p">,</span> <span class="n">Destination_Address</span><span class="p">,</span> <span class="n">Direction</span></code></p>
<h5 id="detect-smb-traffic-between-clients">Detect SMB traffic between clients<a class="headerlink" href="#detect-smb-traffic-between-clients" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">index</span><span class="o">=</span><span class="n">sysmon</span> <span class="n">SourceName</span><span class="o">=</span><span class="ss">&quot;Microsoft-Windows-Sysmon&quot;</span> <span class="n">EventCode</span><span class="o">=</span><span class="mi">3</span> <span class="n">Initiated</span><span class="o">=</span><span class="k">true</span> <span class="n">SourceIp</span><span class="o">!=</span><span class="n">DestinationIp</span> <span class="n">DestinationPort</span><span class="o">=</span><span class="mi">445</span> <span class="n">Image</span><span class="o">!=</span><span class="k">System</span> <span class="p">(</span><span class="n">SourceHostname</span><span class="o">=</span><span class="ss">&quot;fileserver1&quot;</span> <span class="n">DestinationHostname</span><span class="o">=</span><span class="ss">&quot;client1&quot;</span><span class="p">)</span> <span class="k">OR</span> <span class="p">(</span><span class="n">Source_Address</span><span class="o">=</span><span class="ss">&quot;10.10.1.5&quot;</span> <span class="n">Destination_Address</span><span class="o">=</span><span class="ss">&quot;10.10.10.15&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">stats</span> <span class="k">by</span> <span class="n">ComputerName</span> <span class="n">ProcessGuid</span> <span class="o">|</span> <span class="n">fields</span> <span class="n">ComputerName</span> <span class="n">ProcessGuid</span></code></p>
<h5 id="detect-named-pipes">Detect Named Pipes<a class="headerlink" href="#detect-named-pipes" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">index</span><span class="o">=</span><span class="n">sysmon</span> <span class="n">sourcetype</span><span class="o">=</span><span class="ss">&quot;WinEventLog:Microsoft-Windows-Sysmon/Operational&quot;</span> <span class="p">(</span><span class="n">PipeEvent</span> <span class="ss">&quot;Pipe Created&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="k">search</span> <span class="p">(</span><span class="n">EventCode</span><span class="o">=</span><span class="mi">17</span> <span class="p">(</span><span class="n">PipeName</span><span class="o">=</span><span class="ss">&quot;\*&quot;</span><span class="p">))</span> <span class="o">|</span> <span class="n">stats</span> <span class="k">values</span> <span class="p">(</span><span class="n">Image</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Images</span> <span class="k">values</span><span class="p">(</span><span class="n">PipeName</span><span class="p">)</span> <span class="k">AS</span> <span class="n">PipeNames</span> <span class="k">count</span> <span class="k">by</span> <span class="n">TaskCategory</span> <span class="n">ComputerName</span></code></p>
<h4 id="detect-wmi">Detect WMI<a class="headerlink" href="#detect-wmi" title="Permanent link">&para;</a></h4>
<p><code class="codehilite"><span class="k">index</span><span class="o">=</span><span class="n">sysmon</span> <span class="n">Image</span><span class="o">=</span><span class="ss">&quot;*\WMIC.exe&quot;</span> <span class="p">(</span><span class="n">CommandLine</span><span class="o">=</span><span class="ss">&quot;*process call create*&quot;</span> <span class="k">OR</span> <span class="n">CommandLine</span><span class="o">=</span><span class="ss">&quot;*/NODE:*&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">stats</span> <span class="k">count</span> <span class="k">by</span> <span class="n">Computer</span><span class="p">,</span><span class="n">CommandLine</span></code></p>
<p>and</p>
<p><code class="codehilite"><span class="k">index</span><span class="o">=</span><span class="n">sysmon</span> <span class="n">ParentImage</span><span class="o">=</span><span class="ss">&quot;*\WmiPrvSE.exe&quot;</span> <span class="o">|</span> <span class="n">stats</span> <span class="k">count</span> <span class="k">by</span> <span class="n">Computer</span><span class="p">,</span><span class="n">CommandLine</span></code></p>
<h4 id="detect-powershell-commands">Detect PowerShell Commands<a class="headerlink" href="#detect-powershell-commands" title="Permanent link">&para;</a></h4>
<p><code class="codehilite"><span class="k">index</span><span class="o">=</span><span class="n">sysmon</span> <span class="n">ParentImage</span><span class="o">=</span><span class="ss">&quot;*wsmprovhost.exe&quot;</span> <span class="o">|</span> <span class="n">stats</span> <span class="k">count</span> <span class="k">by</span> <span class="n">Computer</span><span class="p">,</span><span class="n">CommandLine</span></code></p>
<p>and</p>
<p><code class="codehilite"><span class="nv">index</span><span class="o">=</span><span class="nv">sysmon</span> <span class="nv">Image</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">*powershell.exe</span><span class="s2">&quot;</span> <span class="ss">(</span><span class="nv">CommandLine</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">*-EncodedCommand*</span><span class="s2">&quot;</span> <span class="nv">OR</span> <span class="nv">CommandLine</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">*-Enc*</span><span class="s2">&quot;</span> <span class="nv">OR</span> <span class="nv">CommandLine</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">*-e*</span><span class="s2">&quot;</span> <span class="nv">OR</span> <span class="nv">CommandLine</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">*new-object*</span><span class="s2">&quot;</span> <span class="nv">OR</span> <span class="nv">CommandLine</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">*-nop*</span><span class="s2">&quot;</span> <span class="nv">OR</span> <span class="nv">CommandLine</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">*-noprofile</span><span class="s2">&quot;</span> <span class="nv">OR</span> <span class="nv">CommandLine</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">*-Command*</span><span class="s2">&quot;</span> <span class="nv">OR</span> <span class="nv">COmmandLine</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">*-c*</span><span class="s2">&quot;</span> <span class="nv">OR</span> <span class="nv">CommandLine</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">*Invoke-Command*</span><span class="s2">&quot;</span> <span class="nv">OR</span> <span class="nv">CommandLine</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">*download*</span><span class="s2">&quot;</span> <span class="nv">OR</span> <span class="nv">CommandLine</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">*IEX*</span><span class="s2">&quot;</span> <span class="nv">OR</span> <span class="nv">CommandLine</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">*exec*</span><span class="s2">&quot;</span><span class="ss">)</span><span class="o">|</span> <span class="nv">stats</span> <span class="nv">count</span> <span class="nv">by</span> <span class="nv">Computer</span>,<span class="nv">CommandLine</span></code></p>
<h5 id="alert-on-remote-files-copied-via-cmd-line">Alert on remote files copied via cmd line<a class="headerlink" href="#alert-on-remote-files-copied-via-cmd-line" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">index</span><span class="o">=</span><span class="n">windows</span> <span class="n">LogName</span><span class="o">=</span><span class="k">Security</span> <span class="n">EventCode</span><span class="o">=</span><span class="mi">5145</span> <span class="n">Object_Type</span><span class="o">=</span><span class="n">File</span> <span class="n">Share_Name</span><span class="o">=*</span><span class="err">$</span> <span class="p">(</span><span class="n">Access_Mask</span><span class="o">=</span><span class="mi">0</span><span class="n">x100180</span> <span class="k">OR</span> <span class="n">Access_Mask</span><span class="o">=</span><span class="mi">0</span><span class="n">x80</span> <span class="k">OR</span> <span class="n">Access_Mask</span><span class="o">=</span><span class="mi">0</span><span class="n">x130197</span><span class="p">)</span> <span class="o">|</span><span class="n">bucket</span> <span class="n">span</span><span class="o">=</span><span class="mi">1</span><span class="n">s</span> <span class="n">_time</span> <span class="o">|</span><span class="n">rex</span> <span class="ss">&quot;(?(0x100180|0x80|0x130197))&quot;</span> <span class="o">|</span><span class="n">stats</span> <span class="k">values</span><span class="p">(</span><span class="n">Relative_Target_Name</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Relative_Target_Name</span><span class="p">,</span> <span class="k">values</span><span class="p">(</span><span class="n">Account_Name</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Account_Name</span><span class="p">,</span> <span class="k">values</span><span class="p">(</span><span class="n">Source_Address</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Source_Address</span><span class="p">,</span> <span class="n">dc</span><span class="p">(</span><span class="n">thingtype</span><span class="p">)</span> <span class="k">AS</span> <span class="n">distinct_things</span> <span class="k">by</span> <span class="n">ComputerName</span><span class="p">,</span> <span class="n">_time</span> <span class="o">|</span><span class="k">search</span> <span class="n">distinct_things</span><span class="o">=</span><span class="mi">3</span></code></p>
<h5 id="alert-on-c-or-admin-share-enumeration">Alert on C or Admin share enumeration<a class="headerlink" href="#alert-on-c-or-admin-share-enumeration" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">index</span><span class="o">=</span><span class="n">windows</span> <span class="n">LogName</span><span class="o">=</span><span class="k">Security</span> <span class="n">EventCode</span><span class="o">=</span><span class="mi">5145</span> <span class="n">Share_Name</span><span class="o">=*</span><span class="k">c</span><span class="err">$</span> <span class="k">OR</span> <span class="o">*</span><span class="k">ADMIN</span><span class="err">$</span> <span class="p">(</span><span class="n">Access_Mask</span><span class="o">=</span><span class="mi">0</span><span class="n">x100180</span><span class="p">)</span> <span class="k">NOT</span> <span class="p">(</span><span class="n">Source_Address</span><span class="o">=</span><span class="ss">&quot;10.10.10.15&quot;</span><span class="p">)</span><span class="o">|</span><span class="n">bucket</span> <span class="n">span</span><span class="o">=</span><span class="mi">1</span><span class="n">s</span> <span class="n">_time</span> <span class="o">|</span><span class="n">rex</span> <span class="ss">&quot;(?(0x100180))&quot;</span> <span class="o">|</span><span class="n">stats</span> <span class="k">values</span><span class="p">(</span><span class="n">Relative_Target_Name</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Relative_Target_Name</span><span class="p">,</span> <span class="k">values</span><span class="p">(</span><span class="n">Account_Name</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Account_Name</span><span class="p">,</span> <span class="k">values</span><span class="p">(</span><span class="n">Source_Address</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Source_Address</span><span class="p">,</span> <span class="n">dc</span><span class="p">(</span><span class="n">thingtype</span><span class="p">)</span> <span class="k">AS</span> <span class="n">distinct_things</span> <span class="k">by</span> <span class="n">ComputerName</span><span class="p">,</span> <span class="n">_time</span> <span class="o">|</span><span class="k">search</span> <span class="n">distinct_things</span><span class="o">=</span><span class="mi">3</span></code></p>
<h5 id="search-for-file-delivery">Search for file delivery<a class="headerlink" href="#search-for-file-delivery" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">index</span><span class="o">=</span><span class="n">sysmon</span> <span class="n">SourceName</span><span class="o">=</span><span class="ss">&quot;Microsoft-Windows-Sysmon&quot;</span> <span class="n">FileCreateStreamHash</span> <span class="n">badfile</span><span class="p">.</span><span class="n">exe</span> <span class="o">|</span> <span class="k">search</span> <span class="n">EventCode</span><span class="o">=</span><span class="mi">15</span> <span class="o">|</span> <span class="n">rex</span> <span class="n">field</span><span class="o">=</span><span class="n">TargetFilename</span> <span class="ss">&quot;.*\(?&lt;TargFilename&gt;[^\]*)&quot;</span> <span class="o">|</span> <span class="n">rex</span> <span class="n">field</span><span class="o">=</span><span class="n">Image</span> <span class="ss">&quot;.*\(?&lt;ImageFilename[^\]*)&quot;</span> <span class="o">|</span> <span class="n">rex</span> <span class="n">field</span><span class="o">=</span><span class="n">Hash</span> <span class="ss">&quot;.*MD5=(?&lt;MD5&gt;[A-F0-9]*),IMPHASH=(?&lt;IMPHASH&gt;[A-F0-9]*)&quot;</span> <span class="o">|</span> <span class="n">stats</span> <span class="k">values</span><span class="p">(</span><span class="n">TargFilename</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="n">ComputerName</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Clients</span> <span class="k">count</span> <span class="k">by</span> <span class="n">TaskCategory</span> <span class="n">ImageFilename</span> <span class="n">MD5</span></code></p>
<h5 id="search-for-registry-run-or-runonce-keys">Search for Registry Run (or RunOnce) Keys<a class="headerlink" href="#search-for-registry-run-or-runonce-keys" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">index</span><span class="o">=</span><span class="n">sysmon</span> <span class="n">SourceName</span><span class="o">=</span><span class="ss">&quot;Microsoft-Windows-Sysmon&quot;</span> <span class="n">RegistryEvent</span> <span class="n">CurrentVersion</span> <span class="n">Run</span> <span class="o">|</span> <span class="k">search</span> <span class="n">EventCode</span><span class="o">=</span><span class="mi">13</span> <span class="ss">&quot;*\Windows\CurrentVersion\Run*&quot;</span> <span class="o">|</span> <span class="n">rex</span> <span class="n">field</span><span class="o">=</span><span class="n">Image</span> <span class="ss">&quot;.*\(?Image_EXE&gt;[^\]*)&quot;</span> <span class="o">|</span> <span class="n">rex</span> <span class="n">field</span><span class="o">=</span><span class="n">TargetObject</span> <span class="ss">&quot;.*\CurrentVersion\(?&lt;TargetObj_PATH&gt;.*)&quot;</span> <span class="o">|</span> <span class="n">strcat</span> <span class="ss">&quot;Image=&quot;&quot; IMage_EXE &quot;&quot;, TargetObject=&quot;&quot; TargetObj_PATH &quot;&quot;, Details=&quot;&quot; Details &quot;&quot;&quot;</span> <span class="n">Image_TargetObj_Details</span> <span class="o">|</span> <span class="n">stats</span> <span class="n">dc</span><span class="p">(</span><span class="n">ComputerName</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Clients</span> <span class="k">values</span><span class="p">(</span><span class="n">Image_TragetObj_Details</span><span class="p">)</span> <span class="k">count</span> <span class="k">by</span> <span class="n">TaskCategory</span> <span class="n">Image_EXE</span></code></p>
<h5 id="search-for-file-system-persistence">Search for file system persistence<a class="headerlink" href="#search-for-file-system-persistence" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">index</span><span class="o">=</span><span class="n">sysmon</span> <span class="n">SourceName</span><span class="o">=</span><span class="ss">&quot;Microsoft-Windows-Sysmon&quot;</span> <span class="n">ProcessCreate</span> <span class="ss">&quot;Start Menu&quot;</span> <span class="n">Programs</span> <span class="n">Startup</span> <span class="o">|</span> <span class="k">search</span> <span class="n">Image</span><span class="o">=</span><span class="ss">&quot;*\Microsoft\Windows\Start Menu\Programs\Startup\*&quot;</span> <span class="o">|</span> <span class="n">rex</span> <span class="n">field</span><span class="o">=</span><span class="n">Image</span> <span class="ss">&quot;.*\Programs\Startup\(?&lt;Startup_Image&gt;[^\]*)&quot;</span> <span class="o">|</span> <span class="n">rex</span> <span class="n">field</span><span class="o">=</span><span class="n">Hash</span> <span class="ss">&quot;.*MD5=(?&lt;MD5&gt;[A-F0-9]*),IMPHASH=(?&lt;IMPHASH&gt;[A-F0-9]*)&quot;</span> <span class="o">|</span> <span class="n">stats</span> <span class="k">values</span><span class="p">(</span><span class="n">ComputerName</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Clients</span> <span class="n">vlaues</span><span class="p">(</span><span class="n">MD5</span><span class="p">)</span> <span class="k">count</span> <span class="k">by</span> <span class="n">IMPHASH</span> <span class="n">Startup_Image</span></code></p>
<h5 id="detect-credential-harvesting">Detect credential harvesting<a class="headerlink" href="#detect-credential-harvesting" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">index</span><span class="o">=</span><span class="n">sysmon</span> <span class="n">ParentImage</span><span class="o">=</span><span class="ss">&quot;*\services.exe&quot;</span> <span class="o">|</span> <span class="n">regex</span> <span class="n">CommandLine</span><span class="o">=</span><span class="ss">&quot;\[a-z0-9]{8}-[a-z0-9]{4}-[az0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}.exe-S$&quot;</span></code></p>
<p>and</p>
<p><code class="codehilite"><span class="k">index</span><span class="o">=</span><span class="n">sysmon</span> <span class="n">CommandLine</span><span class="o">=</span><span class="ss">&quot;*privileges::debug*&quot;</span> <span class="k">OR</span> <span class="n">CommandLine</span><span class="o">=</span><span class="ss">&quot;*sekurlsa::*&quot;</span> <span class="k">OR</span> <span class="n">CommandLine</span><span class="o">=</span><span class="ss">&quot;*kerberos::*&quot;</span> <span class="k">OR</span> <span class="n">CommandLine</span><span class="o">=</span><span class="ss">&quot;*crypto::*&quot;</span> <span class="k">OR</span> <span class="n">CommandLine</span><span class="o">=</span><span class="ss">&quot;*lsadump::*&quot;</span> <span class="k">OR</span> <span class="n">CommandLine</span><span class="o">=</span><span class="ss">&quot;*process::*&quot;</span></code></p>
<h5 id="potential-privilege-escalation">Potential Privilege Escalation<a class="headerlink" href="#potential-privilege-escalation" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">index</span><span class="o">=</span><span class="n">sysmon</span> <span class="n">sourcetype</span><span class="o">=</span><span class="ss">&quot;WinEventLog:Microsoft-Windows-Sysmon/Operational&quot;</span> <span class="n">EventCode</span><span class="o">=</span><span class="mi">4688</span> <span class="n">Token_Elevation_Type</span><span class="o">=</span><span class="ss">&quot;*(2)&quot;</span></code></p>
<h5 id="potential-beaconing-detection">Potential Beaconing Detection<a class="headerlink" href="#potential-beaconing-detection" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">index</span><span class="o">=</span><span class="n">proxy</span> <span class="n">sourcetype</span><span class="o">=</span><span class="n">bluecoat</span><span class="p">:</span><span class="n">proxysg</span><span class="p">:</span><span class="k">access</span><span class="p">:</span><span class="n">syslog</span> <span class="n">url</span><span class="o">=*</span> <span class="o">|</span> <span class="n">eval</span> <span class="k">current_time</span><span class="o">=</span><span class="n">_time</span> <span class="o">|</span> <span class="n">sort</span> <span class="mi">0</span> <span class="o">+</span> <span class="k">current_time</span> <span class="o">|</span> <span class="n">streamstats</span> <span class="k">global</span><span class="o">=</span><span class="n">f</span> <span class="n">window</span><span class="o">=</span><span class="mi">2</span> <span class="k">current</span><span class="o">=</span><span class="n">f</span> <span class="k">last</span><span class="p">(</span><span class="k">current_time</span><span class="p">)</span> <span class="k">AS</span> <span class="n">previous_time</span> <span class="k">by</span> <span class="n">src</span><span class="p">,</span> <span class="n">url</span> <span class="o">|</span> <span class="n">eval</span> <span class="n">diff_time</span><span class="o">=</span><span class="k">current_time</span><span class="o">-</span><span class="n">previous_time</span><span class="o">|</span> <span class="n">eventstats</span> <span class="k">count</span><span class="p">,</span> <span class="n">stdev</span><span class="p">(</span><span class="n">diff_time</span><span class="p">)</span> <span class="k">AS</span> <span class="n">std</span> <span class="k">by</span> <span class="n">src</span><span class="p">,</span> <span class="n">url</span></code></p>
<h5 id="detect-webshell-activity-note-this-should-be-updated-at-implementation-and-often">Detect webshell activity (note this should be updated at implementation and often)<a class="headerlink" href="#detect-webshell-activity-note-this-should-be-updated-at-implementation-and-often" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">index</span><span class="o">=</span><span class="n">sysmon</span> <span class="n">ParentImage</span><span class="o">=</span><span class="ss">&quot;*pache*&quot;</span> <span class="n">ParentImage</span><span class="o">=</span><span class="ss">&quot;* omcat*&quot;</span> <span class="n">ParentImage</span><span class="o">=</span><span class="ss">&quot;* ginx*&quot;</span> <span class="n">ParentImage</span><span class="o">=</span><span class="ss">&quot;*\httpd*&quot;</span> <span class="n">ParentImage</span><span class="o">=</span><span class="ss">&quot;*\php-cgi*&quot;</span> <span class="n">ParentImage</span><span class="o">=</span><span class="ss">&quot;*\w3wp*&quot;</span> <span class="n">CommandLine</span><span class="o">=</span><span class="ss">&quot;*whoami*&quot;</span> <span class="n">CommandLine</span><span class="o">=</span><span class="ss">&quot;*net*&quot;</span> <span class="n">CommandLine</span><span class="o">=</span><span class="ss">&quot;*ipconfig*&quot;</span> <span class="n">CommandLine</span><span class="o">=</span><span class="ss">&quot;*hostname*&quot;</span> <span class="n">CommandLine</span><span class="o">=</span><span class="ss">&quot;*systeminfo*&quot;</span> <span class="n">CommandLine</span><span class="o">=</span><span class="ss">&quot;*cmd*&quot;</span> <span class="n">CommandLine</span><span class="o">=</span><span class="ss">&quot;*sh*&quot;</span> <span class="n">CommandLine</span><span class="o">=</span><span class="ss">&quot;*bash*&quot;</span> <span class="n">CommandLine</span><span class="o">=</span><span class="ss">&quot;*powershell*&quot;</span></code></p>
<h5 id="detect-potential-sqli">Detect potential SQLi<a class="headerlink" href="#detect-potential-sqli" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="s s-Atom">index</span><span class="o">=</span><span class="s s-Atom">weblogs</span> <span class="s s-Atom">sourcetype</span><span class="o">=</span><span class="nv">MSWindows</span><span class="s s-Atom">:</span><span class="mi">2008</span><span class="nv">R2</span><span class="s s-Atom">:</span><span class="nv">IIS</span> <span class="p">|</span> <span class="s s-Atom">regex</span> <span class="s s-Atom">cs_uri_query=</span><span class="s2">&quot;(?i)(?:--|;|/*|@|@@version|char|alter|begin|cast|create|cursor|declare|delete|drop|end|exec|fetch|insert|kill|open|select|sys|table|update)&quot;</span> <span class="p">|</span> <span class="s s-Atom">stats</span> <span class="s s-Atom">count</span> <span class="s s-Atom">by</span> <span class="s s-Atom">host</span> <span class="s s-Atom">c_ip</span> <span class="s s-Atom">cs_uri_stem</span> <span class="s s-Atom">cs_uri_query</span> <span class="p">|</span> <span class="s s-Atom">rex</span> <span class="s s-Atom">field</span><span class="o">=</span><span class="s s-Atom">cs_uri_query</span> <span class="s2">&quot;(?i)(?&lt;suspect&gt;--|;|/*|@|@@version|char|alter|begin|cast|create|cursor|declare|delete|drop|end|exec|fetch|insert|kill|open|select|sys|table|update)&quot;</span> <span class="s s-Atom">max_match</span><span class="o">=</span><span class="mi">0</span></code></p>
<h5 id="view-http-post-with-response">View HTTP POST with response<a class="headerlink" href="#view-http-post-with-response" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">index</span><span class="o">=</span><span class="n">json_bro</span> <span class="n">eventtype</span><span class="o">=</span><span class="n">bro_http</span> <span class="k">method</span><span class="o">=</span><span class="n">POST</span> <span class="k">AND</span> <span class="n">status</span> <span class="o">&lt;=</span><span class="mi">403</span> <span class="k">AND</span> <span class="n">uri</span><span class="o">=*</span><span class="p">.</span><span class="n">php</span> <span class="k">OR</span> <span class="n">uri</span><span class="o">=*</span><span class="p">.</span><span class="n">jsp</span> <span class="k">OR</span> <span class="n">uri</span><span class="o">=*</span><span class="p">.</span><span class="n">cfm</span> <span class="k">OR</span> <span class="n">uri</span><span class="o">=*</span><span class="p">.</span><span class="n">asp</span> <span class="k">OR</span> <span class="n">uri</span><span class="o">=*</span><span class="p">.</span><span class="n">aspx</span> <span class="o">|</span><span class="n">stats</span> <span class="k">values</span><span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">orig_h</span><span class="p">)</span> <span class="k">AS</span> <span class="k">Source</span><span class="p">,</span> <span class="k">values</span><span class="p">,(</span><span class="n">hostname</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Destination</span> <span class="k">by</span> <span class="n">uri</span></code></p>
<h5 id="find-weird-user-agents">Find Weird User-Agents<a class="headerlink" href="#find-weird-user-agents" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">index</span><span class="o">=</span><span class="n">json_bro</span> <span class="n">eventtype</span><span class="o">-</span><span class="n">bro_http</span> <span class="o">|</span><span class="n">stats</span> <span class="k">count</span> <span class="k">by</span> <span class="n">user_agent</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">-</span><span class="k">count</span> <span class="o">|</span> <span class="n">reverse</span></code></p>
<h5 id="get-high-severity-epo-events">Get high severity EPO events<a class="headerlink" href="#get-high-severity-epo-events" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">index</span><span class="o">=</span><span class="n">av</span> <span class="n">sourcetype</span><span class="o">=</span><span class="n">mcafee</span><span class="p">:</span><span class="n">epo</span> <span class="p">(</span><span class="n">severity</span><span class="o">=</span><span class="n">critical</span> <span class="k">OR</span> <span class="n">severity</span><span class="o">=</span><span class="n">high</span><span class="p">)</span> <span class="o">|</span> <span class="n">stats</span> <span class="k">values</span><span class="p">(</span><span class="n">event_description</span><span class="p">)</span> <span class="k">AS</span> <span class="k">desc</span><span class="p">,</span> <span class="k">values</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span> <span class="k">AS</span> <span class="n">signature</span><span class="p">,</span> <span class="k">values</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="k">AS</span> <span class="n">file_path</span><span class="p">,</span> <span class="k">count</span> <span class="k">AS</span> <span class="k">result</span> <span class="k">BY</span> <span class="n">dest</span> <span class="o">|</span> <span class="n">eval</span> <span class="n">dd</span><span class="o">=</span><span class="ss">&quot;index=av sourcetype=mcafee:epo (severity=critical OR severity=high) dest=&quot;</span><span class="p">.</span><span class="n">dest</span></code></p>
<hr />
<h4 id="snort">Snort<a class="headerlink" href="#snort" title="Permanent link">&para;</a></h4>
<p>Note these are examples and are mainly illustrated as templates for creating your own internal searches</p>
<h5 id="detect-psexec">Detect psexec<a class="headerlink" href="#detect-psexec" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="nt">alert</span> <span class="nt">tcp</span> <span class="nt">any</span> <span class="nt">any</span> <span class="nt">-</span><span class="o">&gt;</span> <span class="o">$</span><span class="nt">HOME_NET</span> <span class="cp">[</span><span class="mi">139</span><span class="p">,</span><span class="mi">445</span><span class="cp">]</span> <span class="o">(</span><span class="nt">msg</span><span class="o">:</span><span class="s2">&quot;ET POLICY PsExec? service created&quot;</span><span class="o">;</span> <span class="nt">flow</span><span class="p">:</span><span class="nd">to_server</span><span class="o">,</span> <span class="nt">established</span><span class="o">;</span> <span class="nt">content</span><span class="o">:</span><span class="s2">&quot;5c 00 50 00 53 00 45 00 58 00 45 00 53 00 56 00 43 00 2e 00 45 00 58 00 45&quot;</span><span class="o">;</span> <span class="nt">reference</span><span class="o">:</span> <span class="nt">url</span><span class="o">,</span> <span class="nt">xinn</span><span class="p">.</span><span class="nc">org</span><span class="o">/</span><span class="nt">Snort-psexec</span><span class="p">.</span><span class="nc">html</span><span class="o">;</span> <span class="nt">reference</span><span class="p">:</span><span class="nd">url</span><span class="o">,</span> <span class="nt">doc</span><span class="p">.</span><span class="nc">emerginthreats</span><span class="p">.</span><span class="nc">net</span><span class="o">/</span><span class="nt">2010781</span><span class="p">:</span><span class="nd">classtype</span><span class="p">:</span><span class="nd">suspicious-filename-detect</span><span class="p">:</span><span class="nd">sid</span><span class="p">:</span><span class="nd">201781</span><span class="o">;</span> <span class="nt">rev</span><span class="p">:</span><span class="nd">2</span><span class="o">;)</span></code></p>
<h5 id="detect-packets-with-with-port-4444-port-0">Detect packets with with port 4444 (port 0?)<a class="headerlink" href="#detect-packets-with-with-port-4444-port-0" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="nt">alert</span> <span class="nt">tcp</span> <span class="o">$</span><span class="nt">EXTERNAL_NET</span> <span class="nt">any</span> <span class="o">&lt;&gt;</span> <span class="o">$</span><span class="nt">HOME_NET</span> <span class="nt">4444</span> <span class="o">(</span><span class="nt">msg</span><span class="o">:</span><span class="s2">&quot;BAD-TRAFFIC tcp port 4444 traffic&quot;</span><span class="o">;</span> <span class="nt">flow</span><span class="p">:</span><span class="nd">stateless</span><span class="o">;</span> <span class="nt">classtype</span><span class="p">:</span><span class="nd">misc-activity</span><span class="o">;</span> <span class="nt">sid</span><span class="p">:</span><span class="nd">524</span><span class="o">;</span> <span class="nt">rev</span><span class="p">:</span><span class="nd">8</span><span class="o">;)</span><span class="err">&quot;</span></code></p>
<h5 id="snort-appid-list">Snort appid list<a class="headerlink" href="#snort-appid-list" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">sudo</span> <span class="n">u2openappid</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">snort</span><span class="o">/</span><span class="n">appstats</span><span class="o">-</span><span class="n">unified</span><span class="p">.</span><span class="n">log</span><span class="p">.</span><span class="mi">1455060958</span> <span class="o">|</span><span class="n">egrep</span> <span class="o">-</span><span class="n">v</span> <span class="s1">&#39;&quot;http&quot;|&quot;https&quot;|&quot;dns&quot;|&quot;internet_explor&quot;&#39;</span><span class="o">|</span><span class="n">cut</span> <span class="o">-</span><span class="n">d</span><span class="ss">&quot;,&quot;</span> <span class="o">-</span><span class="n">f2</span><span class="o">|</span><span class="n">sort</span><span class="o">|</span><span class="n">uniq</span> <span class="o">-</span><span class="k">c</span><span class="o">|</span><span class="n">sort</span> <span class="o">-</span><span class="n">nr</span></code></p>
<h4 id="interesting-file-extensions-note-this-is-the-same-list-as-above-placed-here-for-use-in-monitoring-via-snort">Interesting file extensions (Note this is the same list as above, placed here for use in monitoring via Snort)<a class="headerlink" href="#interesting-file-extensions-note-this-is-the-same-list-as-above-placed-here-for-use-in-monitoring-via-snort" title="Permanent link">&para;</a></h4>
<p><code class="codehilite"><span class="na">.ade</span><span class="p">,</span> <span class="no">.adp</span><span class="p">,</span> <span class="no">.ani</span><span class="p">,</span> <span class="no">.bas</span><span class="p">,</span> <span class="no">.bat</span><span class="p">,</span> <span class="no">.chm</span><span class="p">,</span> <span class="no">.cmd</span><span class="p">,</span> <span class="no">.com</span><span class="p">,</span> <span class="no">.cpl</span><span class="p">,</span> <span class="no">.crt</span><span class="p">,</span> <span class="no">.exe</span><span class="p">,</span> <span class="no">.hlp</span><span class="p">,</span> <span class="no">.ht</span><span class="p">,</span> <span class="no">.hta</span><span class="p">,</span> <span class="no">.inf</span><span class="p">,</span> <span class="no">.ins</span><span class="p">,</span> <span class="no">.isp</span><span class="p">,</span> <span class="no">.jar</span><span class="p">,</span> <span class="no">.job</span><span class="p">,</span> <span class="no">.js</span><span class="p">,</span> <span class="no">.jse</span><span class="p">,</span> <span class="no">.lnk</span><span class="p">,</span> <span class="no">.mda</span><span class="p">,</span> <span class="no">.mdb</span><span class="p">,</span> <span class="no">.mde</span><span class="p">,</span> <span class="no">.mdz</span><span class="p">,</span> <span class="no">.msc</span><span class="p">,</span> <span class="no">.msi</span><span class="p">,</span> <span class="no">.msp</span><span class="p">,</span> <span class="no">.mst</span><span class="p">,</span> <span class="no">.ocx</span><span class="p">,</span> <span class="no">.pcd</span><span class="p">,</span> <span class="no">.ps1</span><span class="p">,</span> <span class="no">.reg</span><span class="p">,</span> <span class="no">.scr</span><span class="p">,</span> <span class="no">.sct</span><span class="p">,</span> <span class="no">.shs</span><span class="p">,</span> <span class="no">.svg</span><span class="p">,</span> <span class="no">.url</span><span class="p">,</span> <span class="no">.vb</span><span class="p">,</span> <span class="no">.vbe</span><span class="p">,</span> <span class="no">.vbs</span><span class="p">,</span> <span class="no">.wbk</span><span class="p">,</span> <span class="no">.wsc</span><span class="p">,</span> <span class="no">.ws</span><span class="p">,</span> <span class="no">.wsf</span><span class="p">,</span> <span class="no">.wsh</span><span class="p">,</span> <span class="no">.exe</span><span class="p">,</span> <span class="no">.pif</span><span class="p">,</span> <span class="no">.pub</span><span class="p">,</span> <span class="no">.ip</span></code></p>
<hr />
<h4 id="additional-useful-info">Additional Useful Info<a class="headerlink" href="#additional-useful-info" title="Permanent link">&para;</a></h4>
<h5 id="get-methods-from-accesslog">Get methods from access.log<a class="headerlink" href="#get-methods-from-accesslog" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">cat</span> <span class="k">access</span><span class="p">.</span><span class="n">log</span> <span class="o">|</span> <span class="n">cut</span> <span class="o">-</span><span class="n">d</span><span class="err">&quot;</span> <span class="o">-</span><span class="n">f2</span> <span class="o">|</span> <span class="n">cut</span> <span class="o">-</span><span class="n">d</span><span class="s1">&#39; &#39;</span> <span class="o">-</span><span class="n">f1</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">-</span><span class="n">u</span></code></p>
<h5 id="decode-encoded-url-line-290">Decode %encoded url (line 290)<a class="headerlink" href="#decode-encoded-url-line-290" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="nv">awk</span> <span class="s1">&#39;</span><span class="s"> {if (length($0) &gt; max){max=length($0);maxline=$0}} END {print maxline }</span><span class="s1">&#39;</span> <span class="nv">access</span>.<span class="nv">log</span><span class="o">|</span><span class="nv">cut</span> <span class="o">-</span><span class="nv">d</span><span class="s2">&quot;</span><span class="s"> </span><span class="s2">&quot;</span> <span class="o">-</span><span class="nv">f7</span><span class="o">|</span><span class="nv">sed</span> <span class="nv">s</span><span class="o">/%//</span><span class="nv">g</span><span class="o">|</span><span class="nv">sed</span> <span class="nv">s</span><span class="o">/+//</span><span class="nv">g</span><span class="o">|</span><span class="nv">sed</span> <span class="nv">s</span><span class="o">/</span>?<span class="o">//</span><span class="nv">g</span><span class="o">|</span><span class="nv">xxd</span> <span class="o">-</span><span class="nv">r</span> <span class="o">-</span><span class="nv">p</span></code></p>
<p>or</p>
<p><code class="codehilite"><span class="n">cat</span> <span class="k">access</span><span class="p">.</span><span class="n">log</span> <span class="o">|</span><span class="n">grep</span> <span class="n">POST</span><span class="o">|</span><span class="n">grep</span> <span class="n">cgi</span><span class="o">-</span><span class="n">bin</span><span class="o">|</span><span class="n">cut</span> <span class="o">-</span><span class="n">d</span><span class="s1">&#39;&quot;&#39;</span> <span class="o">-</span><span class="n">f2</span><span class="o">|</span><span class="n">sort</span> <span class="o">-</span><span class="n">u</span><span class="o">|</span><span class="n">sed</span> <span class="n">s</span><span class="o">/%//</span><span class="k">g</span><span class="o">|</span><span class="n">sed</span> <span class="n">s</span><span class="o">/+//</span><span class="k">g</span><span class="o">|</span><span class="n">cut</span> <span class="o">-</span><span class="n">d</span><span class="ss">&quot;?&quot;</span> <span class="o">-</span><span class="n">f2</span><span class="o">|</span><span class="n">awk</span> <span class="o">-</span><span class="n">F</span><span class="ss">&quot;HTTP/1.1&quot;</span> <span class="s1">&#39;{print $1}&#39;</span><span class="o">|</span><span class="n">xxd</span> <span class="o">-</span><span class="n">r</span> <span class="o">-</span><span class="n">p</span></code></p>
<h4 id="gather-information-on-windows-host">Gather Information on Windows host<a class="headerlink" href="#gather-information-on-windows-host" title="Permanent link">&para;</a></h4>
<h5 id="list-task-services">List task services<a class="headerlink" href="#list-task-services" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tasklist</span> <span class="o">/</span><span class="n">svc</span> <span class="o">/</span><span class="n">fi</span> <span class="ss">&quot;imagename eq file.exe&quot;</span></code></p>
<h5 id="show-modules-for-task">Show modules for task<a class="headerlink" href="#show-modules-for-task" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tasklist</span> <span class="o">/</span><span class="n">m</span> <span class="o">/</span><span class="n">fi</span> <span class="ss">&quot;imagename eq file.exe&quot;</span></code></p>
<h5 id="verbose-task-information">Verbose task information<a class="headerlink" href="#verbose-task-information" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="n">tasklist</span> <span class="o">/</span><span class="n">v</span> <span class="o">/</span><span class="n">fi</span> <span class="ss">&quot;imagename eq file.exe&quot;</span></code></p>
<h5 id="get-information-about-processes">Get information about processes<a class="headerlink" href="#get-information-about-processes" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">get</span><span class="o">-</span><span class="n">wmiobject</span> <span class="o">-</span><span class="k">class</span> <span class="n">Win32_Process</span> <span class="o">-</span><span class="n">Filter</span> <span class="s1">&#39;Name=&quot;file.exe&quot;&#39;</span></code></p>
<p>and</p>
<p><code class="codehilite"><span class="x">get-process | select * |Where-Object </span><span class="cp">{</span><span class="nv">$_.ID</span> <span class="o">-</span><span class="na">eq</span> <span class="na">PID</span><span class="cp">}</span><span class="x"></span></code></p>
<p>and</p>
<p><code class="codehilite"><span class="x">gwmi Win32_Process|Select ProcessName,ProcessID,ParentProcessID,CommandLine,@</span><span class="cp">{</span><span class="nf">e</span><span class="o">=</span><span class="cp">{</span><span class="nv">$_.GetOwner</span><span class="o">().</span><span class="na">User</span><span class="cp">}}</span><span class="x">|ft -wrap;netstat ano</span></code></p>
<h5 id="look-for-code-injected-into-memory">Look for code injected into memory<a class="headerlink" href="#look-for-code-injected-into-memory" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">Get</span><span class="o">-</span><span class="n">InjectedThread</span><span class="p">.</span><span class="n">ps1</span></code></p>
<p><strong>Reference</strong><br />
 <a href="https://gist.github.com/jaredcatkinson/23905d34537ce4b5b1818c3e6405c1d2">https://gist.github.com/jaredcatkinson/23905d34537ce4b5b1818c3e6405c1d2</a></p>
<hr />
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../threat-gets-a-vote-applying-a-threat-based-approach-to-security-testing/" title="Threat Get's a Vote - Applying a Threat-Based Approach to Security Testing" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Threat Get's a Vote - Applying a Threat-Based Approach to Security Testing
              </span>
            </div>
          </a>
        
        
          <a href="../automating-cobalt-strike-profiles-apache-mod_rewrite-htaccess-files-intelligent-c2-redirection/" title="Automating Cobalt Strike Profiles Apache mod_rewrite htaccess Files for Intelligent C2 Redirection" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Automating Cobalt Strike Profiles Apache mod_rewrite htaccess Files for Intelligent C2 Redirection
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
             2019 Threatexpress
          </div>
        
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/threatexpress" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/joevest" class="md-footer-social__link fa fa-twitter"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script>
      
        <script src="https://platform.twitter.com/widgets.js"></script>
      
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
      
        <script src="../../../js/extra.js"></script>
      
    
  </body>
</html>