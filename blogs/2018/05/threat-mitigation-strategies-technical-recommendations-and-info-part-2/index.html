



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Threatexpress Blog">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.1.0">
    
    
      
        <title>Threat Mitagation Strategies - Part 2 - Threatexpress</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/application.11e41852.css">
      
        <link rel="stylesheet" href="../../../../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="">
      
    
    
      <script src="../../../../assets/javascripts/modernizr.20ef595d.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../../../css/extra.css">
    
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="bluegrey" data-md-color-accent="blue">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#threat-mitigation-strategies-part-2" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../../.." title="Threatexpress" class="md-header-nav__button md-logo">
          
            <img src="../../../../img/threatexpress_logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Threatexpress
              </span>
              <span class="md-header-nav__topic">
                Threat Mitagation Strategies - Part 2
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/threatexpress/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      threatexpress/threatexpress
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../../.." title="Threatexpress" class="md-nav__button md-logo">
      
        <img src="../../../../img/threatexpress_logo.png" width="48" height="48">
      
    </a>
    Threatexpress
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/threatexpress/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      threatexpress/threatexpress
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Blogs
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Blogs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1" type="checkbox" id="nav-2-1">
    
    <label class="md-nav__link" for="nav-2-1">
      2019
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-1">
        2019
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1-1" type="checkbox" id="nav-2-1-1">
    
    <label class="md-nav__link" for="nav-2-1-1">
      1
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-1-1">
        1
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../2019/01/penetration-testing-pasties/" title="Penetration Testing Pasties" class="md-nav__link">
      Penetration Testing Pasties
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2" type="checkbox" id="nav-2-2" checked>
    
    <label class="md-nav__link" for="nav-2-2">
      2018
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-2">
        2018
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2-1" type="checkbox" id="nav-2-2-1">
    
    <label class="md-nav__link" for="nav-2-2-1">
      11
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-2-1">
        11
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../11/a-deep-dive-into-cobalt-strike-malleable-c2/" title="A Deep Dive into Cobalt Strike Malleable C2" class="md-nav__link">
      A Deep Dive into Cobalt Strike Malleable C2
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2-2" type="checkbox" id="nav-2-2-2">
    
    <label class="md-nav__link" for="nav-2-2-2">
      6
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-2-2">
        6
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../06/threat-gets-a-vote-applying-a-threat-based-approach-to-security-testing/" title="Threat Get's a Vote - Applying a Threat Based Approach to Security Testing" class="md-nav__link">
      Threat Get's a Vote - Applying a Threat Based Approach to Security Testing
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2-3" type="checkbox" id="nav-2-2-3" checked>
    
    <label class="md-nav__link" for="nav-2-2-3">
      5
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-2-3">
        5
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Threat Mitagation Strategies - Part 2
      </label>
    
    <a href="./" title="Threat Mitagation Strategies - Part 2" class="md-nav__link md-nav__link--active">
      Threat Mitagation Strategies - Part 2
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#account-management" title="Account Management" class="md-nav__link">
    Account Management
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adjust-password-policy" title="Adjust Password Policy" class="md-nav__link">
    Adjust Password Policy
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setting-the-password-policy-using-gpo" title="Setting the Password Policy using GPO" class="md-nav__link">
    Setting the Password Policy using GPO
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#krbtgt-password-reset" title="KRBTGT password reset" class="md-nav__link">
    KRBTGT password reset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-laps-to-manage-the-local-administrator-rid-500-password" title="Use LAPS to manage the local Administrator (RID 500) password" class="md-nav__link">
    Use LAPS to manage the local Administrator (RID 500) password
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implement-managed-service-accounts" title="Implement Managed Service Accounts" class="md-nav__link">
    Implement Managed Service Accounts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protected-lsa" title="Protected LSA" class="md-nav__link">
    Protected LSA
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#protect-lsa-via-policy" title="Protect LSA Via policy" class="md-nav__link">
    Protect LSA Via policy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protect-lsa-via-registry-entry" title="Protect LSA Via Registry Entry" class="md-nav__link">
    Protect LSA Via Registry Entry
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#windows-logs" title="Windows Logs" class="md-nav__link">
    Windows Logs
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#application-log" title="Application log" class="md-nav__link">
    Application log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-log" title="Security log" class="md-nav__link">
    Security log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-log" title="Setup log" class="md-nav__link">
    Setup log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#system-log" title="System log" class="md-nav__link">
    System log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#forwardedevents-log" title="ForwardedEvents log" class="md-nav__link">
    ForwardedEvents log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#applications-and-services-logs" title="Applications and Services Logs" class="md-nav__link">
    Applications and Services Logs
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#admin" title="Admin" class="md-nav__link">
    Admin
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operational" title="Operational" class="md-nav__link">
    Operational
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analytic" title="Analytic" class="md-nav__link">
    Analytic
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debug" title="Debug" class="md-nav__link">
    Debug
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advanced-audit-policy-should-focus-on-these-in-no-specific-order" title="Advanced Audit Policy should focus on these (in no specific order)" class="md-nav__link">
    Advanced Audit Policy should focus on these (in no specific order)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enable-command-line-logging-must-include-ms15-015-kb3031432" title="Enable Command Line Logging (Must include MS15-015 KB3031432)" class="md-nav__link">
    Enable Command Line Logging (Must include MS15-015 KB3031432)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#account-honeytoken-manual" title="Account HoneyToken (manual)" class="md-nav__link">
    Account HoneyToken (manual)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#account-honeytoken-network" title="Account HoneyToken (network)" class="md-nav__link">
    Account HoneyToken (network)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spn-honeytoken" title="SPN HoneyToken" class="md-nav__link">
    SPN HoneyToken
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershell-module-logging" title="PowerShell Module Logging" class="md-nav__link">
    PowerShell Module Logging
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#log-parsing" title="Log Parsing" class="md-nav__link">
    Log Parsing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parse-powershell-events-for-the-following-mimikatz-indicators" title="Parse PowerShell events for the following Mimikatz indicators" class="md-nav__link">
    Parse PowerShell events for the following Mimikatz indicators
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detecting-offensive-powershell-tools" title="Detecting Offensive PowerShell Tools" class="md-nav__link">
    Detecting Offensive PowerShell Tools
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disable-windows-legacy-typically-unused-features" title="Disable Windows Legacy &amp; Typically Unused Features" class="md-nav__link">
    Disable Windows Legacy &amp; Typically Unused Features
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#force-group-policy-to-reapply-settings-during-refresh" title="Force Group Policy to reapply settings during "refresh"" class="md-nav__link">
    Force Group Policy to reapply settings during "refresh"
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-unneeded-services" title="Disable Unneeded Services" class="md-nav__link">
    Disable Unneeded Services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-net-session-enumeration-netcease" title="Disable Net Session Enumeration (NetCease)" class="md-nav__link">
    Disable Net Session Enumeration (NetCease)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-wpad" title="Disable WPAD" class="md-nav__link">
    Disable WPAD
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-llmnr" title="Disable LLMNR" class="md-nav__link">
    Disable LLMNR
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-wdigest" title="Disable WDigest" class="md-nav__link">
    Disable WDigest
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remove-the-use-of-ntlm-v1" title="Remove the use of NTLM v1" class="md-nav__link">
    Remove the use of NTLM v1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consider-other-mitigations" title="Consider other Mitigations" class="md-nav__link">
    Consider other Mitigations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-security-back-port-patch-kb2871997" title="Deploy security back-port patch (KB2871997)" class="md-nav__link">
    Deploy security back-port patch (KB2871997)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prevent-local-administrator-accounts-from-authenticating-over-the-network" title="Prevent local "administrator" accounts from authenticating over the network" class="md-nav__link">
    Prevent local "administrator" accounts from authenticating over the network
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configure-through-group-policy" title="Configure through Group Policy:" class="md-nav__link">
    Configure through Group Policy:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remote-connections" title="Remote Connections" class="md-nav__link">
    Remote Connections
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rdp-restricted-admin-connect-to-only-1-resource" title="RDP Restricted Admin (Connect to only 1 resource)" class="md-nav__link">
    RDP Restricted Admin (Connect to only 1 resource)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enable-restricted-admin-via-registry" title="Enable Restricted Admin via Registry" class="md-nav__link">
    Enable Restricted Admin via Registry
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-restricted-admin-via-gpo" title="Enable Restricted Admin via GPO" class="md-nav__link">
    Enable Restricted Admin via GPO
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rdp-windows-defender-remote-credential-guard-connect-to-multiple-resources" title="RDP Windows Defender Remote Credential Guard (Connect to multiple resources)" class="md-nav__link">
    RDP Windows Defender Remote Credential Guard (Connect to multiple resources)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enable-windows-defender-credential-guard-via-registry" title="Enable Windows Defender Credential Guard via Registry" class="md-nav__link">
    Enable Windows Defender Credential Guard via Registry
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-windef-cred-guard-via-gpo" title="Enable WinDef Cred Guard via GPO" class="md-nav__link">
    Enable WinDef Cred Guard via GPO
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#limit-client-to-client-communication-implement-and-configure-host-based-firewalls" title="Limit Client-to-Client Communication (Implement and Configure Host Based Firewalls)" class="md-nav__link">
    Limit Client-to-Client Communication (Implement and Configure Host Based Firewalls)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enable-firewall" title="Enable Firewall" class="md-nav__link">
    Enable Firewall
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blockcontrol-tcpudp-access-from-the-internal-network-and-dmz" title="Block/control TCP/UDP access from the Internal network and DMZ" class="md-nav__link">
    Block/control TCP/UDP access from the Internal network and DMZ
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#block-out-bound-tcpudp-access-from-the-client-systems-to-outbound-networks" title="Block out bound TCP/UDP access from the Client systems to outbound networks." class="md-nav__link">
    Block out bound TCP/UDP access from the Client systems to outbound networks.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implement-a-proxy-for-all-outbound-traffic" title="Implement a Proxy for All Outbound Traffic" class="md-nav__link">
    Implement a Proxy for All Outbound Traffic
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-a-new-gpo-to-manage-the-proxy-settings" title="Create a new GPO to manage the proxy settings" class="md-nav__link">
    Create a new GPO to manage the proxy settings
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configurations" title="Configurations" class="md-nav__link">
    Configurations
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoruns" title="AutoRuns" class="md-nav__link">
    AutoRuns
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#application-whiteblack-listing" title="Application White/Black listing" class="md-nav__link">
    Application White/Black listing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#applocker" title="Applocker" class="md-nav__link">
    Applocker
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#applocker-executable-path-restrictions" title="AppLocker Executable Path Restrictions" class="md-nav__link">
    AppLocker Executable Path Restrictions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#interesting-paths" title="Interesting Paths" class="md-nav__link">
    Interesting Paths
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#explicit-whitelisting" title="Explicit Whitelisting" class="md-nav__link">
    Explicit Whitelisting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interesting-file-extensions" title="Interesting file extensions" class="md-nav__link">
    Interesting file extensions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#manual-hunting-and-detection-examples" title="Manual Hunting and Detection Examples" class="md-nav__link">
    Manual Hunting and Detection Examples
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#filtering-event-logs-via-powershell" title="Filtering Event Logs via PowerShell" class="md-nav__link">
    Filtering Event Logs via PowerShell
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#log-locations-on-disk-only-use-event-viewer-or-cli-to-copy" title="Log locations on disk (only use event viewer or cli to copy)" class="md-nav__link">
    Log locations on disk (only use event viewer or cli to copy)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-times-service-was-installed-all-evtx-files-should-be-system-and-count" title="Get times Service was installed (all evtx files, should be system) and count" class="md-nav__link">
    Get times Service was installed (all evtx files, should be system) and count
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-blocked-events" title="Get blocked events" class="md-nav__link">
    Get blocked events
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-windowsdefender-actions" title="Get WindowsDefender actions" class="md-nav__link">
    Get WindowsDefender actions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-windowsdefender-detections" title="Get WindowsDefender detections" class="md-nav__link">
    Get WindowsDefender detections
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-files-by-extension-with-search-from-application-crash" title="Get files (by extension) with search from Application (crash)" class="md-nav__link">
    Get files (by extension) with search from Application (crash)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-emet-events" title="Get EMET events" class="md-nav__link">
    Get EMET events
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-service-installs-and-errors" title="Get service installs and errors" class="md-nav__link">
    Get service installs and errors
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-for-usb-loading" title="Search for USB loading" class="md-nav__link">
    Search for USB loading
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-for-errorwarninginfo" title="Search for error/warning/info" class="md-nav__link">
    Search for error/warning/info
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-remote-eventlog-caution-this-drops-credentials-onto-remote-system" title="Get remote eventlog (caution this drops credentials onto remote system)" class="md-nav__link">
    Get remote eventlog (caution this drops credentials onto remote system)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-log-within-x-hours" title="Get log within X hours" class="md-nav__link">
    Get log within X hours
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-logs-during-downtime" title="Get logs during "downtime"" class="md-nav__link">
    Get logs during "downtime"
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-wevtutil-to-export-logs-export-log" title="Use wevtutil to export logs (export-log)" class="md-nav__link">
    Use wevtutil to export logs (export-log)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-wevutil-to-get-last-20-startups-use-rcomputer-for-remote-and-qe-for-short-query" title="Use wevutil to get last 20 startups (use /r:computer for remote and qe for short query)" class="md-nav__link">
    Use wevutil to get last 20 startups (use /r:computer for remote and qe for short query)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows-consolidated-logging" title="Windows consolidated logging" class="md-nav__link">
    Windows consolidated logging
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-a-detailed-list-of-all-security-auditing-event-entries-use-an-elevated-prompt" title="Get a detailed list of all security-auditing event entries (use an elevated prompt)" class="md-nav__link">
    Get a detailed list of all security-auditing event entries (use an elevated prompt)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#return-a-list-of-all-security-auditing-categories-and-subcategories-use-an-elevated-prompt" title="Return a list of all security-auditing categories and subcategories (use an elevated prompt)" class="md-nav__link">
    Return a list of all security-auditing categories and subcategories (use an elevated prompt)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#network" title="Network" class="md-nav__link">
    Network
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#network-flow-basics" title="Network Flow Basics:" class="md-nav__link">
    Network Flow Basics:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#basic-pcap-carving-nix" title="Basic PCAP Carving (*nix)" class="md-nav__link">
    Basic PCAP Carving (*nix)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-certificates-from-pcap-use-bro-if-possible" title="Get certificates from pcap (use BRO if possible)" class="md-nav__link">
    Get certificates from pcap (use BRO if possible)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-certificates-see-bro" title="View certificates (see BRO)" class="md-nav__link">
    View certificates (see BRO)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-dns-queries-from-pcap-and-count-instances" title="Get DNS queries from pcap and count instances" class="md-nav__link">
    Get DNS queries from pcap and count instances
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-dns-queries-from-nx-domain" title="Get DNS queries from NX domain" class="md-nav__link">
    Get DNS queries from NX domain
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dns-response-codes" title="DNS Response Codes" class="md-nav__link">
    DNS Response Codes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-user-agents-from-pcap" title="Get User-Agents from pcap" class="md-nav__link">
    Get User-Agents from pcap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-info-for-frame-containing-search-dataf" title="Get info for frame containing search dataf" class="md-nav__link">
    Get info for frame containing search dataf
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-for-string-in-tcp-data-finds-data-not-in-field-ie-ua-in-json" title="Search for string in tcp data (finds data not in field i.e. UA in json)" class="md-nav__link">
    Search for string in tcp data (finds data not in field i.e. UA in json)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#find-strings-in-pcap" title="Find strings in pcap" class="md-nav__link">
    Find strings in pcap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-the-frame-that-contains-string" title="Get the frame that contains string" class="md-nav__link">
    Get the frame that contains string
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#show-packet-data-by-field" title="Show packet data by field" class="md-nav__link">
    Show packet data by field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-data-hex-from-first-two-packets-in-pcap" title="Get data &amp; hex from first two packets in pcap" class="md-nav__link">
    Get data &amp; hex from first two packets in pcap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frames-that-have-tcp-header-length-gt-20-and-port-25" title="Get frames that have tcp header length gt 20 and port 25" class="md-nav__link">
    Get frames that have tcp header length gt 20 and port 25
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-data-in-frames-that-have-tcp-header-length-gt-20-and-port-25" title="Get data in frames that have tcp header length gt 20 and port 25" class="md-nav__link">
    Get data in frames that have tcp header length gt 20 and port 25
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frames-with-hex-data-0x7932" title="Get frames with hex data 0x7932" class="md-nav__link">
    Get frames with hex data 0x7932
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frames-and-show-hex-data" title="Get frames and show hex data" class="md-nav__link">
    Get frames and show hex data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-all-arp-request-and-count-request1-reply2" title="Get all arp request and count (request=1, reply=2)" class="md-nav__link">
    Get all arp request and count (request=1, reply=2)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-iplen-less-than-46-64-for-ethernet-minus-14-header-and-4-trailer-icmp-of-0" title="Get ip.len less than 46 (64 for ethernet minus 14 header and 4 trailer) &amp; icmp of 0" class="md-nav__link">
    Get ip.len less than 46 (64 for ethernet minus 14 header and 4 trailer) &amp; icmp of 0
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-ip-option-of-loose-src-routing-with-offset-starting-at-ip-options" title="Get ip option of loose src routing with offset starting at ip options" class="md-nav__link">
    Get ip option of loose src routing with offset starting at ip options
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filter-info" title="Filter Info" class="md-nav__link">
    Filter Info
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frame-with-ip-src-and-ack-flag-set" title="Get frame with IP src and ACK flag set" class="md-nav__link">
    Get frame with IP src and ACK flag set
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frame-with-ip-src-and-ack-or-rst-flag-set" title="Get frame with IP src and ACK or RST flag set" class="md-nav__link">
    Get frame with IP src and ACK or RST flag set
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frame-with-dst-port-0-and-df-flag-set" title="Get frame with dst port 0 and DF flag set" class="md-nav__link">
    Get frame with dst port 0 and DF flag set
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frame-with-net-1010101024" title="Get frame with net 10.10.10.10/24" class="md-nav__link">
    Get frame with net 10.10.10.10/24
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frames-by-ip" title="Get frames by ip" class="md-nav__link">
    Get frames by ip
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-specific-frame-verbose-note-tcp-stream-index-number" title="View specific frame verbose (note tcp stream index number)" class="md-nav__link">
    View specific frame verbose (note tcp stream index number)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#follow-tcp-stream-0-ascii-raw-hex" title="Follow tcp stream 0 (ascii, raw, hex)" class="md-nav__link">
    Follow tcp stream 0 (ascii, raw, hex)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flow-data-analysis" title="Flow Data Analysis" class="md-nav__link">
    Flow Data Analysis
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-rwfilter-to-analyze-flow-data-by-ip-and-port" title="Use rwfilter to analyze flow data by IP and port" class="md-nav__link">
    Use rwfilter to analyze flow data by IP and port
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-detail-of-flow-data-by-ip-and-port" title="View detail of flow data by IP and port" class="md-nav__link">
    View detail of flow data by IP and port
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-all-udp-from-flow-then-pipe-to-get-field-4-4dst-port-3srcport-5proto-6packets-etc" title="Extract all UDP from flow then pipe to get field 4 (4=dst port, 3=srcport, 5=proto, 6=packets, etc)" class="md-nav__link">
    Extract all UDP from flow then pipe to get field 4 (4=dst port, 3=srcport, 5=proto, 6=packets, etc)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-connections-from-108-with-a-reset-to-close-then-pipe-to-get-srcip-count" title="Extract connections from 10/8 with a reset to close then pipe to get srcIP count" class="md-nav__link">
    Extract connections from 10/8 with a reset to close then pipe to get srcIP count
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-rwstats-to-get-flow-data-of-top-5-flows" title="Use rwstats to get flow data of top 5 flows" class="md-nav__link">
    Use rwstats to get flow data of top 5 flows
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-records-not-icmp-tcp-or-udp-note-fail-and-have-src-ip-of-1010101" title="Extract records not ICMP, TCP or UDP (note fail) and have src IP of 10.10.10.1" class="md-nav__link">
    Extract records not ICMP, TCP or UDP (note fail) and have src IP of 10.10.10.1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-top-5-ip-with-data-transfer" title="Get top 5 IP with data transfer" class="md-nav__link">
    Get top 5 IP with data transfer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-flows-with-larger-than-100000-bytes" title="Get flows with larger than 100,000 bytes" class="md-nav__link">
    Get flows with larger than 100,000 bytes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-queries" title="ELSA (BRO queries)" class="md-nav__link">
    ELSA (BRO queries)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#elsa-most-common-svc" title="ELSA most common svc" class="md-nav__link">
    ELSA most common svc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-nx-domains" title="ELSA BRO nx domains" class="md-nav__link">
    ELSA BRO nx domains
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-common-fqdn" title="ELSA BRO common FQDN" class="md-nav__link">
    ELSA BRO common FQDN
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-sites-hosting-exe" title="ELSA BRO Sites hosting EXE" class="md-nav__link">
    ELSA BRO Sites hosting EXE
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-uri-with-exe-downloads" title="ELSA BRO URI with EXE downloads" class="md-nav__link">
    ELSA BRO URI with EXE downloads
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-internal-ip-exe-download" title="ELSA BRO Internal IP EXE download" class="md-nav__link">
    ELSA BRO Internal IP EXE download
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-connections-wo-ua-group-by-source-ip" title="ELSA BRO connections w/o UA group by source IP" class="md-nav__link">
    ELSA BRO connections w/o UA group by source IP
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro" title="BRO" class="md-nav__link">
    BRO
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bro-logs" title="BRO Logs" class="md-nav__link">
    BRO Logs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-log-hunting" title="BRO Log Hunting" class="md-nav__link">
    BRO Log Hunting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-protocol-logs" title="BRO Protocol Logs" class="md-nav__link">
    BRO Protocol Logs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-carving" title="BRO Carving" class="md-nav__link">
    BRO Carving
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#read-and-output-bro-logs" title="Read and output bro logs" class="md-nav__link">
    Read and output bro logs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-source-src-ip-dst-ip-dst-port-and-bytes-in-that-order" title="Get source src ip, dst ip, dst port, and bytes (in that order)" class="md-nav__link">
    Get source src ip, dst ip, dst port, and bytes (in that order)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#same-as-above-but-sort-by-bytes-field-5-reverse-by-number" title="Same as above but sort by bytes (field 5 reverse by number)" class="md-nav__link">
    Same as above but sort by bytes (field 5 reverse by number)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-http-on-non-standard-ports-ssl" title="Get http on non-standard ports (ssl?)" class="md-nav__link">
    Get http on non-standard ports (ssl?)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-dns-info-from-bro-logs" title="Extract DNS info from bro logs" class="md-nav__link">
    Extract DNS info from bro logs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-user-agents" title="Get User-Agents" class="md-nav__link">
    Get User-Agents
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-mime-types" title="Get Mime Types" class="md-nav__link">
    Get Mime Types
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-bro-outbound-signature-stored-in-sig-file-read-with-s" title="Get bro outbound signature stored in .sig file (read with -s)" class="md-nav__link">
    Get bro outbound signature stored in .sig file (read with -s)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-bro-windows-shell-signature-stored-in-sig-file-read-with-s" title="Get bro Windows Shell signature stored in .sig file (read with -s)" class="md-nav__link">
    Get bro Windows Shell signature stored in .sig file (read with -s)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-bro-with-sig-file" title="Run bro with sig file" class="md-nav__link">
    Run bro with sig file
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-dst-addresses-in-signature-file" title="View dst addresses in signature file" class="md-nav__link">
    View dst addresses in signature file
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-event-script-to-find-user-agent-outboundbro" title="BRO event script to find User-Agent (outbound.bro)" class="md-nav__link">
    BRO event script to find User-Agent (outbound.bro)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-event-file-to-view-user-agent" title="Run event file to view user-agent" class="md-nav__link">
    Run event file to view user-agent
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-extract-common-files-from-pcap" title="BRO extract common files from pcap" class="md-nav__link">
    BRO extract common files from pcap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-ssl-info" title="Extract ssl info" class="md-nav__link">
    Extract ssl info
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-extract-unique-ssl-certificate-data" title="BRO extract unique SSL certificate data" class="md-nav__link">
    BRO extract unique SSL certificate data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-extract-ssl-issuer-data-from-certificate-extraction" title="BRO extract SSL issuer data from certificate extraction" class="md-nav__link">
    BRO extract SSL issuer data from certificate extraction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-show-shortest-issuer-from-extraction" title="BRO show shortest issuer from extraction" class="md-nav__link">
    BRO show shortest issuer from extraction
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modsecurity-rules" title="ModSecurity rules" class="md-nav__link">
    ModSecurity rules
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#errorlog-ua-not-starting-with-mozilla" title="error.log UA not starting with Mozilla" class="md-nav__link">
    error.log UA not starting with Mozilla
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-visiting-ip-url" title="error.log visiting IP URL" class="md-nav__link">
    error.log visiting IP URL
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-blank-ua" title="error.log blank UA" class="md-nav__link">
    error.log blank UA
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-ua-starting-with-mozilla" title="error.log UA starting with mozilla" class="md-nav__link">
    error.log UA starting with mozilla
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-visiting-by-ip-log-ua-used" title="error.log visiting by IP log UA used" class="md-nav__link">
    error.log visiting by IP log UA used
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-no-ua-not-blank-but-none" title="error.log no UA (not blank but none)" class="md-nav__link">
    error.log no UA (not blank but none)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-note-param-entry" title="error.log note param entry" class="md-nav__link">
    error.log note param entry
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-trigger-on-keyword-can-use-pattern" title="error.log trigger on keyword (can use pattern)" class="md-nav__link">
    error.log trigger on keyword (can use pattern)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#splunk" title="Splunk" class="md-nav__link">
    Splunk
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#new-unauthorized-service" title="New unauthorized service" class="md-nav__link">
    New unauthorized service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detecting-process-abuse" title="Detecting process abuse" class="md-nav__link">
    Detecting process abuse
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detecting-process-abuse-simplified-requires-one-entry-per-process" title="Detecting process abuse (simplified, requires one entry per process)" class="md-nav__link">
    Detecting process abuse (simplified, requires one entry per process)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#process-starts-and-connects-to-ip" title="Process starts and connects to IP" class="md-nav__link">
    Process starts and connects to IP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-smb-traffic-between-clients" title="Detect SMB traffic between clients" class="md-nav__link">
    Detect SMB traffic between clients
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-named-pipes" title="Detect Named Pipes" class="md-nav__link">
    Detect Named Pipes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-wmi" title="Detect WMI" class="md-nav__link">
    Detect WMI
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-powershell-commands" title="Detect PowerShell Commands" class="md-nav__link">
    Detect PowerShell Commands
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#alert-on-remote-files-copied-via-cmd-line" title="Alert on remote files copied via cmd line" class="md-nav__link">
    Alert on remote files copied via cmd line
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alert-on-c-or-admin-share-enumeration" title="Alert on C or Admin share enumeration" class="md-nav__link">
    Alert on C or Admin share enumeration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-for-file-delivery" title="Search for file delivery" class="md-nav__link">
    Search for file delivery
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-for-registry-run-or-runonce-keys" title="Search for Registry Run (or RunOnce) Keys" class="md-nav__link">
    Search for Registry Run (or RunOnce) Keys
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-for-file-system-persistence" title="Search for file system persistence" class="md-nav__link">
    Search for file system persistence
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-credential-harvesting" title="Detect credential harvesting" class="md-nav__link">
    Detect credential harvesting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#potential-privilege-escalation" title="Potential Privilege Escalation" class="md-nav__link">
    Potential Privilege Escalation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#potential-beaconing-detection" title="Potential Beaconing Detection" class="md-nav__link">
    Potential Beaconing Detection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-webshell-activity-note-this-should-be-updated-at-implementation-and-often" title="Detect webshell activity (note this should be updated at implementation and often)" class="md-nav__link">
    Detect webshell activity (note this should be updated at implementation and often)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-potential-sqli" title="Detect potential SQLi" class="md-nav__link">
    Detect potential SQLi
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-http-post-with-response" title="View HTTP POST with response" class="md-nav__link">
    View HTTP POST with response
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#find-weird-user-agents" title="Find Weird User-Agents" class="md-nav__link">
    Find Weird User-Agents
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-high-severity-epo-events" title="Get high severity EPO events" class="md-nav__link">
    Get high severity EPO events
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snort" title="Snort" class="md-nav__link">
    Snort
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#detect-psexec" title="Detect psexec" class="md-nav__link">
    Detect psexec
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-packets-with-with-port-4444-port-0" title="Detect packets with with port 4444 (port 0?)" class="md-nav__link">
    Detect packets with with port 4444 (port 0?)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snort-appid-list" title="Snort appid list" class="md-nav__link">
    Snort appid list
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interesting-file-extensions-note-this-is-the-same-list-as-above-placed-here-for-use-in-monitoring-via-snort" title="Interesting file extensions (Note this is the same list as above, placed here for use in monitoring via Snort)" class="md-nav__link">
    Interesting file extensions (Note this is the same list as above, placed here for use in monitoring via Snort)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#additional-useful-info" title="Additional Useful Info" class="md-nav__link">
    Additional Useful Info
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-methods-from-accesslog" title="Get methods from access.log" class="md-nav__link">
    Get methods from access.log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decode-encoded-url-line-290" title="Decode %encoded url (line 290)" class="md-nav__link">
    Decode %encoded url (line 290)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gather-information-on-windows-host" title="Gather Information on Windows host" class="md-nav__link">
    Gather Information on Windows host
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#list-task-services" title="List task services" class="md-nav__link">
    List task services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#show-modules-for-task" title="Show modules for task" class="md-nav__link">
    Show modules for task
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verbose-task-information" title="Verbose task information" class="md-nav__link">
    Verbose task information
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-information-about-processes" title="Get information about processes" class="md-nav__link">
    Get information about processes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#look-for-code-injected-into-memory" title="Look for code injected into memory" class="md-nav__link">
    Look for code injected into memory
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2-4" type="checkbox" id="nav-2-2-4">
    
    <label class="md-nav__link" for="nav-2-2-4">
      2
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-2-4">
        2
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../02/automating-cobalt-strike-profiles-apache-mod_rewrite-htaccess-files-intelligent-c2-redirection/" title="Automating Cobalt Strike Profiles Apache mod_rewrite htaccess Files for Intelligent C2 Redirection" class="md-nav__link">
      Automating Cobalt Strike Profiles Apache mod_rewrite htaccess Files for Intelligent C2 Redirection
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2-5" type="checkbox" id="nav-2-2-5">
    
    <label class="md-nav__link" for="nav-2-2-5">
      1
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-2-5">
        1
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../01/threat-mitigation-strategies-observations-recommendations/" title="Threat Mitagation Strategies - Part 1" class="md-nav__link">
      Threat Mitagation Strategies - Part 1
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../01/hostenum-updates-usage/" title="HostEnum - Updates and Usage Guide" class="md-nav__link">
      HostEnum - Updates and Usage Guide
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3" type="checkbox" id="nav-2-3">
    
    <label class="md-nav__link" for="nav-2-3">
      2017
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-3">
        2017
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3-1" type="checkbox" id="nav-2-3-1">
    
    <label class="md-nav__link" for="nav-2-3-1">
      10
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-3-1">
        10
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../2017/10/metatwin-borrowing-microsoft-metadata-and-digital-signatures-to-hide-binaries/" title="Borrowing Microsoft MetaData and Signatures to Hide Binary Payloads" class="md-nav__link">
      Borrowing Microsoft MetaData and Signatures to Hide Binary Payloads
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3-2" type="checkbox" id="nav-2-3-2">
    
    <label class="md-nav__link" for="nav-2-3-2">
      09
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-3-2">
        09
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../2017/09/install-bloodhound-ubuntu/" title="Install BloodHound on Ubuntu" class="md-nav__link">
      Install BloodHound on Ubuntu
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3-3" type="checkbox" id="nav-2-3-3">
    
    <label class="md-nav__link" for="nav-2-3-3">
      5
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-3-3">
        5
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../2017/05/empire-modifying-server-c2-indicators/" title="Empire Modifying Server C2 Indicators" class="md-nav__link">
      Empire Modifying Server C2 Indicators
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-4" type="checkbox" id="nav-2-4">
    
    <label class="md-nav__link" for="nav-2-4">
      2016
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-4">
        2016
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-4-1" type="checkbox" id="nav-2-4-1">
    
    <label class="md-nav__link" for="nav-2-4-1">
      09
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-4-1">
        09
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../2016/09/new-information-security-red-teaming-blog-threat-express-minis/" title="New Information Security and Red Teaming Blog Threat Express by MINIS" class="md-nav__link">
      New Information Security and Red Teaming Blog Threat Express by MINIS
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../archive/" title="Archive" class="md-nav__link">
      Archive
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../contributors/" title="Contributors" class="md-nav__link">
      Contributors
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#account-management" title="Account Management" class="md-nav__link">
    Account Management
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adjust-password-policy" title="Adjust Password Policy" class="md-nav__link">
    Adjust Password Policy
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setting-the-password-policy-using-gpo" title="Setting the Password Policy using GPO" class="md-nav__link">
    Setting the Password Policy using GPO
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#krbtgt-password-reset" title="KRBTGT password reset" class="md-nav__link">
    KRBTGT password reset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-laps-to-manage-the-local-administrator-rid-500-password" title="Use LAPS to manage the local Administrator (RID 500) password" class="md-nav__link">
    Use LAPS to manage the local Administrator (RID 500) password
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implement-managed-service-accounts" title="Implement Managed Service Accounts" class="md-nav__link">
    Implement Managed Service Accounts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protected-lsa" title="Protected LSA" class="md-nav__link">
    Protected LSA
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#protect-lsa-via-policy" title="Protect LSA Via policy" class="md-nav__link">
    Protect LSA Via policy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protect-lsa-via-registry-entry" title="Protect LSA Via Registry Entry" class="md-nav__link">
    Protect LSA Via Registry Entry
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#windows-logs" title="Windows Logs" class="md-nav__link">
    Windows Logs
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#application-log" title="Application log" class="md-nav__link">
    Application log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-log" title="Security log" class="md-nav__link">
    Security log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-log" title="Setup log" class="md-nav__link">
    Setup log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#system-log" title="System log" class="md-nav__link">
    System log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#forwardedevents-log" title="ForwardedEvents log" class="md-nav__link">
    ForwardedEvents log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#applications-and-services-logs" title="Applications and Services Logs" class="md-nav__link">
    Applications and Services Logs
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#admin" title="Admin" class="md-nav__link">
    Admin
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operational" title="Operational" class="md-nav__link">
    Operational
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analytic" title="Analytic" class="md-nav__link">
    Analytic
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debug" title="Debug" class="md-nav__link">
    Debug
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advanced-audit-policy-should-focus-on-these-in-no-specific-order" title="Advanced Audit Policy should focus on these (in no specific order)" class="md-nav__link">
    Advanced Audit Policy should focus on these (in no specific order)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enable-command-line-logging-must-include-ms15-015-kb3031432" title="Enable Command Line Logging (Must include MS15-015 KB3031432)" class="md-nav__link">
    Enable Command Line Logging (Must include MS15-015 KB3031432)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#account-honeytoken-manual" title="Account HoneyToken (manual)" class="md-nav__link">
    Account HoneyToken (manual)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#account-honeytoken-network" title="Account HoneyToken (network)" class="md-nav__link">
    Account HoneyToken (network)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spn-honeytoken" title="SPN HoneyToken" class="md-nav__link">
    SPN HoneyToken
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#powershell-module-logging" title="PowerShell Module Logging" class="md-nav__link">
    PowerShell Module Logging
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#log-parsing" title="Log Parsing" class="md-nav__link">
    Log Parsing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parse-powershell-events-for-the-following-mimikatz-indicators" title="Parse PowerShell events for the following Mimikatz indicators" class="md-nav__link">
    Parse PowerShell events for the following Mimikatz indicators
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detecting-offensive-powershell-tools" title="Detecting Offensive PowerShell Tools" class="md-nav__link">
    Detecting Offensive PowerShell Tools
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disable-windows-legacy-typically-unused-features" title="Disable Windows Legacy &amp; Typically Unused Features" class="md-nav__link">
    Disable Windows Legacy &amp; Typically Unused Features
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#force-group-policy-to-reapply-settings-during-refresh" title="Force Group Policy to reapply settings during "refresh"" class="md-nav__link">
    Force Group Policy to reapply settings during "refresh"
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-unneeded-services" title="Disable Unneeded Services" class="md-nav__link">
    Disable Unneeded Services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-net-session-enumeration-netcease" title="Disable Net Session Enumeration (NetCease)" class="md-nav__link">
    Disable Net Session Enumeration (NetCease)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-wpad" title="Disable WPAD" class="md-nav__link">
    Disable WPAD
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-llmnr" title="Disable LLMNR" class="md-nav__link">
    Disable LLMNR
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-wdigest" title="Disable WDigest" class="md-nav__link">
    Disable WDigest
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remove-the-use-of-ntlm-v1" title="Remove the use of NTLM v1" class="md-nav__link">
    Remove the use of NTLM v1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consider-other-mitigations" title="Consider other Mitigations" class="md-nav__link">
    Consider other Mitigations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-security-back-port-patch-kb2871997" title="Deploy security back-port patch (KB2871997)" class="md-nav__link">
    Deploy security back-port patch (KB2871997)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prevent-local-administrator-accounts-from-authenticating-over-the-network" title="Prevent local "administrator" accounts from authenticating over the network" class="md-nav__link">
    Prevent local "administrator" accounts from authenticating over the network
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configure-through-group-policy" title="Configure through Group Policy:" class="md-nav__link">
    Configure through Group Policy:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remote-connections" title="Remote Connections" class="md-nav__link">
    Remote Connections
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rdp-restricted-admin-connect-to-only-1-resource" title="RDP Restricted Admin (Connect to only 1 resource)" class="md-nav__link">
    RDP Restricted Admin (Connect to only 1 resource)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enable-restricted-admin-via-registry" title="Enable Restricted Admin via Registry" class="md-nav__link">
    Enable Restricted Admin via Registry
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-restricted-admin-via-gpo" title="Enable Restricted Admin via GPO" class="md-nav__link">
    Enable Restricted Admin via GPO
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rdp-windows-defender-remote-credential-guard-connect-to-multiple-resources" title="RDP Windows Defender Remote Credential Guard (Connect to multiple resources)" class="md-nav__link">
    RDP Windows Defender Remote Credential Guard (Connect to multiple resources)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enable-windows-defender-credential-guard-via-registry" title="Enable Windows Defender Credential Guard via Registry" class="md-nav__link">
    Enable Windows Defender Credential Guard via Registry
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-windef-cred-guard-via-gpo" title="Enable WinDef Cred Guard via GPO" class="md-nav__link">
    Enable WinDef Cred Guard via GPO
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#limit-client-to-client-communication-implement-and-configure-host-based-firewalls" title="Limit Client-to-Client Communication (Implement and Configure Host Based Firewalls)" class="md-nav__link">
    Limit Client-to-Client Communication (Implement and Configure Host Based Firewalls)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enable-firewall" title="Enable Firewall" class="md-nav__link">
    Enable Firewall
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blockcontrol-tcpudp-access-from-the-internal-network-and-dmz" title="Block/control TCP/UDP access from the Internal network and DMZ" class="md-nav__link">
    Block/control TCP/UDP access from the Internal network and DMZ
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#block-out-bound-tcpudp-access-from-the-client-systems-to-outbound-networks" title="Block out bound TCP/UDP access from the Client systems to outbound networks." class="md-nav__link">
    Block out bound TCP/UDP access from the Client systems to outbound networks.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implement-a-proxy-for-all-outbound-traffic" title="Implement a Proxy for All Outbound Traffic" class="md-nav__link">
    Implement a Proxy for All Outbound Traffic
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-a-new-gpo-to-manage-the-proxy-settings" title="Create a new GPO to manage the proxy settings" class="md-nav__link">
    Create a new GPO to manage the proxy settings
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configurations" title="Configurations" class="md-nav__link">
    Configurations
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoruns" title="AutoRuns" class="md-nav__link">
    AutoRuns
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#application-whiteblack-listing" title="Application White/Black listing" class="md-nav__link">
    Application White/Black listing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#applocker" title="Applocker" class="md-nav__link">
    Applocker
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#applocker-executable-path-restrictions" title="AppLocker Executable Path Restrictions" class="md-nav__link">
    AppLocker Executable Path Restrictions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#interesting-paths" title="Interesting Paths" class="md-nav__link">
    Interesting Paths
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#explicit-whitelisting" title="Explicit Whitelisting" class="md-nav__link">
    Explicit Whitelisting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interesting-file-extensions" title="Interesting file extensions" class="md-nav__link">
    Interesting file extensions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#manual-hunting-and-detection-examples" title="Manual Hunting and Detection Examples" class="md-nav__link">
    Manual Hunting and Detection Examples
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#filtering-event-logs-via-powershell" title="Filtering Event Logs via PowerShell" class="md-nav__link">
    Filtering Event Logs via PowerShell
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#log-locations-on-disk-only-use-event-viewer-or-cli-to-copy" title="Log locations on disk (only use event viewer or cli to copy)" class="md-nav__link">
    Log locations on disk (only use event viewer or cli to copy)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-times-service-was-installed-all-evtx-files-should-be-system-and-count" title="Get times Service was installed (all evtx files, should be system) and count" class="md-nav__link">
    Get times Service was installed (all evtx files, should be system) and count
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-blocked-events" title="Get blocked events" class="md-nav__link">
    Get blocked events
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-windowsdefender-actions" title="Get WindowsDefender actions" class="md-nav__link">
    Get WindowsDefender actions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-windowsdefender-detections" title="Get WindowsDefender detections" class="md-nav__link">
    Get WindowsDefender detections
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-files-by-extension-with-search-from-application-crash" title="Get files (by extension) with search from Application (crash)" class="md-nav__link">
    Get files (by extension) with search from Application (crash)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-emet-events" title="Get EMET events" class="md-nav__link">
    Get EMET events
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-service-installs-and-errors" title="Get service installs and errors" class="md-nav__link">
    Get service installs and errors
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-for-usb-loading" title="Search for USB loading" class="md-nav__link">
    Search for USB loading
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-for-errorwarninginfo" title="Search for error/warning/info" class="md-nav__link">
    Search for error/warning/info
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-remote-eventlog-caution-this-drops-credentials-onto-remote-system" title="Get remote eventlog (caution this drops credentials onto remote system)" class="md-nav__link">
    Get remote eventlog (caution this drops credentials onto remote system)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-log-within-x-hours" title="Get log within X hours" class="md-nav__link">
    Get log within X hours
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-logs-during-downtime" title="Get logs during "downtime"" class="md-nav__link">
    Get logs during "downtime"
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-wevtutil-to-export-logs-export-log" title="Use wevtutil to export logs (export-log)" class="md-nav__link">
    Use wevtutil to export logs (export-log)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-wevutil-to-get-last-20-startups-use-rcomputer-for-remote-and-qe-for-short-query" title="Use wevutil to get last 20 startups (use /r:computer for remote and qe for short query)" class="md-nav__link">
    Use wevutil to get last 20 startups (use /r:computer for remote and qe for short query)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows-consolidated-logging" title="Windows consolidated logging" class="md-nav__link">
    Windows consolidated logging
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-a-detailed-list-of-all-security-auditing-event-entries-use-an-elevated-prompt" title="Get a detailed list of all security-auditing event entries (use an elevated prompt)" class="md-nav__link">
    Get a detailed list of all security-auditing event entries (use an elevated prompt)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#return-a-list-of-all-security-auditing-categories-and-subcategories-use-an-elevated-prompt" title="Return a list of all security-auditing categories and subcategories (use an elevated prompt)" class="md-nav__link">
    Return a list of all security-auditing categories and subcategories (use an elevated prompt)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#network" title="Network" class="md-nav__link">
    Network
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#network-flow-basics" title="Network Flow Basics:" class="md-nav__link">
    Network Flow Basics:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#basic-pcap-carving-nix" title="Basic PCAP Carving (*nix)" class="md-nav__link">
    Basic PCAP Carving (*nix)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-certificates-from-pcap-use-bro-if-possible" title="Get certificates from pcap (use BRO if possible)" class="md-nav__link">
    Get certificates from pcap (use BRO if possible)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-certificates-see-bro" title="View certificates (see BRO)" class="md-nav__link">
    View certificates (see BRO)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-dns-queries-from-pcap-and-count-instances" title="Get DNS queries from pcap and count instances" class="md-nav__link">
    Get DNS queries from pcap and count instances
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-dns-queries-from-nx-domain" title="Get DNS queries from NX domain" class="md-nav__link">
    Get DNS queries from NX domain
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dns-response-codes" title="DNS Response Codes" class="md-nav__link">
    DNS Response Codes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-user-agents-from-pcap" title="Get User-Agents from pcap" class="md-nav__link">
    Get User-Agents from pcap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-info-for-frame-containing-search-dataf" title="Get info for frame containing search dataf" class="md-nav__link">
    Get info for frame containing search dataf
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-for-string-in-tcp-data-finds-data-not-in-field-ie-ua-in-json" title="Search for string in tcp data (finds data not in field i.e. UA in json)" class="md-nav__link">
    Search for string in tcp data (finds data not in field i.e. UA in json)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#find-strings-in-pcap" title="Find strings in pcap" class="md-nav__link">
    Find strings in pcap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-the-frame-that-contains-string" title="Get the frame that contains string" class="md-nav__link">
    Get the frame that contains string
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#show-packet-data-by-field" title="Show packet data by field" class="md-nav__link">
    Show packet data by field
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-data-hex-from-first-two-packets-in-pcap" title="Get data &amp; hex from first two packets in pcap" class="md-nav__link">
    Get data &amp; hex from first two packets in pcap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frames-that-have-tcp-header-length-gt-20-and-port-25" title="Get frames that have tcp header length gt 20 and port 25" class="md-nav__link">
    Get frames that have tcp header length gt 20 and port 25
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-data-in-frames-that-have-tcp-header-length-gt-20-and-port-25" title="Get data in frames that have tcp header length gt 20 and port 25" class="md-nav__link">
    Get data in frames that have tcp header length gt 20 and port 25
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frames-with-hex-data-0x7932" title="Get frames with hex data 0x7932" class="md-nav__link">
    Get frames with hex data 0x7932
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frames-and-show-hex-data" title="Get frames and show hex data" class="md-nav__link">
    Get frames and show hex data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-all-arp-request-and-count-request1-reply2" title="Get all arp request and count (request=1, reply=2)" class="md-nav__link">
    Get all arp request and count (request=1, reply=2)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-iplen-less-than-46-64-for-ethernet-minus-14-header-and-4-trailer-icmp-of-0" title="Get ip.len less than 46 (64 for ethernet minus 14 header and 4 trailer) &amp; icmp of 0" class="md-nav__link">
    Get ip.len less than 46 (64 for ethernet minus 14 header and 4 trailer) &amp; icmp of 0
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-ip-option-of-loose-src-routing-with-offset-starting-at-ip-options" title="Get ip option of loose src routing with offset starting at ip options" class="md-nav__link">
    Get ip option of loose src routing with offset starting at ip options
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filter-info" title="Filter Info" class="md-nav__link">
    Filter Info
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frame-with-ip-src-and-ack-flag-set" title="Get frame with IP src and ACK flag set" class="md-nav__link">
    Get frame with IP src and ACK flag set
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frame-with-ip-src-and-ack-or-rst-flag-set" title="Get frame with IP src and ACK or RST flag set" class="md-nav__link">
    Get frame with IP src and ACK or RST flag set
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frame-with-dst-port-0-and-df-flag-set" title="Get frame with dst port 0 and DF flag set" class="md-nav__link">
    Get frame with dst port 0 and DF flag set
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frame-with-net-1010101024" title="Get frame with net 10.10.10.10/24" class="md-nav__link">
    Get frame with net 10.10.10.10/24
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-frames-by-ip" title="Get frames by ip" class="md-nav__link">
    Get frames by ip
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-specific-frame-verbose-note-tcp-stream-index-number" title="View specific frame verbose (note tcp stream index number)" class="md-nav__link">
    View specific frame verbose (note tcp stream index number)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#follow-tcp-stream-0-ascii-raw-hex" title="Follow tcp stream 0 (ascii, raw, hex)" class="md-nav__link">
    Follow tcp stream 0 (ascii, raw, hex)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flow-data-analysis" title="Flow Data Analysis" class="md-nav__link">
    Flow Data Analysis
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-rwfilter-to-analyze-flow-data-by-ip-and-port" title="Use rwfilter to analyze flow data by IP and port" class="md-nav__link">
    Use rwfilter to analyze flow data by IP and port
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-detail-of-flow-data-by-ip-and-port" title="View detail of flow data by IP and port" class="md-nav__link">
    View detail of flow data by IP and port
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-all-udp-from-flow-then-pipe-to-get-field-4-4dst-port-3srcport-5proto-6packets-etc" title="Extract all UDP from flow then pipe to get field 4 (4=dst port, 3=srcport, 5=proto, 6=packets, etc)" class="md-nav__link">
    Extract all UDP from flow then pipe to get field 4 (4=dst port, 3=srcport, 5=proto, 6=packets, etc)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-connections-from-108-with-a-reset-to-close-then-pipe-to-get-srcip-count" title="Extract connections from 10/8 with a reset to close then pipe to get srcIP count" class="md-nav__link">
    Extract connections from 10/8 with a reset to close then pipe to get srcIP count
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-rwstats-to-get-flow-data-of-top-5-flows" title="Use rwstats to get flow data of top 5 flows" class="md-nav__link">
    Use rwstats to get flow data of top 5 flows
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-records-not-icmp-tcp-or-udp-note-fail-and-have-src-ip-of-1010101" title="Extract records not ICMP, TCP or UDP (note fail) and have src IP of 10.10.10.1" class="md-nav__link">
    Extract records not ICMP, TCP or UDP (note fail) and have src IP of 10.10.10.1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-top-5-ip-with-data-transfer" title="Get top 5 IP with data transfer" class="md-nav__link">
    Get top 5 IP with data transfer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-flows-with-larger-than-100000-bytes" title="Get flows with larger than 100,000 bytes" class="md-nav__link">
    Get flows with larger than 100,000 bytes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-queries" title="ELSA (BRO queries)" class="md-nav__link">
    ELSA (BRO queries)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#elsa-most-common-svc" title="ELSA most common svc" class="md-nav__link">
    ELSA most common svc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-nx-domains" title="ELSA BRO nx domains" class="md-nav__link">
    ELSA BRO nx domains
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-common-fqdn" title="ELSA BRO common FQDN" class="md-nav__link">
    ELSA BRO common FQDN
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-sites-hosting-exe" title="ELSA BRO Sites hosting EXE" class="md-nav__link">
    ELSA BRO Sites hosting EXE
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-uri-with-exe-downloads" title="ELSA BRO URI with EXE downloads" class="md-nav__link">
    ELSA BRO URI with EXE downloads
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-internal-ip-exe-download" title="ELSA BRO Internal IP EXE download" class="md-nav__link">
    ELSA BRO Internal IP EXE download
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsa-bro-connections-wo-ua-group-by-source-ip" title="ELSA BRO connections w/o UA group by source IP" class="md-nav__link">
    ELSA BRO connections w/o UA group by source IP
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro" title="BRO" class="md-nav__link">
    BRO
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bro-logs" title="BRO Logs" class="md-nav__link">
    BRO Logs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-log-hunting" title="BRO Log Hunting" class="md-nav__link">
    BRO Log Hunting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-protocol-logs" title="BRO Protocol Logs" class="md-nav__link">
    BRO Protocol Logs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-carving" title="BRO Carving" class="md-nav__link">
    BRO Carving
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#read-and-output-bro-logs" title="Read and output bro logs" class="md-nav__link">
    Read and output bro logs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-source-src-ip-dst-ip-dst-port-and-bytes-in-that-order" title="Get source src ip, dst ip, dst port, and bytes (in that order)" class="md-nav__link">
    Get source src ip, dst ip, dst port, and bytes (in that order)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#same-as-above-but-sort-by-bytes-field-5-reverse-by-number" title="Same as above but sort by bytes (field 5 reverse by number)" class="md-nav__link">
    Same as above but sort by bytes (field 5 reverse by number)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-http-on-non-standard-ports-ssl" title="Get http on non-standard ports (ssl?)" class="md-nav__link">
    Get http on non-standard ports (ssl?)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-dns-info-from-bro-logs" title="Extract DNS info from bro logs" class="md-nav__link">
    Extract DNS info from bro logs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-user-agents" title="Get User-Agents" class="md-nav__link">
    Get User-Agents
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-mime-types" title="Get Mime Types" class="md-nav__link">
    Get Mime Types
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-bro-outbound-signature-stored-in-sig-file-read-with-s" title="Get bro outbound signature stored in .sig file (read with -s)" class="md-nav__link">
    Get bro outbound signature stored in .sig file (read with -s)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-bro-windows-shell-signature-stored-in-sig-file-read-with-s" title="Get bro Windows Shell signature stored in .sig file (read with -s)" class="md-nav__link">
    Get bro Windows Shell signature stored in .sig file (read with -s)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-bro-with-sig-file" title="Run bro with sig file" class="md-nav__link">
    Run bro with sig file
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-dst-addresses-in-signature-file" title="View dst addresses in signature file" class="md-nav__link">
    View dst addresses in signature file
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-event-script-to-find-user-agent-outboundbro" title="BRO event script to find User-Agent (outbound.bro)" class="md-nav__link">
    BRO event script to find User-Agent (outbound.bro)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-event-file-to-view-user-agent" title="Run event file to view user-agent" class="md-nav__link">
    Run event file to view user-agent
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-extract-common-files-from-pcap" title="BRO extract common files from pcap" class="md-nav__link">
    BRO extract common files from pcap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-ssl-info" title="Extract ssl info" class="md-nav__link">
    Extract ssl info
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-extract-unique-ssl-certificate-data" title="BRO extract unique SSL certificate data" class="md-nav__link">
    BRO extract unique SSL certificate data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-extract-ssl-issuer-data-from-certificate-extraction" title="BRO extract SSL issuer data from certificate extraction" class="md-nav__link">
    BRO extract SSL issuer data from certificate extraction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bro-show-shortest-issuer-from-extraction" title="BRO show shortest issuer from extraction" class="md-nav__link">
    BRO show shortest issuer from extraction
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modsecurity-rules" title="ModSecurity rules" class="md-nav__link">
    ModSecurity rules
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#errorlog-ua-not-starting-with-mozilla" title="error.log UA not starting with Mozilla" class="md-nav__link">
    error.log UA not starting with Mozilla
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-visiting-ip-url" title="error.log visiting IP URL" class="md-nav__link">
    error.log visiting IP URL
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-blank-ua" title="error.log blank UA" class="md-nav__link">
    error.log blank UA
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-ua-starting-with-mozilla" title="error.log UA starting with mozilla" class="md-nav__link">
    error.log UA starting with mozilla
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-visiting-by-ip-log-ua-used" title="error.log visiting by IP log UA used" class="md-nav__link">
    error.log visiting by IP log UA used
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-no-ua-not-blank-but-none" title="error.log no UA (not blank but none)" class="md-nav__link">
    error.log no UA (not blank but none)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-note-param-entry" title="error.log note param entry" class="md-nav__link">
    error.log note param entry
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#errorlog-trigger-on-keyword-can-use-pattern" title="error.log trigger on keyword (can use pattern)" class="md-nav__link">
    error.log trigger on keyword (can use pattern)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#splunk" title="Splunk" class="md-nav__link">
    Splunk
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#new-unauthorized-service" title="New unauthorized service" class="md-nav__link">
    New unauthorized service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detecting-process-abuse" title="Detecting process abuse" class="md-nav__link">
    Detecting process abuse
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detecting-process-abuse-simplified-requires-one-entry-per-process" title="Detecting process abuse (simplified, requires one entry per process)" class="md-nav__link">
    Detecting process abuse (simplified, requires one entry per process)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#process-starts-and-connects-to-ip" title="Process starts and connects to IP" class="md-nav__link">
    Process starts and connects to IP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-smb-traffic-between-clients" title="Detect SMB traffic between clients" class="md-nav__link">
    Detect SMB traffic between clients
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-named-pipes" title="Detect Named Pipes" class="md-nav__link">
    Detect Named Pipes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-wmi" title="Detect WMI" class="md-nav__link">
    Detect WMI
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-powershell-commands" title="Detect PowerShell Commands" class="md-nav__link">
    Detect PowerShell Commands
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#alert-on-remote-files-copied-via-cmd-line" title="Alert on remote files copied via cmd line" class="md-nav__link">
    Alert on remote files copied via cmd line
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alert-on-c-or-admin-share-enumeration" title="Alert on C or Admin share enumeration" class="md-nav__link">
    Alert on C or Admin share enumeration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-for-file-delivery" title="Search for file delivery" class="md-nav__link">
    Search for file delivery
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-for-registry-run-or-runonce-keys" title="Search for Registry Run (or RunOnce) Keys" class="md-nav__link">
    Search for Registry Run (or RunOnce) Keys
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-for-file-system-persistence" title="Search for file system persistence" class="md-nav__link">
    Search for file system persistence
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-credential-harvesting" title="Detect credential harvesting" class="md-nav__link">
    Detect credential harvesting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#potential-privilege-escalation" title="Potential Privilege Escalation" class="md-nav__link">
    Potential Privilege Escalation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#potential-beaconing-detection" title="Potential Beaconing Detection" class="md-nav__link">
    Potential Beaconing Detection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-webshell-activity-note-this-should-be-updated-at-implementation-and-often" title="Detect webshell activity (note this should be updated at implementation and often)" class="md-nav__link">
    Detect webshell activity (note this should be updated at implementation and often)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-potential-sqli" title="Detect potential SQLi" class="md-nav__link">
    Detect potential SQLi
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-http-post-with-response" title="View HTTP POST with response" class="md-nav__link">
    View HTTP POST with response
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#find-weird-user-agents" title="Find Weird User-Agents" class="md-nav__link">
    Find Weird User-Agents
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-high-severity-epo-events" title="Get high severity EPO events" class="md-nav__link">
    Get high severity EPO events
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snort" title="Snort" class="md-nav__link">
    Snort
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#detect-psexec" title="Detect psexec" class="md-nav__link">
    Detect psexec
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-packets-with-with-port-4444-port-0" title="Detect packets with with port 4444 (port 0?)" class="md-nav__link">
    Detect packets with with port 4444 (port 0?)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snort-appid-list" title="Snort appid list" class="md-nav__link">
    Snort appid list
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interesting-file-extensions-note-this-is-the-same-list-as-above-placed-here-for-use-in-monitoring-via-snort" title="Interesting file extensions (Note this is the same list as above, placed here for use in monitoring via Snort)" class="md-nav__link">
    Interesting file extensions (Note this is the same list as above, placed here for use in monitoring via Snort)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#additional-useful-info" title="Additional Useful Info" class="md-nav__link">
    Additional Useful Info
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-methods-from-accesslog" title="Get methods from access.log" class="md-nav__link">
    Get methods from access.log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decode-encoded-url-line-290" title="Decode %encoded url (line 290)" class="md-nav__link">
    Decode %encoded url (line 290)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gather-information-on-windows-host" title="Gather Information on Windows host" class="md-nav__link">
    Gather Information on Windows host
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#list-task-services" title="List task services" class="md-nav__link">
    List task services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#show-modules-for-task" title="Show modules for task" class="md-nav__link">
    Show modules for task
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verbose-task-information" title="Verbose task information" class="md-nav__link">
    Verbose task information
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-information-about-processes" title="Get information about processes" class="md-nav__link">
    Get information about processes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#look-for-code-injected-into-memory" title="Look for code injected into memory" class="md-nav__link">
    Look for code injected into memory
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/threatexpress/edit/master/docs/blogs/2018/05/threat-mitigation-strategies-technical-recommendations-and-info-part-2.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="threat-mitigation-strategies-part-2">Threat Mitigation Strategies: Part 2<a class="headerlink" href="#threat-mitigation-strategies-part-2" title="Permanent link">&para;</a></h1>
<p><strong>James Tubberville | May 15, 2018 | Tweet This Post: <a href="https://twitter.com/intent/tweet?url=http://threatexpress.com/2018/05/threat-mitigation-strategies-technical-recommendations-and-info-part-2/&amp;text=Threat Mitigation Strategies - Part 2"><i class="fa fa-twitter"></i></a></strong></p>
<p><em>The following information was composed by Andrew Chiles (@andrewchiles), Joe Vest (@joevest) and myself (@minis_io) for quick and easy reference. Much of it was pulled together from a variety of sources with attempts to provide references for each. This post is intended to be more of a brain dump rather than a complete technical breakout.</em></p>
<p><img alt="minis_io defender" src="/threatexpress/img/20180515_094034_defend-300x300.png" /></p>
<p>As discussed in the Threat Mitigation Strategies Part 1  <a href="http://threatexpress.com/2018/01/threat-mitigation-strategies-observations-recommendations/">http://threatexpress.com/2018/01/threat-mitigation-strategies-observations-recommendations/</a>, there is commonality between the inherent weaknesses and the actions a threat might perform within an information system or network.  The following recommendations and informational snippets were derived from many offensive and defensive efforts that continue to support these correlations. Each recommendation and snippet can <strong>and very likely should</strong> be applied to all networks. Some systems and networks will have exceptions; however, these are exceptions (not the status quo) and should be handled as such. Also note the exact syntax and use will vary with the network construct, operating system/version, and legal/regulatory security requirements.</p>
<h2 id="account-management">Account Management<a class="headerlink" href="#account-management" title="Permanent link">&para;</a></h2>
<p>Accounts should have specific roles.</p>
<p><strong>General Guidelines</strong></p>
<ul>
<li>Domain Administrators perform management of Windows Active Directory. They do not manage servers or workstations.</li>
<li>Server Administrators perform management of servers. They do not manage workstations.</li>
<li>Workstation Administrators perform management of workstation. They do not manage servers.</li>
<li>Privileged accounts should NOT have external communications (Internet, email, etc.)</li>
<li>Standard users should NOT have elevated access (use secondary accounts if required)</li>
</ul>
<h3 id="adjust-password-policy">Adjust Password Policy<a class="headerlink" href="#adjust-password-policy" title="Permanent link">&para;</a></h3>
<p>Adjust password policy to conform to "800-63-3: Digital Identity Guidelines".</p>
<ul>
<li>Remove periodic password change requirements</li>
<li>Passwords should only be changed if forgotten or suspected compromise  </li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>I don't agree with the two above and recommend maintaining a reasonable duration for password change requirements</p>
</div>
<ul>
<li>Remove complexity requirements (Upper/Lower/Number/Special character)</li>
<li>Require a minimum password length of</li>
<li>A minimum length of 8 is required by NIST, but minimum of <strong>16</strong> is recommended for user accounts</li>
<li>A minimum length of 20 (28+ is recommended) for service accounts</li>
<li>Suggest the use of pass-phrases (such as four random lowercase words). <strong>Example:</strong> "correct horse battery staple!"</li>
<li>Screen passwords against password compromise lists</li>
<li>Screen passwords against keyboard walks</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Meeting the complexity recommendation may not be possible due to current compliance requirements.</p>
</div>
<h4 id="setting-the-password-policy-using-gpo">Setting the Password Policy using GPO<a class="headerlink" href="#setting-the-password-policy-using-gpo" title="Permanent link">&para;</a></h4>
<p>Edit the "Domain Password Policy" GPO to configure the appropriate password length</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>1. Open Group Policy  
2. Computer Configurations &gt; Policies &gt; Windows Settings &gt; Security Settings &gt; Account Policy &gt; Password Policy  
3. Minimum password length: 20
</pre></div>
</td></tr></table>

<h3 id="krbtgt-password-reset">KRBTGT password reset<a class="headerlink" href="#krbtgt-password-reset" title="Permanent link">&para;</a></h3>
<p>Regularly reset the KRBTGT password to minimize stolen credentials from be used in the future.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Review the reset tool guide &quot;Guide to Running New-CtmADKrbtgtKeys&quot; (see references)  
Use the the PowerShell script New-CtmADKrbtgtKeys.ps1 to reset the KRBTGT  
Wait 24 hours and execute the change a 2nd time  
Recommend running on a regular schedule. This should be monthly, quarterly (at most), or after an incident where compromise is suspected.
</pre></div>
</td></tr></table>

<p><strong>References</strong></p>
<ul>
<li><a href="https://gallery.technet.microsoft.com/Reset-the-krbtgt-account-581a9e51">https://gallery.technet.microsoft.com/Reset-the-krbtgt-account-581a9e51</a></li>
<li><a href="https://adsecurity.org/?p=483">https://adsecurity.org/?p=483</a></li>
</ul>
<hr />
<h3 id="use-laps-to-manage-the-local-administrator-rid-500-password">Use LAPS to manage the local Administrator (RID 500) password<a class="headerlink" href="#use-laps-to-manage-the-local-administrator-rid-500-password" title="Permanent link">&para;</a></h3>
<ul>
<li>Install KB2871997</li>
<li>Follow details outlined at <a href="https://adsecurity.org/?p=1790">https://adsecurity.org/?p=1790</a></li>
</ul>
<p><strong>References</strong></p>
<ul>
<li><a href="https://adsecurity.org/?p=1790">https://adsecurity.org/?p=1790</a></li>
<li><a href="https://adsecurity.org/?p=559">https://adsecurity.org/?p=559</a></li>
</ul>
<hr />
<h3 id="implement-managed-service-accounts">Implement Managed Service Accounts<a class="headerlink" href="#implement-managed-service-accounts" title="Permanent link">&para;</a></h3>
<p>Windows Server 2008 R2 and Windows 7 introduced Managed Service Accounts. MSA's allow you to create an account in Active Directory that is tied to a specific computer. That account has its own complex password (see password policy) and is maintained automatically. This means that an MSA can run services on a computer in a secure and easy to maintain manner, while maintaining the capability to connect to network resources as a specific user principal.</p>
<p>Group level MSA's can be deployed in Windows 2012 or higher Domains.</p>
<p><strong>Reference</strong></p>
<ul>
<li><a href="https://blogs.technet.microsoft.com/askds/2009/09/10/managed-service-accounts-understanding-implementing-best-practices-and-troubleshooting/">https://blogs.technet.microsoft.com/askds/2009/09/10/managed-service-accounts-understanding-implementing-best-practices-and-troubleshooting/</a></li>
<li><a href="https://technet.microsoft.com/en-us/library/hh831782.aspx">https://technet.microsoft.com/en-us/library/hh831782.aspx</a></li>
</ul>
<hr />
<h3 id="protected-lsa">Protected LSA<a class="headerlink" href="#protected-lsa" title="Permanent link">&para;</a></h3>
<h4 id="protect-lsa-via-policy">Protect LSA Via policy<a class="headerlink" href="#protect-lsa-via-policy" title="Permanent link">&para;</a></h4>
<p><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nt">1</span><span class="o">.</span> <span class="nt">Advanced</span> <span class="nt">Audit</span> <span class="nt">Policy</span> <span class="nt">Configuration</span> <span class="o">&gt;</span> <span class="nt">Object</span> <span class="nt">Access</span> <span class="o">&gt;</span> <span class="nt">Audit</span> <span class="nt">Kernel</span> <span class="nt">Object</span>  
<span class="nt">2</span><span class="o">.</span> <span class="nt">Enable</span> <span class="nt">SACL</span> <span class="nt">L</span><span class="s2">&quot;S:(AU;SAFA;0x0010;;;WD)&quot;</span>
</pre></div>
</td></tr></table>
and</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>1. Computer Configuration &gt; Preferences &gt; Windows Settings  
2. Right-click Registry &gt; New &gt; Registry Item  
3. Hive HKLM &gt; Path SYSTEMCurrentControlSetControlLsa  
4. DWORD value RunAsPPL=00000001
</pre></div>
</td></tr></table>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>LSA Protection prevents non-protected processes from interacting with LSASS. Mimikatz can still bypass this with a driver ("!+").</p>
</div>
<h4 id="protect-lsa-via-registry-entry">Protect LSA Via Registry Entry<a class="headerlink" href="#protect-lsa-via-registry-entry" title="Permanent link">&para;</a></h4>
<p><code class="codehilite">Manually create registry entry HKEY_LOCAL_MACHINESystemCurrentControlSetControlLsa DWORD RunAsPPL=00000001</code></p>
<p>or</p>
<p><code class="codehilite">reg add HKEY_LOCAL_MACHINESystemCurrentControlSetControlLsa /v RunAsPPL /d 00000001 /t REG_DWORD</code></p>
<hr />
<p>Windows Event Forwarding (WEF) reads any operational or administrative event log on a device in your organization and forwards the events you choose to a Windows Event Collector (WEC) server.</p>
<h2 id="windows-logs">Windows Logs<a class="headerlink" href="#windows-logs" title="Permanent link">&para;</a></h2>
<p>The Windows Logs category includes the logs that were available on previous versions of Windows: the Application, Security, and System logs. It also includes two new logs: the Setup log and the ForwardedEvents log. Windows logs are intended to store events from legacy applications and events that apply to the entire system.</p>
<h5 id="application-log">Application log<a class="headerlink" href="#application-log" title="Permanent link">&para;</a></h5>
<p>The Application log contains events logged by applications or programs. For example, a database program might record a file error in the application log. Program developers decide which events to log.</p>
<h5 id="security-log">Security log<a class="headerlink" href="#security-log" title="Permanent link">&para;</a></h5>
<p>The Security log contains events such as valid and invalid logon attempts, as well as events related to resource use, such as creating, opening, or deleting files or other objects. Administrators can specify what events are recorded in the security log. For example, if you have enabled logon auditing, attempts to log on to the system are recorded in the security log.</p>
<h5 id="setup-log">Setup log<a class="headerlink" href="#setup-log" title="Permanent link">&para;</a></h5>
<p>The Setup log contains events related to application setup.</p>
<h5 id="system-log">System log<a class="headerlink" href="#system-log" title="Permanent link">&para;</a></h5>
<p>The System log contains events logged by Windows system components. For example, the failure of a driver or other system component to load during startup is recorded in the system log. The event types logged by system components are predetermined by Windows.</p>
<h5 id="forwardedevents-log">ForwardedEvents log<a class="headerlink" href="#forwardedevents-log" title="Permanent link">&para;</a></h5>
<p>The ForwardedEvents log is used to store events collected from remote computers. To collect events from remote computers, you must create an event subscription. To learn about event subscriptions, see Event Subscriptions.</p>
<h4 id="applications-and-services-logs">Applications and Services Logs<a class="headerlink" href="#applications-and-services-logs" title="Permanent link">&para;</a></h4>
<p>Applications and Services logs are a new category of event logs. These logs store events from a single application or component rather than events that might have system wide impact.</p>
<p>This category of logs includes four subtypes: Admin, Operational, Analytic, and Debug logs. Events in Admin logs are of particular interest to IT Professionals using the Event Viewer to troubleshoot problems. Events in the Admin log should provide you with guidance about how to respond to them. Events in the Operational log are also useful for IT Professionals, but they are likely to require more interpretation.</p>
<p>Admin and Debug logs are not as user friendly. Analytic logs store events that trace an issue and, often, a high volume of events are logged. Debug logs are used by developers when debugging applications. Both Analytic and Debug logs are hidden and disabled by default. To make these logs visible, follow the steps in Show or Hide Analytic and Debug Logs. To enable these logs, follow the steps in Enable Analytic and Debug Logs.</p>
<h5 id="admin">Admin<a class="headerlink" href="#admin" title="Permanent link">&para;</a></h5>
<p>These events are primarily targeted at end users, administrators, and support personnel. The events that are found in the Admin channels indicate a problem and a well-defined solution that an administrator can act on. An example of an admin event is an event that occurs when an application fails to connect to a printer. These events are either well documented or have a message associated with them that gives the reader direct instructions of what must be done to rectify the problem.</p>
<h5 id="operational">Operational<a class="headerlink" href="#operational" title="Permanent link">&para;</a></h5>
<p>Operational events are used for analyzing and diagnosing a problem or occurrence. They can be used to trigger tools or tasks based on the problem or occurrence. An example of an operational event is an event that occurs when a printer is added or removed from a system.</p>
<h5 id="analytic">Analytic<a class="headerlink" href="#analytic" title="Permanent link">&para;</a></h5>
<p>Analytic events are published in high volume. They describe program operation and indicate problems that cannot be handled by user intervention.</p>
<h5 id="debug">Debug<a class="headerlink" href="#debug" title="Permanent link">&para;</a></h5>
<p>Debug events are used by developers troubleshooting issues with their programs.</p>
<hr />
<h3 id="advanced-audit-policy-should-focus-on-these-in-no-specific-order">Advanced Audit Policy should focus on these (in no specific order)<a class="headerlink" href="#advanced-audit-policy-should-focus-on-these-in-no-specific-order" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>1. A logon was attempted using explicit credentials: Event 552 and 4648  
2. A member was added to a security-enabled global group: Event 4728  
3. A member was added to a security-enabled local group: Event 4732  
4. A member was added to a security-enabled universal group: Event 4756  
5. An account failed to log on: Event 529-539 4625 (followed by a success 4624)  
6. LogonAccount/TargetUserName is Administrator (Using RID-500): Event 4624, 4776  
7. Scheduled Task Creation: Event 602, 4698  
8. Log was cleared: Event 104 and 1102, 4949  
9. EMET dies: Event 1 and 2  
10. Application Error or Hang: Event 1000 and 1002  
11. Windows Defender Errors: Event 1005, 1006, 1008, 1010, 2001, 2003, 2004, 3002, 5008  
12. New process: User NOT admin and Event 4688  
(arp, at, bcdedit, certutil, cscript, cmd, dsquery, hostname, ipconfig, msbuild, nbtstat, net, netsh, netstat, nslookup, ntdsutil, pcalua, ping, powershell, psexec, reg, regasm, regedit, regedt32, regsvr32, regsvcs, rundll32, set, sc, schtasks, systeminfo, tasklist, tracert, whoami, wmic, wscript, wsmprovhost)  
13. Service creation/install: Event 601, 4697, 7045  
14. Service changes: Event 7040  
15. File share access/attempts (C$, ADMIN$, IPC$): Event 5140  
16. PowerShell execution and module loading: Event 501 and 4104 respectively  
17. External media detection: All Events 7045, 10000, 10001 or 10002, 10100, 20001, 20003, 24576, 24577, 24579  
18. User creation: Event 4720
</pre></div>
</td></tr></table>

<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>It's a good idea to hide/exclude these events except specific conditions (See caveats above) as these are consistently rolling: 4688,4689,5156,5158</p>
</div>
<h5 id="enable-command-line-logging-must-include-ms15-015-kb3031432">Enable Command Line Logging (Must include MS15-015 KB3031432)<a class="headerlink" href="#enable-command-line-logging-must-include-ms15-015-kb3031432" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">HKLMSoftwareMicrosoftWindowsCurrentVersionPoliciesSystemAudit DWORD ProcessCreationIncludeCmdLine_Enabled=1</code></p>
<h5 id="account-honeytoken-manual">Account HoneyToken (manual)<a class="headerlink" href="#account-honeytoken-manual" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">echo &quot;crazypassword&quot; | runas /u:yourdomain.comXadmin /netonly ipconfig</code></p>
<p>Consider a check on 4625 where Xadmin is found</p>
<p>Also add hash of crazypassword to IDS and alert when seen</p>
<h5 id="account-honeytoken-network">Account HoneyToken (network)<a class="headerlink" href="#account-honeytoken-network" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">Invoke-HoneyCreds.ps1</code></p>
<p>Reference: <a href="https://github.com/Ben0xA/PowerShellDefense/blob/master/Invoke-HoneyCreds.ps1">https://github.com/Ben0xA/PowerShellDefense/blob/master/Invoke-HoneyCreds.ps1</a></p>
<h5 id="spn-honeytoken">SPN HoneyToken<a class="headerlink" href="#spn-honeytoken" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">Set-ADUser watchaccount -ServicePrincipalNames @{Add=&quot;MSSQLSvc/sql1:1433}</code></p>
<hr />
<h3 id="powershell-module-logging">PowerShell Module Logging<a class="headerlink" href="#powershell-module-logging" title="Permanent link">&para;</a></h3>
<p>Ensure all Windows systems have PowerShell v3 or newer. Newer versions of PowerShell have better logging features, especially PowerShell v5. This will log all PowerShell activity including all PowerShell modules.</p>
<p>Enable PowerShell Module Logging  </p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>1. Open Group Policy  
2. Computer Configuration &gt; Policies &gt; Administrative Templates &gt; Windows Components &gt; Windows PowerShell  
3. Turn on Module Logging  
4. Enter &quot;*&quot; and click OK.`
</pre></div>
</td></tr></table>

<h4 id="log-parsing">Log Parsing<a class="headerlink" href="#log-parsing" title="Permanent link">&para;</a></h4>
<p>If enabled, PowerShell activity will be logged to the Microsoft-Windows-PowerShell/Operational Log. Push or pull these events to a central logging server (via Windows Event Forwarding or similar) or SIEM.</p>
<h4 id="parse-powershell-events-for-the-following-mimikatz-indicators">Parse PowerShell events for the following Mimikatz indicators<a class="headerlink" href="#parse-powershell-events-for-the-following-mimikatz-indicators" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>&quot;System.Reflection.AssemblyName&quot;  
&quot;System.Reflection.Emit.AssemblyBuilderAccess &quot;  
&quot;System.Runtime.InteropServices.MarshalAsAttribute&quot;  
&quot;TOKEN_PRIVILEGES&quot;  
&quot;SE_PRIVILEGE_ENABLED&quot;`
</pre></div>
</td></tr></table>

<h4 id="detecting-offensive-powershell-tools">Detecting Offensive PowerShell Tools<a class="headerlink" href="#detecting-offensive-powershell-tools" title="Permanent link">&para;</a></h4>
<p>Many PowerShell offensive tools use the following calls which are logged in PowerShell Module Logging.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>&quot;GetDelegateForFunctionPointer&quot;  
&quot;System.Reflection.AssemblyName&quot;  
&quot;System.Reflection.Emit.AssemblyBuilderAccess&quot;  
&quot;System.Management.Automation.WindowsErrorReporting&quot;  
&quot;MiniDumpWriteDump&quot;  
&quot;TOKEN_IMPERSONATE&quot;  
&quot;TOKEN_DUPLICATE&quot;  
&quot;TOKEN_ADJUST_PRIVILEGES&quot;  
&quot;TOKEN_PRIVILEGES&quot;`
</pre></div>
</td></tr></table>

<p><strong>Reference</strong></p>
<ul>
<li><a href="https://github.com/palantir/windows-event-forwarding/tree/master/group-policy-objects">https://github.com/palantir/windows-event-forwarding/tree/master/group-policy-objects</a></li>
<li><a href="https://github.com/iadgov/Event-Forwarding-Guidance/tree/master/Subscriptions/samples">https://github.com/iadgov/Event-Forwarding-Guidance/tree/master/Subscriptions/samples</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/threat-protection/use-windows-event-forwarding-to-assist-in-instrusion-detection">https://docs.microsoft.com/en-us/windows/threat-protection/use-windows-event-forwarding-to-assist-in-instrusion-detection</a></li>
<li><a href="https://github.com/MicrosoftDocs/windows-itpro-docs/blob/master/windows/threat-protection/use-windows-event-forwarding-to-assist-in-instrusion-detection.md">https://github.com/MicrosoftDocs/windows-itpro-docs/blob/master/windows/threat-protection/use-windows-event-forwarding-to-assist-in-instrusion-detection.md</a></li>
</ul>
<hr />
<h2 id="disable-windows-legacy-typically-unused-features">Disable Windows Legacy &amp; <strong>Typically</strong> Unused Features<a class="headerlink" href="#disable-windows-legacy-typically-unused-features" title="Permanent link">&para;</a></h2>
<p>The reference (Securing Windows Workstations: Developing a Secure Baseline) located at <a href="https://adsecurity.org/?p=3299">https://adsecurity.org/?p=3299</a> contains a wealth of information to help reduce security risks in a Windows Domain. Key mitigations are highlighted below.</p>
<h3 id="force-group-policy-to-reapply-settings-during-refresh">Force Group Policy to reapply settings during "refresh"<a class="headerlink" href="#force-group-policy-to-reapply-settings-during-refresh" title="Permanent link">&para;</a></h3>
<p><code class="codehilite">Computer Configuration&gt;Policies&gt;Administrative Templates&gt;System&gt;Group Policy&gt;Configure security policy processing</code></p>
<p>Set to Enabled  </p>
<p><code class="codehilite">Also check the box for &quot;Process even if the Group Policy objects have not changed&quot;</code></p>
<p>It's also recommended to configure the same settings for each of the following:</p>
<ul>
<li>Computer Configuration, Policies, Administrative Templates, System, Group Policy, Configure registry policy processing</li>
<li>Computer Configuration, Policies, Administrative Templates, System, Group Policy, Configure scripts policy processing</li>
<li>As well as any other policy settings as needed.</li>
</ul>
<hr />
<h3 id="disable-unneeded-services">Disable Unneeded Services<a class="headerlink" href="#disable-unneeded-services" title="Permanent link">&para;</a></h3>
<p>The document Service-management-WS2016.xlsx contains a list default services, their state, use, and if it is safe to disable.</p>
<ul>
<li>Review the Services outlined in the document Service-management-WS2016.xlsx</li>
<li>Create a list of service to disable, and enforce via GPO</li>
</ul>
<h3 id="disable-net-session-enumeration-netcease">Disable Net Session Enumeration (NetCease)<a class="headerlink" href="#disable-net-session-enumeration-netcease" title="Permanent link">&para;</a></h3>
<p>This hardening process prevents attackers from easily getting some valuable recon information to move laterally within their victim's network.</p>
<ul>
<li>Run the NetCease PowerShell script on Server</li>
<li>Include DCs, Fileservers, or other servers where Session information may be used by and attacker for enumeration</li>
</ul>
<p><strong>References</strong></p>
<ul>
<li><a href="https://gallery.technet.microsoft.com/Net-Cease-Blocking-Net-1e8dcb5b">https://gallery.technet.microsoft.com/Net-Cease-Blocking-Net-1e8dcb5b</a></li>
<li><a href="https://adsecurity.org/?p=3299">https://adsecurity.org/?p=3299</a></li>
</ul>
<hr />
<h3 id="disable-wpad">Disable WPAD<a class="headerlink" href="#disable-wpad" title="Permanent link">&para;</a></h3>
<p>Web Proxy Auto-Discovery Protocol (WPAD) is "a method used by clients to locate the URL of a configuration file using DHCP and/or DNS discovery methods. Once detection and download of the configuration file is complete, it can be executed to determine the proxy for a specified URL."</p>
<p>Disable WPAD via Group Policy by deploying the following registry change:</p>
<p><code class="codehilite">HKEY_CURRENT_USERSoftwareMicrosoftWindowsCurrentVersionInternet SettingsWpadNew DWORD (32-Bit Value) called &quot;WpadOverride&quot; and set to &quot;1&quot;</code></p>
<p>Disable the service "WinHTTP Web Proxy Auto-Discovery Service"</p>
<p><code class="codehilite">Computer Configuration&gt;Policies&gt;Windows Settings&gt;Security Settings&gt;System ServicesSet WinHTTP Web Proxy Auto-Discovery Service to Disabled</code></p>
<p>Note:<br />
Partial mitigation of WPAD issues is possible by installing the Microsoft patch KB3165191 (MS16-077). This patch hardens the WPAD process and when the system responds to NetBIOS requests.</p>
<hr />
<h3 id="disable-llmnr">Disable LLMNR<a class="headerlink" href="#disable-llmnr" title="Permanent link">&para;</a></h3>
<p>Link-Local Multicast Name Resolution (LLMNR):<br />
In a nutshell, Link-Local Multicast Name Resolution (LLMNR) resolves single label names (like: COMPUTER1), on the local subnet, when DNS is unable to resolve the name.</p>
<p>Disable LLMNR via Group Policy by deploying the following:</p>
<p><code class="codehilite">Group Policy:Computer Configuration/Administrative Templates/Network/DNS ClientSet &quot;Turn Off Multicast Name Resolution&quot; to &quot;Enabled&quot;</code></p>
<hr />
<h3 id="disable-wdigest">Disable WDigest<a class="headerlink" href="#disable-wdigest" title="Permanent link">&para;</a></h3>
<p>WDigest provides support for Digest authentication which is: "An industry standard that is used in Windows Server 2003 for Lightweight Directory Access Protocol (LDAP) and Web authentication. Digest Authentication transmits credentials across the network as an MD5 hash or message digest."</p>
<p>Prior to Windows 8.1 and Windows Server 2012 R2, Wdigest was enabled which placed the user's "clear text" password in LSASS memory space in order to support basic authentication scenarios. Windows 8.1 and Windows Server 2012 R2 and newer have WDigest disabled by default.</p>
<p>Disable WDigest via Group Policy by deploying the following registry change:</p>
<p><code class="codehilite">HKEY_LOCAL_MACHINESystemCurrentControlSetControlSecurityProvidersWdigestUseLogonCredential = &quot;0&quot;</code></p>
<p><strong>References</strong></p>
<ul>
<li><a href="https://adsecurity.org/?p=3299">https://adsecurity.org/?p=3299</a></li>
</ul>
<hr />
<h3 id="remove-the-use-of-ntlm-v1">Remove the use of NTLM v1<a class="headerlink" href="#remove-the-use-of-ntlm-v1" title="Permanent link">&para;</a></h3>
<p>Windows Server 2008 R2 included features to help identify NTLM authentication use on the network. It is important to completely remove these legacy authentication protocols since they are insecure. Removal and prevention of LM and NTLMv1 use can be activated through the use of Group Policy security settings.<br />
Plan to move to NTLMv2 and Kerberos at the least, with the long-term goal being Kerberos only.</p>
<ul>
<li>Audit the use of NTLM v1 on the network</li>
<li>Determine the risks and need to support NTLM v1</li>
<li>Disable the use of NTLM v1</li>
</ul>
<p><strong>Reference</strong></p>
<ul>
<li><a href="https://technet.microsoft.com/en-us/library/jj865674(v=ws.10).aspx">https://technet.microsoft.com/en-us/library/jj865674(v=ws.10).aspx</a></li>
<li><a href="https://technet.microsoft.com/en-us/library/dd560653%28v=ws.10%29.aspx">https://technet.microsoft.com/en-us/library/dd560653%28v=ws.10%29.aspx</a></li>
</ul>
<h3 id="consider-other-mitigations">Consider other Mitigations<a class="headerlink" href="#consider-other-mitigations" title="Permanent link">&para;</a></h3>
<p>Consider other mitigations detailed at <a href="https://adsecurity.org/?p=3299">https://adsecurity.org/?p=3299</a></p>
<p><strong>References</strong></p>
<ul>
<li><a href="https://adsecurity.org/?p=3299">https://adsecurity.org/?p=3299</a></li>
</ul>
<hr />
<h3 id="deploy-security-back-port-patch-kb2871997">Deploy security back-port patch (KB2871997)<a class="headerlink" href="#deploy-security-back-port-patch-kb2871997" title="Permanent link">&para;</a></h3>
<p>Ensure all Windows systems prior to Windows 8.1 &amp; Windows Server 2012 R2 have the KB2871997 patch installed. This patch updates earlier supported versions of Windows with security enhancements baked into Windows 8.1 &amp; Windows Server 2012 R2.</p>
<p><strong>References</strong></p>
<ul>
<li><a href="https://adsecurity.org/?p=559">https://adsecurity.org/?p=559</a></li>
<li><a href="https://blogs.technet.microsoft.com/kfalde/2014/11/01/kb2871997-and-wdigest-part-1/">https://blogs.technet.microsoft.com/kfalde/2014/11/01/kb2871997-and-wdigest-part-1/</a></li>
</ul>
<h3 id="prevent-local-administrator-accounts-from-authenticating-over-the-network">Prevent local "administrator" accounts from authenticating over the network<a class="headerlink" href="#prevent-local-administrator-accounts-from-authenticating-over-the-network" title="Permanent link">&para;</a></h3>
<p>While the local Administrator (RID 500) account on two different computers has a different SID, if they have the same account name and password, the local Administrator account from one can authenticate as Administrator on the other. The same is true with any local account that is duplicated on multiple computers.<br />
This presents a security issue if multiple (or all) workstations in an organization have the same account name and password since compromise of one workstation results in compromise of all.</p>
<p>Windows 8.1 &amp; Windows 2012 R2 and newer introduced two new local SIDs:<br />
S-1-5-113: NT AUTHORITYLocal account<br />
S-1-5-114: NT AUTHORITYLocal account and member of Administrators group<br />
These SIDs are also added in earlier supported versions of Windows by installing the KB2871997 patch.</p>
<p><code class="codehilite">Install patch KB2871997</code></p>
<h4 id="configure-through-group-policy">Configure through Group Policy:<a class="headerlink" href="#configure-through-group-policy" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>1. Open Group Policy Management (gpmc.msc or via MMC Group Policy Object Editor)  
2. Computer Configuration &gt; Windows Settings &gt; Local Policies &gt; User Rights Assignment  
3. Deny access to this computer from the network: Local account and member of Administrators group  
4. Deny log on through Remote Desktop Services: Local account and member of Administrators group
</pre></div>
</td></tr></table>

<hr />
<h3 id="remote-connections">Remote Connections<a class="headerlink" href="#remote-connections" title="Permanent link">&para;</a></h3>
<h4 id="rdp-restricted-admin-connect-to-only-1-resource">RDP Restricted Admin (Connect to only 1 resource)<a class="headerlink" href="#rdp-restricted-admin-connect-to-only-1-resource" title="Permanent link">&para;</a></h4>
<p><code class="codehilite">mstsc /v:server /restrictedAdmin</code></p>
<h5 id="enable-restricted-admin-via-registry">Enable Restricted Admin via Registry<a class="headerlink" href="#enable-restricted-admin-via-registry" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">Manually create registry entry HKEY_LOCAL_MACHINESystemCurrentControlSetControlLsa DWORD DisableRestrictedAdmin=0</code></p>
<p>or</p>
<p><code class="codehilite">reg add HKEY_LOCAL_MACHINESystemCurrentControlSetControlLsa /v DisableRestrictedAdmin /d 0 /t REG_DWORD</code></p>
<h5 id="enable-restricted-admin-via-gpo">Enable Restricted Admin via GPO<a class="headerlink" href="#enable-restricted-admin-via-gpo" title="Permanent link">&para;</a></h5>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>1. Open Group Policy Management (gpmc.msc or via MMC Group Policy Object Editor)  
2. Computer Configurations &gt; Policies &gt; Administrative Templates &gt; System &gt; Credential Delegation  
3. Set &quot;Restrict Delegation of credential to remote servers&quot; to enable
</pre></div>
</td></tr></table>

<h4 id="rdp-windows-defender-remote-credential-guard-connect-to-multiple-resources">RDP Windows Defender Remote Credential Guard (Connect to multiple resources)<a class="headerlink" href="#rdp-windows-defender-remote-credential-guard-connect-to-multiple-resources" title="Permanent link">&para;</a></h4>
<p><code class="codehilite">mstsc /v:server /remoteguard</code></p>
<h5 id="enable-windows-defender-credential-guard-via-registry">Enable Windows Defender Credential Guard via Registry<a class="headerlink" href="#enable-windows-defender-credential-guard-via-registry" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">Manually create registry entry HKEY_LOCAL_MACHINESystemCurrentControlSetControlLsa DWORD DisableRestrictedAdmin=0</code></p>
<p>or</p>
<p><code class="codehilite">reg add HKEY_LOCAL_MACHINESystemCurrentControlSetControlLsa /v DisableRestrictedAdmin /d 0 /t REG_DWORD</code></p>
<h5 id="enable-windef-cred-guard-via-gpo">Enable WinDef Cred Guard via GPO<a class="headerlink" href="#enable-windef-cred-guard-via-gpo" title="Permanent link">&para;</a></h5>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>1. Open Group Policy Management (gpmc.msc or via MMC Group Policy Object Editor)  
2. Computer Configurations &gt; Policies &gt; Administrative Templates &gt; System &gt; Credential Delegation  
3. Set &quot;Restrict Delegation of credential to remote servers&quot; to enable  
4. In Options, Under use the following restricted mode: Choose &quot;Prefer Windows Defender Remote Credential Guard&quot; 
</pre></div>
</td></tr></table>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If all systems are Windows 10/2016, Choose "Require Remote Credential Guard"</p>
</div>
<hr />
<h3 id="limit-client-to-client-communication-implement-and-configure-host-based-firewalls">Limit Client-to-Client Communication (Implement <em>and Configure</em> Host Based Firewalls)<a class="headerlink" href="#limit-client-to-client-communication-implement-and-configure-host-based-firewalls" title="Permanent link">&para;</a></h3>
<ul>
<li>Clients and Server should be split into separate OU's</li>
<li>Enable the Windows Firewall through GPO</li>
<li>(Optional) Add exceptions to systems that are used to manage other hosts such as Sysadmins. Use a jump host to minimize exposure.</li>
</ul>
<h4 id="enable-firewall">Enable Firewall<a class="headerlink" href="#enable-firewall" title="Permanent link">&para;</a></h4>
<p><strong>PowerShell</strong></p>
<p>1) Create a GPO to hold the Workstation FW settings (workstation_fw)</p>
<p>Example</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled True PolicyStore example_domain.localworkstation_fw  
Set-NetFirewallProfile -DefaultInboundAction Block -DefaultOutboundAction Allow NotifyOnListen True -AllowUnicastResponseToMulticast True LogFileName %SystemRoot%System32LogFilesFirewallpfirewall.log PolicyStore example_domain.localworkstation_fw
</pre></div>
</td></tr></table>

<p>2) Assign the GPO to a Workstation Container</p>
<p><strong>References</strong></p>
<ul>
<li><a href="https://technet.microsoft.com/en-us/library/hh831755(v=ws.11).aspx">https://technet.microsoft.com/en-us/library/hh831755(v=ws.11).aspx</a></li>
</ul>
<h3 id="blockcontrol-tcpudp-access-from-the-internal-network-and-dmz">Block/control TCP/UDP access from the Internal network and DMZ<a class="headerlink" href="#blockcontrol-tcpudp-access-from-the-internal-network-and-dmz" title="Permanent link">&para;</a></h3>
<ul>
<li>Evaluate the need for servers to connect to the Internet.</li>
<li>Create a list of systems outside the network that require access. Limit access using this whitelist.</li>
<li>Configure firewall rules to enforce these traffic policies.</li>
</ul>
<hr />
<h3 id="block-out-bound-tcpudp-access-from-the-client-systems-to-outbound-networks">Block out bound TCP/UDP access from the Client systems to outbound networks.<a class="headerlink" href="#block-out-bound-tcpudp-access-from-the-client-systems-to-outbound-networks" title="Permanent link">&para;</a></h3>
<p>Clients generally only need a few ports to connect out bound. Limit access from client workstations to these ports.</p>
<ul>
<li>Create a list of ports required by clients to communicate outside the network. Limit access using this whitelist.</li>
<li>Configure firewall rules to enforce these traffic policies.</li>
<li>Rule can be managed at the HOST level via GPO or the network level via firewall rules.</li>
</ul>
<hr />
<h3 id="implement-a-proxy-for-all-outbound-traffic">Implement a Proxy for All Outbound Traffic<a class="headerlink" href="#implement-a-proxy-for-all-outbound-traffic" title="Permanent link">&para;</a></h3>
<p>Force systems to traverse an proxy to communicate outbound. It is preferred to only allow authenticated communications. This prevents privilege users (SYSTEM, root) from communicating outbound.</p>
<ul>
<li>At a minimum, force all client's HTTP(S) and DNS through a proxy</li>
<li>If possible, require user authentication</li>
<li>Prevent outbound access if a client or system attempts to connect to external port directly using network firewall rules</li>
</ul>
<h4 id="create-a-new-gpo-to-manage-the-proxy-settings">Create a new GPO to manage the proxy settings<a class="headerlink" href="#create-a-new-gpo-to-manage-the-proxy-settings" title="Permanent link">&para;</a></h4>
<p>Edit the GPO</p>
<p><code class="codehilite">User Configuration&gt;Windows Settings&gt;Internet Explorer Maintenance&gt;Connection</code></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Select Proxy Server  
Enter the Proxy IP address and Port
</pre></div>
</td></tr></table>

<p>Prevent Users from Changing Settings</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>User Configuration&gt;Administrative Templates&gt;Windows Components&gt;Internet Explorer&gt;Internet Control Panel  
Set Disable the Connections Page to Enabled
</pre></div>
</td></tr></table>

<hr />
<h2 id="configurations">Configurations<a class="headerlink" href="#configurations" title="Permanent link">&para;</a></h2>
<h3 id="autoruns">AutoRuns<a class="headerlink" href="#autoruns" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>1. De-select &quot;Hide Microsoft Entries&quot;  
2. De-select &quot;Hide Windows Entries&quot;  
3. Under Scan Options, enable &quot;Verify code signatures&quot;  
4. Under Scan Options, enable &quot;Check VirusTotal.com&quot; (note this shouldn&#39;t be done on GOV or otherwise sensitive networks)  
5. Review all entries with multiple parameters
</pre></div>
</td></tr></table>

<hr />
<h3 id="application-whiteblack-listing">Application White/Black listing<a class="headerlink" href="#application-whiteblack-listing" title="Permanent link">&para;</a></h3>
<p>A number of solutions exist to limit the applications a user can use on a system. AppLocker allows you to specify which users or groups can run particular applications in your organization based on unique identities of files. If you use AppLocker, you can create rules to allow or deny applications from running.</p>
<hr />
<h3 id="applocker">Applocker<a class="headerlink" href="#applocker" title="Permanent link">&para;</a></h3>
<h4 id="applocker-executable-path-restrictions">AppLocker Executable Path Restrictions<a class="headerlink" href="#applocker-executable-path-restrictions" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>1. Open Group Policy Management (gpmc.msc or via MMC Group Policy Object Editor)  
2. Computer Configuration &gt; Policies &gt; Windows Settings &gt; Security Settings &gt; Application Control Policies &gt; AppLocker  
3. Configure rule enforcement  
4. Executable rules, Check Configured, Enforce rules  
5. Overview &gt; Executable Rules &gt; Right Click Create New Rule  
6. Permissions &gt; Deny &gt; Domain Users  
7. Conditions &gt; Path  
8. Exceptions &gt; Add as/if required  
9. Create &gt; Yes
</pre></div>
</td></tr></table>

<h5 id="interesting-paths">Interesting Paths<a class="headerlink" href="#interesting-paths" title="Permanent link">&para;</a></h5>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>1. &lt;drive letter&gt;users&lt;username&gt;appdata (%AppData% or for extension %AppData%*.exe 5AppData%**.exe)  
2. usersppdatalocal  
3. usersppdatalocaltemp  
4. usersppdataroaming  
5. programdata
</pre></div>
</td></tr></table>

<h4 id="explicit-whitelisting">Explicit Whitelisting<a class="headerlink" href="#explicit-whitelisting" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>1. Open Group Policy Management (gpmc.msc or via MMC Group Policy Object Editor)  
2. Computer Configuration &gt; Policies &gt; Windows Settings &gt; Security Settings &gt; Software Restriction Policies  
3. Security Level Disallowed  
4. In additional rules allow  
a. %HKEY_LOCAL_MACHINESOFTWAREMicrosoftWindowsNTCurrentVersionSystemRoot%  
b. %HKEY_LOCAL_MACHINESOFTWAREMicrosoftWindowsCurrentVersionProgramFilesDir (x86)%  
c. %HKEY_LOCAL_MACHINESOFTWAREMicrosoftWindowsCurrentVersionProgramFilesDir%  
d. *.lnk
</pre></div>
</td></tr></table>

<h4 id="interesting-file-extensions">Interesting file extensions<a class="headerlink" href="#interesting-file-extensions" title="Permanent link">&para;</a></h4>
<p><code class="codehilite"><span class="na">.ade</span><span class="p">,</span> <span class="no">.adp</span><span class="p">,</span> <span class="no">.ani</span><span class="p">,</span> <span class="no">.bas</span><span class="p">,</span> <span class="no">.bat</span><span class="p">,</span> <span class="no">.chm</span><span class="p">,</span> <span class="no">.cmd</span><span class="p">,</span> <span class="no">.com</span><span class="p">,</span> <span class="no">.cpl</span><span class="p">,</span> <span class="no">.crt</span><span class="p">,</span> <span class="no">.exe</span><span class="p">,</span> <span class="no">.hlp</span><span class="p">,</span> <span class="no">.ht</span><span class="p">,</span> <span class="no">.hta</span><span class="p">,</span> <span class="no">.inf</span><span class="p">,</span> <span class="no">.ins</span><span class="p">,</span> <span class="no">.isp</span><span class="p">,</span> <span class="no">.jar</span><span class="p">,</span> <span class="no">.job</span><span class="p">,</span> <span class="no">.js</span><span class="p">,</span> <span class="no">.jse</span><span class="p">,</span> <span class="no">.lnk</span><span class="p">,</span> <span class="no">.mda</span><span class="p">,</span> <span class="no">.mdb</span><span class="p">,</span> <span class="no">.mde</span><span class="p">,</span> <span class="no">.mdz</span><span class="p">,</span> <span class="no">.msc</span><span class="p">,</span> <span class="no">.msi</span><span class="p">,</span> <span class="no">.msp</span><span class="p">,</span> <span class="no">.mst</span><span class="p">,</span> <span class="no">.ocx</span><span class="p">,</span> <span class="no">.pcd</span><span class="p">,</span> <span class="no">.ps1</span><span class="p">,</span> <span class="no">.reg</span><span class="p">,</span> <span class="no">.scr</span><span class="p">,</span> <span class="no">.sct</span><span class="p">,</span> <span class="no">.shs</span><span class="p">,</span> <span class="no">.svg</span><span class="p">,</span> <span class="no">.url</span><span class="p">,</span> <span class="no">.vb</span><span class="p">,</span> <span class="no">.vbe</span><span class="p">,</span> <span class="no">.vbs</span><span class="p">,</span> <span class="no">.wbk</span><span class="p">,</span> <span class="no">.wsc</span><span class="p">,</span> <span class="no">.ws</span><span class="p">,</span> <span class="no">.wsf</span><span class="p">,</span> <span class="no">.wsh</span><span class="p">,</span> <span class="no">.exe</span><span class="p">,</span> <span class="no">.pif</span><span class="p">,</span> <span class="no">.pub</span><span class="p">,</span> <span class="no">.ip</span></code></p>
<p><strong>References</strong></p>
<ul>
<li><a href="https://technet.microsoft.com/en-us/library/dd759117(v=ws.11).aspx">https://technet.microsoft.com/en-us/library/dd759117(v=ws.11).aspx</a></li>
<li><a href="https://technet.microsoft.com/en-us/library/dd759123(v=ws.11).aspx">https://technet.microsoft.com/en-us/library/dd759123(v=ws.11).aspx</a></li>
<li><a href="https://technet.microsoft.com/en-us/library/dd759116(v=ws.11).aspx">https://technet.microsoft.com/en-us/library/dd759116(v=ws.11).aspx</a></li>
</ul>
<hr />
<h2 id="manual-hunting-and-detection-examples">Manual Hunting and Detection Examples<a class="headerlink" href="#manual-hunting-and-detection-examples" title="Permanent link">&para;</a></h2>
<h3 id="filtering-event-logs-via-powershell">Filtering Event Logs via PowerShell<a class="headerlink" href="#filtering-event-logs-via-powershell" title="Permanent link">&para;</a></h3>
<h5 id="log-locations-on-disk-only-use-event-viewer-or-cli-to-copy">Log locations on disk (only use event viewer or cli to copy)<a class="headerlink" href="#log-locations-on-disk-only-use-event-viewer-or-cli-to-copy" title="Permanent link">&para;</a></h5>
<ol>
<li>XP or older: %windir%system32config</li>
<li>Vista or newer: %windir%system32winevtlogs</li>
</ol>
<h5 id="get-times-service-was-installed-all-evtx-files-should-be-system-and-count">Get times Service was installed (all evtx files, should be system) and count<a class="headerlink" href="#get-times-service-was-installed-all-evtx-files-should-be-system-and-count" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">Get-WinEvent -FilterHashtable @{Path=&quot;*.evtx&quot;; ID=7045}|Measure-Object -Line</code></p>
<h5 id="get-blocked-events">Get blocked events<a class="headerlink" href="#get-blocked-events" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">Get-WinEvent -FilterHashtable @{Path=&quot;AppLocker.evtx&quot;; ID=8004}| Format-Table -Wrap</code></p>
<h5 id="get-windowsdefender-actions">Get WindowsDefender actions<a class="headerlink" href="#get-windowsdefender-actions" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">Get-WinEvent -FilterHashtable @{Path=&quot;WindowsDefender.evtx&quot;; ID=1117}| Format-Table</code></p>
<h5 id="get-windowsdefender-detections">Get WindowsDefender detections<a class="headerlink" href="#get-windowsdefender-detections" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">Get-WinEvent -FilterHashtable @{Path=&quot;WindowsDefender.evtx&quot;; ID=1116}| Format-Table</code></p>
<h5 id="get-files-by-extension-with-search-from-application-crash">Get files (by extension) with search from Application (crash)<a class="headerlink" href="#get-files-by-extension-with-search-from-application-crash" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="x">Get-WinEvent -FilterHashtable @</span><span class="cp">{</span><span class="nf">Path</span><span class="o">=</span><span class="s2">&quot;application.evtx&quot;</span><span class="cp">}</span><span class="x">|Where </span><span class="cp">{</span><span class="nv">$_.Message</span> <span class="o">-</span><span class="na">like</span> <span class="s2">&quot;*pdf*&quot;</span><span class="cp">}</span><span class="x">|Format-Table -Wrap</span></code></p>
<h5 id="get-emet-events">Get EMET events<a class="headerlink" href="#get-emet-events" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">Get-WinEvent -FilterHashtable @{Path=&quot;Win7-Application.evtx&quot;; providername=&quot;EMET&quot;}|Format-Table -Wrap</code></p>
<h5 id="get-service-installs-and-errors">Get service installs and errors<a class="headerlink" href="#get-service-installs-and-errors" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">Get-WinEvent -FilterHashtable @{Path=&quot;system.evtx&quot;; ID=7030,7045}| fl</code></p>
<h5 id="search-for-usb-loading">Search for USB loading<a class="headerlink" href="#search-for-usb-loading" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="x">Get-WinEvent -FilterHashtable @</span><span class="cp">{</span><span class="nf">Path</span><span class="o">=</span><span class="s2">&quot;system.evtx&quot;</span><span class="o">;</span> <span class="na">ID</span><span class="o">=</span><span class="m">7045</span><span class="o">,</span><span class="m">10000</span><span class="o">,</span><span class="m">10001</span><span class="o">,</span><span class="m">10100</span><span class="o">,</span><span class="m">20001</span><span class="o">,</span><span class="m">20002</span><span class="o">,</span><span class="m">30003</span><span class="o">,</span><span class="m">24576</span><span class="o">,</span><span class="m">24577</span><span class="o">,</span><span class="m">24579</span><span class="cp">}</span><span class="x">|Where </span><span class="cp">{</span><span class="nv">$_.Message</span> <span class="o">-</span><span class="na">like</span> <span class="s2">&quot;*USB*&quot;</span><span class="cp">}</span><span class="x">|fl</span></code></p>
<h5 id="search-for-errorwarninginfo">Search for error/warning/info<a class="headerlink" href="#search-for-errorwarninginfo" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">Get-WinEvent -FilterHashtable @{Path=&quot;application.evtx&quot;; level=2}</code></p>
<h5 id="get-remote-eventlog-caution-this-drops-credentials-onto-remote-system">Get remote eventlog (caution this drops credentials onto remote system)<a class="headerlink" href="#get-remote-eventlog-caution-this-drops-credentials-onto-remote-system" title="Permanent link">&para;</a></h5>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Get-EventLog -List -ComputerName &lt;ip&gt;  
Get-EventLog -LogName System -ComputerName
</pre></div>
</td></tr></table>

<h5 id="get-log-within-x-hours">Get log within X hours<a class="headerlink" href="#get-log-within-x-hours" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="x">Get-EventLog System -after (get-date).addhours(-12) | Where </span><span class="cp">{</span><span class="nv">$_.entrytype</span> <span class="o">-</span><span class="na">eq</span> <span class="s2">&quot;warning&quot;</span><span class="cp">}</span><span class="x"></span></code></p>
<h5 id="get-logs-during-downtime">Get logs during "downtime"<a class="headerlink" href="#get-logs-during-downtime" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="x">Get-EventLog -LogName security | ? </span><span class="cp">{</span><span class="nv">$_.EventId</span> <span class="o">-</span><span class="na">eq</span> <span class="m">4624</span> <span class="err"></span><span class="na">and</span> <span class="o">(</span><span class="nv">$_.TimeGenerated.TimeOfDay</span> <span class="o">-</span><span class="na">gt</span> <span class="s1">&#39;20:00:00&#39;</span> <span class="o">-</span><span class="na">or</span> <span class="nv">$_.TimeGenerated.TimeOfDay</span> <span class="o">-</span><span class="na">lt</span> <span class="s1">&#39;08:00:00&#39;</span> <span class="o">)</span> <span class="cp">}</span><span class="x"> | export-csv offhours.csv</span></code></p>
<h5 id="use-wevtutil-to-export-logs-export-log">Use wevtutil to export logs (export-log)<a class="headerlink" href="#use-wevtutil-to-export-logs-export-log" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">wevtutil.exe epl system system.evtx</code></p>
<h5 id="use-wevutil-to-get-last-20-startups-use-rcomputer-for-remote-and-qe-for-short-query">Use wevutil to get last 20 startups (use /r:computer for remote and qe for short query)<a class="headerlink" href="#use-wevutil-to-get-last-20-startups-use-rcomputer-for-remote-and-qe-for-short-query" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">wevutil query-events System /count:20 /rd:true /format:text /q:&quot;Event[System[(EventID=12)]]&quot;</code></p>
<h4 id="windows-consolidated-logging">Windows consolidated logging<a class="headerlink" href="#windows-consolidated-logging" title="Permanent link">&para;</a></h4>
<ol>
<li>enable winrm  <ul>
<li><code class="codehilite">winrm qc</code></li>
</ul>
</li>
<li>enable wecutil  <ul>
<li><code class="codehilite">wecutil qc</code></li>
</ul>
</li>
<li>Create subscriptions and select events/filters in event viewer  <ul>
<li>via event viewer or  </li>
<li>by PowerShell  <ul>
<li><code class="codehilite">wecutil cs &quot;Creates a subscription&quot;</code></li>
<li><code class="codehilite">wecutil ss &quot;Sets a subscription&quot;</code>  </li>
<li><code class="codehilite">wecutil es &quot;Views subscriptions&quot;</code></li>
</ul>
</li>
</ul>
</li>
</ol>
<h5 id="get-a-detailed-list-of-all-security-auditing-event-entries-use-an-elevated-prompt">Get a detailed list of all security-auditing event entries (use an elevated prompt)<a class="headerlink" href="#get-a-detailed-list-of-all-security-auditing-event-entries-use-an-elevated-prompt" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">wevtutil gp Microsoft-Windows-Security-Auditing /ge /gm:true</code></p>
<h5 id="return-a-list-of-all-security-auditing-categories-and-subcategories-use-an-elevated-prompt">Return a list of all security-auditing categories and subcategories (use an elevated prompt)<a class="headerlink" href="#return-a-list-of-all-security-auditing-categories-and-subcategories-use-an-elevated-prompt" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">auditpol /list /subcategory:*</code></p>
<hr />
<h3 id="network">Network<a class="headerlink" href="#network" title="Permanent link">&para;</a></h3>
<h4 id="network-flow-basics">Network Flow Basics:<a class="headerlink" href="#network-flow-basics" title="Permanent link">&para;</a></h4>
<ol>
<li>Prevent traffic on uncommon ports (not if a good threat)</li>
<li>Establish commonality in traffic (size, frequency, browser headers, etc.)</li>
<li>Consistently review outlying DNS entries (very few connections or host traffic)</li>
<li>Identify and investigate unique User-Agent strings</li>
<li>Identify and investigate Base64 encoded strings within the URL</li>
<li>Identify and investigate executables being downloaded and traversing the network</li>
</ol>
<h4 id="basic-pcap-carving-nix">Basic PCAP Carving (*nix)<a class="headerlink" href="#basic-pcap-carving-nix" title="Permanent link">&para;</a></h4>
<p>Note: The snippets below are examples for pcap carving. I'd highly recommend using bro/  for traffic analysis.</p>
<h5 id="get-certificates-from-pcap-use-bro-if-possible">Get certificates from pcap (use BRO if possible)<a class="headerlink" href="#get-certificates-from-pcap-use-bro-if-possible" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tshark -nr file.pcap -2 -R &quot;ssl.handshake.certificate&quot; -V &gt; cert.txt</code></p>
<p>or</p>
<p><code class="codehilite">ssldump -Nr /path/file.pcap | awk &#39;BEGIN {c=0;} { if ($0 ~ /^[ ]+Certificate$/) {c=1; print &quot;========================================&quot;;} if ($0 !~ /^ +/ ) {c=0;} if (c==1) print $0; }&#39;</code></p>
<h5 id="view-certificates-see-bro">View certificates (see BRO)<a class="headerlink" href="#view-certificates-see-bro" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">openssl x509 -in certsname.der -inform der -text -noout</code></p>
<h5 id="get-dns-queries-from-pcap-and-count-instances">Get DNS queries from pcap and count instances<a class="headerlink" href="#get-dns-queries-from-pcap-and-count-instances" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tshark -r /path/file.pcap -T fields -e ip.src -e dns.qry.name -2 -R &quot;dns.flags.response eq 0&quot;</code></p>
<p>or</p>
<p><code class="codehilite">tcpdump n r file.pcap &quot;port 53&quot; 2&gt;/dev/null|grep E &#39;A?&#39;|awk &#39;{print $(NF-1)}&#39;|sort|uniq c|sort n</code></p>
<h5 id="get-dns-queries-from-nx-domain">Get DNS queries from NX domain<a class="headerlink" href="#get-dns-queries-from-nx-domain" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tshark -r /path/file.pcap -T fields -e ip.src -e dns.qry.name -2 -R &quot;dns.flags.rcode eq 3&quot;</code></p>
<h5 id="dns-response-codes">DNS Response Codes<a class="headerlink" href="#dns-response-codes" title="Permanent link">&para;</a></h5>
<table>
<thead>
<tr>
<th>RCODE</th>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>NoError</td>
<td>No Error</td>
</tr>
<tr>
<td>1</td>
<td>FormErr</td>
<td>Format Error</td>
</tr>
<tr>
<td>2</td>
<td>ServFail</td>
<td>Server Failure</td>
</tr>
<tr>
<td>3</td>
<td>NXDomain</td>
<td>Non-Existent Domain</td>
</tr>
<tr>
<td>4</td>
<td>NotImp</td>
<td>Not Implemented</td>
</tr>
<tr>
<td>5</td>
<td>Refused</td>
<td>Query Refused</td>
</tr>
<tr>
<td>6</td>
<td>YXDomain</td>
<td>Name Exists when it should not</td>
</tr>
<tr>
<td>7</td>
<td>YXRRSet</td>
<td>RR Set Exists when it should not</td>
</tr>
<tr>
<td>8</td>
<td>NXRRSet</td>
<td>RR Set that should exist does not</td>
</tr>
<tr>
<td>9</td>
<td>NotAuth</td>
<td>Server Not Authoritative for zone</td>
</tr>
<tr>
<td>9</td>
<td>NotAuth</td>
<td>Not Authorized</td>
</tr>
<tr>
<td>10</td>
<td>NotZone</td>
<td>Name not contained in zone</td>
</tr>
<tr>
<td>16</td>
<td>BADVERS</td>
<td>Bad OPT Version</td>
</tr>
<tr>
<td>16</td>
<td>BADSIG</td>
<td>TSIG Signature Failure</td>
</tr>
<tr>
<td>17</td>
<td>BADKEY</td>
<td>Key not recognized</td>
</tr>
<tr>
<td>18</td>
<td>BADTIME</td>
<td>Signature out of time window</td>
</tr>
<tr>
<td>19</td>
<td>BADMODE</td>
<td>Bad TKEY Mode</td>
</tr>
<tr>
<td>20</td>
<td>BADNAME</td>
<td>Duplicate key name</td>
</tr>
<tr>
<td>21</td>
<td>BADALG</td>
<td>Algorithm not supported</td>
</tr>
<tr>
<td>22</td>
<td>BADTRUNC</td>
<td>Bad Truncation</td>
</tr>
<tr>
<td>23</td>
<td>BADCOOKIE</td>
<td>Bad/missing Server Cookie</td>
</tr>
</tbody>
</table>
<h5 id="get-user-agents-from-pcap">Get User-Agents from pcap<a class="headerlink" href="#get-user-agents-from-pcap" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tshark -r /path/file.pcap -T fields -e http.user_agent|sort -n -k1|uniq -c|sort -n</code></p>
<p>or</p>
<p><code class="codehilite">tcpdump n A r file.pcap &#39;tcp port 80&#39;|egrep I &quot;User-Agent&quot;|sort|uniq c|sort -n</code></p>
<p>or</p>
<p><code class="codehilite">strings /path/file.pcap |grep -i User-Agent|uniq -c|sort -n</code></p>
<h5 id="get-info-for-frame-containing-search-dataf">Get info for frame containing search dataf<a class="headerlink" href="#get-info-for-frame-containing-search-dataf" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tshark -r /tmp/10.10.10.52:1082_10.10.19.32:80-6.raw -2 -R &#39;frame contains &quot;MZ&quot;&#39;</code></p>
<h5 id="search-for-string-in-tcp-data-finds-data-not-in-field-ie-ua-in-json">Search for string in tcp data (finds data not in field i.e. UA in json)<a class="headerlink" href="#search-for-string-in-tcp-data-finds-data-not-in-field-ie-ua-in-json" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tshark -r /path/file.pcap -T pdml -T fields -e tcp.data -2 -R &#39;tcp contains &quot;User-Agent&quot;&#39;|sed s/://g|xxd -p -r|grep -a User-Agent|uniq -c</code></p>
<h5 id="find-strings-in-pcap">Find strings in pcap<a class="headerlink" href="#find-strings-in-pcap" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tshark -r file.pcap -T pdml -T fields -e irc.response -Y &#39;frame contains &quot;badguy&quot;&#39;</code></p>
<p>or</p>
<p><code class="codehilite">tshark -r file.pcap -T pdml -Y &#39;frame contains &quot;badguy&quot;&#39;|grep badguy</code></p>
<p>or</p>
<p><code class="codehilite">ngrep -q -I /path/file.pcap &quot;badguy&quot;</code></p>
<p>or</p>
<p><code class="codehilite">strings /path/file.pcap |grep -i User-Agent |sort -u</code></p>
<p>or</p>
<p><code class="codehilite">tshark -r /path/file.pcap -T pdml -2 -R &#39;frame contains &quot;User-Agent&quot;&#39;|grep User-Agent</code></p>
<h5 id="get-the-frame-that-contains-string">Get the frame that contains string<a class="headerlink" href="#get-the-frame-that-contains-string" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tshark -r file.pcap -2 -R &#39;frame contains &quot;badguy&quot;</code></p>
<h5 id="show-packet-data-by-field">Show packet data by field<a class="headerlink" href="#show-packet-data-by-field" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tshark -nr /path/file.pcap -T fields -e http.user_agent -2 -R http.user_agent</code></p>
<h5 id="get-data-hex-from-first-two-packets-in-pcap">Get data &amp; hex from first two packets in pcap<a class="headerlink" href="#get-data-hex-from-first-two-packets-in-pcap" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tcpdump -n -r /path/file.pcap -c2 -x -v</code></p>
<h5 id="get-frames-that-have-tcp-header-length-gt-20-and-port-25">Get frames that have tcp header length gt 20 and port 25<a class="headerlink" href="#get-frames-that-have-tcp-header-length-gt-20-and-port-25" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tshark -r /path/file.pcap -Y &#39;tcp.hdr_len &gt; 20 &amp;&amp; tcp.port == 25&#39;</code></p>
<h5 id="get-data-in-frames-that-have-tcp-header-length-gt-20-and-port-25">Get data in frames that have tcp header length gt 20 and port 25<a class="headerlink" href="#get-data-in-frames-that-have-tcp-header-length-gt-20-and-port-25" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tshark -r /path/file.pcap -T pdml -T fields -e tcp.port -e tcp.hdr_len -Y &#39;tcp.hdr_len &gt; 20 &amp;&amp; tcp.port == 25&#39;</code></p>
<h5 id="get-frames-with-hex-data-0x7932">Get frames with hex data 0x7932<a class="headerlink" href="#get-frames-with-hex-data-0x7932" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tshark -r /path/file.pcap -Y &#39;ip.id == 0x7932&#39;</code></p>
<h5 id="get-frames-and-show-hex-data">Get frames and show hex data<a class="headerlink" href="#get-frames-and-show-hex-data" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tshark -r /path/file.pcap -T pdml -T fields -e ip.id -Y &#39;ip.id == 0x7932&#39;</code></p>
<h5 id="get-all-arp-request-and-count-request1-reply2">Get all arp request and count (request=1, reply=2)<a class="headerlink" href="#get-all-arp-request-and-count-request1-reply2" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tshark -r file.pcap -Y &#39;arp.opcode == 1&#39;|wc -l</code></p>
<h5 id="get-iplen-less-than-46-64-for-ethernet-minus-14-header-and-4-trailer-icmp-of-0">Get ip.len less than 46 (64 for ethernet minus 14 header and 4 trailer) &amp; icmp of 0<a class="headerlink" href="#get-iplen-less-than-46-64-for-ethernet-minus-14-header-and-4-trailer-icmp-of-0" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tshark -r file.pcap -Y &#39;ip.len &lt; 46 &amp;&amp; icmp.type == 0&#39;</code></p>
<h5 id="get-ip-option-of-loose-src-routing-with-offset-starting-at-ip-options">Get ip option of loose src routing with offset starting at ip options<a class="headerlink" href="#get-ip-option-of-loose-src-routing-with-offset-starting-at-ip-options" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tshark -r file.pcap -Y &#39;ip[20] == 0x83 &amp;&amp; ip.hdr_len &gt;20&#39;</code></p>
<h5 id="filter-info">Filter Info<a class="headerlink" href="#filter-info" title="Permanent link">&para;</a></h5>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>URG = 32 or 0x20  
ACK = 16 or 0x10  
PSH = 8 or 0x08  
RST = 4 or 0x04  
SYN = 2 or 0x02  
FIN = 1 or 0x01  
All = 0xFF
</pre></div>
</td></tr></table>

<p>Examples:<br />
<code class="codehilite">&#39;tcp[13] &amp; 2 !=0&#39; Get all SYN</code></p>
<p><code class="codehilite">&#39;tcp[13] &amp; 4 !=0&#39; Get all RST</code></p>
<p><code class="codehilite">&#39;tcp[13] &amp; 16 !=0&#39; Get all ACK</code></p>
<h5 id="get-frame-with-ip-src-and-ack-flag-set">Get frame with IP src and ACK flag set<a class="headerlink" href="#get-frame-with-ip-src-and-ack-flag-set" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tshark -n -r /path/file.pcap &#39;((ip.src == 192.168.10.1) and (tcp.flags.ack==1))&#39;</code></p>
<p>or</p>
<p><code class="codehilite">tshark -n -r /path/file.pcap &#39;tcp[13] == 0x10 &amp;&amp; ip.src == 192.168.10.1&#39;</code></p>
<p>or</p>
<p><code class="codehilite">tcpdump -n -r /path/file.pcap &#39;src host 192.168.10.1 and tcp[13] = 0x10&#39;</code></p>
<h5 id="get-frame-with-ip-src-and-ack-or-rst-flag-set">Get frame with IP src and ACK or RST flag set<a class="headerlink" href="#get-frame-with-ip-src-and-ack-or-rst-flag-set" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tshark -n -r /path/file.pcap &#39;((ip.src == 192.168.10.1) and (tcp.flags.syn==1 or tcp.flags.reset==1))&#39;</code></p>
<p>or</p>
<p><code class="codehilite">tshark -n -r /path/file.pcap &#39;ip.src == 192.168.10.1 &amp;&amp; tcp[13] == 0x14 or tcp[13] == 0x10 or tcp[13] == 0x04&#39;</code></p>
<p>or</p>
<p><code class="codehilite">tcpdump -n -r /path/file.pcap &#39;src host 192.168.10.1 and tcp[13] &amp; 0x14 !=0&#39;</code></p>
<h5 id="get-frame-with-dst-port-0-and-df-flag-set">Get frame with dst port 0 and DF flag set<a class="headerlink" href="#get-frame-with-dst-port-0-and-df-flag-set" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tshark -n -r /path/file.pcap &#39;tcp.port == 0 &amp;&amp; ip[6] == 0x40&#39;</code></p>
<h5 id="get-frame-with-net-1010101024">Get frame with net 10.10.10.10/24<a class="headerlink" href="#get-frame-with-net-1010101024" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tcpdump -n -r /path/file.pcap &#39;dst net 10.10.10 and ip[19] &amp; 0xd0 = 0xd0&#39;</code></p>
<h5 id="get-frames-by-ip">Get frames by ip<a class="headerlink" href="#get-frames-by-ip" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tshark -n -r file.pcap &#39;((ip.addr == 10.10.10.10) and (ip.addr == 192.168.10.11))&#39;</code></p>
<h5 id="view-specific-frame-verbose-note-tcp-stream-index-number">View specific frame verbose (note tcp stream index number)<a class="headerlink" href="#view-specific-frame-verbose-note-tcp-stream-index-number" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tshark -n -r file.pcap -Y frame.number==12 -V</code></p>
<h5 id="follow-tcp-stream-0-ascii-raw-hex">Follow tcp stream 0 (ascii, raw, hex)<a class="headerlink" href="#follow-tcp-stream-0-ascii-raw-hex" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tshark -n -r file.pcap -z &quot;follow,tcp,ascii,0&quot;</code></p>
<h4 id="flow-data-analysis">Flow Data Analysis<a class="headerlink" href="#flow-data-analysis" title="Permanent link">&para;</a></h4>
<h5 id="use-rwfilter-to-analyze-flow-data-by-ip-and-port">Use rwfilter to analyze flow data by IP and port<a class="headerlink" href="#use-rwfilter-to-analyze-flow-data-by-ip-and-port" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">rwfilter suspicious.silk --any-address=192.168.10.10 --aport=1088 --print-stat</code></p>
<h5 id="view-detail-of-flow-data-by-ip-and-port">View detail of flow data by IP and port<a class="headerlink" href="#view-detail-of-flow-data-by-ip-and-port" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">rwfilter suspicious.silk --any-address=192.168.10.10 --aport=1088 --pass=stdout|rwcut</code></p>
<h5 id="extract-all-udp-from-flow-then-pipe-to-get-field-4-4dst-port-3srcport-5proto-6packets-etc">Extract all UDP from flow then pipe to get field 4 (4=dst port, 3=srcport, 5=proto, 6=packets, etc)<a class="headerlink" href="#extract-all-udp-from-flow-then-pipe-to-get-field-4-4dst-port-3srcport-5proto-6packets-etc" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">rwfilter suspicious.silk --proto=17 --pass=stdout|rwuniq --fields=4</code></p>
<h5 id="extract-connections-from-108-with-a-reset-to-close-then-pipe-to-get-srcip-count">Extract connections from 10/8 with a reset to close then pipe to get srcIP count<a class="headerlink" href="#extract-connections-from-108-with-a-reset-to-close-then-pipe-to-get-srcip-count" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">rwfilter suspicious.silk --any-address=10.10.0.0/16 --flags-all=R/R --pass=stdout|rwuniq --fields=1</code></p>
<h5 id="use-rwstats-to-get-flow-data-of-top-5-flows">Use rwstats to get flow data of top 5 flows<a class="headerlink" href="#use-rwstats-to-get-flow-data-of-top-5-flows" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">rwstats suspicious.silk --fields sIP --bytes --count=5</code></p>
<h5 id="extract-records-not-icmp-tcp-or-udp-note-fail-and-have-src-ip-of-1010101">Extract records not ICMP, TCP or UDP (note fail) and have src IP of 10.10.10.1<a class="headerlink" href="#extract-records-not-icmp-tcp-or-udp-note-fail-and-have-src-ip-of-1010101" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">rwfilter suspicious.silk --proto=1,6,17 --fail=stdout|rwfilter --input-pipe=stdin --saddress=10.10.10.1 --pass=stdout | rwcut</code></p>
<p>or</p>
<p><code class="codehilite">rwfilter suspicious.silk --proto=0,2-5,7-16,18- --saddress=10.10.10.1 --pass=stdout | rwcut</code></p>
<h5 id="get-top-5-ip-with-data-transfer">Get top 5 IP with data transfer<a class="headerlink" href="#get-top-5-ip-with-data-transfer" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">rwstats phishing-attack.silk --fields=sip --top --bytes --count 5</code></p>
<h5 id="get-flows-with-larger-than-100000-bytes">Get flows with larger than 100,000 bytes<a class="headerlink" href="#get-flows-with-larger-than-100000-bytes" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">rwfilter phishing-attack.silk --proto=6 --bytes=100000- --pass=stdout |rwcut -f 1-8</code></p>
<hr />
<h4 id="elsa-bro-queries">ELSA (BRO queries)<a class="headerlink" href="#elsa-bro-queries" title="Permanent link">&para;</a></h4>
<h5 id="elsa-most-common-svc">ELSA most common svc<a class="headerlink" href="#elsa-most-common-svc" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">class</span>=<span class="n">BRO_CONN</span> <span class="n">groupby:service</span></code></p>
<h5 id="elsa-bro-nx-domains">ELSA BRO nx domains<a class="headerlink" href="#elsa-bro-nx-domains" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">class</span>=<span class="n">BRO_DNS</span> <span class="n">nxdomain</span> <span class="n">groupby:hostname</span></code></p>
<h5 id="elsa-bro-common-fqdn">ELSA BRO common FQDN<a class="headerlink" href="#elsa-bro-common-fqdn" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">class</span>=<span class="n">BRO_HTTP</span> <span class="s">&quot;-&quot;</span> <span class="n">groupby:site</span></code></p>
<h5 id="elsa-bro-sites-hosting-exe">ELSA BRO Sites hosting EXE<a class="headerlink" href="#elsa-bro-sites-hosting-exe" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">class</span>=<span class="n">BRO_HTTP</span> <span class="n">BRO_HTTP</span>.<span class="n">mime_type</span>=<span class="s">&quot;x-dosexec&quot;</span> <span class="n">groupby:site</span></code></p>
<h5 id="elsa-bro-uri-with-exe-downloads">ELSA BRO URI with EXE downloads<a class="headerlink" href="#elsa-bro-uri-with-exe-downloads" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">class</span>=<span class="n">BRO_HTTP</span> <span class="n">BRO_HTTP</span>.<span class="n">mime_type</span>=<span class="s">&quot;x-dosexec&quot;</span> <span class="n">groupby:BRO_HTTP</span>.<span class="n">uri</span></code></p>
<h5 id="elsa-bro-internal-ip-exe-download">ELSA BRO Internal IP EXE download<a class="headerlink" href="#elsa-bro-internal-ip-exe-download" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">class</span>=<span class="n">BRO_FILES</span> <span class="s">&quot;-&quot;</span> <span class="n">mime_type</span>=<span class="s">&quot;application/x-dosexec&quot;</span> <span class="n">groupby:rx_hosts</span></code></p>
<h5 id="elsa-bro-connections-wo-ua-group-by-source-ip">ELSA BRO connections w/o UA group by source IP<a class="headerlink" href="#elsa-bro-connections-wo-ua-group-by-source-ip" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="k">class</span>=<span class="n">BRO_HTTP</span> <span class="s">&quot;-&quot;</span> <span class="n">user_agent</span>=<span class="s">&quot;-&quot;</span> <span class="n">groupby:srcipt</span></code></p>
<hr />
<h4 id="bro">BRO<a class="headerlink" href="#bro" title="Permanent link">&para;</a></h4>
<h5 id="bro-logs">BRO Logs<a class="headerlink" href="#bro-logs" title="Permanent link">&para;</a></h5>
<p>Just a few logs that can be used to gather information. Note, custom logs can be created and referenced using the BRO.</p>
<h5 id="bro-log-hunting">BRO Log Hunting<a class="headerlink" href="#bro-log-hunting" title="Permanent link">&para;</a></h5>
<table>
<thead>
<tr>
<th>BRO log</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>conn.log</td>
<td>IP/protocol connections</td>
</tr>
<tr>
<td>conn-summary.log</td>
<td>Statistics/summarizes activity</td>
</tr>
<tr>
<td>known_hosts.log</td>
<td>New hosts within past hour</td>
</tr>
<tr>
<td>known_serices.log</td>
<td>New services within past hour</td>
</tr>
<tr>
<td>dpd.log</td>
<td>Dynamic protocol detection</td>
</tr>
<tr>
<td>weird.log</td>
<td>Anomalous activity</td>
</tr>
<tr>
<td>loaded_scripts.log</td>
<td>Scripts loaded on start</td>
</tr>
<tr>
<td>reporter.log</td>
<td>Severity of issues with bro</td>
</tr>
<tr>
<td>software.log</td>
<td>Determines version of detected protocol</td>
</tr>
<tr>
<td>various protocols (http,dns,ssl,etc)</td>
<td>Activity log per protocol</td>
</tr>
</tbody>
</table>
<h5 id="bro-protocol-logs">BRO Protocol Logs<a class="headerlink" href="#bro-protocol-logs" title="Permanent link">&para;</a></h5>
<table>
<thead>
<tr>
<th>BRO log</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>conn.log</td>
<td>TCP/UDP/ICMP connections</td>
</tr>
<tr>
<td>dce_rpc.log</td>
<td>Distributed Computing Environment/RPC</td>
</tr>
<tr>
<td>dhcp.log</td>
<td>DHCP leases</td>
</tr>
<tr>
<td>dnp3.log</td>
<td>DNP3 requests and replies</td>
</tr>
<tr>
<td>dns.log</td>
<td>DNS activity</td>
</tr>
<tr>
<td>ftp.log</td>
<td>FTP activity</td>
</tr>
<tr>
<td>http.log</td>
<td>HTTP requests and replies</td>
</tr>
<tr>
<td>irc.log</td>
<td>IRC commands and responses</td>
</tr>
<tr>
<td>kerberos.log</td>
<td>Kerberos</td>
</tr>
<tr>
<td>modbus.log</td>
<td>Modbus commands and responses</td>
</tr>
<tr>
<td>modbus_register_change.log</td>
<td>Tracks changes to Modbus holding registers</td>
</tr>
<tr>
<td>mysql.log</td>
<td>MySQL</td>
</tr>
<tr>
<td>ntlm.log</td>
<td>NT LAN Manager (NTLM)</td>
</tr>
<tr>
<td>radius.log</td>
<td>RADIUS authentication attempts</td>
</tr>
<tr>
<td>rdp.log</td>
<td>RDP RDP</td>
</tr>
<tr>
<td>rfb.log</td>
<td>Remote Framebuffer (RFB)</td>
</tr>
<tr>
<td>sip.log</td>
<td>SIP</td>
</tr>
<tr>
<td>smb_cmd.log</td>
<td>SMB commands</td>
</tr>
<tr>
<td>smb_files.log</td>
<td>SMB files</td>
</tr>
<tr>
<td>smb_mapping.log</td>
<td>SMB trees</td>
</tr>
<tr>
<td>smtp.log</td>
<td>SMTP transactions</td>
</tr>
<tr>
<td>snmp.log</td>
<td>SNMP messages</td>
</tr>
<tr>
<td>socks.log</td>
<td>SOCKS proxy requests</td>
</tr>
<tr>
<td>ssh.log</td>
<td>SSH connections</td>
</tr>
<tr>
<td>ssl.log</td>
<td>SSL/TLS handshake info</td>
</tr>
<tr>
<td>syslog.log</td>
<td>Syslog messages</td>
</tr>
<tr>
<td>tunnel.log</td>
<td>Tunneling protocol events</td>
</tr>
</tbody>
</table>
<p><strong>BRO Log Reference</strong><br />
 <a href="https://www.bro.org/sphinx-git/script-reference/log-files.html">https://www.bro.org/sphinx-git/script-reference/log-files.html</a></p>
<h4 id="bro-carving">BRO Carving<a class="headerlink" href="#bro-carving" title="Permanent link">&para;</a></h4>
<h5 id="read-and-output-bro-logs">Read and output bro logs<a class="headerlink" href="#read-and-output-bro-logs" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">bro -r file.pcap</code></p>
<h5 id="get-source-src-ip-dst-ip-dst-port-and-bytes-in-that-order">Get source src ip, dst ip, dst port, and bytes (in that order)<a class="headerlink" href="#get-source-src-ip-dst-ip-dst-port-and-bytes-in-that-order" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">cat conn.log |bro-cut id.orig_h id.resp_h id.resp_p orig_bytes |head -2</code></p>
<h5 id="same-as-above-but-sort-by-bytes-field-5-reverse-by-number">Same as above but sort by bytes (field 5 reverse by number)<a class="headerlink" href="#same-as-above-but-sort-by-bytes-field-5-reverse-by-number" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">cat conn.log |bro-cut id.orig_h id.orig_p id.resp_h id.resp_p orig_bytes|sort -k 5 -rn</code></p>
<h5 id="get-http-on-non-standard-ports-ssl">Get http on non-standard ports (ssl?)<a class="headerlink" href="#get-http-on-non-standard-ports-ssl" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">cat conn.log | bro-cut service id.resp_p id.resp_h | awk &#39;$1 == &quot;http&quot; &amp;&amp; ! ($2 == 80 || $2 == 8080) { print $3 }&#39; | sort -u</code></p>
<h5 id="extract-dns-info-from-bro-logs">Extract DNS info from bro logs<a class="headerlink" href="#extract-dns-info-from-bro-logs" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">cat dns.log |bro-cut query | sort -u</code></p>
<p>and</p>
<p><code class="codehilite">cat dns.log | bro-cut -d answers | sort -u</code></p>
<h5 id="get-user-agents">Get User-Agents<a class="headerlink" href="#get-user-agents" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">cat http.log | bro-cut user_agent | sort | uniq -c |sort -n</code></p>
<h5 id="get-mime-types">Get Mime Types<a class="headerlink" href="#get-mime-types" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">cat http.log | bro-cut orig_mime_type | sort | uniq -c |sort -n</code></p>
<h5 id="get-bro-outbound-signature-stored-in-sig-file-read-with-s">Get bro outbound signature stored in .sig file (read with -s)<a class="headerlink" href="#get-bro-outbound-signature-stored-in-sig-file-read-with-s" title="Permanent link">&para;</a></h5>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>signature outbound-sig {  
ip-proto == tcp  
src-ip == 192.168.0.0/16  
dst-ip != 192.168.0.0/16  
dst-port == 80  
http-request-header /^User-Agent:.*/  
event &quot;Outbound HTTP traffic&quot;  
}
</pre></div>
</td></tr></table>

<h5 id="get-bro-windows-shell-signature-stored-in-sig-file-read-with-s">Get bro Windows Shell signature stored in .sig file (read with -s)<a class="headerlink" href="#get-bro-windows-shell-signature-stored-in-sig-file-read-with-s" title="Permanent link">&para;</a></h5>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>signature windows_reverse_shell {  
ip-proto == tcp  
tcp-state established,originator  
event &quot;ATTACK-RESPONSES Microsoft cmd.exe banner (reverse-shell originator)&quot;  
payload /.*Microsoft Windows.*x28Cx29 Copyright 1985-.*Microsoft Corp/  
}
</pre></div>
</td></tr></table>

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>signature windows_shell {  
ip-proto == tcp  
tcp-state established,responder  
event &quot;ATTACK-RESPONSES Microsoft cmd.exe banner (normal-shell responder)&quot;  
payload /.*Microsoft Windows.*x28Cx29 Copyright 1985-.*Microsoft Corp/  
}
</pre></div>
</td></tr></table>

<h5 id="run-bro-with-sig-file">Run bro with sig file<a class="headerlink" href="#run-bro-with-sig-file" title="Permanent link">&para;</a></h5>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>bro -r file.pcap -s outbound.sig
</pre></div>
</td></tr></table>

<h5 id="view-dst-addresses-in-signature-file">View dst addresses in signature file<a class="headerlink" href="#view-dst-addresses-in-signature-file" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">cat signatures.log |bro-cut dst_addr | sort | uniq -c |sort -n</code></p>
<h5 id="bro-event-script-to-find-user-agent-outboundbro">BRO event script to find User-Agent (outbound.bro)<a class="headerlink" href="#bro-event-script-to-find-user-agent-outboundbro" title="Permanent link">&para;</a></h5>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>event http_header(c: connection, is_orig: bool, name: string, value: string)  
{  
local snet = 192.168.0.0/16;  
if (c$id$orig_h in snet)  
{  
if (c$id$resp_h !in snet)  
{  
if (c$id$resp_p == 80/tcp &amp;&amp; name == &quot;USER-AGENT&quot;)  
{  
print fmt (&quot;source IP %s, destination IP/port %s %s, USER-AGENT content %s&quot;,  
c$id$orig_h,c$id$resp_h,c$id$resp_p,value);  
}  
}  
}  
}
</pre></div>
</td></tr></table>

<p><strong>BRO Scripting Reference</strong> 
 <a href="https://www.bro.org/sphinx/scripting/">https://www.bro.org/sphinx/scripting/</a></p>
<h5 id="run-event-file-to-view-user-agent">Run event file to view user-agent<a class="headerlink" href="#run-event-file-to-view-user-agent" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">bro -r file.pcap outbound-event.bro</code></p>
<h5 id="bro-extract-common-files-from-pcap">BRO extract common files from pcap<a class="headerlink" href="#bro-extract-common-files-from-pcap" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">sudo bro -r file.pcap /opt/bro/share/bro/file-extraction/extract.bro</code></p>
<h5 id="extract-ssl-info">Extract ssl info<a class="headerlink" href="#extract-ssl-info" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">cat ssl.log | bro-cut server_name, subject, issuer_subject</code></p>
<h5 id="bro-extract-unique-ssl-certificate-data">BRO extract unique SSL certificate data<a class="headerlink" href="#bro-extract-unique-ssl-certificate-data" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">bro -C -r file.pcap &gt; cert_data.txt</code></p>
<h5 id="bro-extract-ssl-issuer-data-from-certificate-extraction">BRO extract SSL issuer data from certificate extraction<a class="headerlink" href="#bro-extract-ssl-issuer-data-from-certificate-extraction" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">cat ssl.log|bro-cut issuer_subject|sort -u &gt; /tmp/bro/data.txt</code></p>
<h5 id="bro-show-shortest-issuer-from-extraction">BRO show shortest issuer from extraction<a class="headerlink" href="#bro-show-shortest-issuer-from-extraction" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">cat /tmp/bro/data.txt |awk &#39;{print length, $0}&#39;|sort -nr</code></p>
<hr />
<h4 id="modsecurity-rules">ModSecurity rules<a class="headerlink" href="#modsecurity-rules" title="Permanent link">&para;</a></h4>
<h5 id="errorlog-ua-not-starting-with-mozilla">error.log UA not starting with Mozilla<a class="headerlink" href="#errorlog-ua-not-starting-with-mozilla" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">SecRule REQUEST_HEADERS:User-Agent &quot;!^Mozilla/d.d&quot; &quot;log,msg:&#39;User-Agent without Mozilla/#.#&#39;&quot;</code></p>
<h5 id="errorlog-visiting-ip-url">error.log visiting IP URL<a class="headerlink" href="#errorlog-visiting-ip-url" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">SecRule REQUEST_HEADERS:Host &quot;^[d.:]+$&quot; &quot;log,msg:&#39;Host used an IP address&#39;&quot;</code></p>
<h5 id="errorlog-blank-ua">error.log blank UA<a class="headerlink" href="#errorlog-blank-ua" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">SecRule REQUEST_HEADERS:User-Agent &quot;^$&quot; &quot;log,msg:&#39;Request has blank UA&#39;&quot;</code></p>
<h5 id="errorlog-ua-starting-with-mozilla">error.log UA starting with mozilla<a class="headerlink" href="#errorlog-ua-starting-with-mozilla" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">SecRule REQUEST_HEADERS:User-Agent &quot;^mozilla&quot; &quot;log,msg:&#39;Request has mozilla UA&#39;&quot;</code></p>
<h5 id="errorlog-visiting-by-ip-log-ua-used">error.log visiting by IP log UA used<a class="headerlink" href="#errorlog-visiting-by-ip-log-ua-used" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">SecRule REQUEST_HEADERS:Host &quot;^[d.:]+$&quot; &quot;log,msg:&#39;Host used an IP address check errorlog for UA&#39;,logdata:&#39;User-Agent:%{REQUEST_HEADERS.User-Agent}&#39;&quot;</code></p>
<h5 id="errorlog-no-ua-not-blank-but-none">error.log no UA (not blank but none)<a class="headerlink" href="#errorlog-no-ua-not-blank-but-none" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">SecRule &amp;REQUEST_HEADERS:User-Agent &quot;@eq 0&quot; &quot;log,msg:&#39;Request missing UA&#39;,logdata:&#39;User-Agent:%{REQUEST_HEADERS.User-Agent}&#39;&quot;</code></p>
<h5 id="errorlog-note-param-entry">error.log note param entry<a class="headerlink" href="#errorlog-note-param-entry" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">SecRule &amp;ARGS:password &quot;@gt 1&quot; &quot;log,msg:&#39;PW data&#39;,logdata:&#39;params:%{REQUEST_LINE}&#39;&quot;</code></p>
<h5 id="errorlog-trigger-on-keyword-can-use-pattern">error.log trigger on keyword (can use pattern)<a class="headerlink" href="#errorlog-trigger-on-keyword-can-use-pattern" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">#Trigger on EXFIL from body (phase:4 is the Response Body)SecRule RESPONSE_BODY &quot;badguy&quot; &quot;phase:4, msg:&#39;HoneyToken Exfil Detected&#39;, tag:&#39;HONEYTOKEN EXFIL&#39;&quot;</code></p>
<hr />
<h4 id="splunk">Splunk<a class="headerlink" href="#splunk" title="Permanent link">&para;</a></h4>
<p>Note these are examples and are mainly illustrated as templates for creating your own internal searches</p>
<h5 id="new-unauthorized-service">New unauthorized service<a class="headerlink" href="#new-unauthorized-service" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">index=windows LogName=System EventCode=7045 NOT (Service_Name=&lt;yourscanner&gt;) | eval Message=split(Message,&quot;.&quot;) | eval Short_Message=mvindex(Message,0) | table_time, host, Service_Name, Service_Type, Service_Start_Type, Service_Account, Short_Message</code></p>
<h5 id="detecting-process-abuse">Detecting process abuse<a class="headerlink" href="#detecting-process-abuse" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">index=sysmon SourceType=&quot;WinEventLog:Microsoft-Windows-Sysmon/Operational&quot; ProcessCreate (whoami OR netstat OR etc) | search EventCode=1 Image=&quot;*\whoami.exe&quot; OR Image=&quot;* etstat.exe&quot; OR Image=&quot;* asklist.exe&quot; | bin )time span=5m | rex field=Message &quot;.*User:(xxx|NT AUTHORITY)\(?&lt;USER&gt;.*)&quot; | stats dc(Image) AS CNT_CMDS values(CommandLine) values(ParentImage) values(ParentCommandLine) count by _time ComputerName USER</code></p>
<h5 id="detecting-process-abuse-simplified-requires-one-entry-per-process">Detecting process abuse (simplified, requires one entry per process)<a class="headerlink" href="#detecting-process-abuse-simplified-requires-one-entry-per-process" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">index=sysmon Image=&quot;* et.exe&quot; (CommandLine=&quot;*net group*&quot; OR CommandLine=&quot;*net localgroup*&quot; OR CommandLine=&quot;*net user*&quot;) | stats count by Computer,CommandLine</code></p>
<h5 id="process-starts-and-connects-to-ip">Process starts and connects to IP<a class="headerlink" href="#process-starts-and-connects-to-ip" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">index=windows LogName=System EventCode=5156 NOT (Source_Address=&quot;10.10.10.15&quot;) NOT (Application_Name=&quot;path:file.exe&quot;) | eval Message=split(Message,&quot;.&quot;) | table_time, host, Application_Name, Source_Address, Destination_Address, Direction</code></p>
<h5 id="detect-smb-traffic-between-clients">Detect SMB traffic between clients<a class="headerlink" href="#detect-smb-traffic-between-clients" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">index=sysmon SourceName=&quot;Microsoft-Windows-Sysmon&quot; EventCode=3 Initiated=true SourceIp!=DestinationIp DestinationPort=445 Image!=System (SourceHostname=&quot;fileserver1&quot; DestinationHostname=&quot;client1&quot;) OR (Source_Address=&quot;10.10.1.5&quot; Destination_Address=&quot;10.10.10.15&quot;) | stats by ComputerName ProcessGuid | fields ComputerName ProcessGuid</code></p>
<h5 id="detect-named-pipes">Detect Named Pipes<a class="headerlink" href="#detect-named-pipes" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">index=sysmon sourcetype=&quot;WinEventLog:Microsoft-Windows-Sysmon/Operational&quot; (PipeEvent &quot;Pipe Created&quot;) | search (EventCode=17 (PipeName=&quot;\*&quot;)) | stats values (Image) AS Images values(PipeName) AS PipeNames count by TaskCategory ComputerName</code></p>
<h4 id="detect-wmi">Detect WMI<a class="headerlink" href="#detect-wmi" title="Permanent link">&para;</a></h4>
<p><code class="codehilite">index=sysmon Image=&quot;*\WMIC.exe&quot; (CommandLine=&quot;*process call create*&quot; OR CommandLine=&quot;*/NODE:*&quot;) | stats count by Computer,CommandLine</code></p>
<p>and</p>
<p><code class="codehilite">index=sysmon ParentImage=&quot;*\WmiPrvSE.exe&quot; | stats count by Computer,CommandLine</code></p>
<h4 id="detect-powershell-commands">Detect PowerShell Commands<a class="headerlink" href="#detect-powershell-commands" title="Permanent link">&para;</a></h4>
<p><code class="codehilite">index=sysmon ParentImage=&quot;*wsmprovhost.exe&quot; | stats count by Computer,CommandLine</code></p>
<p>and</p>
<p><code class="codehilite">index=sysmon Image=&quot;*powershell.exe&quot; (CommandLine=&quot;*-EncodedCommand*&quot; OR CommandLine=&quot;*-Enc*&quot; OR CommandLine=&quot;*-e*&quot; OR CommandLine=&quot;*new-object*&quot; OR CommandLine=&quot;*-nop*&quot; OR CommandLine=&quot;*-noprofile&quot; OR CommandLine=&quot;*-Command*&quot; OR COmmandLine=&quot;*-c*&quot; OR CommandLine=&quot;*Invoke-Command*&quot; OR CommandLine=&quot;*download*&quot; OR CommandLine=&quot;*IEX*&quot; OR CommandLine=&quot;*exec*&quot;)| stats count by Computer,CommandLine</code></p>
<h5 id="alert-on-remote-files-copied-via-cmd-line">Alert on remote files copied via cmd line<a class="headerlink" href="#alert-on-remote-files-copied-via-cmd-line" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">index=windows LogName=Security EventCode=5145 Object_Type=File Share_Name=*$ (Access_Mask=0x100180 OR Access_Mask=0x80 OR Access_Mask=0x130197) |bucket span=1s _time |rex &quot;(?(0x100180|0x80|0x130197))&quot; |stats values(Relative_Target_Name) AS Relative_Target_Name, values(Account_Name) AS Account_Name, values(Source_Address) AS Source_Address, dc(thingtype) AS distinct_things by ComputerName, _time |search distinct_things=3</code></p>
<h5 id="alert-on-c-or-admin-share-enumeration">Alert on C or Admin share enumeration<a class="headerlink" href="#alert-on-c-or-admin-share-enumeration" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">index=windows LogName=Security EventCode=5145 Share_Name=*c$ OR *ADMIN$ (Access_Mask=0x100180) NOT (Source_Address=&quot;10.10.10.15&quot;)|bucket span=1s _time |rex &quot;(?(0x100180))&quot; |stats values(Relative_Target_Name) AS Relative_Target_Name, values(Account_Name) AS Account_Name, values(Source_Address) AS Source_Address, dc(thingtype) AS distinct_things by ComputerName, _time |search distinct_things=3</code></p>
<h5 id="search-for-file-delivery">Search for file delivery<a class="headerlink" href="#search-for-file-delivery" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">index=sysmon SourceName=&quot;Microsoft-Windows-Sysmon&quot; FileCreateStreamHash badfile.exe | search EventCode=15 | rex field=TargetFilename &quot;.*\(?&lt;TargFilename&gt;[^\]*)&quot; | rex field=Image &quot;.*\(?&lt;ImageFilename[^\]*)&quot; | rex field=Hash &quot;.*MD5=(?&lt;MD5&gt;[A-F0-9]*),IMPHASH=(?&lt;IMPHASH&gt;[A-F0-9]*)&quot; | stats values(TargFilename) values(ComputerName) AS Clients count by TaskCategory ImageFilename MD5</code></p>
<h5 id="search-for-registry-run-or-runonce-keys">Search for Registry Run (or RunOnce) Keys<a class="headerlink" href="#search-for-registry-run-or-runonce-keys" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">index=sysmon SourceName=&quot;Microsoft-Windows-Sysmon&quot; RegistryEvent CurrentVersion Run | search EventCode=13 &quot;*\Windows\CurrentVersion\Run*&quot; | rex field=Image &quot;.*\(?Image_EXE&gt;[^\]*)&quot; | rex field=TargetObject &quot;.*\CurrentVersion\(?&lt;TargetObj_PATH&gt;.*)&quot; | strcat &quot;Image=&quot;&quot; IMage_EXE &quot;&quot;, TargetObject=&quot;&quot; TargetObj_PATH &quot;&quot;, Details=&quot;&quot; Details &quot;&quot;&quot; Image_TargetObj_Details | stats dc(ComputerName) AS Clients values(Image_TragetObj_Details) count by TaskCategory Image_EXE</code></p>
<h5 id="search-for-file-system-persistence">Search for file system persistence<a class="headerlink" href="#search-for-file-system-persistence" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">index=sysmon SourceName=&quot;Microsoft-Windows-Sysmon&quot; ProcessCreate &quot;Start Menu&quot; Programs Startup | search Image=&quot;*\Microsoft\Windows\Start Menu\Programs\Startup\*&quot; | rex field=Image &quot;.*\Programs\Startup\(?&lt;Startup_Image&gt;[^\]*)&quot; | rex field=Hash &quot;.*MD5=(?&lt;MD5&gt;[A-F0-9]*),IMPHASH=(?&lt;IMPHASH&gt;[A-F0-9]*)&quot; | stats values(ComputerName) AS Clients vlaues(MD5) count by IMPHASH Startup_Image</code></p>
<h5 id="detect-credential-harvesting">Detect credential harvesting<a class="headerlink" href="#detect-credential-harvesting" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">index=sysmon ParentImage=&quot;*\services.exe&quot; | regex CommandLine=&quot;\[a-z0-9]{8}-[a-z0-9]{4}-[az0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}.exe-S$&quot;</code></p>
<p>and</p>
<p><code class="codehilite">index=sysmon CommandLine=&quot;*privileges::debug*&quot; OR CommandLine=&quot;*sekurlsa::*&quot; OR CommandLine=&quot;*kerberos::*&quot; OR CommandLine=&quot;*crypto::*&quot; OR CommandLine=&quot;*lsadump::*&quot; OR CommandLine=&quot;*process::*&quot;</code></p>
<h5 id="potential-privilege-escalation">Potential Privilege Escalation<a class="headerlink" href="#potential-privilege-escalation" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">index=sysmon sourcetype=&quot;WinEventLog:Microsoft-Windows-Sysmon/Operational&quot; EventCode=4688 Token_Elevation_Type=&quot;*(2)&quot;</code></p>
<h5 id="potential-beaconing-detection">Potential Beaconing Detection<a class="headerlink" href="#potential-beaconing-detection" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">index=proxy sourcetype=bluecoat:proxysg:access:syslog url=* | eval current_time=_time | sort 0 + current_time | streamstats global=f window=2 current=f last(current_time) AS previous_time by src, url | eval diff_time=current_time-previous_time| eventstats count, stdev(diff_time) AS std by src, url</code></p>
<h5 id="detect-webshell-activity-note-this-should-be-updated-at-implementation-and-often">Detect webshell activity (note this should be updated at implementation and often)<a class="headerlink" href="#detect-webshell-activity-note-this-should-be-updated-at-implementation-and-often" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">index=sysmon ParentImage=&quot;*pache*&quot; ParentImage=&quot;* omcat*&quot; ParentImage=&quot;* ginx*&quot; ParentImage=&quot;*\httpd*&quot; ParentImage=&quot;*\php-cgi*&quot; ParentImage=&quot;*\w3wp*&quot; CommandLine=&quot;*whoami*&quot; CommandLine=&quot;*net*&quot; CommandLine=&quot;*ipconfig*&quot; CommandLine=&quot;*hostname*&quot; CommandLine=&quot;*systeminfo*&quot; CommandLine=&quot;*cmd*&quot; CommandLine=&quot;*sh*&quot; CommandLine=&quot;*bash*&quot; CommandLine=&quot;*powershell*&quot;</code></p>
<h5 id="detect-potential-sqli">Detect potential SQLi<a class="headerlink" href="#detect-potential-sqli" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="s s-Atom">index</span><span class="o">=</span><span class="s s-Atom">weblogs</span> <span class="s s-Atom">sourcetype</span><span class="o">=</span><span class="nv">MSWindows</span><span class="s s-Atom">:</span><span class="mi">2008</span><span class="nv">R2</span><span class="s s-Atom">:</span><span class="nv">IIS</span> <span class="p">|</span> <span class="s s-Atom">regex</span> <span class="s s-Atom">cs_uri_query=</span><span class="s2">&quot;(?i)(?:--|;|/*|@|@@version|char|alter|begin|cast|create|cursor|declare|delete|drop|end|exec|fetch|insert|kill|open|select|sys|table|update)&quot;</span> <span class="p">|</span> <span class="s s-Atom">stats</span> <span class="s s-Atom">count</span> <span class="s s-Atom">by</span> <span class="s s-Atom">host</span> <span class="s s-Atom">c_ip</span> <span class="s s-Atom">cs_uri_stem</span> <span class="s s-Atom">cs_uri_query</span> <span class="p">|</span> <span class="s s-Atom">rex</span> <span class="s s-Atom">field</span><span class="o">=</span><span class="s s-Atom">cs_uri_query</span> <span class="s2">&quot;(?i)(?&lt;suspect&gt;--|;|/*|@|@@version|char|alter|begin|cast|create|cursor|declare|delete|drop|end|exec|fetch|insert|kill|open|select|sys|table|update)&quot;</span> <span class="s s-Atom">max_match</span><span class="o">=</span><span class="mi">0</span></code></p>
<h5 id="view-http-post-with-response">View HTTP POST with response<a class="headerlink" href="#view-http-post-with-response" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">index=json_bro eventtype=bro_http method=POST AND status &lt;=403 AND uri=*.php OR uri=*.jsp OR uri=*.cfm OR uri=*.asp OR uri=*.aspx |stats values(id.orig_h) AS Source, values,(hostname) AS Destination by uri</code></p>
<h5 id="find-weird-user-agents">Find Weird User-Agents<a class="headerlink" href="#find-weird-user-agents" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">index=json_bro eventtype-bro_http |stats count by user_agent | sort -count | reverse</code></p>
<h5 id="get-high-severity-epo-events">Get high severity EPO events<a class="headerlink" href="#get-high-severity-epo-events" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">index=av sourcetype=mcafee:epo (severity=critical OR severity=high) | stats values(event_description) AS desc, values(signature) AS signature, values(file_name) AS file_path, count AS result BY dest | eval dd=&quot;index=av sourcetype=mcafee:epo (severity=critical OR severity=high) dest=&quot;.dest</code></p>
<hr />
<h4 id="snort">Snort<a class="headerlink" href="#snort" title="Permanent link">&para;</a></h4>
<p>Note these are examples and are mainly illustrated as templates for creating your own internal searches</p>
<h5 id="detect-psexec">Detect psexec<a class="headerlink" href="#detect-psexec" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="nt">alert</span> <span class="nt">tcp</span> <span class="nt">any</span> <span class="nt">any</span> <span class="nt">-</span><span class="o">&gt;</span> <span class="o">$</span><span class="nt">HOME_NET</span> <span class="cp">[</span><span class="mi">139</span><span class="p">,</span><span class="mi">445</span><span class="cp">]</span> <span class="o">(</span><span class="nt">msg</span><span class="o">:</span><span class="s2">&quot;ET POLICY PsExec? service created&quot;</span><span class="o">;</span> <span class="nt">flow</span><span class="p">:</span><span class="nd">to_server</span><span class="o">,</span> <span class="nt">established</span><span class="o">;</span> <span class="nt">content</span><span class="o">:</span><span class="s2">&quot;5c 00 50 00 53 00 45 00 58 00 45 00 53 00 56 00 43 00 2e 00 45 00 58 00 45&quot;</span><span class="o">;</span> <span class="nt">reference</span><span class="o">:</span> <span class="nt">url</span><span class="o">,</span> <span class="nt">xinn</span><span class="p">.</span><span class="nc">org</span><span class="o">/</span><span class="nt">Snort-psexec</span><span class="p">.</span><span class="nc">html</span><span class="o">;</span> <span class="nt">reference</span><span class="p">:</span><span class="nd">url</span><span class="o">,</span> <span class="nt">doc</span><span class="p">.</span><span class="nc">emerginthreats</span><span class="p">.</span><span class="nc">net</span><span class="o">/</span><span class="nt">2010781</span><span class="p">:</span><span class="nd">classtype</span><span class="p">:</span><span class="nd">suspicious-filename-detect</span><span class="p">:</span><span class="nd">sid</span><span class="p">:</span><span class="nd">201781</span><span class="o">;</span> <span class="nt">rev</span><span class="p">:</span><span class="nd">2</span><span class="o">;)</span></code></p>
<h5 id="detect-packets-with-with-port-4444-port-0">Detect packets with with port 4444 (port 0?)<a class="headerlink" href="#detect-packets-with-with-port-4444-port-0" title="Permanent link">&para;</a></h5>
<p><code class="codehilite"><span class="nt">alert</span> <span class="nt">tcp</span> <span class="o">$</span><span class="nt">EXTERNAL_NET</span> <span class="nt">any</span> <span class="o">&lt;&gt;</span> <span class="o">$</span><span class="nt">HOME_NET</span> <span class="nt">4444</span> <span class="o">(</span><span class="nt">msg</span><span class="o">:</span><span class="s2">&quot;BAD-TRAFFIC tcp port 4444 traffic&quot;</span><span class="o">;</span> <span class="nt">flow</span><span class="p">:</span><span class="nd">stateless</span><span class="o">;</span> <span class="nt">classtype</span><span class="p">:</span><span class="nd">misc-activity</span><span class="o">;</span> <span class="nt">sid</span><span class="p">:</span><span class="nd">524</span><span class="o">;</span> <span class="nt">rev</span><span class="p">:</span><span class="nd">8</span><span class="o">;)</span><span class="err">&quot;</span></code></p>
<h5 id="snort-appid-list">Snort appid list<a class="headerlink" href="#snort-appid-list" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">sudo u2openappid /var/log/snort/appstats-unified.log.1455060958 |egrep -v &#39;&quot;http&quot;|&quot;https&quot;|&quot;dns&quot;|&quot;internet_explor&quot;&#39;|cut -d&quot;,&quot; -f2|sort|uniq -c|sort -nr</code></p>
<h4 id="interesting-file-extensions-note-this-is-the-same-list-as-above-placed-here-for-use-in-monitoring-via-snort">Interesting file extensions (Note this is the same list as above, placed here for use in monitoring via Snort)<a class="headerlink" href="#interesting-file-extensions-note-this-is-the-same-list-as-above-placed-here-for-use-in-monitoring-via-snort" title="Permanent link">&para;</a></h4>
<p><code class="codehilite"><span class="na">.ade</span><span class="p">,</span> <span class="no">.adp</span><span class="p">,</span> <span class="no">.ani</span><span class="p">,</span> <span class="no">.bas</span><span class="p">,</span> <span class="no">.bat</span><span class="p">,</span> <span class="no">.chm</span><span class="p">,</span> <span class="no">.cmd</span><span class="p">,</span> <span class="no">.com</span><span class="p">,</span> <span class="no">.cpl</span><span class="p">,</span> <span class="no">.crt</span><span class="p">,</span> <span class="no">.exe</span><span class="p">,</span> <span class="no">.hlp</span><span class="p">,</span> <span class="no">.ht</span><span class="p">,</span> <span class="no">.hta</span><span class="p">,</span> <span class="no">.inf</span><span class="p">,</span> <span class="no">.ins</span><span class="p">,</span> <span class="no">.isp</span><span class="p">,</span> <span class="no">.jar</span><span class="p">,</span> <span class="no">.job</span><span class="p">,</span> <span class="no">.js</span><span class="p">,</span> <span class="no">.jse</span><span class="p">,</span> <span class="no">.lnk</span><span class="p">,</span> <span class="no">.mda</span><span class="p">,</span> <span class="no">.mdb</span><span class="p">,</span> <span class="no">.mde</span><span class="p">,</span> <span class="no">.mdz</span><span class="p">,</span> <span class="no">.msc</span><span class="p">,</span> <span class="no">.msi</span><span class="p">,</span> <span class="no">.msp</span><span class="p">,</span> <span class="no">.mst</span><span class="p">,</span> <span class="no">.ocx</span><span class="p">,</span> <span class="no">.pcd</span><span class="p">,</span> <span class="no">.ps1</span><span class="p">,</span> <span class="no">.reg</span><span class="p">,</span> <span class="no">.scr</span><span class="p">,</span> <span class="no">.sct</span><span class="p">,</span> <span class="no">.shs</span><span class="p">,</span> <span class="no">.svg</span><span class="p">,</span> <span class="no">.url</span><span class="p">,</span> <span class="no">.vb</span><span class="p">,</span> <span class="no">.vbe</span><span class="p">,</span> <span class="no">.vbs</span><span class="p">,</span> <span class="no">.wbk</span><span class="p">,</span> <span class="no">.wsc</span><span class="p">,</span> <span class="no">.ws</span><span class="p">,</span> <span class="no">.wsf</span><span class="p">,</span> <span class="no">.wsh</span><span class="p">,</span> <span class="no">.exe</span><span class="p">,</span> <span class="no">.pif</span><span class="p">,</span> <span class="no">.pub</span><span class="p">,</span> <span class="no">.ip</span></code></p>
<hr />
<h4 id="additional-useful-info">Additional Useful Info<a class="headerlink" href="#additional-useful-info" title="Permanent link">&para;</a></h4>
<h5 id="get-methods-from-accesslog">Get methods from access.log<a class="headerlink" href="#get-methods-from-accesslog" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">cat access.log | cut -d&quot; -f2 | cut -d&#39; &#39; -f1 | sort -u</code></p>
<h5 id="decode-encoded-url-line-290">Decode %encoded url (line 290)<a class="headerlink" href="#decode-encoded-url-line-290" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">awk &#39; {if (length($0) &gt; max){max=length($0);maxline=$0}} END {print maxline }&#39; access.log|cut -d&quot; &quot; -f7|sed s/%//g|sed s/+//g|sed s/?//g|xxd -r -p</code></p>
<p>or</p>
<p><code class="codehilite">cat access.log |grep POST|grep cgi-bin|cut -d&#39;&quot;&#39; -f2|sort -u|sed s/%//g|sed s/+//g|cut -d&quot;?&quot; -f2|awk -F&quot;HTTP/1.1&quot; &#39;{print $1}&#39;|xxd -r -p</code></p>
<h4 id="gather-information-on-windows-host">Gather Information on Windows host<a class="headerlink" href="#gather-information-on-windows-host" title="Permanent link">&para;</a></h4>
<h5 id="list-task-services">List task services<a class="headerlink" href="#list-task-services" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tasklist /svc /fi &quot;imagename eq file.exe&quot;</code></p>
<h5 id="show-modules-for-task">Show modules for task<a class="headerlink" href="#show-modules-for-task" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tasklist /m /fi &quot;imagename eq file.exe&quot;</code></p>
<h5 id="verbose-task-information">Verbose task information<a class="headerlink" href="#verbose-task-information" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">tasklist /v /fi &quot;imagename eq file.exe&quot;</code></p>
<h5 id="get-information-about-processes">Get information about processes<a class="headerlink" href="#get-information-about-processes" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">get-wmiobject -class Win32_Process -Filter &#39;Name=&quot;file.exe&quot;&#39;</code></p>
<p>and</p>
<p><code class="codehilite"><span class="x">get-process | select * |Where-Object </span><span class="cp">{</span><span class="nv">$_.ID</span> <span class="o">-</span><span class="na">eq</span> <span class="na">PID</span><span class="cp">}</span><span class="x"></span></code></p>
<p>and</p>
<p><code class="codehilite"><span class="x">gwmi Win32_Process|Select ProcessName,ProcessID,ParentProcessID,CommandLine,@</span><span class="cp">{</span><span class="nf">e</span><span class="o">=</span><span class="cp">{</span><span class="nv">$_.GetOwner</span><span class="o">().</span><span class="na">User</span><span class="cp">}}</span><span class="x">|ft -wrap;netstat ano</span></code></p>
<h5 id="look-for-code-injected-into-memory">Look for code injected into memory<a class="headerlink" href="#look-for-code-injected-into-memory" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">Get-InjectedThread.ps1</code></p>
<p><strong>Reference</strong><br />
 <a href="https://gist.github.com/jaredcatkinson/23905d34537ce4b5b1818c3e6405c1d2">https://gist.github.com/jaredcatkinson/23905d34537ce4b5b1818c3e6405c1d2</a></p>
<hr />
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../06/threat-gets-a-vote-applying-a-threat-based-approach-to-security-testing/" title="Threat Get's a Vote - Applying a Threat Based Approach to Security Testing" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Threat Get's a Vote - Applying a Threat Based Approach to Security Testing
              </span>
            </div>
          </a>
        
        
          <a href="../../02/automating-cobalt-strike-profiles-apache-mod_rewrite-htaccess-files-intelligent-c2-redirection/" title="Automating Cobalt Strike Profiles Apache mod_rewrite htaccess Files for Intelligent C2 Redirection" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Automating Cobalt Strike Profiles Apache mod_rewrite htaccess Files for Intelligent C2 Redirection
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
             2019 Threatexpress
          </div>
        
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/threatexpress" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/joevest" class="md-footer-social__link fa fa-twitter"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../../assets/javascripts/application.9e1f3b71.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../../.."}})</script>
      
        <script src="https://platform.twitter.com/widgets.js"></script>
      
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
      
        <script src="../../../../js/extra.js"></script>
      
    
    
      
    
  </body>
</html>